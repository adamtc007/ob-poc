-- 14_agentic_crud_phase1_schema.sql
-- Phase 1: Foundation schema for Agentic DSL CRUD Implementation
-- Adds CRUD operation tracking, RAG embeddings, and DSL example library

-- ============================================================================
-- CRUD OPERATIONS TRACKING
-- ============================================================================

-- Track all CRUD operations generated by the agentic system
CREATE TABLE IF NOT EXISTS "ob-poc".crud_operations (
    operation_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    operation_type VARCHAR(20) NOT NULL CHECK (operation_type IN ('CREATE', 'READ', 'UPDATE', 'DELETE')),
    asset_type VARCHAR(50) NOT NULL CHECK (asset_type IN ('CBU', 'ENTITY', 'PARTNERSHIP', 'LIMITED_COMPANY', 'PROPER_PERSON', 'TRUST', 'ATTRIBUTE', 'DOCUMENT')),
    entity_table_name VARCHAR(100), -- specific entity table name (e.g., 'entity_partnerships')
    generated_dsl TEXT NOT NULL,
    ai_instruction TEXT NOT NULL,
    affected_records JSONB NOT NULL DEFAULT '[]'::jsonb,
    execution_status VARCHAR(20) NOT NULL DEFAULT 'PENDING' CHECK (execution_status IN ('PENDING', 'EXECUTING', 'COMPLETED', 'FAILED', 'ROLLED_BACK')),
    ai_confidence DECIMAL(3,2) CHECK (ai_confidence >= 0.0 AND ai_confidence <= 1.0),
    ai_provider VARCHAR(50), -- 'openai', 'gemini', etc.
    ai_model VARCHAR(100), -- 'gpt-4', 'gemini-pro', etc.
    execution_time_ms INTEGER,
    error_message TEXT,
    created_by VARCHAR(255) DEFAULT 'agentic_system',
    created_at TIMESTAMPTZ DEFAULT (now() at time zone 'utc'),
    completed_at TIMESTAMPTZ,
    -- Performance and audit fields
    rows_affected INTEGER DEFAULT 0,
    transaction_id UUID, -- Links to transaction manager if part of batch
    parent_operation_id UUID REFERENCES "ob-poc".crud_operations(operation_id) -- For compound operations
);

-- Indexes for CRUD operations
CREATE INDEX IF NOT EXISTS idx_crud_operations_type ON "ob-poc".crud_operations (operation_type);
CREATE INDEX IF NOT EXISTS idx_crud_operations_asset ON "ob-poc".crud_operations (asset_type);
CREATE INDEX IF NOT EXISTS idx_crud_operations_status ON "ob-poc".crud_operations (execution_status);
CREATE INDEX IF NOT EXISTS idx_crud_operations_created ON "ob-poc".crud_operations (created_at DESC);
CREATE INDEX IF NOT EXISTS idx_crud_operations_transaction ON "ob-poc".crud_operations (transaction_id) WHERE transaction_id IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_crud_operations_parent ON "ob-poc".crud_operations (parent_operation_id) WHERE parent_operation_id IS NOT NULL;

-- ============================================================================
-- RAG SYSTEM SUPPORT
-- ============================================================================

-- Install pgvector extension for vector embeddings (if not already installed)
-- CREATE EXTENSION IF NOT EXISTS vector;

-- Store vector embeddings for RAG context retrieval
CREATE TABLE IF NOT EXISTS "ob-poc".rag_embeddings (
    embedding_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    content_type VARCHAR(50) NOT NULL CHECK (content_type IN ('SCHEMA', 'EXAMPLE', 'ATTRIBUTE', 'RULE', 'GRAMMAR', 'VERB_PATTERN')),
    content_text TEXT NOT NULL,
    -- embedding vector(1536), -- OpenAI ada-002 dimensions (commented out until pgvector is available)
    embedding_data JSONB, -- Store embeddings as JSON until pgvector is available
    metadata JSONB NOT NULL DEFAULT '{}'::jsonb,
    source_table VARCHAR(100), -- Source table name for schema embeddings
    asset_type VARCHAR(50), -- Asset type this embedding relates to
    relevance_score DECIMAL(3,2) DEFAULT 1.0,
    usage_count INTEGER DEFAULT 0,
    last_used_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT (now() at time zone 'utc'),
    updated_at TIMESTAMPTZ DEFAULT (now() at time zone 'utc')
);

-- Indexes for RAG embeddings
CREATE INDEX IF NOT EXISTS idx_rag_embeddings_type ON "ob-poc".rag_embeddings (content_type);
CREATE INDEX IF NOT EXISTS idx_rag_embeddings_asset ON "ob-poc".rag_embeddings (asset_type);
CREATE INDEX IF NOT EXISTS idx_rag_embeddings_source ON "ob-poc".rag_embeddings (source_table) WHERE source_table IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_rag_embeddings_usage ON "ob-poc".rag_embeddings (usage_count DESC);
CREATE INDEX IF NOT EXISTS idx_rag_embeddings_relevance ON "ob-poc".rag_embeddings (relevance_score DESC);

-- ============================================================================
-- DSL EXAMPLES LIBRARY
-- ============================================================================

-- Store curated examples of natural language -> DSL mappings
CREATE TABLE IF NOT EXISTS "ob-poc".dsl_examples (
    example_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    title VARCHAR(255) NOT NULL,
    description TEXT,
    operation_type VARCHAR(20) NOT NULL CHECK (operation_type IN ('CREATE', 'READ', 'UPDATE', 'DELETE')),
    asset_type VARCHAR(50) NOT NULL CHECK (asset_type IN ('CBU', 'ENTITY', 'PARTNERSHIP', 'LIMITED_COMPANY', 'PROPER_PERSON', 'TRUST', 'ATTRIBUTE', 'DOCUMENT')),
    entity_table_name VARCHAR(100), -- specific entity table for entity operations
    natural_language_input TEXT NOT NULL,
    example_dsl TEXT NOT NULL,
    expected_outcome TEXT,
    tags TEXT[] DEFAULT ARRAY[]::TEXT[],
    complexity_level VARCHAR(20) DEFAULT 'MEDIUM' CHECK (complexity_level IN ('SIMPLE', 'MEDIUM', 'COMPLEX')),
    success_rate DECIMAL(3,2) DEFAULT 1.0, -- Track how often this example leads to successful operations
    usage_count INTEGER DEFAULT 0,
    last_used_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT (now() at time zone 'utc'),
    updated_at TIMESTAMPTZ DEFAULT (now() at time zone 'utc'),
    created_by VARCHAR(255) DEFAULT 'system'
);

-- Indexes for DSL examples
CREATE INDEX IF NOT EXISTS idx_dsl_examples_operation ON "ob-poc".dsl_examples (operation_type);
CREATE INDEX IF NOT EXISTS idx_dsl_examples_asset ON "ob-poc".dsl_examples (asset_type);
CREATE INDEX IF NOT EXISTS idx_dsl_examples_table ON "ob-poc".dsl_examples (entity_table_name) WHERE entity_table_name IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_dsl_examples_complexity ON "ob-poc".dsl_examples (complexity_level);
CREATE INDEX IF NOT EXISTS idx_dsl_examples_success ON "ob-poc".dsl_examples (success_rate DESC);
CREATE INDEX IF NOT EXISTS idx_dsl_examples_usage ON "ob-poc".dsl_examples (usage_count DESC);
CREATE INDEX IF NOT EXISTS idx_dsl_examples_tags ON "ob-poc".dsl_examples USING gin(tags);

-- ============================================================================
-- ENTITY-SPECIFIC CRUD METADATA
-- ============================================================================

-- Track entity-specific CRUD constraints and rules
CREATE TABLE IF NOT EXISTS "ob-poc".entity_crud_rules (
    rule_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    entity_table_name VARCHAR(100) NOT NULL,
    operation_type VARCHAR(20) NOT NULL CHECK (operation_type IN ('CREATE', 'READ', 'UPDATE', 'DELETE')),
    field_name VARCHAR(100),
    constraint_type VARCHAR(50) NOT NULL CHECK (constraint_type IN ('REQUIRED', 'UNIQUE', 'FOREIGN_KEY', 'VALIDATION', 'BUSINESS_RULE')),
    constraint_description TEXT NOT NULL,
    validation_pattern VARCHAR(500), -- Regex or validation rule
    error_message TEXT,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT (now() at time zone 'utc'),
    updated_at TIMESTAMPTZ DEFAULT (now() at time zone 'utc')
);

-- Indexes for entity CRUD rules
CREATE INDEX IF NOT EXISTS idx_entity_crud_rules_table ON "ob-poc".entity_crud_rules (entity_table_name);
CREATE INDEX IF NOT EXISTS idx_entity_crud_rules_operation ON "ob-poc".entity_crud_rules (operation_type);
CREATE INDEX IF NOT EXISTS idx_entity_crud_rules_field ON "ob-poc".entity_crud_rules (field_name) WHERE field_name IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_entity_crud_rules_active ON "ob-poc".entity_crud_rules (is_active);

-- ============================================================================
-- INITIAL SEED DATA FOR DSL EXAMPLES
-- ============================================================================

-- Seed initial DSL examples for entity operations
INSERT INTO "ob-poc".dsl_examples (title, description, operation_type, asset_type, entity_table_name, natural_language_input, example_dsl, expected_outcome, tags, complexity_level)
VALUES
-- Partnership examples
('Create Delaware LLC', 'Create a limited liability partnership in Delaware', 'CREATE', 'PARTNERSHIP', 'entity_partnerships',
 'Create a new Delaware LLC called TechCorp with formation date January 15, 2024',
 '(data.create :asset "partnership" :values {:partnership_name "TechCorp LLC" :partnership_type "Limited Liability" :jurisdiction "US-DE" :formation_date "2024-01-15"})',
 'New partnership record created with generated UUID',
 ARRAY['partnership', 'delaware', 'llc', 'create'], 'SIMPLE'),

('Find US Partnerships', 'Search for partnerships by jurisdiction', 'READ', 'PARTNERSHIP', 'entity_partnerships',
 'Show me all partnerships registered in the United States',
 '(data.read :asset "partnership" :where {:jurisdiction "US"} :select ["partnership_name" "partnership_type" "jurisdiction"])',
 'List of US partnerships with name, type, and jurisdiction',
 ARRAY['partnership', 'search', 'jurisdiction'], 'SIMPLE'),

-- Proper Person examples
('Create Individual', 'Create a natural person entity', 'CREATE', 'PROPER_PERSON', 'entity_proper_persons',
 'Add John Smith, born January 1, 1985, US nationality, with passport number P123456789',
 '(data.create :asset "proper_person" :values {:first_name "John" :last_name "Smith" :date_of_birth "1985-01-01" :nationality "US" :id_document_type "Passport" :id_document_number "P123456789"})',
 'New proper person record created with personal details',
 ARRAY['person', 'individual', 'create', 'passport'], 'SIMPLE'),

-- Limited Company examples
('Create UK Company', 'Create a UK limited company', 'CREATE', 'LIMITED_COMPANY', 'entity_limited_companies',
 'Register AlphaTech Ltd as a UK company with registration number 12345678, incorporated on March 1, 2023',
 '(data.create :asset "limited_company" :values {:company_name "AlphaTech Ltd" :registration_number "12345678" :jurisdiction "GB" :incorporation_date "2023-03-01"})',
 'New limited company record created with UK registration details',
 ARRAY['company', 'uk', 'limited', 'create'], 'SIMPLE'),

-- Trust examples
('Create Discretionary Trust', 'Create a discretionary trust entity', 'CREATE', 'TRUST', 'entity_trusts',
 'Establish the Smith Family Trust as a discretionary trust in the Cayman Islands, created on February 15, 2024',
 '(data.create :asset "trust" :values {:trust_name "Smith Family Trust" :trust_type "Discretionary" :jurisdiction "KY" :establishment_date "2024-02-15"})',
 'New trust entity created with discretionary structure',
 ARRAY['trust', 'discretionary', 'cayman', 'create'], 'MEDIUM'),

-- Complex search examples
('Find High Net Worth Entities', 'Complex search across multiple entity types', 'READ', 'ENTITY', 'entities',
 'Find all entities (partnerships, companies, trusts) in offshore jurisdictions',
 '(data.read :asset "entity" :where {:jurisdiction ["KY" "BVI" "BS" "CH"]} :join ["entity_type"] :select ["name" "entity_type" "jurisdiction"])',
 'List of offshore entities across all types',
 ARRAY['entity', 'offshore', 'complex', 'search'], 'COMPLEX'),

-- Update examples
('Update Company Address', 'Update entity address information', 'UPDATE', 'LIMITED_COMPANY', 'entity_limited_companies',
 'Update the registered address of AlphaTech Ltd to 123 New Street, London, UK',
 '(data.update :asset "limited_company" :where {:company_name "AlphaTech Ltd"} :values {:registered_address "123 New Street, London, UK"})',
 'Company address updated successfully',
 ARRAY['company', 'address', 'update'], 'SIMPLE');

-- ============================================================================
-- ENTITY CRUD RULES SEED DATA
-- ============================================================================

-- Seed basic validation rules for entity tables
INSERT INTO "ob-poc".entity_crud_rules (entity_table_name, operation_type, field_name, constraint_type, constraint_description, validation_pattern, error_message)
VALUES
-- Partnership rules
('entity_partnerships', 'CREATE', 'partnership_name', 'REQUIRED', 'Partnership name is mandatory', NULL, 'Partnership name cannot be empty'),
('entity_partnerships', 'CREATE', 'partnership_type', 'VALIDATION', 'Must be valid partnership type', '^(General|Limited|Limited Liability)$', 'Partnership type must be General, Limited, or Limited Liability'),
('entity_partnerships', 'CREATE', 'jurisdiction', 'VALIDATION', 'Must be valid jurisdiction code', '^[A-Z]{2}(-[A-Z]{2})?$', 'Jurisdiction must be valid country/state code (e.g., US, US-DE)'),

-- Proper Person rules
('entity_proper_persons', 'CREATE', 'first_name', 'REQUIRED', 'First name is mandatory', NULL, 'First name cannot be empty'),
('entity_proper_persons', 'CREATE', 'last_name', 'REQUIRED', 'Last name is mandatory', NULL, 'Last name cannot be empty'),
('entity_proper_persons', 'CREATE', 'date_of_birth', 'VALIDATION', 'Must be valid date and not future', NULL, 'Date of birth must be a valid past date'),

-- Limited Company rules
('entity_limited_companies', 'CREATE', 'company_name', 'REQUIRED', 'Company name is mandatory', NULL, 'Company name cannot be empty'),
('entity_limited_companies', 'CREATE', 'jurisdiction', 'VALIDATION', 'Must be valid jurisdiction code', '^[A-Z]{2}(-[A-Z]{2})?$', 'Jurisdiction must be valid country code'),

-- Trust rules
('entity_trusts', 'CREATE', 'trust_name', 'REQUIRED', 'Trust name is mandatory', NULL, 'Trust name cannot be empty'),
('entity_trusts', 'CREATE', 'jurisdiction', 'REQUIRED', 'Trust jurisdiction is mandatory', NULL, 'Trust jurisdiction cannot be empty'),
('entity_trusts', 'CREATE', 'trust_type', 'VALIDATION', 'Must be valid trust type', '^(Discretionary|Fixed Interest|Unit Trust|Charitable)$', 'Trust type must be Discretionary, Fixed Interest, Unit Trust, or Charitable');

-- Add comments for documentation
COMMENT ON TABLE "ob-poc".crud_operations IS 'Tracks all CRUD operations generated by the agentic system with AI metadata and execution status';
COMMENT ON TABLE "ob-poc".rag_embeddings IS 'Vector embeddings for RAG context retrieval in agentic CRUD operations';
COMMENT ON TABLE "ob-poc".dsl_examples IS 'Curated library of natural language to DSL examples for training and context';
COMMENT ON TABLE "ob-poc".entity_crud_rules IS 'Entity-specific validation rules and constraints for CRUD operations';

COMMENT ON COLUMN "ob-poc".crud_operations.ai_confidence IS 'AI confidence score between 0.0 and 1.0 for the generated DSL';
COMMENT ON COLUMN "ob-poc".crud_operations.affected_records IS 'JSON array of record IDs affected by this operation';
COMMENT ON COLUMN "ob-poc".rag_embeddings.embedding_data IS 'Vector embedding stored as JSON until pgvector extension is available';
COMMENT ON COLUMN "ob-poc".dsl_examples.success_rate IS 'Rate of successful operations when using this example (0.0 to 1.0)';
