; Trust UBO Discovery Workflow Template
; Implements FATF guidance for trust beneficial ownership identification
; Supports both US (FinCEN) and EU (5MLD) regulatory frameworks

(workflow.trust.ubo
  (entity.name "{{.EntityName}}")
  (entity.type "TRUST")
  (jurisdiction "{{.Jurisdiction}}")
  (workflow.id "{{.SessionID}}")
  (created.at "{{.CreatedAt}}")

  ; Trust structure identification
  (trust.structure.analyze
    (trust.type "{{.TrustType | default "DISCRETIONARY"}}")
    (trust.purpose "{{.TrustPurpose | default "ASSET_PROTECTION"}}")
    (trust.domicile "{{.Jurisdiction}}")
    (revocable "{{.IsRevocable | default false}}")
    (charitable "{{.IsCharitable | default false}}")
  )

  ; Settlor identification and verification
  (trust.settlor.identify
    (verification.required true)
    (living.settlor.kyc "{{.ComplianceTier | default "STANDARD"}}")
    (deceased.settlor.documentation true)
    (multiple.settlors "{{.HasMultipleSettlors | default false}}")
    (attributes
      "@attr{trust.settlor.legal_name}"
      "@attr{trust.settlor.date_of_birth}"
      "@attr{trust.settlor.jurisdiction_of_residence}"
      "@attr{trust.settlor.identification_document}"
      {{if eq .Jurisdiction "US"}}
      "@attr{trust.settlor.ssn}"
      {{end}}
      {{if or (eq .Jurisdiction "LU") (eq .Jurisdiction "DE") (eq .Jurisdiction "FR")}}
      "@attr{trust.settlor.eu_tax_id}"
      {{end}}
    )
  )

  ; Trustee identification (always required)
  (trust.trustee.identify
    (professional.trustee "{{.HasProfessionalTrustee | default false}}")
    (individual.trustees.count "{{.IndividualTrusteeCount | default 1}}")
    (corporate.trustees.count "{{.CorporateTrusteeCount | default 0}}")
    (attributes
      "@attr{trust.trustee.legal_name}"
      "@attr{trust.trustee.business_address}"
      "@attr{trust.trustee.license_number}"
      "@attr{trust.trustee.regulatory_authority}"
      {{if .HasIndividualTrustees}}
      "@attr{trust.trustee.individual.identification}"
      {{end}}
    )
  )

  ; Beneficiary discovery and classification
  (trust.beneficiaries.discover
    (named.beneficiaries.required true)
    (class.of.beneficiaries "{{.HasClassBeneficiaries | default false}}")
    (discretionary.beneficiaries "{{.IsDiscretionary | default true}}")
    (charitable.beneficiaries "{{.IsCharitable | default false}}")
    (vested.interests.identification true)

    ; Current beneficiaries (entitled to distributions)
    (current.beneficiaries
      (verification.required true)
      (kyc.tier "{{.BeneficiaryKYCTier | default "STANDARD"}}")
      (attributes
        "@attr{trust.beneficiary.legal_name}"
        "@attr{trust.beneficiary.relationship_to_settlor}"
        "@attr{trust.beneficiary.distribution_percentage}"
        "@attr{trust.beneficiary.vesting_date}"
      )
    )

    ; Remainder beneficiaries (entitled after termination)
    (remainder.beneficiaries
      (identification.required true)
      (contingent.beneficiaries true)
      (attributes
        "@attr{trust.remainder.beneficiary.legal_name}"
        "@attr{trust.remainder.beneficiary.contingency_conditions}"
      )
    )
  )

  ; Protector identification (if applicable)
  {{if .HasProtector}}
  (trust.protector.identify
    (protector.powers.review true)
    (veto.powers "{{.ProtectorVetoPowers | default false}}")
    (appointment.powers "{{.ProtectorAppointmentPowers | default false}}")
    (attributes
      "@attr{trust.protector.legal_name}"
      "@attr{trust.protector.powers_description}"
      "@attr{trust.protector.appointment_mechanism}"
    )
  )
  {{end}}

  ; Control prong analysis (US FinCEN requirements)
  {{if eq .Jurisdiction "US"}}
  (ubo.control.prong.analysis
    (control.threshold 25)
    (control.mechanisms
      "TRUSTEE_POWERS"
      "PROTECTOR_POWERS"
      "BENEFICIARY_VETO_RIGHTS"
      "DISTRIBUTION_COMMITTEE"
    )
    (control.persons.identify
      (direct.control true)
      (indirect.control true)
      (joint.control true)
    )
  )
  {{end}}

  ; Ownership prong analysis (beneficial ownership identification)
  (ubo.ownership.prong.analysis
    (ownership.threshold "{{.UBOThreshold | default 25}}")
    (economic.interests.analysis true)
    (distribution.rights.analysis true)
    (remainder.interests.analysis true)

    ; Direct ownership through beneficial interests
    (direct.beneficial.ownership
      (current.distribution.rights true)
      (capital.distribution.rights true)
      (voting.rights.in.trust.decisions false) ; Trusts typically don't have voting
    )

    ; Indirect ownership through entities
    (indirect.beneficial.ownership
      (through.corporate.beneficiaries true)
      (through.trust.beneficiaries true)
      (chain.of.ownership.analysis true)
      (ultimate.beneficial.owners.identification true)
    )
  )

  ; Regulatory framework application
  {{if eq .Jurisdiction "US"}}
  (compliance.fincen.cdd.rule
    (beneficial.ownership.threshold 25)
    (control.person.identification true)
    (ownership.person.identification true)
    (certification.requirements true)
    (ongoing.monitoring true)
  )
  {{else if or (eq .Jurisdiction "LU") (eq .Jurisdiction "DE") (eq .Jurisdiction "FR") (eq .Jurisdiction "IE")}}
  (compliance.eu.5mld
    (beneficial.ownership.register true)
    (dual.prong.test true)
    (ownership.threshold 25)
    (control.threshold "SIGNIFICANT_INFLUENCE")
    (transparency.requirements true)
    (ongoing.monitoring true)
  )
  {{else if eq .Jurisdiction "CH"}}
  (compliance.swiss.amla
    (beneficial.ownership.identification true)
    (control.person.analysis true)
    (ongoing.monitoring.enhanced "{{eq .ComplianceTier "ENHANCED"}}")
    (finma.reporting.requirements true)
  )
  {{end}}

  ; Risk assessment and ongoing monitoring
  (risk.assessment.trust
    (complexity.score "{{.TrustComplexityScore | default "MEDIUM"}}")
    (jurisdiction.risk "{{.JurisdictionRisk | default "STANDARD"}}")
    (beneficiary.risk.profile true)
    (source.of.funds.verification "{{.ComplianceTier}}")
    (ongoing.monitoring.frequency "{{.MonitoringFrequency | default "ANNUAL"}}")
  )

  ; Documentation requirements
  (documentation.requirements
    (trust.deed.review true)
    (trust.amendments.review true)
    (beneficiary.letters.of.wishes false) ; Usually confidential
    (trustee.resolutions true)
    (distribution.records.review true)
    (asset.valuations.review true)
    {{if .HasProtector}}
    (protector.appointment.documents true)
    {{end}}
  )

  ; Cross-domain dependencies and handoffs
  (dependencies.resolution
    (depends.on.domains "kyc" "onboarding")
    (provides.to.domains "custody" "compliance" "reporting")
    (shared.attributes
      "@attr{trust.ubo.control_persons}"
      "@attr{trust.ubo.ownership_persons}"
      "@attr{trust.ubo.combined_threshold_persons}"
      "@attr{trust.risk.assessment_score}"
      "@attr{trust.compliance.status}"
    )
  )

  ; Final UBO determination
  (ubo.final.determination
    (control.persons.list "@attr{trust.final.control_persons}")
    (ownership.persons.list "@attr{trust.final.ownership_persons}")
    (combined.ubo.list "@attr{trust.final.ubo_persons}")
    (no.ubo.identified.reason "@attr{trust.no_ubo_reason}")
    (regulatory.filing.requirements true)
    (ongoing.verification.schedule "@attr{trust.verification_schedule}")
  )
)
