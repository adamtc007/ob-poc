{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/schemas/investor_ir.schema.json",
  "title": "Investor Lifecycle IR",
  "type": "object",
  "required": ["version", "plan_id", "created_at", "steps"],
  "properties": {
    "version": { "type": "string", "pattern": "^1\\.\\d+\\.\\d+$" },
    "plan_id": { "$ref": "#/$defs/UUID" },
    "created_at": { "$ref": "#/$defs/Timestamp" },
    "metadata": { "type": "object", "additionalProperties": true },
    "steps": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/Step" }
    }
  },
  "$defs": {
    "UUID": { "type": "string", "format": "uuid" },
    "Date": { "type": "string", "format": "date" },
    "Timestamp": { "type": "string", "format": "date-time" },
    "CurrencyCode": { "type": "string", "pattern": "^[A-Z]{3}$" },
    "IdempotencyKey": { "type": "string", "pattern": "^[A-Za-z0-9_-]{10,128}$" },
    "Units": { "type": "number" },
    "Amount": { "type": "number" },
    "AttrRef": {
      "type": "object",
      "required": ["kind", "id"],
      "properties": {
        "kind": { "const": "AttrRef" },
        "id": { "type": "string", "pattern": "^[A-Z]+(\\.[A-Z0-9_\\[\\]\\-]+)*$" },
        "type": { "type": "string" },
        "required": { "type": "boolean", "default": true },
        "constraints": { "type": "object", "additionalProperties": true },
        "sources": {
          "type": "array",
          "items": { "type": "object", "additionalProperties": true }
        }
      },
      "additionalProperties": false
    },
    "Value": {
      "description": "Literal or late-bound attribute reference",
      "oneOf": [
        { "type": "string" },
        { "type": "number" },
        { "type": "boolean" },
        { "type": "object", "additionalProperties": true },
        { "$ref": "#/$defs/AttrRef" }
      ]
    },

    "Step": {
      "type": "object",
      "required": ["op", "args"],
      "properties": {
        "op": {
          "type": "string",
          "enum": [
            "investor.start-opportunity",
            "investor.record-indication",

            "kyc.begin",
            "kyc.collect-doc",
            "kyc.screen",
            "kyc.approve",

            "tax.capture",

            "bank.set-instruction",

            "subscribe.request",
            "cash.confirm",
            "deal.nav",
            "subscribe.issue",

            "kyc.refresh-schedule",
            "screen.continuous",

            "redeem.request",
            "redeem.settle",

            "offboard.close"
          ]
        },
        "args": { "type": "object" },
        "idempotency_key": { "$ref": "#/$defs/IdempotencyKey" },
        "annotations": { "type": "object", "additionalProperties": true }
      },
      "additionalProperties": false,
      "allOf": [
        { "if": { "properties": { "op": { "const": "investor.start-opportunity" } } },
          "then": { "properties": { "args": { "$ref": "#/$defs/args.investor.start-opportunity" } } } },

        { "if": { "properties": { "op": { "const": "investor.record-indication" } } },
          "then": { "properties": { "args": { "$ref": "#/$defs/args.investor.record-indication" } } } },

        { "if": { "properties": { "op": { "const": "kyc.begin" } } },
          "then": { "properties": { "args": { "$ref": "#/$defs/args.kyc.begin" } } } },

        { "if": { "properties": { "op": { "const": "kyc.collect-doc" } } },
          "then": { "properties": { "args": { "$ref": "#/$defs/args.kyc.collect-doc" } } } },

        { "if": { "properties": { "op": { "const": "kyc.screen" } } },
          "then": { "properties": { "args": { "$ref": "#/$defs/args.kyc.screen" } } } },

        { "if": { "properties": { "op": { "const": "kyc.approve" } } },
          "then": { "properties": { "args": { "$ref": "#/$defs/args.kyc.approve" } } } },

        { "if": { "properties": { "op": { "const": "tax.capture" } } },
          "then": { "properties": { "args": { "$ref": "#/$defs/args.tax.capture" } } } },

        { "if": { "properties": { "op": { "const": "bank.set-instruction" } } },
          "then": { "properties": { "args": { "$ref": "#/$defs/args.bank.set-instruction" } } } },

        { "if": { "properties": { "op": { "const": "subscribe.request" } } },
          "then": { "properties": { "args": { "$ref": "#/$defs/args.subscribe.request" } } } },

        { "if": { "properties": { "op": { "const": "cash.confirm" } } },
          "then": { "properties": { "args": { "$ref": "#/$defs/args.cash.confirm" } } } },

        { "if": { "properties": { "op": { "const": "deal.nav" } } },
          "then": { "properties": { "args": { "$ref": "#/$defs/args.deal.nav" } } } },

        { "if": { "properties": { "op": { "const": "subscribe.issue" } } },
          "then": { "properties": { "args": { "$ref": "#/$defs/args.subscribe.issue" } } } },

        { "if": { "properties": { "op": { "const": "kyc.refresh-schedule" } } },
          "then": { "properties": { "args": { "$ref": "#/$defs/args.kyc.refresh-schedule" } } } },

        { "if": { "properties": { "op": { "const": "screen.continuous" } } },
          "then": { "properties": { "args": { "$ref": "#/$defs/args.screen.continuous" } } } },

        { "if": { "properties": { "op": { "const": "redeem.request" } } },
          "then": { "properties": { "args": { "$ref": "#/$defs/args.redeem.request" } } } },

        { "if": { "properties": { "op": { "const": "redeem.settle" } } },
          "then": { "properties": { "args": { "$ref": "#/$defs/args.redeem.settle" } } } },

        { "if": { "properties": { "op": { "const": "offboard.close" } } },
          "then": { "properties": { "args": { "$ref": "#/$defs/args.offboard.close" } } } }
      ]
    },

    "args.investor.start-opportunity": {
      "type": "object",
      "required": ["legal_name", "type", "domicile"],
      "properties": {
        "legal_name": { "$ref": "#/$defs/Value" },
        "type": { "type": "string", "enum": ["PROPER_PERSON","CORPORATE","TRUST","FOHF","NOMINEE"] },
        "domicile": { "$ref": "#/$defs/Value" },
        "lei": { "$ref": "#/$defs/Value" },
        "registration_number": { "$ref": "#/$defs/Value" },
        "address": {
          "type": "object",
          "properties": {
            "line1": { "$ref": "#/$defs/Value" },
            "line2": { "$ref": "#/$defs/Value" },
            "line3": { "$ref": "#/$defs/Value" },
            "line4": { "$ref": "#/$defs/Value" },
            "city": { "$ref": "#/$defs/Value" },
            "postal_code": { "$ref": "#/$defs/Value" },
            "country": { "$ref": "#/$defs/Value" }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },

    "args.investor.record-indication": {
      "type": "object",
      "required": ["investor_id", "fund_id", "class_id", "ticket"],
      "properties": {
        "investor_id": { "$ref": "#/$defs/UUID" },
        "fund_id": { "$ref": "#/$defs/UUID" },
        "class_id": { "$ref": "#/$defs/UUID" },
        "ticket": { "$ref": "#/$defs/Amount" },
        "currency": { "$ref": "#/$defs/CurrencyCode" },
        "indication_date": { "$ref": "#/$defs/Date" }
      },
      "additionalProperties": false
    },

    "args.kyc.begin": {
      "type": "object",
      "required": ["investor_id"],
      "properties": {
        "investor_id": { "$ref": "#/$defs/UUID" },
        "risk_rating": { "type": "string", "enum": ["LOW", "MEDIUM", "HIGH"], "default": "MEDIUM" }
      },
      "additionalProperties": false
    },

    "args.kyc.collect-doc": {
      "type": "object",
      "required": ["investor_id", "doc_type"],
      "properties": {
        "investor_id": { "$ref": "#/$defs/UUID" },
        "doc_type": {
          "type": "string",
          "enum": ["passport", "drivers_license", "cert_of_incorporation", "articles_of_association", "W-8BEN", "W-8BEN-E", "W-9", "side_letter", "prospectus", "constitutional_docs"]
        },
        "subject": { "type": "string", "default": "primary" },
        "subject_id": { "$ref": "#/$defs/UUID" },
        "uri": { "type": "string", "format": "uri" },
        "sha256": { "type": "string", "pattern": "^[a-fA-F0-9]{64}$" },
        "issued_on": { "$ref": "#/$defs/Date" },
        "expires_on": { "$ref": "#/$defs/Date" }
      },
      "additionalProperties": false
    },

    "args.kyc.screen": {
      "type": "object",
      "required": ["investor_id", "provider"],
      "properties": {
        "investor_id": { "$ref": "#/$defs/UUID" },
        "provider": {
          "type": "string",
          "enum": ["worldcheck", "dow_jones", "lexisnexis", "refinitiv", "acuris"]
        },
        "reference": { "type": "string" },
        "screening_date": { "$ref": "#/$defs/Date" }
      },
      "additionalProperties": false
    },

    "args.kyc.approve": {
      "type": "object",
      "required": ["investor_id", "risk", "refresh_due"],
      "properties": {
        "investor_id": { "$ref": "#/$defs/UUID" },
        "risk": { "type": "string", "enum": ["LOW","MEDIUM","HIGH"] },
        "refresh_due": { "$ref": "#/$defs/Date" },
        "approved_by": { "type": "string" },
        "approval_notes": { "type": "string" },
        "sow_summary": { "type": "string" },
        "sof_summary": { "type": "string" }
      },
      "additionalProperties": false
    },

    "args.tax.capture": {
      "type": "object",
      "required": ["investor_id", "fatca", "crs", "form"],
      "properties": {
        "investor_id": { "$ref": "#/$defs/UUID" },
        "fatca": {
          "type": "string",
          "enum": ["US_Person", "Active_NFFE", "Passive_NFFE", "Financial_Institution", "Exempt_Beneficial_Owner"]
        },
        "crs": {
          "type": "string",
          "enum": ["FI", "Active_NFE", "Passive_NFE", "Investment_Entity"]
        },
        "form": {
          "type": "string",
          "enum": ["W-8BEN", "W-8BEN-E", "W-9", "CRS_Self_Cert"]
        },
        "tin": { "type": "string" },
        "withholding_rate": { "type": "number", "minimum": 0, "maximum": 100 },
        "form_signed_date": { "$ref": "#/$defs/Date" },
        "form_expires_date": { "$ref": "#/$defs/Date" }
      },
      "additionalProperties": false
    },

    "args.bank.set-instruction": {
      "type": "object",
      "required": ["investor_id", "currency", "swift_bic"],
      "properties": {
        "investor_id": { "$ref": "#/$defs/UUID" },
        "currency": { "$ref": "#/$defs/CurrencyCode" },
        "account_name": { "type": "string" },
        "iban": { "type": "string", "pattern": "^[A-Z]{2}[0-9]{2}[A-Z0-9]{4}[0-9]{7}([A-Z0-9]?){0,16}$" },
        "account_no": { "type": "string" },
        "swift_bic": { "type": "string", "pattern": "^[A-Z]{6}[A-Z0-9]{2}([A-Z0-9]{3})?$" },
        "intermediary_bank": { "type": "string" },
        "intermediary_swift": { "type": "string" },
        "active_from": { "$ref": "#/$defs/Date" },
        "active_to": { "$ref": "#/$defs/Date" }
      },
      "additionalProperties": false
    },

    "args.subscribe.request": {
      "type": "object",
      "required": ["investor_id", "class_id", "amount", "trade_date", "currency"],
      "properties": {
        "investor_id": { "$ref": "#/$defs/UUID" },
        "class_id": { "$ref": "#/$defs/UUID" },
        "series_id": { "$ref": "#/$defs/UUID" },
        "amount": { "$ref": "#/$defs/Amount" },
        "trade_date": { "$ref": "#/$defs/Date" },
        "currency": { "$ref": "#/$defs/CurrencyCode" },
        "bank_id": { "$ref": "#/$defs/UUID" }
      },
      "additionalProperties": false
    },

    "args.cash.confirm": {
      "type": "object",
      "required": ["investor_id", "amount", "value_date"],
      "properties": {
        "investor_id": { "$ref": "#/$defs/UUID" },
        "trade_id": { "$ref": "#/$defs/UUID" },
        "amount": { "$ref": "#/$defs/Amount" },
        "value_date": { "$ref": "#/$defs/Date" },
        "bank_id": { "$ref": "#/$defs/UUID" },
        "reference": { "type": "string" },
        "confirmed_by": { "type": "string" }
      },
      "additionalProperties": false
    },

    "args.deal.nav": {
      "type": "object",
      "required": ["fund_id", "nav_date"],
      "properties": {
        "fund_id": { "$ref": "#/$defs/UUID" },
        "class_id": { "$ref": "#/$defs/UUID" },
        "nav_date": { "$ref": "#/$defs/Date" },
        "nav_per_share": { "type": "number", "minimum": 0 },
        "total_nav": { "type": "number" },
        "shares_outstanding": { "type": "number" }
      },
      "additionalProperties": false
    },

    "args.subscribe.issue": {
      "type": "object",
      "required": ["investor_id", "class_id", "nav_per_share", "units"],
      "properties": {
        "investor_id": { "$ref": "#/$defs/UUID" },
        "trade_id": { "$ref": "#/$defs/UUID" },
        "class_id": { "$ref": "#/$defs/UUID" },
        "series_id": { "$ref": "#/$defs/UUID" },
        "nav_per_share": { "type": "number", "minimum": 0 },
        "units": { "$ref": "#/$defs/Units" },
        "nav_date": { "$ref": "#/$defs/Date" },
        "settlement_date": { "$ref": "#/$defs/Date" },
        "fees_amount": { "type": "number", "minimum": 0, "default": 0 }
      },
      "additionalProperties": false
    },

    "args.kyc.refresh-schedule": {
      "type": "object",
      "required": ["investor_id", "frequency", "next"],
      "properties": {
        "investor_id": { "$ref": "#/$defs/UUID" },
        "frequency": {
          "type": "string",
          "enum": ["ANNUAL", "BIANNUAL", "QUARTERLY", "MONTHLY"]
        },
        "next": { "$ref": "#/$defs/Date" }
      },
      "additionalProperties": false
    },

    "args.screen.continuous": {
      "type": "object",
      "required": ["investor_id", "frequency"],
      "properties": {
        "investor_id": { "$ref": "#/$defs/UUID" },
        "frequency": {
          "type": "string",
          "enum": ["DAILY", "WEEKLY", "MONTHLY"]
        },
        "provider": { "type": "string" },
        "auto_escalate": { "type": "boolean", "default": true }
      },
      "additionalProperties": false
    },

    "args.redeem.request": {
      "type": "object",
      "required": ["investor_id", "class_id", "units", "notice_date"],
      "properties": {
        "investor_id": { "$ref": "#/$defs/UUID" },
        "class_id": { "$ref": "#/$defs/UUID" },
        "series_id": { "$ref": "#/$defs/UUID" },
        "units": { "$ref": "#/$defs/Units" },
        "percentage": { "type": "number", "minimum": 0, "maximum": 100 },
        "notice_date": { "$ref": "#/$defs/Date" },
        "trade_date": { "$ref": "#/$defs/Date" },
        "bank_id": { "$ref": "#/$defs/UUID" }
      },
      "additionalProperties": false
    },

    "args.redeem.settle": {
      "type": "object",
      "required": ["investor_id", "amount", "settle_date"],
      "properties": {
        "investor_id": { "$ref": "#/$defs/UUID" },
        "trade_id": { "$ref": "#/$defs/UUID" },
        "amount": { "$ref": "#/$defs/Amount" },
        "settle_date": { "$ref": "#/$defs/Date" },
        "bank_id": { "$ref": "#/$defs/UUID" },
        "reference": { "type": "string" },
        "fx_rate": { "type": "number", "minimum": 0 },
        "fees_amount": { "type": "number", "minimum": 0, "default": 0 }
      },
      "additionalProperties": false
    },

    "args.offboard.close": {
      "type": "object",
      "required": ["investor_id"],
      "properties": {
        "investor_id": { "$ref": "#/$defs/UUID" },
        "closure_date": { "$ref": "#/$defs/Date" },
        "reason": {
          "type": "string",
          "enum": ["VOLUNTARY", "INVOLUNTARY", "REGULATORY", "DECEASED", "MERGED"]
        },
        "final_confirmation": { "type": "boolean", "default": true },
        "retention_period_years": { "type": "integer", "minimum": 0, "default": 7 }
      },
      "additionalProperties": false
    }
  }
}