-- Migration 040: DSL Diff Tracking for Learning Loop
--
-- Captures the diff between agent-generated DSL and what the user actually executed.
-- This is valuable correction signal for improving the agent.

-- Add DSL tracking columns to intent_feedback
ALTER TABLE "ob-poc".intent_feedback
ADD COLUMN IF NOT EXISTS generated_dsl TEXT,
ADD COLUMN IF NOT EXISTS final_dsl TEXT,
ADD COLUMN IF NOT EXISTS user_edits JSONB;

COMMENT ON COLUMN "ob-poc".intent_feedback.generated_dsl IS 'DSL as generated by agent (before user edits)';
COMMENT ON COLUMN "ob-poc".intent_feedback.final_dsl IS 'DSL as actually executed (after user edits)';
COMMENT ON COLUMN "ob-poc".intent_feedback.user_edits IS 'Array of {field, from, to} edit records capturing what user changed';

-- Add direct_dsl to match_method enum if not exists
DO $$
BEGIN
    -- Check if direct_dsl already exists in the enum
    IF NOT EXISTS (
        SELECT 1 FROM pg_enum
        WHERE enumlabel = 'direct_dsl'
        AND enumtypid = (SELECT oid FROM pg_type WHERE typname = 'match_method' AND typnamespace = (SELECT oid FROM pg_namespace WHERE nspname = 'ob-poc'))
    ) THEN
        ALTER TYPE "ob-poc".match_method ADD VALUE IF NOT EXISTS 'direct_dsl';
    END IF;
END$$;

-- Update the learning feedback view to include DSL diff info
CREATE OR REPLACE VIEW "ob-poc".v_learning_feedback AS
SELECT
    f.id,
    f.interaction_id,
    f.session_id,
    f.input_phrase,
    f.input_source,
    f.matched_verb,
    f.match_method,
    f.similarity_score,
    f.domain_context,
    f.outcome,
    f.generated_dsl,
    f.final_dsl,
    f.user_edits,
    f.created_at,
    g.execution_status,
    g.execution_error,
    g.executed_at,
    -- Learning signal derivation
    CASE
        WHEN f.outcome = 'executed' AND f.user_edits IS NULL THEN 'success'
        WHEN f.outcome = 'executed' AND f.user_edits IS NOT NULL THEN 'correction'
        WHEN f.outcome = 'wrong_match' THEN 'wrong_match'
        WHEN f.outcome = 'rejected' THEN 'rejection'
        WHEN f.matched_verb IS NULL THEN 'no_match'
        WHEN g.execution_status = 'failed' THEN 'false_positive'
        ELSE 'pending'
    END AS learning_signal,
    -- Was DSL edited?
    CASE
        WHEN f.generated_dsl IS NOT NULL AND f.final_dsl IS NOT NULL
             AND f.generated_dsl != f.final_dsl THEN true
        ELSE false
    END AS was_edited,
    -- Time from phrase to execution
    CASE
        WHEN g.executed_at IS NOT NULL THEN
            EXTRACT(EPOCH FROM (g.executed_at - f.created_at)) * 1000
        ELSE NULL
    END AS phrase_to_execution_ms
FROM "ob-poc".intent_feedback f
LEFT JOIN "ob-poc".dsl_generation_log g ON g.intent_feedback_id = f.id;

-- Index for finding corrections (edited DSL)
CREATE INDEX IF NOT EXISTS idx_intent_feedback_has_edits
ON "ob-poc".intent_feedback ((user_edits IS NOT NULL))
WHERE user_edits IS NOT NULL;

-- View for analyzing user corrections
CREATE OR REPLACE VIEW "ob-poc".v_user_corrections AS
SELECT
    f.matched_verb,
    f.input_phrase,
    f.generated_dsl,
    f.final_dsl,
    f.user_edits,
    jsonb_array_length(f.user_edits) AS edit_count,
    f.outcome,
    f.created_at
FROM "ob-poc".intent_feedback f
WHERE f.user_edits IS NOT NULL
  AND jsonb_array_length(f.user_edits) > 0
ORDER BY f.created_at DESC;

COMMENT ON VIEW "ob-poc".v_user_corrections IS 'Shows cases where users edited agent-generated DSL - valuable for learning';
