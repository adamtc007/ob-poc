# TODO: CBU/KYC/UBO Architecture Fixes

**Generated by**: Opus 4.5 Architecture Review  
**Date**: 2025-12-14  
**Priority**: Fix all before proceeding to DAG execution layer

---

## Phase 1: Critical Bug Fixes (Do First)

### 1.1 Fix `ubo.verify-ubo` Wrong Table Reference

**File**: `rust/config/verbs/ubo.yaml`

**Problem**: Lookup references non-existent table `ubo_determinations`

**Current** (BROKEN):
```yaml
- name: ubo-id
  type: uuid
  required: true
  maps_to: ubo_id
  lookup:
    table: ubo_determinations  # WRONG - table doesn't exist
    schema: ob-poc
    search_key: ubo_id
    primary_key: ubo_id
```

**Fix** (change to):
```yaml
- name: ubo-id
  type: uuid
  required: true
  maps_to: ubo_id
  lookup:
    table: ubo_registry
    entity_type: ubo
    schema: ob-poc
    search_key: ubo_id
    primary_key: ubo_id
```

---

### 1.2 Fix `isda.create` Missing Counterparty Lookup

**File**: `rust/config/verbs/custody/isda.yaml`

**Problem**: `counterparty` arg has no lookup - users can't resolve entity name → UUID

**Current** (incomplete):
```yaml
- name: counterparty
  type: uuid
  required: true
  maps_to: counterparty_entity_id
  # NO LOOKUP - user must know UUID
```

**Fix** (add lookup):
```yaml
- name: counterparty
  type: uuid
  required: true
  maps_to: counterparty_entity_id
  lookup:
    table: entities
    entity_type: entity
    schema: ob-poc
    search_key: name
    primary_key: entity_id
```

---

### 1.3 Fix KYC Case Status Enum Mismatch

**File**: `rust/config/verbs/kyc/kyc-case.yaml`

**Problem**: Schema has statuses not allowed by verb

**Schema allows**: `INTAKE, DISCOVERY, ASSESSMENT, REVIEW, APPROVED, REJECTED, BLOCKED, WITHDRAWN, EXPIRED, REFER_TO_REGULATOR, DO_NOT_ONBOARD`

**Verb allows**: Missing `REFER_TO_REGULATOR`, `DO_NOT_ONBOARD`

**Fix** - Update `update-status` verb:
```yaml
- name: status
  type: string
  required: true
  maps_to: status
  valid_values:
    - INTAKE
    - DISCOVERY
    - ASSESSMENT
    - REVIEW
    - APPROVED
    - REJECTED
    - BLOCKED
    - WITHDRAWN
    - EXPIRED
    - REFER_TO_REGULATOR    # ADD
    - DO_NOT_ONBOARD        # ADD
```

**Also update** `close` verb valid_values:
```yaml
- name: status
  type: string
  required: true
  maps_to: status
  valid_values:
    - APPROVED
    - REJECTED
    - WITHDRAWN
    - EXPIRED
    - REFER_TO_REGULATOR    # ADD - regulatory referral is a close state
    - DO_NOT_ONBOARD        # ADD - definitive rejection
```

---

### 1.4 Fix UBO Verification Status Enum Mismatch

**File**: `rust/config/verbs/ubo.yaml`

**Problem**: Schema has more statuses than verb allows

**Schema allows**: `SUSPECTED, PENDING, PROVEN, VERIFIED, FAILED, DISPUTED, REMOVED`

**Verb allows**: `PENDING, VERIFIED, FAILED, DISPUTED`

**Fix** - Update `verify-ubo` verb:
```yaml
- name: verification-status
  type: string
  required: true
  maps_to: verification_status
  valid_values:
    - SUSPECTED      # ADD - initial state from calculation
    - PENDING
    - PROVEN         # ADD - evidence-backed but not final verified
    - VERIFIED
    - FAILED
    - DISPUTED
    - REMOVED        # ADD - UBO no longer qualifies
```

---

## Phase 2: Schema Cleanup

### 2.1 Remove Duplicate CBU Category CHECK Constraint

**File**: Database migration required

**Problem**: `cbus` table has TWO CHECK constraints on `cbu_category` with different values:
- `cbus_category_check` includes `FAMILY_TRUST`
- `chk_cbu_category` includes `INTERNAL_TEST`

**Fix**: Create migration to consolidate:

```sql
-- Migration: consolidate_cbu_category_constraint.sql

-- Drop both existing constraints
ALTER TABLE "ob-poc".cbus DROP CONSTRAINT IF EXISTS cbus_category_check;
ALTER TABLE "ob-poc".cbus DROP CONSTRAINT IF EXISTS chk_cbu_category;

-- Add single consolidated constraint with all valid values
ALTER TABLE "ob-poc".cbus ADD CONSTRAINT chk_cbu_category CHECK (
  cbu_category IS NULL OR cbu_category IN (
    'FUND_MANDATE',
    'CORPORATE_GROUP', 
    'INSTITUTIONAL_ACCOUNT',
    'RETAIL_CLIENT',
    'FAMILY_TRUST',
    'INTERNAL_TEST',
    'CORRESPONDENT_BANK'
  )
);
```

**Also update** `cbu.yaml` `set-category` verb to include all values:
```yaml
- name: category
  type: string
  required: true
  maps_to: cbu_category
  validation:
    enum:
      - FUND_MANDATE
      - CORPORATE_GROUP
      - INSTITUTIONAL_ACCOUNT
      - RETAIL_CLIENT
      - FAMILY_TRUST          # ADD
      - INTERNAL_TEST
      - CORRESPONDENT_BANK
```

---

## Phase 3: Missing Verbs (Completeness)

### 3.1 Add `cbu.attach-evidence` Verb

**File**: `rust/config/verbs/cbu.yaml`

**Problem**: `cbu_evidence` table exists but no verb to attach evidence

**Add this verb**:
```yaml
attach-evidence:
  description: Attach evidence (document or attestation) to CBU
  behavior: crud
  crud:
    operation: insert
    table: cbu_evidence
    schema: ob-poc
    returning: evidence_id
  args:
    - name: cbu-id
      type: uuid
      required: true
      maps_to: cbu_id
      lookup:
        table: cbus
        entity_type: cbu
        schema: ob-poc
        search_key: name
        primary_key: cbu_id
    - name: document-id
      type: uuid
      required: false
      maps_to: document_id
      lookup:
        table: document_catalog
        entity_type: document
        schema: ob-poc
        search_key: document_name
        primary_key: doc_id
    - name: attestation-ref
      type: string
      required: false
      maps_to: attestation_ref
    - name: evidence-type
      type: string
      required: true
      maps_to: evidence_type
      valid_values:
        - DOCUMENT
        - ATTESTATION
        - SCREENING
        - REGISTRY_CHECK
        - MANUAL_VERIFICATION
    - name: evidence-category
      type: string
      required: false
      maps_to: evidence_category
    - name: description
      type: string
      required: false
      maps_to: description
    - name: attached-by
      type: string
      required: false
      maps_to: attached_by
  returns:
    type: uuid
    name: evidence_id
    capture: true

verify-evidence:
  description: Mark evidence as verified or rejected
  behavior: crud
  crud:
    operation: update
    table: cbu_evidence
    schema: ob-poc
    key: evidence_id
    set_values:
      verified_at: now()
  args:
    - name: evidence-id
      type: uuid
      required: true
      maps_to: evidence_id
    - name: verification-status
      type: string
      required: true
      maps_to: verification_status
      valid_values:
        - PENDING
        - VERIFIED
        - REJECTED
        - EXPIRED
    - name: verified-by
      type: string
      required: true
      maps_to: verified_by
    - name: verification-notes
      type: string
      required: false
      maps_to: verification_notes
  returns:
    type: affected

list-evidence:
  description: List evidence for a CBU
  behavior: crud
  crud:
    operation: list_by_fk
    table: cbu_evidence
    schema: ob-poc
    fk_col: cbu_id
  args:
    - name: cbu-id
      type: uuid
      required: true
      lookup:
        table: cbus
        entity_type: cbu
        schema: ob-poc
        search_key: name
        primary_key: cbu_id
    - name: evidence-type
      type: string
      required: false
      maps_to: evidence_type
    - name: verification-status
      type: string
      required: false
      maps_to: verification_status
  returns:
    type: record_set
```

---

### 3.2 Add `ubo.supersede` Verb

**File**: `rust/config/verbs/ubo.yaml`

**Problem**: Schema has `superseded_by`, `superseded_at` columns but no verb

**Add this verb**:
```yaml
supersede:
  description: Supersede a UBO determination when ownership changes
  behavior: crud
  crud:
    operation: update
    table: ubo_registry
    schema: ob-poc
    key: ubo_id
    set_values:
      superseded_at: now()
  args:
    - name: ubo-id
      type: uuid
      required: true
      maps_to: ubo_id
      lookup:
        table: ubo_registry
        entity_type: ubo
        schema: ob-poc
        search_key: ubo_id
        primary_key: ubo_id
    - name: superseded-by
      type: uuid
      required: true
      maps_to: superseded_by
      description: ID of the new UBO determination that replaces this one
      lookup:
        table: ubo_registry
        entity_type: ubo
        schema: ob-poc
        search_key: ubo_id
        primary_key: ubo_id
    - name: reason
      type: string
      required: true
      maps_to: closed_reason
  returns:
    type: affected

remove:
  description: Remove a UBO (no longer qualifies)
  behavior: crud
  crud:
    operation: update
    table: ubo_registry
    schema: ob-poc
    key: ubo_id
    set_values:
      verification_status: REMOVED
      closed_at: now()
  args:
    - name: ubo-id
      type: uuid
      required: true
      maps_to: ubo_id
      lookup:
        table: ubo_registry
        entity_type: ubo
        schema: ob-poc
        search_key: ubo_id
        primary_key: ubo_id
    - name: removal-reason
      type: string
      required: true
      maps_to: removal_reason
    - name: replacement-ubo-id
      type: uuid
      required: false
      maps_to: replacement_ubo_id
      description: If this UBO is being replaced by another
      lookup:
        table: ubo_registry
        entity_type: ubo
        schema: ob-poc
        search_key: ubo_id
        primary_key: ubo_id
  returns:
    type: affected
```

---

### 3.3 Add `kyc-case.reopen` Verb

**File**: `rust/config/verbs/kyc/kyc-case.yaml`

**Problem**: No way to reopen closed case for remediation

**Add this verb**:
```yaml
reopen:
  description: Reopen a closed case for remediation or review
  behavior: crud
  crud:
    operation: update
    table: cases
    schema: kyc
    key: case_id
    set_values:
      closed_at: null
  emits_event: case.reopened
  args:
    - name: case-id
      type: uuid
      required: true
      maps_to: case_id
      lookup:
        table: cases
        entity_type: kyc_case
        schema: kyc
        search_key: case_id
        primary_key: case_id
    - name: reopen-reason
      type: string
      required: true
      maps_to: notes
    - name: new-case-type
      type: string
      required: false
      maps_to: case_type
      default: REMEDIATION
      valid_values:
        - REMEDIATION
        - EVENT_DRIVEN
        - PERIODIC_REVIEW
    - name: new-status
      type: string
      required: false
      maps_to: status
      default: INTAKE
      valid_values:
        - INTAKE
        - DISCOVERY
  returns:
    type: affected
```

---

## Phase 4: Consistency Improvements

### 4.1 Standardize `entity_type` Naming in Lookups

**Convention to adopt**:
- Core types: singular (`entity`, `cbu`, `role`, `document`)
- Domain-specific: `domain_type` format (`kyc_case`, `ubo_registry`, `trading_profile`)

**Files to audit and fix**:

| File | Current | Should Be |
|------|---------|-----------|
| `kyc/kyc-case.yaml` | `kyc_case` | ✅ Correct |
| `observation/allegation.yaml` | `workstream` | `entity_workstream` |
| `ubo.yaml` | varies | Standardize to `ubo` |

**Fix** in `allegation.yaml`:
```yaml
# Change from:
lookup:
  table: entity_workstreams
  entity_type: workstream
  
# To:
lookup:
  table: entity_workstreams
  entity_type: entity_workstream
```

---

## Verification Checklist

After implementing all fixes, verify:

- [ ] `ubo.verify-ubo` lookup resolves correctly
- [ ] `isda.create` allows entity name for counterparty
- [ ] `kyc-case.update-status` accepts `REFER_TO_REGULATOR` and `DO_NOT_ONBOARD`
- [ ] `ubo.verify-ubo` accepts all schema verification statuses
- [ ] Database has single `chk_cbu_category` constraint
- [ ] `cbu.set-category` accepts all category values
- [ ] `cbu.attach-evidence` verb exists and works
- [ ] `ubo.supersede` and `ubo.remove` verbs exist
- [ ] `kyc-case.reopen` verb exists

---

## Testing Commands

```bash
# Validate all verb YAML files parse correctly
cargo xtask validate-verbs

# Check for enum mismatches between schema and verbs
cargo xtask schema-verb-audit

# Run the DSL linter on test fixtures
cargo test -p ob-poc --test dsl_integration
```

---

## Next: DAG Execution Layer

Once all fixes verified, proceed to DAG execution implementation (separate TODO).
