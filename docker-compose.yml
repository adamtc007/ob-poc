services:
  # Uncomment 'db' service if you want a separate Docker Postgres instance
  # db:
  #   image: pgvector/pgvector:pg17
  #   container_name: ob-poc-db
  #   environment:
  #     POSTGRES_DB: data_designer
  #     POSTGRES_USER: postgres
  #     POSTGRES_PASSWORD: postgres
  #   ports:
  #     - "5433:5432"
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data
  #     - ./init_docker.sql:/docker-entrypoint-initdb.d/01_init.sql:ro
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U postgres -d data_designer"]
  #     interval: 5s
  #     timeout: 5s
  #     retries: 5

  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: ob-poc-api
    environment:
      # Connect to host's local Postgres (same data as native Rust testing)
      # host.docker.internal resolves to the host machine from inside Docker
      DATABASE_URL: postgresql://localhost@host.docker.internal:5432/data_designer
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      RUST_LOG: info
    ports:
      - "3001:3000"
      - "50052:50051"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped

  bpmn-lite:
    build:
      context: ./bpmn-lite
      dockerfile: Dockerfile
    container_name: bpmn-lite
    ports:
      - "50053:50051" # gRPC (50051 inside container, 50053 on host)
    environment:
      RUST_LOG: info
      DATABASE_URL: postgresql://localhost@host.docker.internal:5432/data_designer
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped

# volumes:
#   postgres_data:
