# Entity Index Configuration
# Drives index construction and search key resolution
# IMPORTANT: Uses existing ob-poc database tables - no new tables created
#
# index_mode options:
#   trigram - ngram(3,3) for fuzzy substring search (names, descriptions)
#   exact   - standard word tokenization for prefix/exact match (codes, enums)

refresh:
  interval_secs: 300 # 5 minutes
  startup_mode: async # async | sync

database:
  connection_string_env: "DATABASE_URL"

entities:
  # Natural persons - maps to existing entity_proper_persons table
  # Uses composite search with nationality and DOB discriminators for disambiguation
  person:
    nickname: "PERSON"
    source_table: '"ob-poc".entity_proper_persons'
    return_key: "entity_id" # Return UUID for binding
    display_template: "{first_name} {last_name}"
    # Enhanced display with discriminators when available
    display_template_full: "{first_name} {last_name} ({nationality}, b.{birth_year})"
    index_mode: trigram # Names need fuzzy substring search
    # Composite search schema: name + nationality + DOB
    # Nationality is usually captured first, then DOB (year approx or exact)
    composite_search: "(search_name (nationality :selectivity 0.7) (date_of_birth :selectivity 0.95 :match-mode year-or-exact))"
    search_keys:
      - name: "name"
        column: "search_name"
        default: true
      - name: "first_name"
        column: "first_name"
      - name: "last_name"
        column: "last_name"
      - name: "id_document"
        column: "id_document_number"
    # Discriminator columns for filtering/scoring
    discriminators:
      - name: "nationality"
        column: "nationality"
        selectivity: 0.7
      - name: "date_of_birth"
        column: "date_of_birth"
        selectivity: 0.95
        match_mode: "year_or_exact" # Match if year matches OR exact date matches
      - name: "person_state"
        column: "person_state"
        selectivity: 0.3 # Filter only, not disambiguation
    shard:
      enabled: true
      prefix_len: 1

  # Funds - maps to existing cbus table filtered by client_type
  fund:
    nickname: "FUND"
    source_table: '"ob-poc".cbus'
    return_key: "name" # Return name for DSL source (resolved to UUID at execution)
    display_template: "{name}"
    index_mode: trigram # Fund names need fuzzy search
    filter: "client_type IN ('FUND', 'fund')"
    search_keys:
      - name: "name"
        column: "name"
        default: true
      - name: "jurisdiction"
        column: "jurisdiction"
    shard:
      enabled: true
      prefix_len: 2

  # CBUs (all types) - maps to existing cbus table
  cbu:
    nickname: "CBU"
    source_table: '"ob-poc".cbus'
    return_key: "cbu_id" # Return UUID for UI binding (name available in label)
    display_template: "{name}"
    index_mode: trigram # CBU names need fuzzy search
    search_keys:
      - name: "id"
        column: "cbu_id"
      - name: "name"
        column: "name"
        default: true
      - name: "jurisdiction"
        column: "jurisdiction"
      - name: "client_type"
        column: "client_type"
    shard:
      enabled: true
      prefix_len: 2

  # Products - maps to existing products table
  product:
    nickname: "PRODUCT"
    source_table: '"ob-poc".products'
    return_key: "product_code" # Return the code for DSL insertion
    display_template: "{name} ({product_code})"
    index_mode: exact # Codes should use exact match
    filter: "is_active = true"
    search_keys:
      - name: "name"
        column: "name"
      - name: "product_code"
        column: "product_code"
        default: true # DSL uses product codes like FUND_ACCOUNTING
    shard:
      enabled: false # Small table, no sharding

  # Legal entities (companies) - maps to existing entity_limited_companies table
  legal_entity:
    nickname: "LEGAL_ENTITY"
    source_table: '"ob-poc".entity_limited_companies'
    return_key: "company_name" # Return name for DSL source (resolved to UUID at execution)
    display_template: "{company_name}"
    index_mode: trigram # Company names need fuzzy search
    search_keys:
      - name: "name"
        column: "company_name"
        default: true
      - name: "registration_number"
        column: "registration_number"
      - name: "jurisdiction"
        column: "jurisdiction"
    shard:
      enabled: true
      prefix_len: 1

  # Generic entities - uses entity_search_view which combines all entity types
  entity:
    nickname: "ENTITY"
    source_table: '"ob-poc".entity_search_view'
    return_key: "id" # Return UUID for UI binding
    display_template: "{display_name} ({entity_type})"
    index_mode: trigram # Entity names need fuzzy search
    search_keys:
      - name: "name"
        column: "search_text"
        default: true
      - name: "type"
        column: "entity_type"
    shard:
      enabled: true
      prefix_len: 1

  # Services - maps to existing services table
  service:
    nickname: "SERVICE"
    source_table: '"ob-poc".services'
    return_key: "service_code" # Return code for DSL
    display_template: "{name}"
    index_mode: exact # Service codes use exact match
    filter: "is_active = true"
    search_keys:
      - name: "name"
        column: "name"
        default: true
      - name: "service_code"
        column: "service_code"
    shard:
      enabled: false

  # ============================================
  # REFERENCE DATA TABLES (small lookup tables)
  # ============================================

  # Roles - entity roles within a CBU
  role:
    nickname: "ROLE"
    source_table: '"ob-poc".roles'
    return_key: "name"
    display_template: "{name}"
    index_mode: exact # Short code list, prefix match is fine
    search_keys:
      - name: "name"
        column: "name"
        default: true
    shard:
      enabled: false

  # Jurisdictions
  jurisdiction:
    nickname: "JURISDICTION"
    source_table: '"ob-poc".master_jurisdictions'
    return_key: "jurisdiction_code"
    display_template: "{jurisdiction_name}"
    index_mode: exact
    search_keys:
      - name: "code"
        column: "jurisdiction_code"
        default: true
      - name: "name"
        column: "jurisdiction_name"
    shard:
      enabled: false

  # Currencies
  currency:
    nickname: "CURRENCY"
    source_table: '"ob-poc".currencies'
    return_key: "iso_code"
    display_template: "{name}"
    index_mode: exact
    filter: "is_active = true"
    search_keys:
      - name: "code"
        column: "iso_code"
        default: true
      - name: "name"
        column: "name"
    shard:
      enabled: false

  # Client Types
  client_type:
    nickname: "CLIENT_TYPE"
    source_table: '"ob-poc".client_types'
    return_key: "code"
    display_template: "{name}"
    index_mode: exact
    filter: "is_active = true"
    search_keys:
      - name: "code"
        column: "code"
        default: true
      - name: "name"
        column: "name"
    shard:
      enabled: false

  # Case Types (KYC)
  case_type:
    nickname: "CASE_TYPE"
    source_table: '"ob-poc".case_types'
    return_key: "code"
    display_template: "{name}"
    index_mode: exact
    filter: "is_active = true"
    search_keys:
      - name: "code"
        column: "code"
        default: true
      - name: "name"
        column: "name"
    shard:
      enabled: false

  # Screening Types
  screening_type:
    nickname: "SCREENING_TYPE"
    source_table: '"ob-poc".screening_types'
    return_key: "code"
    display_template: "{name}"
    index_mode: exact
    filter: "is_active = true"
    search_keys:
      - name: "code"
        column: "code"
        default: true
      - name: "name"
        column: "name"
    shard:
      enabled: false

  # Risk Ratings
  risk_rating:
    nickname: "RISK_RATING"
    source_table: '"ob-poc".risk_ratings'
    return_key: "code"
    display_template: "{name}"
    index_mode: exact
    filter: "is_active = true"
    search_keys:
      - name: "code"
        column: "code"
        default: true
      - name: "name"
        column: "name"
    shard:
      enabled: false

  # Settlement Types
  settlement_type:
    nickname: "SETTLEMENT_TYPE"
    source_table: '"ob-poc".settlement_types'
    return_key: "code"
    display_template: "{name}"
    index_mode: exact
    filter: "is_active = true"
    search_keys:
      - name: "code"
        column: "code"
        default: true
      - name: "name"
        column: "name"
    shard:
      enabled: false

  # SSI Types
  ssi_type:
    nickname: "SSI_TYPE"
    source_table: '"ob-poc".ssi_types'
    return_key: "code"
    display_template: "{name}"
    index_mode: exact
    filter: "is_active = true"
    search_keys:
      - name: "code"
        column: "code"
        default: true
      - name: "name"
        column: "name"
    shard:
      enabled: false

  # Instrument Classes (custody schema)
  instrument_class:
    nickname: "INSTRUMENT_CLASS"
    source_table: "custody.instrument_classes"
    return_key: "class_id"
    display_template: "{name}"
    index_mode: exact
    search_keys:
      - name: "code"
        column: "code"
        default: true
      - name: "name"
        column: "name"
    shard:
      enabled: false

  # Markets (custody schema)
  market:
    nickname: "MARKET"
    source_table: "custody.markets"
    return_key: "market_id"
    display_template: "{name}"
    index_mode: exact
    search_keys:
      - name: "mic"
        column: "mic"
        default: true
      - name: "name"
        column: "name"
    shard:
      enabled: false

  # ============================================
  # VALIDATION TABLES (for parser/linter)
  # ============================================

  # Document Types - for :document-type and :doc-type args
  document_type:
    nickname: "DOCUMENT_TYPE"
    source_table: '"ob-poc".document_types'
    return_key: "type_code"
    display_template: "{display_name}"
    index_mode: exact
    search_keys:
      - name: "code"
        column: "type_code"
        default: true
      - name: "name"
        column: "display_name"
    shard:
      enabled: false

  # Entity Types - for :entity-type and :type args
  entity_type:
    nickname: "ENTITY_TYPE"
    source_table: '"ob-poc".entity_types'
    return_key: "name"
    display_template: "{name}"
    index_mode: exact
    search_keys:
      - name: "name"
        column: "name"
        default: true
      - name: "type_code"
        column: "type_code"
    shard:
      enabled: false

  # Attribute Registry - for :attribute-id and :attribute args
  attribute:
    nickname: "ATTRIBUTE"
    source_table: '"ob-poc".attribute_registry'
    return_key: "id"
    display_template: "{display_name}"
    index_mode: exact
    search_keys:
      - name: "id"
        column: "id"
        default: true
      - name: "name"
        column: "display_name"
    shard:
      enabled: false

  # Document Catalog - for :document-id and :doc-id args (UUID lookup)
  document:
    nickname: "DOCUMENT"
    source_table: '"ob-poc".document_catalog'
    return_key: "doc_id"
    display_template: "{document_name}"
    index_mode: trigram
    search_keys:
      - name: "name"
        column: "document_name"
        default: true
      - name: "id"
        column: "doc_id"
    shard:
      enabled: false

  # ============================================
  # SERVICE/RESOURCE TABLES (name-based lookups)
  # ============================================

  # Service Resource Types - for provisioning by name/code
  resource_type:
    nickname: "RESOURCE_TYPE"
    source_table: '"ob-poc".service_resource_types'
    return_key: "resource_id"
    display_template: "{name}"
    index_mode: exact
    search_keys:
      - name: "name"
        column: "name"
        default: true
      - name: "code"
        column: "resource_code"
    shard:
      enabled: false

  # ============================================
  # CUSTODY TABLES (name-based lookups)
  # ============================================

  # Standing Settlement Instructions - for :ssi-id name-based lookup
  ssi:
    nickname: "SSI"
    source_table: "custody.cbu_ssi"
    return_key: "ssi_id"
    display_template: "{ssi_name} ({ssi_type})"
    index_mode: trigram # SSI names need fuzzy search
    filter: "status = 'ACTIVE'"
    search_keys:
      - name: "name"
        column: "ssi_name"
        default: true
      - name: "type"
        column: "ssi_type"
    shard:
      enabled: false

  # Booking Rules - for :rule-id name-based lookup
  booking_rule:
    nickname: "BOOKING_RULE"
    source_table: "custody.ssi_booking_rules"
    return_key: "rule_id"
    display_template: "{rule_name}"
    index_mode: trigram # Rule names need fuzzy search
    filter: "is_active = true"
    search_keys:
      - name: "name"
        column: "rule_name"
        default: true
    shard:
      enabled: false

  # ============================================
  # INVESTOR REGISTRY TABLES (name-based lookups)
  # ============================================

  # Share Classes - for :share-class-id name-based lookup
  share_class:
    nickname: "SHARE_CLASS"
    source_table: "kyc.share_classes"
    return_key: "id"
    display_template: "{name} ({isin})"
    index_mode: trigram # Share class names need fuzzy search
    filter: "status = 'active'"
    search_keys:
      - name: "name"
        column: "name"
        default: true
      - name: "isin"
        column: "isin"
    shard:
      enabled: false
