version: "1.0"

# =============================================================================
# DOMAIN: cbu (Client Business Unit)
# =============================================================================
domains:
  cbu:
    description: "Client Business Unit operations"

    verbs:
      create:
        description: "Create a new Client Business Unit"
        behavior: crud
        crud:
          operation: insert
          table: cbus
          schema: ob-poc
          returning: cbu_id
        args:
          - name: name
            type: string
            required: true
            maps_to: name
          - name: jurisdiction
            type: string
            required: false
            maps_to: jurisdiction
          - name: client-type
            type: string
            required: false
            maps_to: client_type
          - name: nature-purpose
            type: string
            required: false
            maps_to: nature_purpose
          - name: description
            type: string
            required: false
            maps_to: description
          - name: commercial-client-entity-id
            type: uuid
            required: false
            maps_to: commercial_client_entity_id
          - name: product-id
            type: uuid
            required: false
            maps_to: product_id
        returns:
          type: uuid
          name: cbu_id
          capture: true

      read:
        description: "Read a CBU by ID"
        behavior: crud
        crud:
          operation: select
          table: cbus
          schema: ob-poc
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
        returns:
          type: record

      update:
        description: "Update a CBU"
        behavior: crud
        crud:
          operation: update
          table: cbus
          schema: ob-poc
          key: cbu_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
          - name: name
            type: string
            required: false
            maps_to: name
          - name: status
            type: string
            required: false
            maps_to: status
          - name: client-type
            type: string
            required: false
            maps_to: client_type
          - name: jurisdiction
            type: string
            required: false
            maps_to: jurisdiction
          - name: commercial-client-entity-id
            type: uuid
            required: false
            maps_to: commercial_client_entity_id
          - name: product-id
            type: uuid
            required: false
            maps_to: product_id
        returns:
          type: affected

      delete:
        description: "Delete a CBU"
        behavior: crud
        crud:
          operation: delete
          table: cbus
          schema: ob-poc
          key: cbu_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
        returns:
          type: affected

      list:
        description: "List CBUs with optional filters"
        behavior: crud
        crud:
          operation: select
          table: cbus
          schema: ob-poc
        args:
          - name: status
            type: string
            required: false
            maps_to: status
          - name: client-type
            type: string
            required: false
            maps_to: client_type
          - name: jurisdiction
            type: string
            required: false
            maps_to: jurisdiction
          - name: limit
            type: integer
            required: false
            default: 100
          - name: offset
            type: integer
            required: false
            default: 0
        returns:
          type: record_set

      ensure:
        description: "Create or update a CBU by natural key"
        behavior: crud
        crud:
          operation: upsert
          table: cbus
          schema: ob-poc
          conflict_keys: [name, jurisdiction]
          returning: cbu_id
        args:
          - name: name
            type: string
            required: true
            maps_to: name
          - name: jurisdiction
            type: string
            required: false
            maps_to: jurisdiction
          - name: client-type
            type: string
            required: false
            maps_to: client_type
          - name: nature-purpose
            type: string
            required: false
            maps_to: nature_purpose
          - name: commercial-client-entity-id
            type: uuid
            required: false
            maps_to: commercial_client_entity_id
          - name: product-id
            type: uuid
            required: false
            maps_to: product_id
        returns:
          type: uuid
          name: cbu_id
          capture: true

      assign-role:
        description: "Assign a role to an entity within a CBU"
        behavior: crud
        crud:
          operation: role_link
          junction: cbu_entity_roles
          schema: ob-poc
          from_col: cbu_id
          to_col: entity_id
          role_table: roles
          role_col: role_id
          returning: cbu_entity_role_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
          - name: entity-id
            type: uuid
            required: true
            maps_to: entity_id
          - name: role
            type: lookup
            required: true
            lookup:
              table: roles
              code_column: name
              id_column: role_id
        returns:
          type: uuid
          name: cbu_entity_role_id
          capture: false

      remove-role:
        description: "Remove a specific role from an entity within a CBU"
        behavior: crud
        crud:
          operation: role_unlink
          junction: cbu_entity_roles
          schema: ob-poc
          from_col: cbu_id
          to_col: entity_id
          role_table: roles
        args:
          - name: cbu-id
            type: uuid
            required: true
          - name: entity-id
            type: uuid
            required: true
          - name: role
            type: lookup
            required: true
            lookup:
              table: roles
              code_column: name
              id_column: role_id
        returns:
          type: affected

      parties:
        description: "List all parties (entities with their roles) for a CBU"
        behavior: crud
        crud:
          operation: list_parties
          junction: cbu_entity_roles
          schema: ob-poc
          fk_col: cbu_id
        args:
          - name: cbu-id
            type: uuid
            required: true
        returns:
          type: record_set

      # -------------------------------------------------------------------------
      # CBU Evidence Lifecycle Verbs (Phase 2)
      # -------------------------------------------------------------------------

      set-status:
        description: "Update CBU status with transition validation"
        behavior: crud
        crud:
          operation: update
          table: cbus
          schema: ob-poc
          key: cbu_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
          - name: status
            type: string
            required: true
            maps_to: status
            valid_values:
              [
                DISCOVERED,
                VALIDATION_PENDING,
                VALIDATED,
                UPDATE_PENDING_PROOF,
                VALIDATION_FAILED,
              ]
        returns:
          type: affected

      attach-evidence:
        description: "Attach evidence document or attestation to a CBU"
        behavior: crud
        crud:
          operation: insert
          table: cbu_evidence
          schema: ob-poc
          returning: evidence_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
          - name: evidence-type
            type: string
            required: true
            maps_to: evidence_type
            valid_values:
              [
                DOCUMENT,
                ATTESTATION,
                SCREENING,
                REGISTRY_CHECK,
                MANUAL_VERIFICATION,
              ]
          - name: document-id
            type: uuid
            required: false
            maps_to: document_id
          - name: attestation-ref
            type: string
            required: false
            maps_to: attestation_ref
          - name: evidence-category
            type: string
            required: false
            maps_to: evidence_category
            valid_values: [IDENTITY, OWNERSHIP, REGULATORY, FINANCIAL]
          - name: description
            type: string
            required: false
            maps_to: description
          - name: attached-by
            type: string
            required: false
            maps_to: attached_by
        returns:
          type: uuid
          name: evidence_id
          capture: true

      verify-evidence:
        description: "Verify or reject attached evidence"
        behavior: crud
        crud:
          operation: update
          table: cbu_evidence
          schema: ob-poc
          key: evidence_id
          set_values:
            verified_at: now()
        args:
          - name: evidence-id
            type: uuid
            required: true
            maps_to: evidence_id
          - name: verification-status
            type: string
            required: true
            maps_to: verification_status
            valid_values: [VERIFIED, REJECTED, EXPIRED]
          - name: verified-by
            type: string
            required: false
            maps_to: verified_by
          - name: verification-notes
            type: string
            required: false
            maps_to: verification_notes
        returns:
          type: affected

      list-evidence:
        description: "List evidence attached to a CBU"
        behavior: crud
        crud:
          operation: select
          table: cbu_evidence
          schema: ob-poc
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
          - name: verification-status
            type: string
            required: false
            maps_to: verification_status
            valid_values: [PENDING, VERIFIED, REJECTED, EXPIRED]
          - name: evidence-category
            type: string
            required: false
            maps_to: evidence_category
        returns:
          type: record_set

      log-change:
        description: "Log a change to the CBU audit trail"
        behavior: crud
        crud:
          operation: insert
          table: cbu_change_log
          schema: ob-poc
          returning: log_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
          - name: change-type
            type: string
            required: true
            maps_to: change_type
            valid_values:
              [
                STATUS_CHANGE,
                FIELD_UPDATE,
                EVIDENCE_ADDED,
                EVIDENCE_VERIFIED,
                ROLE_CHANGE,
                UBO_CHANGE,
                PRODUCT_CHANGE,
              ]
          - name: field-name
            type: string
            required: false
            maps_to: field_name
          - name: old-value
            type: json
            required: false
            maps_to: old_value
          - name: new-value
            type: json
            required: false
            maps_to: new_value
          - name: evidence-ids
            type: uuid_array
            required: false
            maps_to: evidence_ids
          - name: changed-by
            type: string
            required: false
            maps_to: changed_by
          - name: reason
            type: string
            required: false
            maps_to: reason
          - name: case-id
            type: uuid
            required: false
            maps_to: case_id
        returns:
          type: uuid
          name: log_id
          capture: false

      list-changes:
        description: "List change log entries for a CBU"
        behavior: crud
        crud:
          operation: select
          table: cbu_change_log
          schema: ob-poc
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
          - name: change-type
            type: string
            required: false
            maps_to: change_type
          - name: limit
            type: integer
            required: false
            default: 100
          - name: offset
            type: integer
            required: false
            default: 0
        returns:
          type: record_set

      check-evidence-completeness:
        description: "Check if CBU has all required evidence categories verified"
        behavior: plugin
        plugin:
          handler: check_cbu_evidence_completeness
        args:
          - name: cbu-id
            type: uuid
            required: true
        returns:
          type: record

      # -------------------------------------------------------------------------
      # CBU Product Assignment
      # -------------------------------------------------------------------------
      add-product:
        description: "Add a product to a CBU (creates service_delivery_map entries for all services)"
        behavior: plugin
        args:
          - name: cbu-id
            type: uuid
            required: true
          - name: product
            type: string
            required: true
            description: "Product name (looked up in products table)"
        returns:
          type: affected
          description: "Number of service delivery entries created"

  # ===========================================================================
  # DOMAIN: entity
  # ===========================================================================
  entity:
    description: "Entity management operations"

    # Dynamic verb generation from entity_types table
    dynamic_verbs:
      - pattern: "create-{type_code}"
        source:
          table: entity_types
          schema: ob-poc
          code_column: type_code
          name_column: name
          transform: kebab_case
        behavior: crud
        crud:
          operation: entity_create
          base_table: entities
          schema: ob-poc
          extension_table_column: table_name
          type_id_column: entity_type_id
          returning: entity_id
        base_args:
          - name: name
            type: string
            required: true
            maps_to: name
          - name: jurisdiction
            type: string
            required: false
            maps_to: jurisdiction

    verbs:
      # Static fallback verbs for common entity types (used when DB not available)
      create-limited-company:
        description: "Create a limited company entity"
        behavior: crud
        crud:
          operation: entity_create
          base_table: entities
          schema: ob-poc
          extension_table_column: table_name
          type_id_column: entity_type_id
          returning: entity_id
        args:
          - name: name
            type: string
            required: true
            maps_to: company_name
          - name: cbu-id
            type: uuid
            required: false
          - name: company-number
            type: string
            required: false
            maps_to: registration_number
          - name: jurisdiction
            type: string
            required: false
            maps_to: jurisdiction
        returns:
          type: uuid
          name: entity_id
          capture: true

      create-proper-person:
        description: "Create a natural person entity"
        behavior: crud
        crud:
          operation: entity_create
          base_table: entities
          schema: ob-poc
          extension_table_column: table_name
          type_id_column: entity_type_id
          returning: entity_id
        args:
          - name: first-name
            type: string
            required: true
            maps_to: first_name
          - name: last-name
            type: string
            required: true
            maps_to: last_name
          - name: cbu-id
            type: uuid
            required: false
          - name: date-of-birth
            type: date
            required: false
            maps_to: date_of_birth
          - name: nationality
            type: string
            required: false
            maps_to: nationality
        returns:
          type: uuid
          name: entity_id
          capture: true

      create-trust-discretionary:
        description: "Create a discretionary trust entity"
        behavior: crud
        crud:
          operation: entity_create
          base_table: entities
          schema: ob-poc
          extension_table_column: table_name
          type_id_column: entity_type_id
          returning: entity_id
        args:
          - name: name
            type: string
            required: true
            maps_to: trust_name
          - name: cbu-id
            type: uuid
            required: false
          - name: jurisdiction
            type: string
            required: true
            maps_to: jurisdiction
          - name: establishment-date
            type: date
            required: false
            maps_to: establishment_date
          - name: trust-purpose
            type: string
            required: false
            maps_to: trust_purpose
        returns:
          type: uuid
          name: entity_id
          capture: true

      create-partnership-limited:
        description: "Create a limited partnership entity"
        behavior: crud
        crud:
          operation: entity_create
          base_table: entities
          schema: ob-poc
          extension_table_column: table_name
          type_id_column: entity_type_id
          returning: entity_id
        args:
          - name: name
            type: string
            required: true
            maps_to: partnership_name
          - name: cbu-id
            type: uuid
            required: false
          - name: jurisdiction
            type: string
            required: false
            maps_to: jurisdiction
          - name: formation-date
            type: date
            required: false
            maps_to: formation_date
        returns:
          type: uuid
          name: entity_id
          capture: true

      read:
        description: "Read an entity by ID"
        behavior: crud
        crud:
          operation: select
          table: entities
          schema: ob-poc
        args:
          - name: entity-id
            type: uuid
            required: true
            maps_to: entity_id
        returns:
          type: record

      update:
        description: "Update an entity's base fields"
        behavior: crud
        crud:
          operation: update
          table: entities
          schema: ob-poc
          key: entity_id
        args:
          - name: entity-id
            type: uuid
            required: true
            maps_to: entity_id
          - name: name
            type: string
            required: false
            maps_to: name
          - name: status
            type: string
            required: false
            maps_to: status
          - name: jurisdiction
            type: string
            required: false
            maps_to: jurisdiction
        returns:
          type: affected

      delete:
        description: "Delete an entity (cascades to type extension)"
        behavior: crud
        crud:
          operation: delete
          table: entities
          schema: ob-poc
          key: entity_id
        args:
          - name: entity-id
            type: uuid
            required: true
            maps_to: entity_id
        returns:
          type: affected

      list:
        description: "List entities with optional filters"
        behavior: crud
        crud:
          operation: select
          table: entities
          schema: ob-poc
        args:
          - name: entity-type
            type: string
            required: false
          - name: jurisdiction
            type: string
            required: false
            maps_to: jurisdiction
          - name: status
            type: string
            required: false
            maps_to: status
          - name: limit
            type: integer
            required: false
            default: 100
          - name: offset
            type: integer
            required: false
            default: 0
        returns:
          type: record_set

  # ===========================================================================
  # DOMAIN: document
  # ===========================================================================
  document:
    description: "Document catalog and extraction operations"

    verbs:
      catalog:
        description: "Catalog a document for an entity within a CBU"
        behavior: plugin
        args:
          - name: cbu-id
            type: uuid
            required: true
          - name: entity-id
            type: uuid
            required: true
          - name: document-type
            type: lookup
            required: true
            lookup:
              table: document_types
              code_column: type_code
              id_column: type_id
          - name: file-path
            type: string
            required: false
          - name: metadata
            type: json
            required: false
        returns:
          type: uuid
          name: doc_id
          capture: true

      extract:
        description: "Extract attributes from a cataloged document"
        behavior: plugin
        args:
          - name: document-id
            type: uuid
            required: true
          - name: attributes
            type: string_list
            required: false
          - name: use-ocr
            type: boolean
            required: false
            default: false
        returns:
          type: record

      extract-to-observations:
        description: "Extract document data and create observations"
        behavior: plugin
        handler: document_extract_observations
        args:
          - name: document-id
            type: uuid
            required: true
          - name: entity-id
            type: uuid
            required: true
          - name: auto-verify-allegations
            type: boolean
            required: false
            default: true
        returns:
          type: record_set

  # ===========================================================================
  # DOMAIN: screening
  # ===========================================================================
  screening:
    description: "Entity screening operations (PEP, sanctions, adverse media)"

    verbs:
      pep:
        description: "Run PEP (Politically Exposed Persons) screening"
        behavior: plugin
        args:
          - name: entity-id
            type: uuid
            required: true
          - name: provider
            type: string
            required: false
        returns:
          type: uuid
          capture: true

      sanctions:
        description: "Run sanctions list screening"
        behavior: plugin
        args:
          - name: entity-id
            type: uuid
            required: true
          - name: lists
            type: string_list
            required: false
        returns:
          type: uuid
          capture: true

      adverse-media:
        description: "Run adverse media screening"
        behavior: plugin
        args:
          - name: entity-id
            type: uuid
            required: true
          - name: lookback-months
            type: integer
            required: false
            default: 24
        returns:
          type: uuid
          capture: true

  # ===========================================================================
  # DOMAIN: delivery
  # ===========================================================================
  # Two-level model:
  # 1. assign-product: Links CBU to product AND creates service_delivery_map entries
  #    for all services in that product (via product_services join)
  # 2. record/complete/fail: Per-service status tracking in service_delivery_map
  delivery:
    description: "CBU product assignment and service delivery tracking"

    verbs:
      # Primary verb: assign a product to a CBU
      # This is a PLUGIN because it does 3 things:
      # 1. Sets cbus.product_id
      # 2. Queries product_services to get all services for the product
      # 3. Creates service_delivery_map entries for each (cbu, product, service)
      assign-product:
        description: "Assign a product to a CBU and create delivery entries for all its services"
        behavior: plugin
        args:
          - name: cbu-id
            type: uuid
            required: true
          - name: product
            type: string
            required: true
            description: "Product name (looked up in products table)"
        returns:
          type: affected
          description: "Number of service delivery entries created"

      # Per-service delivery tracking (for granular status updates)
      record:
        description: "Record a single service delivery entry (use assign-product for bulk)"
        behavior: plugin
        args:
          - name: cbu-id
            type: uuid
            required: true
          - name: product
            type: string
            required: true
          - name: service
            type: string
            required: true
          - name: instance-id
            type: uuid
            required: false
          - name: config
            type: json
            required: false
        returns:
          type: uuid
          capture: true

      complete:
        description: "Mark a service delivery as complete"
        behavior: plugin
        args:
          - name: cbu-id
            type: uuid
            required: true
          - name: product
            type: string
            required: true
          - name: service
            type: string
            required: true
          - name: instance-id
            type: uuid
            required: false
        returns:
          type: affected

      fail:
        description: "Mark a service delivery as failed"
        behavior: plugin
        args:
          - name: cbu-id
            type: uuid
            required: true
          - name: product
            type: string
            required: true
          - name: service
            type: string
            required: true
          - name: reason
            type: string
            required: true
        returns:
          type: affected

  # ===========================================================================
  # DOMAIN: product
  # ===========================================================================
  # Products are reference data - read-only via DSL, managed separately
  product:
    description: "Product catalog operations (read-only - products are reference data)"

    verbs:
      read:
        description: "Read a product by ID or code"
        behavior: crud
        crud:
          operation: select
          table: products
          schema: ob-poc
        args:
          - name: product-id
            type: uuid
            required: false
            maps_to: product_id
          - name: product-code
            type: string
            required: false
            maps_to: product_code
        returns:
          type: record

      list:
        description: "List products with optional filters"
        behavior: crud
        crud:
          operation: select
          table: products
          schema: ob-poc
        args:
          - name: product-category
            type: string
            required: false
            maps_to: product_category
          - name: is-active
            type: boolean
            required: false
            maps_to: is_active
          - name: limit
            type: integer
            required: false
            default: 100
          - name: offset
            type: integer
            required: false
            default: 0
        returns:
          type: record_set

  # ===========================================================================
  # DOMAIN: service
  # ===========================================================================
  # Services are reference data - read-only via DSL, managed separately
  service:
    description: "Service catalog operations (read-only - services are reference data)"

    verbs:
      read:
        description: "Read a service by ID or code"
        behavior: crud
        crud:
          operation: select
          table: services
          schema: ob-poc
        args:
          - name: service-id
            type: uuid
            required: false
            maps_to: service_id
          - name: service-code
            type: string
            required: false
            maps_to: service_code
        returns:
          type: record

      list:
        description: "List services with optional filters"
        behavior: crud
        crud:
          operation: select
          table: services
          schema: ob-poc
        args:
          - name: service-type
            type: string
            required: false
            maps_to: service_type
          - name: is-active
            type: boolean
            required: false
            maps_to: is_active
          - name: limit
            type: integer
            required: false
            default: 100
          - name: offset
            type: integer
            required: false
            default: 0
        returns:
          type: record_set

      list-by-product:
        description: "List services for a product"
        behavior: crud
        crud:
          operation: select_with_join
          primary_table: services
          join_table: product_services
          join_col: service_id
          filter_col: product_id
          schema: ob-poc
        args:
          - name: product-id
            type: uuid
            required: true
          - name: is-mandatory
            type: boolean
            required: false
        returns:
          type: record_set

  # ===========================================================================
  # DOMAIN: service-resource
  # ===========================================================================
  # Service resource TYPES are reference data - read-only via DSL
  # Instance operations (provision, activate, etc.) create CBU-specific instances
  service-resource:
    description: "Service resource type (read-only) and instance operations"

    verbs:
      # === Type Operations (read-only - reference data) ===
      read:
        description: "Read a service resource type by ID or code"
        behavior: crud
        crud:
          operation: select
          table: service_resource_types
          schema: ob-poc
        args:
          - name: resource-id
            type: uuid
            required: false
            maps_to: resource_id
          - name: resource-code
            type: string
            required: false
            maps_to: resource_code
        returns:
          type: record

      list:
        description: "List service resource types with optional filters"
        behavior: crud
        crud:
          operation: select
          table: service_resource_types
          schema: ob-poc
        args:
          - name: resource-type
            type: string
            required: false
            maps_to: resource_type
          - name: owner
            type: string
            required: false
            maps_to: owner
          - name: is-active
            type: boolean
            required: false
            maps_to: is_active
          - name: limit
            type: integer
            required: false
            default: 100
          - name: offset
            type: integer
            required: false
            default: 0
        returns:
          type: record_set

      # === Taxonomy lookups (read-only - taxonomy managed separately) ===
      list-by-service:
        description: "List service resource types for a service"
        behavior: crud
        crud:
          operation: select_with_join
          primary_table: service_resource_types
          join_table: service_resources
          join_col: resource_id
          filter_col: service_id
          schema: ob-poc
        args:
          - name: service-id
            type: uuid
            required: true
        returns:
          type: record_set

      # Attribute lookups (read-only - attribute requirements managed separately)
      list-attributes:
        description: "List attribute requirements for a service resource type"
        behavior: crud
        crud:
          operation: list_by_fk
          table: resource_attribute_requirements
          schema: ob-poc
          fk_col: resource_id
        args:
          - name: resource-id
            type: uuid
            required: true
          - name: is-mandatory
            type: boolean
            required: false
        returns:
          type: record_set

      # === Instance Operations (provisioning and lifecycle) ===
      provision:
        description: "Provision a service resource instance for a CBU"
        behavior: plugin
        handler: resource_instance_create
        args:
          - name: cbu-id
            type: uuid
            required: true
          - name: resource-type
            type: string
            required: true
          - name: instance-url
            type: string
            required: true
          - name: instance-id
            type: string
            required: false
          - name: instance-name
            type: string
            required: false
          - name: product-id
            type: uuid
            required: false
          - name: service-id
            type: uuid
            required: false
          - name: config
            type: json
            required: false
        returns:
          type: uuid
          name: instance_id
          capture: true

      set-attr:
        description: "Set an attribute value on a service resource instance"
        behavior: plugin
        handler: resource_set_attr
        args:
          - name: instance-id
            type: uuid
            required: true
          - name: attr
            type: string
            required: true
          - name: value
            type: string
            required: true
          - name: state
            type: string
            required: false
            valid_values: [proposed, confirmed, derived, system]
          - name: source
            type: json
            required: false

      activate:
        description: "Activate a service resource instance"
        behavior: plugin
        handler: resource_activate
        args:
          - name: instance-id
            type: uuid
            required: true

      suspend:
        description: "Suspend a service resource instance"
        behavior: plugin
        handler: resource_suspend
        args:
          - name: instance-id
            type: uuid
            required: true
          - name: reason
            type: string
            required: false

      decommission:
        description: "Decommission a service resource instance"
        behavior: plugin
        handler: resource_decommission
        args:
          - name: instance-id
            type: uuid
            required: true
          - name: reason
            type: string
            required: false

      validate-attrs:
        description: "Validate that all required attributes are set for a resource instance"
        behavior: plugin
        handler: resource_validate_attrs
        args:
          - name: instance-id
            type: uuid
            required: true
        returns:
          type: record
          name: validation_result

  # ===========================================================================
  # DOMAIN: instrument-class (Custody Taxonomy Reference)
  # ===========================================================================
  instrument-class:
    description: "Instrument class with industry taxonomy mappings"

    verbs:
      ensure:
        description: "Create or update instrument class with CFI/SMPG/ISDA mappings"
        behavior: crud
        crud:
          operation: upsert
          table: instrument_classes
          schema: custody
          conflict_keys: [code]
          returning: class_id
        args:
          - name: code
            type: string
            required: true
            maps_to: code
          - name: name
            type: string
            required: true
            maps_to: name
          - name: settlement-cycle
            type: string
            required: true
            maps_to: default_settlement_cycle
          - name: swift-family
            type: string
            required: false
            maps_to: swift_message_family
          - name: cfi-category
            type: string
            required: false
            maps_to: cfi_category
          - name: cfi-group
            type: string
            required: false
            maps_to: cfi_group
          - name: smpg-group
            type: string
            required: false
            maps_to: smpg_group
          - name: isda-asset-class
            type: string
            required: false
            maps_to: isda_asset_class
          - name: requires-isda
            type: boolean
            required: false
            maps_to: requires_isda
            default: false
          - name: parent
            type: lookup
            required: false
            maps_to: parent_class_id
            lookup:
              table: instrument_classes
              schema: custody
              code_column: code
              id_column: class_id
        returns:
          type: uuid
          name: class_id
          capture: true

      read:
        description: "Read instrument class by code"
        behavior: crud
        crud:
          operation: select
          table: instrument_classes
          schema: custody
        args:
          - name: code
            type: string
            required: true
            maps_to: code
        returns:
          type: record

      list:
        description: "List instrument classes with filters"
        behavior: crud
        crud:
          operation: select
          table: instrument_classes
          schema: custody
        args:
          - name: smpg-group
            type: string
            required: false
            maps_to: smpg_group
          - name: isda-asset-class
            type: string
            required: false
            maps_to: isda_asset_class
          - name: requires-isda
            type: boolean
            required: false
            maps_to: requires_isda
        returns:
          type: record_set

  # ===========================================================================
  # DOMAIN: security-type (ALERT codes)
  # ===========================================================================
  security-type:
    description: "SMPG/ALERT security type codes"

    verbs:
      ensure:
        description: "Create or update ALERT security type"
        behavior: crud
        crud:
          operation: upsert
          table: security_types
          schema: custody
          conflict_keys: [code]
          returning: security_type_id
        args:
          - name: class
            type: lookup
            required: true
            maps_to: instrument_class_id
            lookup:
              table: instrument_classes
              schema: custody
              code_column: code
              id_column: class_id
          - name: code
            type: string
            required: true
            maps_to: code
          - name: name
            type: string
            required: true
            maps_to: name
          - name: cfi-pattern
            type: string
            required: false
            maps_to: cfi_pattern
        returns:
          type: uuid
          name: security_type_id
          capture: true

      list:
        description: "List security types for an instrument class"
        behavior: crud
        crud:
          operation: list_by_fk
          table: security_types
          schema: custody
          fk_col: class_id
        args:
          - name: class
            type: lookup
            required: true
            maps_to: class_id
            lookup:
              table: instrument_classes
              schema: custody
              code_column: code
              id_column: class_id
        returns:
          type: record_set

  # ===========================================================================
  # DOMAIN: market (Market Reference)
  # ===========================================================================
  market:
    description: "Market/Exchange reference data"

    verbs:
      ensure:
        description: "Create or update market reference"
        behavior: crud
        crud:
          operation: upsert
          table: markets
          schema: custody
          conflict_keys: [mic]
          returning: market_id
        args:
          - name: mic
            type: string
            required: true
            maps_to: mic
          - name: name
            type: string
            required: true
            maps_to: name
          - name: country-code
            type: string
            required: true
            maps_to: country_code
          - name: primary-currency
            type: string
            required: true
            maps_to: primary_currency
          - name: csd-bic
            type: string
            required: false
            maps_to: csd_bic
          - name: timezone
            type: string
            required: true
            maps_to: timezone
        returns:
          type: uuid
          name: market_id
          capture: true

      read:
        description: "Read market by MIC"
        behavior: crud
        crud:
          operation: select
          table: markets
          schema: custody
        args:
          - name: mic
            type: string
            required: true
            maps_to: mic
        returns:
          type: record

      list:
        description: "List markets"
        behavior: crud
        crud:
          operation: select
          table: markets
          schema: custody
        args:
          - name: country-code
            type: string
            required: false
            maps_to: country_code
        returns:
          type: record_set

  # ===========================================================================
  # DOMAIN: subcustodian (Bank's Sub-custodian Network)
  # ===========================================================================
  subcustodian:
    description: "Bank's sub-custodian network (Omgeo Institution Network)"

    verbs:
      ensure:
        description: "Create or update sub-custodian entry for market/currency"
        behavior: crud
        crud:
          operation: upsert
          table: subcustodian_network
          schema: custody
          conflict_keys: [market_id, currency, subcustodian_bic, effective_date]
          returning: network_id
        args:
          - name: market
            type: lookup
            required: true
            maps_to: market_id
            lookup:
              table: markets
              schema: custody
              code_column: mic
              id_column: market_id
          - name: currency
            type: string
            required: true
            maps_to: currency
          - name: subcustodian-bic
            type: string
            required: true
            maps_to: subcustodian_bic
          - name: subcustodian-name
            type: string
            required: false
            maps_to: subcustodian_name
          - name: local-agent-bic
            type: string
            required: false
            maps_to: local_agent_bic
          - name: local-agent-account
            type: string
            required: false
            maps_to: local_agent_account
          - name: pset
            type: string
            required: true
            maps_to: place_of_settlement_bic
          - name: csd-participant
            type: string
            required: false
            maps_to: csd_participant_id
          - name: is-primary
            type: boolean
            required: false
            maps_to: is_primary
            default: true
          - name: effective-date
            type: date
            required: true
            maps_to: effective_date
        returns:
          type: uuid
          name: network_id
          capture: true

      list-by-market:
        description: "List sub-custodian entries for a market"
        behavior: crud
        crud:
          operation: list_by_fk
          table: subcustodian_network
          schema: custody
          fk_col: market_id
        args:
          - name: market
            type: lookup
            required: true
            maps_to: market_id
            lookup:
              table: markets
              schema: custody
              code_column: mic
              id_column: market_id
          - name: currency
            type: string
            required: false
            maps_to: currency
        returns:
          type: record_set

      lookup:
        description: "Find sub-custodian for market/currency"
        behavior: plugin
        handler: subcustodian_lookup
        args:
          - name: market
            type: string
            required: true
          - name: currency
            type: string
            required: true
          - name: as-of-date
            type: date
            required: false
        returns:
          type: record

  # ===========================================================================
  # DOMAIN: cbu-custody (Three-Layer Model)
  # ===========================================================================
  cbu-custody:
    description: "CBU custody operations: Universe, SSIs, and Booking Rules"

    verbs:
      # -----------------------------------------------------------------------
      # LAYER 1: Universe
      # -----------------------------------------------------------------------
      add-universe:
        description: "Declare what a CBU trades (instrument class + market + currencies)"
        behavior: crud
        crud:
          operation: upsert
          table: cbu_instrument_universe
          schema: custody
          conflict_keys:
            [cbu_id, instrument_class_id, market_id, counterparty_entity_id]
          returning: universe_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
          - name: instrument-class
            type: lookup
            required: true
            maps_to: instrument_class_id
            lookup:
              table: instrument_classes
              schema: custody
              code_column: code
              id_column: class_id
          - name: market
            type: lookup
            required: false
            maps_to: market_id
            lookup:
              table: markets
              schema: custody
              code_column: mic
              id_column: market_id
          - name: currencies
            type: string_list
            required: true
            maps_to: currencies
          - name: settlement-types
            type: string_list
            required: false
            maps_to: settlement_types
            default: ["DVP"]
          - name: counterparty
            type: uuid
            required: false
            maps_to: counterparty_entity_id
          - name: is-held
            type: boolean
            required: false
            maps_to: is_held
            default: true
          - name: is-traded
            type: boolean
            required: false
            maps_to: is_traded
            default: true
        returns:
          type: uuid
          name: universe_id
          capture: false

      list-universe:
        description: "List CBU's traded universe"
        behavior: crud
        crud:
          operation: list_by_fk
          table: cbu_instrument_universe
          schema: custody
          fk_col: cbu_id
        args:
          - name: cbu-id
            type: uuid
            required: true
        returns:
          type: record_set

      # -----------------------------------------------------------------------
      # LAYER 2: SSI Data
      # -----------------------------------------------------------------------
      create-ssi:
        description: "Create a Standing Settlement Instruction (pure account data)"
        behavior: crud
        crud:
          operation: insert
          table: cbu_ssi
          schema: custody
          returning: ssi_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
          - name: name
            type: string
            required: true
            maps_to: ssi_name
          - name: type
            type: string
            required: true
            maps_to: ssi_type
            valid_values: [SECURITIES, CASH, COLLATERAL, FX_NOSTRO]
          - name: safekeeping-account
            type: string
            required: false
            maps_to: safekeeping_account
          - name: safekeeping-bic
            type: string
            required: false
            maps_to: safekeeping_bic
          - name: safekeeping-name
            type: string
            required: false
            maps_to: safekeeping_account_name
          - name: cash-account
            type: string
            required: false
            maps_to: cash_account
          - name: cash-bic
            type: string
            required: false
            maps_to: cash_account_bic
          - name: cash-currency
            type: string
            required: false
            maps_to: cash_currency
          - name: collateral-account
            type: string
            required: false
            maps_to: collateral_account
          - name: collateral-bic
            type: string
            required: false
            maps_to: collateral_account_bic
          - name: pset-bic
            type: string
            required: false
            maps_to: pset_bic
          - name: effective-date
            type: date
            required: true
            maps_to: effective_date
        returns:
          type: uuid
          name: ssi_id
          capture: true

      list-ssis:
        description: "List SSIs for a CBU"
        behavior: crud
        crud:
          operation: list_by_fk
          table: cbu_ssi
          schema: custody
          fk_col: cbu_id
        args:
          - name: cbu-id
            type: uuid
            required: true
          - name: status
            type: string
            required: false
            maps_to: status
          - name: type
            type: string
            required: false
            maps_to: ssi_type
        returns:
          type: record_set

      activate-ssi:
        description: "Activate an SSI"
        behavior: crud
        crud:
          operation: update
          table: cbu_ssi
          schema: custody
          key: ssi_id
          set_values:
            status: ACTIVE
        args:
          - name: ssi-id
            type: uuid
            required: true
            maps_to: ssi_id
        returns:
          type: affected

      suspend-ssi:
        description: "Suspend an SSI"
        behavior: crud
        crud:
          operation: update
          table: cbu_ssi
          schema: custody
          key: ssi_id
          set_values:
            status: SUSPENDED
        args:
          - name: ssi-id
            type: uuid
            required: true
            maps_to: ssi_id
        returns:
          type: affected

      # -----------------------------------------------------------------------
      # LAYER 3: Booking Rules (ALERT-style)
      # -----------------------------------------------------------------------
      add-booking-rule:
        description: "Add ALERT-style booking rule for SSI routing"
        behavior: crud
        crud:
          operation: insert
          table: ssi_booking_rules
          schema: custody
          returning: rule_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
          - name: ssi-id
            type: uuid
            required: true
            maps_to: ssi_id
          - name: name
            type: string
            required: true
            maps_to: rule_name
          - name: priority
            type: integer
            required: true
            maps_to: priority
          # Match criteria (all optional = wildcards)
          - name: instrument-class
            type: lookup
            required: false
            maps_to: instrument_class_id
            lookup:
              table: instrument_classes
              schema: custody
              code_column: code
              id_column: class_id
          - name: security-type
            type: lookup
            required: false
            maps_to: security_type_id
            lookup:
              table: security_types
              schema: custody
              code_column: code
              id_column: security_type_id
          - name: market
            type: lookup
            required: false
            maps_to: market_id
            lookup:
              table: markets
              schema: custody
              code_column: mic
              id_column: market_id
          - name: currency
            type: string
            required: false
            maps_to: currency
          - name: settlement-type
            type: string
            required: false
            maps_to: settlement_type
          - name: counterparty
            type: uuid
            required: false
            maps_to: counterparty_entity_id
          # OTC criteria
          - name: isda-asset-class
            type: string
            required: false
            maps_to: isda_asset_class
          - name: isda-base-product
            type: string
            required: false
            maps_to: isda_base_product
          - name: effective-date
            type: date
            required: false
            maps_to: effective_date
        returns:
          type: uuid
          name: rule_id
          capture: true

      list-booking-rules:
        description: "List booking rules for a CBU"
        behavior: crud
        crud:
          operation: list_by_fk
          table: ssi_booking_rules
          schema: custody
          fk_col: cbu_id
          order_by: priority
        args:
          - name: cbu-id
            type: uuid
            required: true
          - name: is-active
            type: boolean
            required: false
            maps_to: is_active
        returns:
          type: record_set

      update-rule-priority:
        description: "Update booking rule priority"
        behavior: crud
        crud:
          operation: update
          table: ssi_booking_rules
          schema: custody
          key: rule_id
        args:
          - name: rule-id
            type: uuid
            required: true
            maps_to: rule_id
          - name: priority
            type: integer
            required: true
            maps_to: priority
        returns:
          type: affected

      deactivate-rule:
        description: "Deactivate a booking rule"
        behavior: crud
        crud:
          operation: update
          table: ssi_booking_rules
          schema: custody
          key: rule_id
          set_values:
            is_active: false
        args:
          - name: rule-id
            type: uuid
            required: true
            maps_to: rule_id
        returns:
          type: affected

      # -----------------------------------------------------------------------
      # Plugins
      # -----------------------------------------------------------------------
      derive-required-coverage:
        description: "Compare universe to booking rules, find gaps"
        behavior: plugin
        handler: derive_required_coverage
        args:
          - name: cbu-id
            type: uuid
            required: true
        returns:
          type: record_set

      validate-booking-coverage:
        description: "Validate that all universe entries have matching booking rules"
        behavior: plugin
        handler: validate_booking_coverage
        args:
          - name: cbu-id
            type: uuid
            required: true
        returns:
          type: record

      lookup-ssi:
        description: "Find SSI for given trade characteristics (simulate ALERT lookup)"
        behavior: plugin
        handler: lookup_ssi_for_trade
        args:
          - name: cbu-id
            type: uuid
            required: true
          - name: instrument-class
            type: string
            required: true
          - name: security-type
            type: string
            required: false
          - name: market
            type: string
            required: false
          - name: currency
            type: string
            required: true
          - name: settlement-type
            type: string
            required: false
          - name: counterparty-bic
            type: string
            required: false
        returns:
          type: record

  # ===========================================================================
  # DOMAIN: isda (ISDA/CSA Agreement Management)
  # ===========================================================================
  isda:
    description: "ISDA and CSA agreement management for OTC derivatives"

    verbs:
      create:
        description: "Create ISDA agreement with counterparty"
        behavior: crud
        crud:
          operation: insert
          table: isda_agreements
          schema: custody
          returning: isda_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
          - name: counterparty
            type: uuid
            required: true
            maps_to: counterparty_entity_id
          - name: agreement-date
            type: date
            required: true
            maps_to: agreement_date
          - name: governing-law
            type: string
            required: false
            maps_to: governing_law
            valid_values: [NY, ENGLISH]
          - name: effective-date
            type: date
            required: true
            maps_to: effective_date
        returns:
          type: uuid
          name: isda_id
          capture: true

      add-coverage:
        description: "Add instrument class coverage to ISDA"
        behavior: crud
        crud:
          operation: insert
          table: isda_product_coverage
          schema: custody
          returning: coverage_id
        args:
          - name: isda-id
            type: uuid
            required: true
            maps_to: isda_id
          - name: instrument-class
            type: lookup
            required: true
            maps_to: instrument_class_id
            lookup:
              table: instrument_classes
              schema: custody
              code_column: code
              id_column: class_id
          - name: isda-taxonomy
            type: lookup
            required: false
            maps_to: isda_taxonomy_id
            lookup:
              table: isda_product_taxonomy
              schema: custody
              code_column: taxonomy_code
              id_column: taxonomy_id
        returns:
          type: uuid
          name: coverage_id

      add-csa:
        description: "Add CSA (Credit Support Annex) to ISDA"
        behavior: crud
        crud:
          operation: insert
          table: csa_agreements
          schema: custody
          returning: csa_id
        args:
          - name: isda-id
            type: uuid
            required: true
            maps_to: isda_id
          - name: csa-type
            type: string
            required: true
            maps_to: csa_type
            valid_values: [VM, IM]
          - name: threshold
            type: decimal
            required: false
            maps_to: threshold_amount
          - name: threshold-currency
            type: string
            required: false
            maps_to: threshold_currency
          - name: mta
            type: decimal
            required: false
            maps_to: minimum_transfer_amount
          - name: collateral-ssi
            type: uuid
            required: false
            maps_to: collateral_ssi_id
          - name: effective-date
            type: date
            required: true
            maps_to: effective_date
        returns:
          type: uuid
          name: csa_id
          capture: true

      list:
        description: "List ISDA agreements for CBU"
        behavior: crud
        crud:
          operation: list_by_fk
          table: isda_agreements
          schema: custody
          fk_col: cbu_id
        args:
          - name: cbu-id
            type: uuid
            required: true
          - name: counterparty
            type: uuid
            required: false
            maps_to: counterparty_entity_id
        returns:
          type: record_set

  # ===========================================================================
  # DOMAIN: entity-settlement (Counterparty SSI from ALERT)
  # ===========================================================================
  entity-settlement:
    description: "Entity settlement identity and SSIs (counterparty data from ALERT)"

    verbs:
      set-identity:
        description: "Set primary settlement identity for an entity"
        behavior: crud
        crud:
          operation: upsert
          table: entity_settlement_identity
          schema: custody
          conflict_keys: [entity_id, primary_bic]
          returning: identity_id
        args:
          - name: entity-id
            type: uuid
            required: true
            maps_to: entity_id
          - name: bic
            type: string
            required: true
            maps_to: primary_bic
          - name: lei
            type: string
            required: false
            maps_to: lei
          - name: alert-id
            type: string
            required: false
            maps_to: alert_participant_id
          - name: ctm-id
            type: string
            required: false
            maps_to: ctm_participant_id
        returns:
          type: uuid
          name: identity_id
          capture: true

      add-ssi:
        description: "Add counterparty SSI (from ALERT or manual)"
        behavior: crud
        crud:
          operation: insert
          table: entity_ssi
          schema: custody
          returning: entity_ssi_id
        args:
          - name: entity-id
            type: uuid
            required: true
            maps_to: entity_id
          - name: instrument-class
            type: lookup
            required: false
            maps_to: instrument_class_id
            lookup:
              table: instrument_classes
              schema: custody
              code_column: code
              id_column: class_id
          - name: security-type
            type: lookup
            required: false
            maps_to: security_type_id
            lookup:
              table: security_types
              schema: custody
              code_column: code
              id_column: security_type_id
          - name: market
            type: lookup
            required: false
            maps_to: market_id
            lookup:
              table: markets
              schema: custody
              code_column: mic
              id_column: market_id
          - name: currency
            type: string
            required: false
            maps_to: currency
          - name: counterparty-bic
            type: string
            required: true
            maps_to: counterparty_bic
          - name: safekeeping-account
            type: string
            required: false
            maps_to: safekeeping_account
          - name: source
            type: string
            required: false
            maps_to: source
            valid_values: [ALERT, MANUAL, CTM]
            default: ALERT
          - name: source-reference
            type: string
            required: false
            maps_to: source_reference
          - name: effective-date
            type: date
            required: true
            maps_to: effective_date
        returns:
          type: uuid
          name: entity_ssi_id
          capture: true

  # ===========================================================================
  # DOMAIN: kyc (KYC Document Collection and Status)
  # ===========================================================================
  # DOMAIN: ubo (Ultimate Beneficial Ownership)
  # ===========================================================================
  ubo:
    description: "UBO ownership and control chain management"

    verbs:
      # Ownership Links (uses existing ownership_relationships table)
      add-ownership:
        description: "Add ownership relationship between entities"
        behavior: crud
        crud:
          operation: insert
          table: ownership_relationships
          schema: ob-poc
          returning: ownership_id
        args:
          - name: owner-entity-id
            type: uuid
            required: true
            maps_to: owner_entity_id
          - name: owned-entity-id
            type: uuid
            required: true
            maps_to: owned_entity_id
          - name: percentage
            type: decimal
            required: true
            maps_to: ownership_percent
          - name: ownership-type
            type: string
            required: true
            maps_to: ownership_type
            valid_values: [DIRECT, INDIRECT, BENEFICIAL]
          - name: effective-from
            type: date
            required: false
            maps_to: effective_from
          - name: evidence-doc-id
            type: uuid
            required: false
            maps_to: evidence_doc_id
          - name: notes
            type: string
            required: false
            maps_to: notes
        returns:
          type: uuid
          name: ownership_id
          capture: true

      update-ownership:
        description: "Update ownership percentage or end date"
        behavior: crud
        crud:
          operation: update
          table: ownership_relationships
          schema: ob-poc
          key: ownership_id
        args:
          - name: ownership-id
            type: uuid
            required: true
            maps_to: ownership_id
          - name: percentage
            type: decimal
            required: false
            maps_to: ownership_percent
          - name: effective-to
            type: date
            required: false
            maps_to: effective_to
          - name: notes
            type: string
            required: false
            maps_to: notes
        returns:
          type: affected

      end-ownership:
        description: "End an ownership relationship"
        behavior: crud
        crud:
          operation: update
          table: ownership_relationships
          schema: ob-poc
          key: ownership_id
        args:
          - name: ownership-id
            type: uuid
            required: true
            maps_to: ownership_id
          - name: effective-to
            type: date
            required: true
            maps_to: effective_to
        returns:
          type: affected

      list-owners:
        description: "List owners of an entity (who owns this entity)"
        behavior: crud
        crud:
          operation: list_by_fk
          table: ownership_relationships
          schema: ob-poc
          fk_col: owned_entity_id
        args:
          - name: entity-id
            type: uuid
            required: true
            maps_to: owned_entity_id
        returns:
          type: record_set

      list-owned:
        description: "List entities owned by an entity (what does this entity own)"
        behavior: crud
        crud:
          operation: list_by_fk
          table: ownership_relationships
          schema: ob-poc
          fk_col: owner_entity_id
        args:
          - name: entity-id
            type: uuid
            required: true
            maps_to: owner_entity_id
        returns:
          type: record_set

      # UBO Registry (uses existing ubo_registry table)
      register-ubo:
        description: "Register a UBO determination for a CBU"
        behavior: crud
        crud:
          operation: upsert
          table: ubo_registry
          schema: ob-poc
          conflict_keys:
            [subject_entity_id, ubo_proper_person_id, relationship_type]
          returning: ubo_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
          - name: subject-entity-id
            type: uuid
            required: true
            maps_to: subject_entity_id
          - name: ubo-person-id
            type: uuid
            required: true
            maps_to: ubo_proper_person_id
          - name: relationship-type
            type: string
            required: true
            maps_to: relationship_type
          - name: qualifying-reason
            type: string
            required: true
            maps_to: qualifying_reason
            valid_values: [OWNERSHIP_25PCT, CONTROL, SENIOR_MANAGEMENT, OTHER]
          - name: ownership-percentage
            type: decimal
            required: false
            maps_to: ownership_percentage
          - name: control-type
            type: string
            required: false
            maps_to: control_type
          - name: workflow-type
            type: string
            required: true
            maps_to: workflow_type
          - name: regulatory-framework
            type: string
            required: false
            maps_to: regulatory_framework
          - name: case-id
            type: uuid
            required: false
            maps_to: case_id
          - name: workstream-id
            type: uuid
            required: false
            maps_to: workstream_id
          - name: discovery-method
            type: string
            required: false
            maps_to: discovery_method
            valid_values: [MANUAL, INFERRED, DOCUMENT, REGISTRY, SCREENING]
        returns:
          type: uuid
          name: ubo_id
          capture: true

      verify-ubo:
        description: "Mark a UBO as verified"
        behavior: crud
        crud:
          operation: update
          table: ubo_registry
          schema: ob-poc
          key: ubo_id
        args:
          - name: ubo-id
            type: uuid
            required: true
            maps_to: ubo_id
          - name: verification-status
            type: string
            required: true
            maps_to: verification_status
            valid_values:
              [SUSPECTED, PENDING, PROVEN, VERIFIED, FAILED, DISPUTED, REMOVED]
          - name: risk-rating
            type: string
            required: false
            maps_to: risk_rating
            valid_values: [LOW, MEDIUM, HIGH, PROHIBITED]
        returns:
          type: affected

      list-ubos:
        description: "List UBOs for a CBU"
        behavior: crud
        crud:
          operation: list_by_fk
          table: ubo_registry
          schema: ob-poc
          fk_col: cbu_id
        args:
          - name: cbu-id
            type: uuid
            required: true
          - name: verification-status
            type: string
            required: false
            maps_to: verification_status
        returns:
          type: record_set

      list-by-subject:
        description: "List UBOs for a subject entity"
        behavior: crud
        crud:
          operation: list_by_fk
          table: ubo_registry
          schema: ob-poc
          fk_col: subject_entity_id
        args:
          - name: subject-entity-id
            type: uuid
            required: true
        returns:
          type: record_set

      # Plugin verbs for complex UBO operations
      calculate:
        description: "Calculate ultimate beneficial ownership chain"
        behavior: plugin
        args:
          - name: cbu-id
            type: uuid
            required: true
          - name: entity-id
            type: uuid
            required: true
          - name: threshold
            type: decimal
            required: false
            default: 25.0
        returns:
          type: record_set

      # UBO Discovery and Chain Analysis (Phase 4 enhancements)
      discover-owner:
        description: "Discover potential UBOs from document extraction or registry lookup"
        behavior: plugin
        plugin:
          handler: ubo_discover_owner
        args:
          - name: cbu-id
            type: uuid
            required: true
          - name: entity-id
            type: uuid
            required: true
          - name: source-type
            type: string
            required: true
            valid_values: [DOCUMENT, REGISTRY, SCREENING]
          - name: source-ref
            type: string
            required: false
        returns:
          type: json
          capture: true

      infer-chain:
        description: "Infer ownership chain from known relationships"
        behavior: plugin
        plugin:
          handler: ubo_infer_chain
        args:
          - name: cbu-id
            type: uuid
            required: true
          - name: start-entity-id
            type: uuid
            required: true
          - name: max-depth
            type: integer
            required: false
            default: 10
        returns:
          type: json
          capture: true

      trace-chains:
        description: "Trace all ownership chains to natural persons for a CBU"
        behavior: plugin
        plugin:
          handler: ubo_trace_chains
        args:
          - name: cbu-id
            type: uuid
            required: true
          - name: target-entity-id
            type: uuid
            required: false
          - name: threshold
            type: decimal
            required: false
            default: 25.0
        returns:
          type: json
          capture: true

      check-completeness:
        description: "Check if UBO determination is complete for a CBU"
        behavior: plugin
        plugin:
          handler: ubo_check_completeness
        args:
          - name: cbu-id
            type: uuid
            required: true
          - name: threshold
            type: decimal
            required: false
            default: 25.0
        returns:
          type: json
          capture: true

      # UBO Lifecycle Management
      supersede-ubo:
        description: "Supersede a UBO record with a newer determination"
        behavior: plugin
        plugin:
          handler: ubo_supersede
        args:
          - name: old-ubo-id
            type: uuid
            required: true
          - name: new-ubo-id
            type: uuid
            required: true
          - name: reason
            type: string
            required: false
        returns:
          type: affected

      close-ubo:
        description: "Close a UBO record (no longer a UBO)"
        behavior: crud
        crud:
          operation: update
          table: ubo_registry
          schema: ob-poc
          key: ubo_id
          set_values:
            closed_at: now()
        args:
          - name: ubo-id
            type: uuid
            required: true
            maps_to: ubo_id
          - name: closed-reason
            type: string
            required: true
            maps_to: closed_reason
        returns:
          type: affected

      # UBO Snapshots
      snapshot-cbu:
        description: "Capture a point-in-time snapshot of UBO state for a CBU"
        behavior: plugin
        plugin:
          handler: ubo_snapshot_cbu
        args:
          - name: cbu-id
            type: uuid
            required: true
          - name: case-id
            type: uuid
            required: false
          - name: snapshot-type
            type: string
            required: false
            default: MANUAL
            valid_values:
              [MANUAL, PERIODIC, EVENT_DRIVEN, CASE_OPEN, CASE_CLOSE]
          - name: reason
            type: string
            required: false
        returns:
          type: uuid
          name: snapshot_id
          capture: true

      compare-snapshot:
        description: "Compare two UBO snapshots to detect changes"
        behavior: plugin
        plugin:
          handler: ubo_compare_snapshot
        args:
          - name: cbu-id
            type: uuid
            required: true
          - name: baseline-snapshot-id
            type: uuid
            required: true
          - name: current-snapshot-id
            type: uuid
            required: true
        returns:
          type: json
          capture: true

      list-snapshots:
        description: "List UBO snapshots for a CBU"
        behavior: crud
        crud:
          operation: list_by_fk
          table: ubo_snapshots
          schema: ob-poc
          fk_col: cbu_id
        args:
          - name: cbu-id
            type: uuid
            required: true
        returns:
          type: record_set

      # -------------------------------------------------------------------------
      # UBO Discovery & Proof Lifecycle Verbs (Phase 3)
      # -------------------------------------------------------------------------

      assert:
        description: "Assert a suspected UBO (creates SUSPECTED record pending proof)"
        behavior: crud
        crud:
          operation: insert
          table: ubo_registry
          schema: ob-poc
          returning: ubo_id
          set_values:
            verification_status: SUSPECTED
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
          - name: subject-entity-id
            type: uuid
            required: true
            maps_to: subject_entity_id
          - name: ubo-person-id
            type: uuid
            required: true
            maps_to: ubo_proper_person_id
          - name: relationship-type
            type: string
            required: true
            maps_to: relationship_type
          - name: qualifying-reason
            type: string
            required: true
            maps_to: qualifying_reason
            valid_values: [OWNERSHIP_25PCT, CONTROL, SENIOR_MANAGEMENT, OTHER]
          - name: ownership-percentage
            type: decimal
            required: false
            maps_to: ownership_percentage
          - name: workflow-type
            type: string
            required: true
            maps_to: workflow_type
          - name: case-id
            type: uuid
            required: false
            maps_to: case_id
          - name: workstream-id
            type: uuid
            required: false
            maps_to: workstream_id
          - name: discovery-method
            type: string
            required: false
            maps_to: discovery_method
            valid_values: [MANUAL, INFERRED, DOCUMENT, REGISTRY, SCREENING]
        returns:
          type: uuid
          name: ubo_id
          capture: true

      prove:
        description: "Prove a UBO determination with evidence (transitions to PROVEN)"
        behavior: crud
        crud:
          operation: update
          table: ubo_registry
          schema: ob-poc
          key: ubo_id
          set_values:
            verification_status: PROVEN
            proof_date: now()
        args:
          - name: ubo-id
            type: uuid
            required: true
            maps_to: ubo_id
          - name: proof-method
            type: string
            required: true
            maps_to: proof_method
            valid_values:
              [
                DOCUMENT,
                REGISTRY_LOOKUP,
                SCREENING_MATCH,
                MANUAL_VERIFICATION,
                OWNERSHIP_CHAIN,
                CLIENT_ATTESTATION,
              ]
          - name: evidence-doc-ids
            type: uuid_array
            required: false
            maps_to: evidence_doc_ids
          - name: proof-notes
            type: string
            required: false
            maps_to: proof_notes
        returns:
          type: affected

      remove:
        description: "Remove a UBO (no longer qualifies as UBO)"
        behavior: crud
        crud:
          operation: update
          table: ubo_registry
          schema: ob-poc
          key: ubo_id
          set_values:
            verification_status: REMOVED
            closed_at: now()
        args:
          - name: ubo-id
            type: uuid
            required: true
            maps_to: ubo_id
          - name: removal-reason
            type: string
            required: true
            maps_to: removal_reason
          - name: replacement-ubo-id
            type: uuid
            required: false
            maps_to: replacement_ubo_id
        returns:
          type: affected

      attach-evidence:
        description: "Attach evidence document to a UBO record"
        behavior: crud
        crud:
          operation: insert
          table: ubo_evidence
          schema: ob-poc
          returning: ubo_evidence_id
        args:
          - name: ubo-id
            type: uuid
            required: true
            maps_to: ubo_id
          - name: evidence-type
            type: string
            required: true
            maps_to: evidence_type
            valid_values:
              [
                DOCUMENT,
                ATTESTATION,
                SCREENING,
                REGISTRY_LOOKUP,
                OWNERSHIP_RECORD,
              ]
          - name: evidence-role
            type: string
            required: true
            maps_to: evidence_role
            valid_values:
              [
                IDENTITY_PROOF,
                OWNERSHIP_PROOF,
                CONTROL_PROOF,
                ADDRESS_PROOF,
                SOURCE_OF_WEALTH,
                CHAIN_LINK,
              ]
          - name: document-id
            type: uuid
            required: false
            maps_to: document_id
          - name: attestation-ref
            type: string
            required: false
            maps_to: attestation_ref
          - name: description
            type: string
            required: false
            maps_to: description
          - name: attached-by
            type: string
            required: false
            maps_to: attached_by
        returns:
          type: uuid
          name: ubo_evidence_id
          capture: true

      verify-evidence:
        description: "Verify or reject evidence attached to a UBO"
        behavior: crud
        crud:
          operation: update
          table: ubo_evidence
          schema: ob-poc
          key: ubo_evidence_id
          set_values:
            verified_at: now()
        args:
          - name: evidence-id
            type: uuid
            required: true
            maps_to: ubo_evidence_id
          - name: verification-status
            type: string
            required: true
            maps_to: verification_status
            valid_values: [VERIFIED, REJECTED, EXPIRED]
          - name: verified-by
            type: string
            required: false
            maps_to: verified_by
          - name: verification-notes
            type: string
            required: false
            maps_to: verification_notes
        returns:
          type: affected

      list-evidence:
        description: "List evidence attached to a UBO"
        behavior: crud
        crud:
          operation: select
          table: ubo_evidence
          schema: ob-poc
        args:
          - name: ubo-id
            type: uuid
            required: true
            maps_to: ubo_id
          - name: verification-status
            type: string
            required: false
            maps_to: verification_status
        returns:
          type: record_set

      can-prove:
        description: "Check if UBO has sufficient evidence to be proven"
        behavior: plugin
        plugin:
          handler: can_prove_ubo
        args:
          - name: ubo-id
            type: uuid
            required: true
        returns:
          type: record

  # ===========================================================================
  # DOMAIN: share-class (Fund Share Classes and Investor Registry)
  # ===========================================================================
  share-class:
    description: "Fund share class management and investor registry (Clearstream-style)"

    verbs:
      # Share Class CRUD
      create:
        description: "Create a new share class for a fund CBU"
        behavior: crud
        crud:
          operation: insert
          table: share_classes
          schema: kyc
          returning: id
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
          - name: entity-id
            type: uuid
            required: false
            maps_to: entity_id
          - name: name
            type: string
            required: true
            maps_to: name
          - name: isin
            type: string
            required: false
            maps_to: isin
          - name: currency
            type: string
            required: false
            maps_to: currency
            default: "EUR"
          - name: fund-type
            type: string
            required: false
            maps_to: fund_type
            valid_values: [HEDGE_FUND, UCITS, AIFMD, PRIVATE_EQUITY, REIT]
          - name: fund-structure
            type: string
            required: false
            maps_to: fund_structure
            valid_values: [OPEN_ENDED, CLOSED_ENDED]
          - name: investor-eligibility
            type: string
            required: false
            maps_to: investor_eligibility
            valid_values: [RETAIL, PROFESSIONAL, QUALIFIED]
          - name: nav-per-share
            type: decimal
            required: false
            maps_to: nav_per_share
          - name: nav-date
            type: date
            required: false
            maps_to: nav_date
          - name: management-fee-bps
            type: integer
            required: false
            maps_to: management_fee_bps
          - name: performance-fee-bps
            type: integer
            required: false
            maps_to: performance_fee_bps
          - name: high-water-mark
            type: boolean
            required: false
            maps_to: high_water_mark
          - name: hurdle-rate
            type: decimal
            required: false
            maps_to: hurdle_rate
          - name: subscription-frequency
            type: string
            required: false
            maps_to: subscription_frequency
          - name: redemption-frequency
            type: string
            required: false
            maps_to: redemption_frequency
          - name: redemption-notice-days
            type: integer
            required: false
            maps_to: redemption_notice_days
          - name: lock-up-period-months
            type: integer
            required: false
            maps_to: lock_up_period_months
          - name: gate-percentage
            type: decimal
            required: false
            maps_to: gate_percentage
          - name: minimum-investment
            type: decimal
            required: false
            maps_to: minimum_investment
          - name: class-category
            type: string
            required: false
            maps_to: class_category
            valid_values: [CORPORATE, FUND]
        returns:
          type: uuid
          name: share_class_id
          capture: true

      ensure:
        description: "Create or update share class by ISIN"
        behavior: crud
        crud:
          operation: upsert
          table: share_classes
          schema: kyc
          conflict_keys: [cbu_id, isin]
          returning: id
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
          - name: entity-id
            type: uuid
            required: false
            maps_to: entity_id
          - name: name
            type: string
            required: true
            maps_to: name
          - name: isin
            type: string
            required: true
            maps_to: isin
          - name: currency
            type: string
            required: false
            maps_to: currency
          - name: fund-type
            type: string
            required: false
            maps_to: fund_type
            valid_values: [HEDGE_FUND, UCITS, AIFMD, PRIVATE_EQUITY, REIT]
          - name: fund-structure
            type: string
            required: false
            maps_to: fund_structure
            valid_values: [OPEN_ENDED, CLOSED_ENDED]
          - name: investor-eligibility
            type: string
            required: false
            maps_to: investor_eligibility
            valid_values: [RETAIL, PROFESSIONAL, QUALIFIED]
          - name: nav-per-share
            type: decimal
            required: false
            maps_to: nav_per_share
          - name: nav-date
            type: date
            required: false
            maps_to: nav_date
          - name: management-fee-bps
            type: integer
            required: false
            maps_to: management_fee_bps
          - name: performance-fee-bps
            type: integer
            required: false
            maps_to: performance_fee_bps
          - name: high-water-mark
            type: boolean
            required: false
            maps_to: high_water_mark
          - name: hurdle-rate
            type: decimal
            required: false
            maps_to: hurdle_rate
          - name: subscription-frequency
            type: string
            required: false
            maps_to: subscription_frequency
          - name: redemption-frequency
            type: string
            required: false
            maps_to: redemption_frequency
          - name: redemption-notice-days
            type: integer
            required: false
            maps_to: redemption_notice_days
          - name: lock-up-period-months
            type: integer
            required: false
            maps_to: lock_up_period_months
          - name: gate-percentage
            type: decimal
            required: false
            maps_to: gate_percentage
          - name: minimum-investment
            type: decimal
            required: false
            maps_to: minimum_investment
          - name: class-category
            type: string
            required: false
            maps_to: class_category
            valid_values: [CORPORATE, FUND]
        returns:
          type: uuid
          name: share_class_id
          capture: true

      update-nav:
        description: "Update NAV for a share class"
        behavior: crud
        crud:
          operation: update
          table: share_classes
          schema: kyc
          key: id
        args:
          - name: share-class-id
            type: uuid
            required: true
            maps_to: id
          - name: nav-per-share
            type: decimal
            required: true
            maps_to: nav_per_share
          - name: nav-date
            type: date
            required: true
            maps_to: nav_date
        returns:
          type: affected

      read:
        description: "Read a share class by ID"
        behavior: crud
        crud:
          operation: select
          table: share_classes
          schema: kyc
        args:
          - name: share-class-id
            type: uuid
            required: true
            maps_to: id
        returns:
          type: record

      list:
        description: "List share classes for a fund"
        behavior: crud
        crud:
          operation: list_by_fk
          table: share_classes
          schema: kyc
          fk_col: cbu_id
        args:
          - name: cbu-id
            type: uuid
            required: true
          - name: status
            type: string
            required: false
            maps_to: status
        returns:
          type: record_set

      close:
        description: "Close a share class to new subscriptions"
        behavior: crud
        crud:
          operation: update
          table: share_classes
          schema: kyc
          key: id
          set_values:
            status: closed
        args:
          - name: share-class-id
            type: uuid
            required: true
            maps_to: id
        returns:
          type: affected

  # ===========================================================================
  # DOMAIN: holding (Investor Holdings/Positions)
  # ===========================================================================
  holding:
    description: "Investor position management in share classes"

    verbs:
      create:
        description: "Create a new investor holding in a share class"
        behavior: crud
        crud:
          operation: insert
          table: holdings
          schema: kyc
          returning: id
        args:
          - name: share-class-id
            type: uuid
            required: true
            maps_to: share_class_id
          - name: investor-entity-id
            type: uuid
            required: true
            maps_to: investor_entity_id
          - name: units
            type: decimal
            required: false
            maps_to: units
            default: 0
          - name: cost-basis
            type: decimal
            required: false
            maps_to: cost_basis
          - name: acquisition-date
            type: date
            required: false
            maps_to: acquisition_date
        returns:
          type: uuid
          name: holding_id
          capture: true

      ensure:
        description: "Ensure investor holding exists (upsert)"
        behavior: crud
        crud:
          operation: upsert
          table: holdings
          schema: kyc
          conflict_keys: [share_class_id, investor_entity_id]
          returning: id
        args:
          - name: share-class-id
            type: uuid
            required: true
            maps_to: share_class_id
          - name: investor-entity-id
            type: uuid
            required: true
            maps_to: investor_entity_id
          - name: units
            type: decimal
            required: false
            maps_to: units
          - name: cost-basis
            type: decimal
            required: false
            maps_to: cost_basis
          - name: acquisition-date
            type: date
            required: false
            maps_to: acquisition_date
        returns:
          type: uuid
          name: holding_id
          capture: true

      update-units:
        description: "Update holding units (for position adjustments)"
        behavior: crud
        crud:
          operation: update
          table: holdings
          schema: kyc
          key: id
        args:
          - name: holding-id
            type: uuid
            required: true
            maps_to: id
          - name: units
            type: decimal
            required: true
            maps_to: units
          - name: cost-basis
            type: decimal
            required: false
            maps_to: cost_basis
        returns:
          type: affected

      read:
        description: "Read a holding by ID"
        behavior: crud
        crud:
          operation: select
          table: holdings
          schema: kyc
        args:
          - name: holding-id
            type: uuid
            required: true
            maps_to: id
        returns:
          type: record

      list-by-share-class:
        description: "List holdings for a share class"
        behavior: crud
        crud:
          operation: list_by_fk
          table: holdings
          schema: kyc
          fk_col: share_class_id
        args:
          - name: share-class-id
            type: uuid
            required: true
          - name: status
            type: string
            required: false
            maps_to: status
        returns:
          type: record_set

      list-by-investor:
        description: "List holdings for an investor across all share classes"
        behavior: crud
        crud:
          operation: list_by_fk
          table: holdings
          schema: kyc
          fk_col: investor_entity_id
        args:
          - name: investor-entity-id
            type: uuid
            required: true
        returns:
          type: record_set

      close:
        description: "Close a holding (mark as inactive)"
        behavior: crud
        crud:
          operation: update
          table: holdings
          schema: kyc
          key: id
          set_values:
            status: closed
        args:
          - name: holding-id
            type: uuid
            required: true
            maps_to: id
        returns:
          type: affected

  # ===========================================================================
  # DOMAIN: movement (Subscription/Redemption Transactions)
  # ===========================================================================
  movement:
    description: "Fund subscription, redemption, and transfer transactions"

    verbs:
      subscribe:
        description: "Record a subscription (investor buying units)"
        behavior: crud
        crud:
          operation: insert
          table: movements
          schema: kyc
          returning: id
        args:
          - name: holding-id
            type: uuid
            required: true
            maps_to: holding_id
          - name: units
            type: decimal
            required: true
            maps_to: units
          - name: price-per-unit
            type: decimal
            required: true
            maps_to: price_per_unit
          - name: amount
            type: decimal
            required: false
            maps_to: amount
          - name: currency
            type: string
            required: false
            maps_to: currency
            default: "EUR"
          - name: trade-date
            type: date
            required: true
            maps_to: trade_date
          - name: settlement-date
            type: date
            required: false
            maps_to: settlement_date
          - name: reference
            type: string
            required: false
            maps_to: reference
          - name: notes
            type: string
            required: false
            maps_to: notes
        returns:
          type: uuid
          name: movement_id
          capture: true
        set_values:
          movement_type: subscription

      redeem:
        description: "Record a redemption (investor selling units)"
        behavior: crud
        crud:
          operation: insert
          table: movements
          schema: kyc
          returning: id
        args:
          - name: holding-id
            type: uuid
            required: true
            maps_to: holding_id
          - name: units
            type: decimal
            required: true
            maps_to: units
          - name: price-per-unit
            type: decimal
            required: true
            maps_to: price_per_unit
          - name: amount
            type: decimal
            required: false
            maps_to: amount
          - name: currency
            type: string
            required: false
            maps_to: currency
            default: "EUR"
          - name: trade-date
            type: date
            required: true
            maps_to: trade_date
          - name: settlement-date
            type: date
            required: false
            maps_to: settlement_date
          - name: reference
            type: string
            required: false
            maps_to: reference
          - name: notes
            type: string
            required: false
            maps_to: notes
        returns:
          type: uuid
          name: movement_id
          capture: true
        set_values:
          movement_type: redemption

      transfer-in:
        description: "Record an incoming transfer of units"
        behavior: crud
        crud:
          operation: insert
          table: movements
          schema: kyc
          returning: id
        args:
          - name: holding-id
            type: uuid
            required: true
            maps_to: holding_id
          - name: units
            type: decimal
            required: true
            maps_to: units
          - name: price-per-unit
            type: decimal
            required: false
            maps_to: price_per_unit
          - name: trade-date
            type: date
            required: true
            maps_to: trade_date
          - name: reference
            type: string
            required: false
            maps_to: reference
          - name: notes
            type: string
            required: false
            maps_to: notes
        returns:
          type: uuid
          name: movement_id
          capture: true
        set_values:
          movement_type: transfer_in

      transfer-out:
        description: "Record an outgoing transfer of units"
        behavior: crud
        crud:
          operation: insert
          table: movements
          schema: kyc
          returning: id
        args:
          - name: holding-id
            type: uuid
            required: true
            maps_to: holding_id
          - name: units
            type: decimal
            required: true
            maps_to: units
          - name: price-per-unit
            type: decimal
            required: false
            maps_to: price_per_unit
          - name: trade-date
            type: date
            required: true
            maps_to: trade_date
          - name: reference
            type: string
            required: false
            maps_to: reference
          - name: notes
            type: string
            required: false
            maps_to: notes
        returns:
          type: uuid
          name: movement_id
          capture: true
        set_values:
          movement_type: transfer_out

      confirm:
        description: "Confirm a pending movement"
        behavior: crud
        crud:
          operation: update
          table: movements
          schema: kyc
          key: id
          set_values:
            status: confirmed
        args:
          - name: movement-id
            type: uuid
            required: true
            maps_to: id
        returns:
          type: affected

      settle:
        description: "Mark a movement as settled"
        behavior: crud
        crud:
          operation: update
          table: movements
          schema: kyc
          key: id
          set_values:
            status: settled
        args:
          - name: movement-id
            type: uuid
            required: true
            maps_to: id
          - name: settlement-date
            type: date
            required: false
            maps_to: settlement_date
        returns:
          type: affected

      cancel:
        description: "Cancel a pending movement"
        behavior: crud
        crud:
          operation: update
          table: movements
          schema: kyc
          key: id
          set_values:
            status: cancelled
        args:
          - name: movement-id
            type: uuid
            required: true
            maps_to: id
          - name: notes
            type: string
            required: false
            maps_to: notes
        returns:
          type: affected

      list-by-holding:
        description: "List movements for a holding"
        behavior: crud
        crud:
          operation: list_by_fk
          table: movements
          schema: kyc
          fk_col: holding_id
        args:
          - name: holding-id
            type: uuid
            required: true
          - name: movement-type
            type: string
            required: false
            maps_to: movement_type
          - name: status
            type: string
            required: false
            maps_to: status
        returns:
          type: record_set

      read:
        description: "Read a movement by ID"
        behavior: crud
        crud:
          operation: select
          table: movements
          schema: kyc
        args:
          - name: movement-id
            type: uuid
            required: true
            maps_to: id
        returns:
          type: record

  # ===========================================================================
  # DOMAIN: kyc-case (KYC Case Lifecycle Management)
  # ===========================================================================
  kyc-case:
    description: "KYC case lifecycle management"

    verbs:
      create:
        description: "Create a new KYC case for a CBU"
        behavior: crud
        crud:
          operation: insert
          table: cases
          schema: kyc
          returning: case_id
        emits_event: case.created
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
          - name: case-type
            type: string
            required: false
            maps_to: case_type
            default: "NEW_CLIENT"
            valid_values:
              [NEW_CLIENT, PERIODIC_REVIEW, EVENT_DRIVEN, REMEDIATION]
          - name: sla-deadline
            type: timestamp
            required: false
            maps_to: sla_deadline
          - name: assigned-analyst-id
            type: uuid
            required: false
            maps_to: assigned_analyst_id
          - name: notes
            type: string
            required: false
            maps_to: notes
        returns:
          type: uuid
          name: case_id
          capture: true

      update-status:
        description: "Update case status"
        behavior: crud
        crud:
          operation: update
          table: cases
          schema: kyc
          key: case_id
        emits_event: case.status-changed
        args:
          - name: case-id
            type: uuid
            required: true
            maps_to: case_id
          - name: status
            type: string
            required: true
            maps_to: status
            valid_values:
              [
                INTAKE,
                DISCOVERY,
                ASSESSMENT,
                REVIEW,
                APPROVED,
                REJECTED,
                BLOCKED,
                WITHDRAWN,
                EXPIRED,
                REFER_TO_REGULATOR,
                DO_NOT_ONBOARD,
              ]
        returns:
          type: affected

      escalate:
        description: "Escalate case to higher authority"
        behavior: crud
        crud:
          operation: update
          table: cases
          schema: kyc
          key: case_id
        emits_event: case.escalated
        args:
          - name: case-id
            type: uuid
            required: true
            maps_to: case_id
          - name: escalation-level
            type: string
            required: true
            maps_to: escalation_level
            valid_values: [STANDARD, SENIOR_COMPLIANCE, EXECUTIVE, BOARD]
        returns:
          type: affected

      assign:
        description: "Assign case to analyst and/or reviewer"
        behavior: crud
        crud:
          operation: update
          table: cases
          schema: kyc
          key: case_id
        emits_event: case.assigned
        args:
          - name: case-id
            type: uuid
            required: true
            maps_to: case_id
          - name: analyst-id
            type: uuid
            required: false
            maps_to: assigned_analyst_id
          - name: reviewer-id
            type: uuid
            required: false
            maps_to: assigned_reviewer_id
        returns:
          type: affected

      set-risk-rating:
        description: "Set case risk rating"
        behavior: crud
        crud:
          operation: update
          table: cases
          schema: kyc
          key: case_id
        emits_event: case.risk-rated
        args:
          - name: case-id
            type: uuid
            required: true
            maps_to: case_id
          - name: risk-rating
            type: string
            required: true
            maps_to: risk_rating
            valid_values: [LOW, MEDIUM, HIGH, VERY_HIGH, PROHIBITED]
        returns:
          type: affected

      close:
        description: "Close the case"
        behavior: crud
        crud:
          operation: update
          table: cases
          schema: kyc
          key: case_id
          set_values:
            closed_at: now()
        emits_event: case.closed
        args:
          - name: case-id
            type: uuid
            required: true
            maps_to: case_id
          - name: status
            type: string
            required: true
            maps_to: status
            valid_values:
              [APPROVED, REJECTED, WITHDRAWN, EXPIRED, DO_NOT_ONBOARD]
          - name: notes
            type: string
            required: false
            maps_to: notes
        returns:
          type: affected

      read:
        description: "Read case details"
        behavior: crud
        crud:
          operation: select
          table: cases
          schema: kyc
        args:
          - name: case-id
            type: uuid
            required: true
            maps_to: case_id
        returns:
          type: record

      list-by-cbu:
        description: "List cases for a CBU"
        behavior: crud
        crud:
          operation: list_by_fk
          table: cases
          schema: kyc
          fk_col: cbu_id
        args:
          - name: cbu-id
            type: uuid
            required: true
          - name: status
            type: string
            required: false
            maps_to: status
        returns:
          type: record_set

      # -------------------------------------------------------------------------
      # Case Decision Verbs (Phase 4)
      # -------------------------------------------------------------------------

      apply-decision:
        description: "Apply a decision to the case based on red-flag evaluation"
        behavior: plugin
        plugin:
          handler: apply_case_decision
        emits_event: case.decision-applied
        args:
          - name: case-id
            type: uuid
            required: true
          - name: decision
            type: string
            required: true
            valid_values:
              [
                APPROVE,
                APPROVE_WITH_CONDITIONS,
                ESCALATE,
                REFER_TO_REGULATOR,
                DO_NOT_ONBOARD,
                REJECT,
              ]
          - name: decided-by
            type: string
            required: true
          - name: notes
            type: string
            required: false
        returns:
          type: boolean

  # ===========================================================================
  # DOMAIN: entity-workstream (Per-entity workstream within a KYC case)
  # ===========================================================================
  entity-workstream:
    description: "Per-entity workstream within a KYC case"

    verbs:
      create:
        description: "Create a new entity workstream"
        behavior: crud
        crud:
          operation: insert
          table: entity_workstreams
          schema: kyc
          returning: workstream_id
        emits_event: workstream.created
        args:
          - name: case-id
            type: uuid
            required: true
            maps_to: case_id
          - name: entity-id
            type: uuid
            required: true
            maps_to: entity_id
          - name: discovery-source-id
            type: uuid
            required: false
            maps_to: discovery_source_workstream_id
          - name: discovery-reason
            type: string
            required: false
            maps_to: discovery_reason
          - name: discovery-depth
            type: integer
            required: false
            maps_to: discovery_depth
            default: 1
          - name: ownership-percentage
            type: decimal
            required: false
            maps_to: ownership_percentage
          - name: is-ubo
            type: boolean
            required: false
            maps_to: is_ubo
            default: false
        returns:
          type: uuid
          name: workstream_id
          capture: true

      update-status:
        description: "Update workstream status"
        behavior: crud
        crud:
          operation: update
          table: entity_workstreams
          schema: kyc
          key: workstream_id
        emits_event: workstream.status-changed
        args:
          - name: workstream-id
            type: uuid
            required: true
            maps_to: workstream_id
          - name: status
            type: string
            required: true
            maps_to: status
            valid_values:
              [
                PENDING,
                COLLECT,
                VERIFY,
                SCREEN,
                ASSESS,
                COMPLETE,
                BLOCKED,
                ENHANCED_DD,
                REFERRED,
                PROHIBITED,
              ]
        returns:
          type: affected

      block:
        description: "Block workstream with reason"
        behavior: crud
        crud:
          operation: update
          table: entity_workstreams
          schema: kyc
          key: workstream_id
          set_values:
            status: BLOCKED
            blocked_at: now()
        emits_event: workstream.blocked
        args:
          - name: workstream-id
            type: uuid
            required: true
            maps_to: workstream_id
          - name: reason
            type: string
            required: true
            maps_to: blocked_reason
        returns:
          type: affected

      complete:
        description: "Mark workstream as complete"
        behavior: crud
        crud:
          operation: update
          table: entity_workstreams
          schema: kyc
          key: workstream_id
          set_values:
            status: COMPLETE
            completed_at: now()
        emits_event: workstream.completed
        args:
          - name: workstream-id
            type: uuid
            required: true
            maps_to: workstream_id
          - name: risk-rating
            type: string
            required: false
            maps_to: risk_rating
            valid_values: [LOW, MEDIUM, HIGH, VERY_HIGH]
        returns:
          type: affected

      set-enhanced-dd:
        description: "Flag workstream for enhanced due diligence"
        behavior: crud
        crud:
          operation: update
          table: entity_workstreams
          schema: kyc
          key: workstream_id
          set_values:
            requires_enhanced_dd: true
            status: ENHANCED_DD
        emits_event: workstream.enhanced-dd-set
        args:
          - name: workstream-id
            type: uuid
            required: true
            maps_to: workstream_id
        returns:
          type: affected

      set-ubo:
        description: "Mark workstream entity as UBO"
        behavior: crud
        crud:
          operation: update
          table: entity_workstreams
          schema: kyc
          key: workstream_id
          set_values:
            is_ubo: true
        emits_event: workstream.ubo-set
        args:
          - name: workstream-id
            type: uuid
            required: true
            maps_to: workstream_id
          - name: ownership-percentage
            type: decimal
            required: false
            maps_to: ownership_percentage
        returns:
          type: affected

      list-by-case:
        description: "List workstreams for a case"
        behavior: crud
        crud:
          operation: list_by_fk
          table: entity_workstreams
          schema: kyc
          fk_col: case_id
        args:
          - name: case-id
            type: uuid
            required: true
          - name: status
            type: string
            required: false
            maps_to: status
        returns:
          type: record_set

      read:
        description: "Read workstream details"
        behavior: crud
        crud:
          operation: select
          table: entity_workstreams
          schema: kyc
        args:
          - name: workstream-id
            type: uuid
            required: true
            maps_to: workstream_id
        returns:
          type: record

  # ===========================================================================
  # DOMAIN: red-flag (Risk indicators and issues)
  # ===========================================================================
  red-flag:
    description: "Risk indicators and issues requiring attention"

    verbs:
      raise:
        description: "Raise a new red flag"
        behavior: crud
        crud:
          operation: insert
          table: red_flags
          schema: kyc
          returning: red_flag_id
        emits_event: red-flag.raised
        args:
          - name: case-id
            type: uuid
            required: true
            maps_to: case_id
          - name: workstream-id
            type: uuid
            required: false
            maps_to: workstream_id
          - name: flag-type
            type: string
            required: true
            maps_to: flag_type
            valid_values:
              [
                SANCTIONS_MATCH,
                PEP_IDENTIFIED,
                ADVERSE_MEDIA,
                NOMINEE_UNDISCLOSED,
                OPAQUE_STRUCTURE,
                DOCUMENT_FRAUD,
                INCONSISTENT_INFO,
                HIGH_RISK_JURISDICTION,
                COMPLEX_STRUCTURE,
                SOURCE_OF_WEALTH_UNCLEAR,
                MISSING_UBO,
                SHELL_COMPANY,
                TAX_HAVEN,
                CASH_INTENSIVE,
                REGULATORY_ACTION,
                DOCUMENT_OVERDUE,
                SLA_BREACH,
              ]
          - name: severity
            type: string
            required: true
            maps_to: severity
            valid_values: [SOFT, ESCALATE, HARD_STOP]
          - name: description
            type: string
            required: true
            maps_to: description
          - name: source
            type: string
            required: false
            maps_to: source
            valid_values:
              [
                SCREENING,
                DOCUMENT_REVIEW,
                ANALYST,
                SYSTEM,
                RULE_ENGINE,
                EXTERNAL,
              ]
          - name: source-reference
            type: string
            required: false
            maps_to: source_reference
        returns:
          type: uuid
          name: red_flag_id
          capture: true

      mitigate:
        description: "Mark red flag as mitigated"
        behavior: crud
        crud:
          operation: update
          table: red_flags
          schema: kyc
          key: red_flag_id
          set_values:
            status: MITIGATED
            resolution_type: MITIGATED
            resolved_at: now()
        emits_event: red-flag.mitigated
        args:
          - name: red-flag-id
            type: uuid
            required: true
            maps_to: red_flag_id
          - name: notes
            type: string
            required: true
            maps_to: resolution_notes
        returns:
          type: affected

      waive:
        description: "Waive red flag with justification"
        behavior: crud
        crud:
          operation: update
          table: red_flags
          schema: kyc
          key: red_flag_id
          set_values:
            status: WAIVED
            resolution_type: WAIVED
            resolved_at: now()
        emits_event: red-flag.waived
        args:
          - name: red-flag-id
            type: uuid
            required: true
            maps_to: red_flag_id
          - name: justification
            type: string
            required: true
            maps_to: waiver_justification
          - name: approved-by
            type: uuid
            required: true
            maps_to: waiver_approved_by
        returns:
          type: affected

      dismiss:
        description: "Dismiss red flag as false positive"
        behavior: crud
        crud:
          operation: update
          table: red_flags
          schema: kyc
          key: red_flag_id
          set_values:
            status: CLOSED
            resolution_type: FALSE_POSITIVE
            resolved_at: now()
        emits_event: red-flag.dismissed
        args:
          - name: red-flag-id
            type: uuid
            required: true
            maps_to: red_flag_id
          - name: notes
            type: string
            required: true
            maps_to: resolution_notes
        returns:
          type: affected

      set-blocking:
        description: "Set red flag as blocking the case"
        behavior: crud
        crud:
          operation: update
          table: red_flags
          schema: kyc
          key: red_flag_id
          set_values:
            status: BLOCKING
        emits_event: red-flag.blocking
        args:
          - name: red-flag-id
            type: uuid
            required: true
            maps_to: red_flag_id
        returns:
          type: affected

      list-by-case:
        description: "List red flags for a case"
        behavior: crud
        crud:
          operation: list_by_fk
          table: red_flags
          schema: kyc
          fk_col: case_id
        args:
          - name: case-id
            type: uuid
            required: true
          - name: status
            type: string
            required: false
            maps_to: status
          - name: severity
            type: string
            required: false
            maps_to: severity
        returns:
          type: record_set

      list-by-workstream:
        description: "List red flags for a workstream"
        behavior: crud
        crud:
          operation: list_by_fk
          table: red_flags
          schema: kyc
          fk_col: workstream_id
        args:
          - name: workstream-id
            type: uuid
            required: true
          - name: status
            type: string
            required: false
            maps_to: status
        returns:
          type: record_set

      # -------------------------------------------------------------------------
      # Red-Flag Aggregation Verbs (Phase 4)
      # -------------------------------------------------------------------------

      aggregate:
        description: "Compute aggregated red-flag scores for a case"
        behavior: plugin
        plugin:
          handler: compute_case_redflag_score
        args:
          - name: case-id
            type: uuid
            required: true
        returns:
          type: record

      evaluate:
        description: "Evaluate case and create decision recommendation snapshot"
        behavior: plugin
        plugin:
          handler: evaluate_case_decision
        args:
          - name: case-id
            type: uuid
            required: true
          - name: evaluated-by
            type: string
            required: false
        returns:
          type: uuid
          name: snapshot_id
          capture: true

      list-evaluations:
        description: "List evaluation snapshots for a case"
        behavior: crud
        crud:
          operation: select
          table: case_evaluation_snapshots
          schema: ob-poc
        args:
          - name: case-id
            type: uuid
            required: true
            maps_to: case_id
          - name: limit
            type: integer
            required: false
            default: 10
        returns:
          type: record_set

  # ===========================================================================
  # DOMAIN: doc-request (Document collection and verification)
  # ===========================================================================
  doc-request:
    description: "Document collection and verification for KYC workstreams"

    verbs:
      create:
        description: "Create a document request"
        behavior: crud
        crud:
          operation: insert
          table: doc_requests
          schema: kyc
          returning: request_id
        emits_event: doc-request.created
        args:
          - name: workstream-id
            type: uuid
            required: true
            maps_to: workstream_id
          - name: doc-type
            type: string
            required: true
            maps_to: doc_type
            valid_values:
              [
                PASSPORT,
                NATIONAL_ID,
                DRIVERS_LICENSE,
                PROOF_OF_ADDRESS,
                CERT_OF_INCORPORATION,
                CERT_OF_GOOD_STANDING,
                MEMORANDUM_ARTICLES,
                REGISTER_OF_DIRECTORS,
                REGISTER_OF_SHAREHOLDERS,
                ANNUAL_RETURN,
                TRUST_DEED,
                LETTER_OF_WISHES,
                DEED_OF_APPOINTMENT,
                BANK_STATEMENT,
                SOURCE_OF_WEALTH,
                SOURCE_OF_FUNDS,
                FINANCIAL_STATEMENTS,
                TAX_RETURN,
                REGULATORY_LICENSE,
                POWER_OF_ATTORNEY,
                BOARD_RESOLUTION,
                SIGNATORY_LIST,
              ]
          - name: due-date
            type: date
            required: false
            maps_to: due_date
          - name: is-mandatory
            type: boolean
            required: false
            maps_to: is_mandatory
            default: true
          - name: priority
            type: string
            required: false
            maps_to: priority
            default: "NORMAL"
            valid_values: [LOW, NORMAL, HIGH, URGENT]
        returns:
          type: uuid
          name: request_id
          capture: true

      mark-requested:
        description: "Mark document as formally requested"
        behavior: crud
        crud:
          operation: update
          table: doc_requests
          schema: kyc
          key: request_id
          set_values:
            status: REQUESTED
            requested_at: now()
        emits_event: doc-request.requested
        args:
          - name: request-id
            type: uuid
            required: true
            maps_to: request_id
        returns:
          type: affected

      receive:
        description: "Record document received"
        behavior: crud
        crud:
          operation: update
          table: doc_requests
          schema: kyc
          key: request_id
          set_values:
            status: RECEIVED
            received_at: now()
        emits_event: doc-request.received
        args:
          - name: request-id
            type: uuid
            required: true
            maps_to: request_id
          - name: document-id
            type: uuid
            required: true
            maps_to: document_id
        returns:
          type: affected

      verify:
        description: "Verify document as valid"
        behavior: crud
        crud:
          operation: update
          table: doc_requests
          schema: kyc
          key: request_id
          set_values:
            status: VERIFIED
            verified_at: now()
        emits_event: doc-request.verified
        args:
          - name: request-id
            type: uuid
            required: true
            maps_to: request_id
          - name: notes
            type: string
            required: false
            maps_to: verification_notes
        returns:
          type: affected

      reject:
        description: "Reject document"
        behavior: crud
        crud:
          operation: update
          table: doc_requests
          schema: kyc
          key: request_id
          set_values:
            status: REJECTED
        emits_event: doc-request.rejected
        args:
          - name: request-id
            type: uuid
            required: true
            maps_to: request_id
          - name: reason
            type: string
            required: true
            maps_to: rejection_reason
        returns:
          type: affected

      waive:
        description: "Waive document requirement"
        behavior: crud
        crud:
          operation: update
          table: doc_requests
          schema: kyc
          key: request_id
          set_values:
            status: WAIVED
        emits_event: doc-request.waived
        args:
          - name: request-id
            type: uuid
            required: true
            maps_to: request_id
          - name: notes
            type: string
            required: true
            maps_to: verification_notes
        returns:
          type: affected

      list-by-workstream:
        description: "List document requests for a workstream"
        behavior: crud
        crud:
          operation: list_by_fk
          table: doc_requests
          schema: kyc
          fk_col: workstream_id
        args:
          - name: workstream-id
            type: uuid
            required: true
          - name: status
            type: string
            required: false
            maps_to: status
        returns:
          type: record_set

  # ===========================================================================
  # DOMAIN: case-screening (Screenings within KYC case workstreams)
  # ===========================================================================
  case-screening:
    description: "Sanctions, PEP, and adverse media screening for KYC workstreams"

    verbs:
      run:
        description: "Initiate a screening"
        behavior: crud
        crud:
          operation: insert
          table: screenings
          schema: kyc
          returning: screening_id
        emits_event: screening.started
        args:
          - name: workstream-id
            type: uuid
            required: true
            maps_to: workstream_id
          - name: screening-type
            type: string
            required: true
            maps_to: screening_type
            valid_values:
              [
                SANCTIONS,
                PEP,
                ADVERSE_MEDIA,
                CREDIT,
                CRIMINAL,
                REGULATORY,
                CONSOLIDATED,
              ]
          - name: provider
            type: string
            required: false
            maps_to: provider
        returns:
          type: uuid
          name: screening_id
          capture: true

      complete:
        description: "Record screening completion"
        behavior: crud
        crud:
          operation: update
          table: screenings
          schema: kyc
          key: screening_id
          set_values:
            completed_at: now()
        emits_event: screening.completed
        args:
          - name: screening-id
            type: uuid
            required: true
            maps_to: screening_id
          - name: status
            type: string
            required: true
            maps_to: status
            valid_values: [CLEAR, HIT_PENDING_REVIEW, ERROR]
          - name: result-summary
            type: string
            required: false
            maps_to: result_summary
          - name: match-count
            type: integer
            required: false
            maps_to: match_count
        returns:
          type: affected

      review-hit:
        description: "Review a screening hit"
        behavior: crud
        crud:
          operation: update
          table: screenings
          schema: kyc
          key: screening_id
          set_values:
            reviewed_at: now()
        emits_event: screening.reviewed
        args:
          - name: screening-id
            type: uuid
            required: true
            maps_to: screening_id
          - name: status
            type: string
            required: true
            maps_to: status
            valid_values: [HIT_CONFIRMED, HIT_DISMISSED]
          - name: notes
            type: string
            required: true
            maps_to: review_notes
          - name: red-flag-id
            type: uuid
            required: false
            maps_to: red_flag_id
        returns:
          type: affected

      list-by-workstream:
        description: "List screenings for a workstream"
        behavior: crud
        crud:
          operation: list_by_fk
          table: screenings
          schema: kyc
          fk_col: workstream_id
        args:
          - name: workstream-id
            type: uuid
            required: true
          - name: screening-type
            type: string
            required: false
            maps_to: screening_type
          - name: status
            type: string
            required: false
            maps_to: status
        returns:
          type: record_set

  # ===========================================================================
  # DOMAIN: case-event (Audit trail for case activities)
  # ===========================================================================
  case-event:
    description: "Audit trail for KYC case activities"

    verbs:
      log:
        description: "Log a case event"
        behavior: crud
        crud:
          operation: insert
          table: case_events
          schema: kyc
          returning: event_id
        args:
          - name: case-id
            type: uuid
            required: true
            maps_to: case_id
          - name: workstream-id
            type: uuid
            required: false
            maps_to: workstream_id
          - name: event-type
            type: string
            required: true
            maps_to: event_type
          - name: event-data
            type: json
            required: false
            maps_to: event_data
          - name: actor-id
            type: uuid
            required: false
            maps_to: actor_id
          - name: actor-type
            type: string
            required: false
            maps_to: actor_type
            default: "USER"
            valid_values: [USER, SYSTEM, RULE_ENGINE, INTEGRATION]
          - name: comment
            type: string
            required: false
            maps_to: comment
        returns:
          type: uuid
          name: event_id
          capture: false

      list-by-case:
        description: "List events for a case"
        behavior: crud
        crud:
          operation: list_by_fk
          table: case_events
          schema: kyc
          fk_col: case_id
        args:
          - name: case-id
            type: uuid
            required: true
          - name: event-type
            type: string
            required: false
            maps_to: event_type

  # ===========================================================================
  # DOMAIN: allegation (Client Allegations - KYC starting point)
  # ===========================================================================
  allegation:
    description: "Client allegations - unverified claims that start the KYC process"

    verbs:
      record:
        description: "Record a client allegation about an entity attribute"
        behavior: crud
        crud:
          operation: insert
          table: client_allegations
          schema: ob-poc
          returning: allegation_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
          - name: entity-id
            type: uuid
            required: true
            maps_to: entity_id
          - name: attribute-id
            type: uuid
            required: true
            maps_to: attribute_id
          - name: value
            type: json
            required: true
            maps_to: alleged_value
          - name: display-value
            type: string
            required: false
            maps_to: alleged_value_display
          - name: source
            type: string
            required: true
            maps_to: allegation_source
          - name: source-reference
            type: string
            required: false
            maps_to: allegation_reference
          - name: case-id
            type: uuid
            required: false
            maps_to: case_id
          - name: workstream-id
            type: uuid
            required: false
            maps_to: workstream_id
        returns:
          type: uuid
          name: allegation_id
          capture: true

      verify:
        description: "Mark allegation as verified by an observation"
        behavior: crud
        crud:
          operation: update
          table: client_allegations
          schema: ob-poc
          key: allegation_id
          set_values:
            verification_status: VERIFIED
            verified_at: "now()"
        args:
          - name: allegation-id
            type: uuid
            required: true
            maps_to: allegation_id
          - name: observation-id
            type: uuid
            required: true
            maps_to: verified_by_observation_id
          - name: result
            type: string
            required: false
            maps_to: verification_result
          - name: notes
            type: string
            required: false
            maps_to: verification_notes
        returns:
          type: affected

      contradict:
        description: "Mark allegation as contradicted by evidence"
        behavior: crud
        crud:
          operation: update
          table: client_allegations
          schema: ob-poc
          key: allegation_id
          set_values:
            verification_status: CONTRADICTED
            verified_at: "now()"
        args:
          - name: allegation-id
            type: uuid
            required: true
            maps_to: allegation_id
          - name: observation-id
            type: uuid
            required: true
            maps_to: verified_by_observation_id
          - name: result
            type: string
            required: false
            maps_to: verification_result
          - name: notes
            type: string
            required: true
            maps_to: verification_notes
        returns:
          type: affected

      mark-partial:
        description: "Mark allegation as partially verified"
        behavior: crud
        crud:
          operation: update
          table: client_allegations
          schema: ob-poc
          key: allegation_id
          set_values:
            verification_status: PARTIAL
            verified_at: "now()"
        args:
          - name: allegation-id
            type: uuid
            required: true
            maps_to: allegation_id
          - name: observation-id
            type: uuid
            required: true
            maps_to: verified_by_observation_id
          - name: notes
            type: string
            required: true
            maps_to: verification_notes
        returns:
          type: affected

      list-by-entity:
        description: "List allegations for an entity"
        behavior: crud
        crud:
          operation: list_by_fk
          table: client_allegations
          schema: ob-poc
          fk_col: entity_id
        args:
          - name: entity-id
            type: uuid
            required: true
          - name: status
            type: string
            required: false
            maps_to: verification_status
        returns:
          type: record_set

      list-pending:
        description: "List pending allegations for a CBU"
        behavior: crud
        crud:
          operation: select
          table: client_allegations
          schema: ob-poc
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
        returns:
          type: record_set

  # ===========================================================================
  # DOMAIN: observation (Attribute Observations from various sources)
  # ===========================================================================
  observation:
    description: "Attribute observations from various sources"

    verbs:
      record:
        description: "Record an attribute observation"
        behavior: crud
        crud:
          operation: insert
          table: attribute_observations
          schema: ob-poc
          returning: observation_id
        args:
          - name: entity-id
            type: uuid
            required: true
            maps_to: entity_id
          - name: attribute-id
            type: uuid
            required: true
            maps_to: attribute_id
          - name: value-text
            type: string
            required: false
            maps_to: value_text
          - name: value-number
            type: decimal
            required: false
            maps_to: value_number
          - name: value-boolean
            type: boolean
            required: false
            maps_to: value_boolean
          - name: value-date
            type: date
            required: false
            maps_to: value_date
          - name: value-json
            type: json
            required: false
            maps_to: value_json
          - name: source-type
            type: string
            required: true
            maps_to: source_type
          - name: source-document-id
            type: uuid
            required: false
            maps_to: source_document_id
          - name: confidence
            type: decimal
            required: false
            maps_to: confidence
          - name: is-authoritative
            type: boolean
            required: false
            maps_to: is_authoritative
          - name: extraction-method
            type: string
            required: false
            maps_to: extraction_method
        returns:
          type: uuid
          name: observation_id
          capture: true

      record-from-document:
        description: "Record observation extracted from a document"
        behavior: plugin
        handler: observation_from_document
        args:
          - name: entity-id
            type: uuid
            required: true
          - name: document-id
            type: uuid
            required: true
          - name: attribute
            type: string
            required: true
          - name: value
            type: string
            required: true
          - name: extraction-method
            type: string
            required: false
          - name: confidence
            type: decimal
            required: false
        returns:
          type: uuid
          name: observation_id
          capture: true

      supersede:
        description: "Supersede an observation with a newer one"
        behavior: crud
        crud:
          operation: update
          table: attribute_observations
          schema: ob-poc
          key: observation_id
          set_values:
            status: SUPERSEDED
            superseded_at: "now()"
        args:
          - name: observation-id
            type: uuid
            required: true
            maps_to: observation_id
          - name: superseded-by
            type: uuid
            required: true
            maps_to: superseded_by
        returns:
          type: affected

      list-for-entity:
        description: "List all observations for an entity"
        behavior: crud
        crud:
          operation: list_by_fk
          table: attribute_observations
          schema: ob-poc
          fk_col: entity_id
        args:
          - name: entity-id
            type: uuid
            required: true
          - name: status
            type: string
            required: false
            maps_to: status
        returns:
          type: record_set

      list-for-attribute:
        description: "List observations of a specific attribute for an entity"
        behavior: crud
        crud:
          operation: select
          table: attribute_observations
          schema: ob-poc
        args:
          - name: entity-id
            type: uuid
            required: true
            maps_to: entity_id
          - name: attribute-id
            type: uuid
            required: true
            maps_to: attribute_id
          - name: status
            type: string
            required: false
            maps_to: status
        returns:
          type: record_set

      get-current:
        description: "Get current best observation for an attribute"
        behavior: plugin
        handler: observation_get_current
        args:
          - name: entity-id
            type: uuid
            required: true
          - name: attribute
            type: string
            required: true
        returns:
          type: record

      reconcile:
        description: "Compare observations for an attribute and auto-create discrepancies"
        behavior: plugin
        handler: observation_reconcile
        args:
          - name: entity-id
            type: uuid
            required: true
          - name: attribute
            type: string
            required: true
          - name: case-id
            type: uuid
            required: false
          - name: auto-create-discrepancies
            type: boolean
            required: false
            default: true
        returns:
          type: record_set

      verify-allegations:
        description: "Batch verify pending allegations against observations"
        behavior: plugin
        handler: observation_verify_allegations
        args:
          - name: cbu-id
            type: uuid
            required: true
          - name: entity-id
            type: uuid
            required: true
          - name: case-id
            type: uuid
            required: false
        returns:
          type: record_set

  # ===========================================================================
  # DOMAIN: discrepancy (Observation Discrepancies)
  # ===========================================================================
  discrepancy:
    description: "Observation discrepancies - conflicts between attribute observations"

    verbs:
      record:
        description: "Record a discrepancy between observations"
        behavior: crud
        crud:
          operation: insert
          table: observation_discrepancies
          schema: ob-poc
          returning: discrepancy_id
        args:
          - name: entity-id
            type: uuid
            required: true
            maps_to: entity_id
          - name: attribute-id
            type: uuid
            required: true
            maps_to: attribute_id
          - name: observation-1-id
            type: uuid
            required: true
            maps_to: observation_1_id
          - name: observation-2-id
            type: uuid
            required: true
            maps_to: observation_2_id
          - name: type
            type: string
            required: true
            maps_to: discrepancy_type
          - name: severity
            type: string
            required: true
            maps_to: severity
          - name: description
            type: string
            required: true
            maps_to: description
          - name: value-1-display
            type: string
            required: false
            maps_to: value_1_display
          - name: value-2-display
            type: string
            required: false
            maps_to: value_2_display
          - name: case-id
            type: uuid
            required: false
            maps_to: case_id
          - name: workstream-id
            type: uuid
            required: false
            maps_to: workstream_id
        returns:
          type: uuid
          name: discrepancy_id
          capture: true

      resolve:
        description: "Resolve a discrepancy"
        behavior: crud
        crud:
          operation: update
          table: observation_discrepancies
          schema: ob-poc
          key: discrepancy_id
          set_values:
            resolution_status: RESOLVED
            resolved_at: "now()"
        args:
          - name: discrepancy-id
            type: uuid
            required: true
            maps_to: discrepancy_id
          - name: resolution-type
            type: string
            required: true
            maps_to: resolution_type
          - name: accepted-observation-id
            type: uuid
            required: false
            maps_to: accepted_observation_id
          - name: notes
            type: string
            required: false
            maps_to: resolution_notes
          - name: resolved-by
            type: string
            required: false
            maps_to: resolved_by
        returns:
          type: affected

      escalate:
        description: "Escalate a discrepancy"
        behavior: crud
        crud:
          operation: update
          table: observation_discrepancies
          schema: ob-poc
          key: discrepancy_id
          set_values:
            resolution_status: ESCALATED
        args:
          - name: discrepancy-id
            type: uuid
            required: true
            maps_to: discrepancy_id
          - name: notes
            type: string
            required: false
            maps_to: resolution_notes
        returns:
          type: affected

      list-open:
        description: "List open discrepancies"
        behavior: crud
        crud:
          operation: select
          table: observation_discrepancies
          schema: ob-poc
        args:
          - name: entity-id
            type: uuid
            required: false
            maps_to: entity_id
          - name: case-id
            type: uuid
            required: false
            maps_to: case_id
          - name: severity
            type: string
            required: false
            maps_to: severity
        returns:
          type: record_set

  # ===========================================================================
  # DOMAIN: threshold (KYC Threshold Computation)
  # ===========================================================================
  threshold:
    description: "KYC threshold computation and evaluation"

    verbs:
      derive:
        description: "Compute KYC requirements based on CBU risk factors"
        behavior: plugin
        plugin:
          handler: threshold_derive
        args:
          - name: cbu-id
            type: uuid
            required: true
        returns:
          type: json
          capture: true
          description: |
            Returns risk_score, risk_band, factors[], entity_requirements[], screening_requirements

      evaluate:
        description: "Check if CBU meets threshold requirements"
        behavior: plugin
        plugin:
          handler: threshold_evaluate
        args:
          - name: cbu-id
            type: uuid
            required: true
          - name: requirements
            type: json
            required: false
            description: "Pre-computed requirements (if not provided, derives them)"
        returns:
          type: json
          capture: true
          description: |
            Returns overall_status (COMPLETE|INCOMPLETE|BLOCKED), entities[], gaps[], blocking[]

      check-entity:
        description: "Check single entity against requirements"
        behavior: plugin
        plugin:
          handler: threshold_check_entity
        args:
          - name: entity-id
            type: uuid
            required: true
          - name: role
            type: string
            required: true
          - name: risk-band
            type: string
            required: true
        returns:
          type: json
          capture: true

  # ===========================================================================
  # DOMAIN: rfi (Request for Information)
  # ===========================================================================
  rfi:
    description: "Request for Information - batch document request operations using kyc.doc_requests"

    verbs:
      # NOTE: RFI operations work with the existing kyc.doc_requests table,
      # not separate RFI tables. "RFI" is a batch concept that generates
      # multiple doc_requests based on threshold requirements.

      generate:
        description: "Generate doc_requests from threshold requirements for a case"
        behavior: plugin
        plugin:
          handler: rfi_generate
        args:
          - name: case-id
            type: uuid
            required: true
          - name: batch-reference
            type: string
            required: false
            description: "Optional batch reference (auto-generated if not provided)"
        returns:
          type: json
          capture: true

      check-completion:
        description: "Check document completion status for a case"
        behavior: plugin
        plugin:
          handler: rfi_check_completion
        args:
          - name: case-id
            type: uuid
            required: true
        returns:
          type: json
          capture: true

      list-by-case:
        description: "List all doc_requests for a case"
        behavior: plugin
        plugin:
          handler: rfi_list_by_case
        args:
          - name: case-id
            type: uuid
            required: true
          - name: status
            type: string
            required: false
            valid_values:
              [
                DRAFT,
                REQUIRED,
                REQUESTED,
                RECEIVED,
                UNDER_REVIEW,
                VERIFIED,
                REJECTED,
                WAIVED,
                EXPIRED,
              ]
        returns:
          type: record_set

  # ===========================================================================
  # DOMAIN: debug (Inspection and debugging utilities)
  # ===========================================================================
  debug:
    description: "Inspection and debugging utilities for development and testing"

    verbs:
      dump-cbu:
        description: "Dump complete CBU state as YAML for inspection"
        behavior: plugin
        plugin:
          handler: debug_dump_cbu
        args:
          - name: cbu-id
            type: uuid
            required: true
          - name: include-entities
            type: boolean
            required: false
            default: true
          - name: include-roles
            type: boolean
            required: false
            default: true
          - name: include-evidence
            type: boolean
            required: false
            default: true
          - name: include-ubos
            type: boolean
            required: false
            default: true
          - name: format
            type: string
            required: false
            default: "yaml"
            valid_values: [yaml, json]
        returns:
          type: string
          capture: true

      dump-case:
        description: "Dump complete KYC case state as YAML for inspection"
        behavior: plugin
        plugin:
          handler: debug_dump_case
        args:
          - name: case-id
            type: uuid
            required: true
          - name: include-workstreams
            type: boolean
            required: false
            default: true
          - name: include-red-flags
            type: boolean
            required: false
            default: true
          - name: include-screenings
            type: boolean
            required: false
            default: true
          - name: include-doc-requests
            type: boolean
            required: false
            default: true
          - name: format
            type: string
            required: false
            default: "yaml"
            valid_values: [yaml, json]
        returns:
          type: string
          capture: true

      checkpoint:
        description: "Log a named checkpoint with CBU/case state for test review"
        behavior: plugin
        plugin:
          handler: debug_checkpoint
        args:
          - name: name
            type: string
            required: true
          - name: cbu-id
            type: uuid
            required: false
          - name: case-id
            type: uuid
            required: false
          - name: message
            type: string
            required: false
        returns:
          type: uuid
          name: checkpoint_id
          capture: true

      list-dsl-instances:
        description: "List DSL instances persisted in the database"
        behavior: crud
        crud:
          operation: select
          table: dsl_instances
          schema: ob-poc
        args:
          - name: business-reference
            type: string
            required: false
            maps_to: business_reference
          - name: domain
            type: string
            required: false
            maps_to: domain
          - name: limit
            type: integer
            required: false
            default: 20
        returns:
          type: record_set

      get-dsl-source:
        description: "Get DSL source code for an instance"
        behavior: crud
        crud:
          operation: select
          table: dsl_instance_versions
          schema: ob-poc
        args:
          - name: instance-id
            type: uuid
            required: true
            maps_to: instance_id
          - name: version
            type: integer
            required: false
            maps_to: version_number
        returns:
          type: record
