version: "1.0"

# =============================================================================
# DOMAIN: cbu (Client Business Unit)
# =============================================================================
domains:
  cbu:
    description: "Client Business Unit operations"

    verbs:
      create:
        description: "Create a new Client Business Unit"
        behavior: crud
        crud:
          operation: insert
          table: cbus
          schema: ob-poc
          returning: cbu_id
        args:
          - name: name
            type: string
            required: true
            maps_to: name
          - name: jurisdiction
            type: string
            required: false
            maps_to: jurisdiction
          - name: client-type
            type: string
            required: false
            maps_to: client_type
          - name: nature-purpose
            type: string
            required: false
            maps_to: nature_purpose
          - name: description
            type: string
            required: false
            maps_to: description
        returns:
          type: uuid
          name: cbu_id
          capture: true

      read:
        description: "Read a CBU by ID"
        behavior: crud
        crud:
          operation: select
          table: cbus
          schema: ob-poc
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
        returns:
          type: record

      update:
        description: "Update a CBU"
        behavior: crud
        crud:
          operation: update
          table: cbus
          schema: ob-poc
          key: cbu_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
          - name: name
            type: string
            required: false
            maps_to: name
          - name: status
            type: string
            required: false
            maps_to: status
          - name: client-type
            type: string
            required: false
            maps_to: client_type
          - name: jurisdiction
            type: string
            required: false
            maps_to: jurisdiction
        returns:
          type: affected

      delete:
        description: "Delete a CBU"
        behavior: crud
        crud:
          operation: delete
          table: cbus
          schema: ob-poc
          key: cbu_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
        returns:
          type: affected

      list:
        description: "List CBUs with optional filters"
        behavior: crud
        crud:
          operation: select
          table: cbus
          schema: ob-poc
        args:
          - name: status
            type: string
            required: false
            maps_to: status
          - name: client-type
            type: string
            required: false
            maps_to: client_type
          - name: jurisdiction
            type: string
            required: false
            maps_to: jurisdiction
          - name: limit
            type: integer
            required: false
            default: 100
          - name: offset
            type: integer
            required: false
            default: 0
        returns:
          type: record_set

      ensure:
        description: "Create or update a CBU by natural key"
        behavior: crud
        crud:
          operation: upsert
          table: cbus
          schema: ob-poc
          conflict_keys: [name, jurisdiction]
          returning: cbu_id
        args:
          - name: name
            type: string
            required: true
            maps_to: name
          - name: jurisdiction
            type: string
            required: false
            maps_to: jurisdiction
          - name: client-type
            type: string
            required: false
            maps_to: client_type
          - name: nature-purpose
            type: string
            required: false
            maps_to: nature_purpose
        returns:
          type: uuid
          name: cbu_id
          capture: true

      assign-role:
        description: "Assign a role to an entity within a CBU"
        behavior: crud
        crud:
          operation: role_link
          junction: cbu_entity_roles
          schema: ob-poc
          from_col: cbu_id
          to_col: entity_id
          role_table: roles
          role_col: role_id
          returning: cbu_entity_role_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
          - name: entity-id
            type: uuid
            required: true
            maps_to: entity_id
          - name: role
            type: lookup
            required: true
            lookup:
              table: roles
              code_column: name
              id_column: role_id
        returns:
          type: uuid
          name: cbu_entity_role_id
          capture: false

      remove-role:
        description: "Remove a specific role from an entity within a CBU"
        behavior: crud
        crud:
          operation: role_unlink
          junction: cbu_entity_roles
          schema: ob-poc
          from_col: cbu_id
          to_col: entity_id
          role_table: roles
        args:
          - name: cbu-id
            type: uuid
            required: true
          - name: entity-id
            type: uuid
            required: true
          - name: role
            type: lookup
            required: true
            lookup:
              table: roles
              code_column: name
              id_column: role_id
        returns:
          type: affected

      parties:
        description: "List all parties (entities with their roles) for a CBU"
        behavior: crud
        crud:
          operation: list_parties
          junction: cbu_entity_roles
          schema: ob-poc
          fk_col: cbu_id
        args:
          - name: cbu-id
            type: uuid
            required: true
        returns:
          type: record_set

  # ===========================================================================
  # DOMAIN: entity
  # ===========================================================================
  entity:
    description: "Entity management operations"

    # Dynamic verb generation from entity_types table
    dynamic_verbs:
      - pattern: "create-{type_code}"
        source:
          table: entity_types
          schema: ob-poc
          code_column: type_code
          name_column: name
          transform: kebab_case
        behavior: crud
        crud:
          operation: entity_create
          base_table: entities
          schema: ob-poc
          extension_table_column: table_name
          type_id_column: entity_type_id
          returning: entity_id
        base_args:
          - name: name
            type: string
            required: true
            maps_to: name
          - name: jurisdiction
            type: string
            required: false
            maps_to: jurisdiction

    verbs:
      # Static fallback verbs for common entity types (used when DB not available)
      create-limited-company:
        description: "Create a limited company entity"
        behavior: crud
        crud:
          operation: entity_create
          base_table: entities
          schema: ob-poc
          extension_table_column: table_name
          type_id_column: entity_type_id
          returning: entity_id
        args:
          - name: name
            type: string
            required: true
            maps_to: company_name
          - name: cbu-id
            type: uuid
            required: false
          - name: company-number
            type: string
            required: false
            maps_to: registration_number
          - name: jurisdiction
            type: string
            required: false
            maps_to: jurisdiction
        returns:
          type: uuid
          name: entity_id
          capture: true

      create-proper-person:
        description: "Create a natural person entity"
        behavior: crud
        crud:
          operation: entity_create
          base_table: entities
          schema: ob-poc
          extension_table_column: table_name
          type_id_column: entity_type_id
          returning: entity_id
        args:
          - name: first-name
            type: string
            required: true
            maps_to: first_name
          - name: last-name
            type: string
            required: true
            maps_to: last_name
          - name: cbu-id
            type: uuid
            required: false
          - name: date-of-birth
            type: date
            required: false
            maps_to: date_of_birth
          - name: nationality
            type: string
            required: false
            maps_to: nationality
        returns:
          type: uuid
          name: entity_id
          capture: true

      create-trust-discretionary:
        description: "Create a discretionary trust entity"
        behavior: crud
        crud:
          operation: entity_create
          base_table: entities
          schema: ob-poc
          extension_table_column: table_name
          type_id_column: entity_type_id
          returning: entity_id
        args:
          - name: name
            type: string
            required: true
            maps_to: trust_name
          - name: cbu-id
            type: uuid
            required: false
          - name: jurisdiction
            type: string
            required: true
            maps_to: jurisdiction
          - name: establishment-date
            type: date
            required: false
            maps_to: establishment_date
          - name: trust-purpose
            type: string
            required: false
            maps_to: trust_purpose
        returns:
          type: uuid
          name: entity_id
          capture: true

      create-partnership-limited:
        description: "Create a limited partnership entity"
        behavior: crud
        crud:
          operation: entity_create
          base_table: entities
          schema: ob-poc
          extension_table_column: table_name
          type_id_column: entity_type_id
          returning: entity_id
        args:
          - name: name
            type: string
            required: true
            maps_to: partnership_name
          - name: cbu-id
            type: uuid
            required: false
          - name: jurisdiction
            type: string
            required: false
            maps_to: jurisdiction
          - name: formation-date
            type: date
            required: false
            maps_to: formation_date
        returns:
          type: uuid
          name: entity_id
          capture: true

      read:
        description: "Read an entity by ID"
        behavior: crud
        crud:
          operation: select
          table: entities
          schema: ob-poc
        args:
          - name: entity-id
            type: uuid
            required: true
            maps_to: entity_id
        returns:
          type: record

      update:
        description: "Update an entity's base fields"
        behavior: crud
        crud:
          operation: update
          table: entities
          schema: ob-poc
          key: entity_id
        args:
          - name: entity-id
            type: uuid
            required: true
            maps_to: entity_id
          - name: name
            type: string
            required: false
            maps_to: name
          - name: status
            type: string
            required: false
            maps_to: status
          - name: jurisdiction
            type: string
            required: false
            maps_to: jurisdiction
        returns:
          type: affected

      delete:
        description: "Delete an entity (cascades to type extension)"
        behavior: crud
        crud:
          operation: delete
          table: entities
          schema: ob-poc
          key: entity_id
        args:
          - name: entity-id
            type: uuid
            required: true
            maps_to: entity_id
        returns:
          type: affected

      list:
        description: "List entities with optional filters"
        behavior: crud
        crud:
          operation: select
          table: entities
          schema: ob-poc
        args:
          - name: entity-type
            type: string
            required: false
          - name: jurisdiction
            type: string
            required: false
            maps_to: jurisdiction
          - name: status
            type: string
            required: false
            maps_to: status
          - name: limit
            type: integer
            required: false
            default: 100
          - name: offset
            type: integer
            required: false
            default: 0
        returns:
          type: record_set

  # ===========================================================================
  # DOMAIN: product
  # ===========================================================================
  product:
    description: "Product catalog operations"

    verbs:
      create:
        description: "Create a new product in the catalog"
        behavior: crud
        crud:
          operation: insert
          table: products
          schema: ob-poc
          returning: product_id
        args:
          - name: name
            type: string
            required: true
            maps_to: name
          - name: product-code
            type: string
            required: true
            maps_to: product_code
          - name: description
            type: string
            required: false
            maps_to: description
          - name: product-category
            type: string
            required: false
            maps_to: product_category
          - name: regulatory-framework
            type: string
            required: false
            maps_to: regulatory_framework
          - name: min-asset-requirement
            type: decimal
            required: false
            maps_to: min_asset_requirement
          - name: metadata
            type: json
            required: false
            maps_to: metadata
        returns:
          type: uuid
          name: product_id
          capture: true

      read:
        description: "Read a product by ID or code"
        behavior: crud
        crud:
          operation: select
          table: products
          schema: ob-poc
        args:
          - name: product-id
            type: uuid
            required: false
            maps_to: product_id
          - name: product-code
            type: string
            required: false
            maps_to: product_code
        returns:
          type: record

      update:
        description: "Update a product"
        behavior: crud
        crud:
          operation: update
          table: products
          schema: ob-poc
          key: product_id
        args:
          - name: product-id
            type: uuid
            required: true
            maps_to: product_id
          - name: name
            type: string
            required: false
            maps_to: name
          - name: description
            type: string
            required: false
            maps_to: description
          - name: is-active
            type: boolean
            required: false
            maps_to: is_active
          - name: product-category
            type: string
            required: false
            maps_to: product_category
        returns:
          type: affected

      delete:
        description: "Delete a product"
        behavior: crud
        crud:
          operation: delete
          table: products
          schema: ob-poc
          key: product_id
        args:
          - name: product-id
            type: uuid
            required: true
            maps_to: product_id
        returns:
          type: affected

      list:
        description: "List products with optional filters"
        behavior: crud
        crud:
          operation: select
          table: products
          schema: ob-poc
        args:
          - name: product-category
            type: string
            required: false
            maps_to: product_category
          - name: is-active
            type: boolean
            required: false
            maps_to: is_active
          - name: limit
            type: integer
            required: false
            default: 100
          - name: offset
            type: integer
            required: false
            default: 0
        returns:
          type: record_set

      ensure:
        description: "Create or update a product by product-code"
        behavior: crud
        crud:
          operation: upsert
          table: products
          schema: ob-poc
          conflict_keys: [product_code]
          returning: product_id
        args:
          - name: name
            type: string
            required: true
            maps_to: name
          - name: product-code
            type: string
            required: true
            maps_to: product_code
          - name: description
            type: string
            required: false
            maps_to: description
          - name: product-category
            type: string
            required: false
            maps_to: product_category
          - name: regulatory-framework
            type: string
            required: false
            maps_to: regulatory_framework
        returns:
          type: uuid
          name: product_id
          capture: true

  # ===========================================================================
  # DOMAIN: service
  # ===========================================================================
  service:
    description: "Service catalog operations"

    verbs:
      create:
        description: "Create a new service in the catalog"
        behavior: crud
        crud:
          operation: insert
          table: services
          schema: ob-poc
          returning: service_id
        args:
          - name: name
            type: string
            required: true
            maps_to: name
          - name: service-code
            type: string
            required: true
            maps_to: service_code
          - name: description
            type: string
            required: false
            maps_to: description
          - name: service-type
            type: string
            required: false
            maps_to: service_type
          - name: is-active
            type: boolean
            required: false
            maps_to: is_active
            default: true
        returns:
          type: uuid
          name: service_id
          capture: true

      read:
        description: "Read a service by ID or code"
        behavior: crud
        crud:
          operation: select
          table: services
          schema: ob-poc
        args:
          - name: service-id
            type: uuid
            required: false
            maps_to: service_id
          - name: service-code
            type: string
            required: false
            maps_to: service_code
        returns:
          type: record

      update:
        description: "Update a service"
        behavior: crud
        crud:
          operation: update
          table: services
          schema: ob-poc
          key: service_id
        args:
          - name: service-id
            type: uuid
            required: true
            maps_to: service_id
          - name: name
            type: string
            required: false
            maps_to: name
          - name: description
            type: string
            required: false
            maps_to: description
          - name: is-active
            type: boolean
            required: false
            maps_to: is_active
          - name: service-type
            type: string
            required: false
            maps_to: service_type
        returns:
          type: affected

      delete:
        description: "Delete a service"
        behavior: crud
        crud:
          operation: delete
          table: services
          schema: ob-poc
          key: service_id
        args:
          - name: service-id
            type: uuid
            required: true
            maps_to: service_id
        returns:
          type: affected

      list:
        description: "List services with optional filters"
        behavior: crud
        crud:
          operation: select
          table: services
          schema: ob-poc
        args:
          - name: service-type
            type: string
            required: false
            maps_to: service_type
          - name: is-active
            type: boolean
            required: false
            maps_to: is_active
          - name: limit
            type: integer
            required: false
            default: 100
          - name: offset
            type: integer
            required: false
            default: 0
        returns:
          type: record_set

      ensure:
        description: "Create or update a service by service-code"
        behavior: crud
        crud:
          operation: upsert
          table: services
          schema: ob-poc
          conflict_keys: [service_code]
          returning: service_id
        args:
          - name: name
            type: string
            required: true
            maps_to: name
          - name: service-code
            type: string
            required: true
            maps_to: service_code
          - name: description
            type: string
            required: false
            maps_to: description
          - name: service-type
            type: string
            required: false
            maps_to: service_type
        returns:
          type: uuid
          name: service_id
          capture: true

      link-product:
        description: "Link a service to a product"
        behavior: crud
        crud:
          operation: link
          junction: product_services
          schema: ob-poc
          from_col: service_id
          to_col: product_id
        args:
          - name: service-id
            type: uuid
            required: true
            maps_to: service_id
          - name: product-id
            type: uuid
            required: true
            maps_to: product_id
          - name: is-mandatory
            type: boolean
            required: false
            maps_to: is_mandatory
          - name: is-default
            type: boolean
            required: false
            maps_to: is_default
          - name: display-order
            type: integer
            required: false
            maps_to: display_order
        returns:
          type: void

      unlink-product:
        description: "Unlink a service from a product"
        behavior: crud
        crud:
          operation: unlink
          junction: product_services
          schema: ob-poc
          from_col: service_id
          to_col: product_id
        args:
          - name: service-id
            type: uuid
            required: true
          - name: product-id
            type: uuid
            required: true
        returns:
          type: affected

      list-by-product:
        description: "List services for a product"
        behavior: crud
        crud:
          operation: select_with_join
          primary_table: services
          join_table: product_services
          join_col: service_id
          filter_col: product_id
          schema: ob-poc
        args:
          - name: product-id
            type: uuid
            required: true
          - name: is-mandatory
            type: boolean
            required: false
        returns:
          type: record_set

  # ===========================================================================
  # DOMAIN: service-resource
  # ===========================================================================
  service-resource:
    description: "Service resource type and instance operations"

    verbs:
      create:
        description: "Create a new service resource type"
        behavior: crud
        crud:
          operation: insert
          table: service_resource_types
          schema: ob-poc
          returning: resource_id
        args:
          - name: name
            type: string
            required: true
            maps_to: name
          - name: resource-code
            type: string
            required: true
            maps_to: resource_code
          - name: owner
            type: string
            required: true
            maps_to: owner
          - name: description
            type: string
            required: false
            maps_to: description
          - name: resource-type
            type: string
            required: false
            maps_to: resource_type
          - name: vendor
            type: string
            required: false
            maps_to: vendor
          - name: api-endpoint
            type: string
            required: false
            maps_to: api_endpoint
          - name: capabilities
            type: json
            required: false
            maps_to: capabilities
        returns:
          type: uuid
          name: resource_id
          capture: true

      read:
        description: "Read a service resource type by ID or code"
        behavior: crud
        crud:
          operation: select
          table: service_resource_types
          schema: ob-poc
        args:
          - name: resource-id
            type: uuid
            required: false
            maps_to: resource_id
          - name: resource-code
            type: string
            required: false
            maps_to: resource_code
        returns:
          type: record

      update:
        description: "Update a service resource type"
        behavior: crud
        crud:
          operation: update
          table: service_resource_types
          schema: ob-poc
          key: resource_id
        args:
          - name: resource-id
            type: uuid
            required: true
            maps_to: resource_id
          - name: name
            type: string
            required: false
            maps_to: name
          - name: description
            type: string
            required: false
            maps_to: description
          - name: is-active
            type: boolean
            required: false
            maps_to: is_active
          - name: api-endpoint
            type: string
            required: false
            maps_to: api_endpoint
          - name: capabilities
            type: json
            required: false
            maps_to: capabilities
        returns:
          type: affected

      delete:
        description: "Delete a service resource type"
        behavior: crud
        crud:
          operation: delete
          table: service_resource_types
          schema: ob-poc
          key: resource_id
        args:
          - name: resource-id
            type: uuid
            required: true
            maps_to: resource_id
        returns:
          type: affected

      list:
        description: "List service resource types with optional filters"
        behavior: crud
        crud:
          operation: select
          table: service_resource_types
          schema: ob-poc
        args:
          - name: resource-type
            type: string
            required: false
            maps_to: resource_type
          - name: owner
            type: string
            required: false
            maps_to: owner
          - name: is-active
            type: boolean
            required: false
            maps_to: is_active
          - name: limit
            type: integer
            required: false
            default: 100
          - name: offset
            type: integer
            required: false
            default: 0
        returns:
          type: record_set

      ensure:
        description: "Create or update a service resource type by resource-code"
        behavior: crud
        crud:
          operation: upsert
          table: service_resource_types
          schema: ob-poc
          conflict_keys: [resource_code]
          returning: resource_id
        args:
          - name: name
            type: string
            required: true
            maps_to: name
          - name: resource-code
            type: string
            required: true
            maps_to: resource_code
          - name: owner
            type: string
            required: true
            maps_to: owner
          - name: description
            type: string
            required: false
            maps_to: description
          - name: resource-type
            type: string
            required: false
            maps_to: resource_type
          - name: vendor
            type: string
            required: false
            maps_to: vendor
        returns:
          type: uuid
          name: resource_id
          capture: true

      link-service:
        description: "Link a service resource type to a service"
        behavior: crud
        crud:
          operation: link
          junction: service_resources
          schema: ob-poc
          from_col: resource_id
          to_col: service_id
        args:
          - name: resource-id
            type: uuid
            required: true
            maps_to: resource_id
          - name: service-id
            type: uuid
            required: true
            maps_to: service_id
          - name: is-primary
            type: boolean
            required: false
            maps_to: is_primary
        returns:
          type: void

      unlink-service:
        description: "Unlink a service resource type from a service"
        behavior: crud
        crud:
          operation: unlink
          junction: service_resources
          schema: ob-poc
          from_col: resource_id
          to_col: service_id
        args:
          - name: resource-id
            type: uuid
            required: true
          - name: service-id
            type: uuid
            required: true
        returns:
          type: affected

      list-by-service:
        description: "List service resource types for a service"
        behavior: crud
        crud:
          operation: select_with_join
          primary_table: service_resource_types
          join_table: service_resources
          join_col: resource_id
          filter_col: service_id
          schema: ob-poc
        args:
          - name: service-id
            type: uuid
            required: true
        returns:
          type: record_set

      # Attribute dictionary linkage
      add-attribute:
        description: "Add an attribute requirement to a service resource type"
        behavior: crud
        crud:
          operation: insert
          table: resource_attribute_requirements
          schema: ob-poc
          returning: requirement_id
        args:
          - name: resource-id
            type: uuid
            required: true
            maps_to: resource_id
          - name: attribute-id
            type: uuid
            required: true
            maps_to: attribute_id
          - name: resource-field-name
            type: string
            required: false
            maps_to: resource_field_name
          - name: is-mandatory
            type: boolean
            required: false
            maps_to: is_mandatory
            default: true
          - name: transformation-rule
            type: json
            required: false
            maps_to: transformation_rule
          - name: validation-override
            type: json
            required: false
            maps_to: validation_override
          - name: default-value
            type: string
            required: false
            maps_to: default_value
          - name: display-order
            type: integer
            required: false
            maps_to: display_order
        returns:
          type: uuid
          name: requirement_id
          capture: false

      remove-attribute:
        description: "Remove an attribute requirement from a service resource type"
        behavior: crud
        crud:
          operation: delete
          table: resource_attribute_requirements
          schema: ob-poc
          key: requirement_id
        args:
          - name: requirement-id
            type: uuid
            required: true
            maps_to: requirement_id
        returns:
          type: affected

      update-attribute:
        description: "Update an attribute requirement configuration"
        behavior: crud
        crud:
          operation: update
          table: resource_attribute_requirements
          schema: ob-poc
          key: requirement_id
        args:
          - name: requirement-id
            type: uuid
            required: true
            maps_to: requirement_id
          - name: resource-field-name
            type: string
            required: false
            maps_to: resource_field_name
          - name: is-mandatory
            type: boolean
            required: false
            maps_to: is_mandatory
          - name: transformation-rule
            type: json
            required: false
            maps_to: transformation_rule
          - name: validation-override
            type: json
            required: false
            maps_to: validation_override
          - name: default-value
            type: string
            required: false
            maps_to: default_value
          - name: display-order
            type: integer
            required: false
            maps_to: display_order
        returns:
          type: affected

      list-attributes:
        description: "List attribute requirements for a service resource type"
        behavior: crud
        crud:
          operation: list_by_fk
          table: resource_attribute_requirements
          schema: ob-poc
          fk_col: resource_id
        args:
          - name: resource-id
            type: uuid
            required: true
          - name: is-mandatory
            type: boolean
            required: false
        returns:
          type: record_set

      ensure-attribute:
        description: "Ensure an attribute requirement exists (upsert)"
        behavior: crud
        crud:
          operation: upsert
          table: resource_attribute_requirements
          schema: ob-poc
          conflict_keys: [resource_id, attribute_id]
          returning: requirement_id
        args:
          - name: resource-id
            type: uuid
            required: true
            maps_to: resource_id
          - name: attribute-id
            type: uuid
            required: true
            maps_to: attribute_id
          - name: resource-field-name
            type: string
            required: false
            maps_to: resource_field_name
          - name: is-mandatory
            type: boolean
            required: false
            maps_to: is_mandatory
          - name: transformation-rule
            type: json
            required: false
            maps_to: transformation_rule
          - name: validation-override
            type: json
            required: false
            maps_to: validation_override
          - name: default-value
            type: string
            required: false
            maps_to: default_value
          - name: display-order
            type: integer
            required: false
            maps_to: display_order
        returns:
          type: uuid
          name: requirement_id
          capture: false

      # === Instance Operations (provisioning and lifecycle) ===
      provision:
        description: "Provision a service resource instance for a CBU"
        behavior: plugin
        handler: resource_instance_create
        args:
          - name: cbu-id
            type: uuid
            required: true
          - name: resource-type
            type: string
            required: true
          - name: instance-url
            type: string
            required: true
          - name: instance-id
            type: string
            required: false
          - name: instance-name
            type: string
            required: false
          - name: product-id
            type: uuid
            required: false
          - name: service-id
            type: uuid
            required: false
          - name: config
            type: json
            required: false
        returns:
          type: uuid
          name: instance_id
          capture: true

      set-attr:
        description: "Set an attribute value on a service resource instance"
        behavior: plugin
        handler: resource_set_attr
        args:
          - name: instance-id
            type: uuid
            required: true
          - name: attr
            type: string
            required: true
          - name: value
            type: string
            required: true
          - name: state
            type: string
            required: false
            valid_values: [proposed, confirmed, derived, system]
          - name: source
            type: json
            required: false

      activate:
        description: "Activate a service resource instance"
        behavior: plugin
        handler: resource_activate
        args:
          - name: instance-id
            type: uuid
            required: true

      suspend:
        description: "Suspend a service resource instance"
        behavior: plugin
        handler: resource_suspend
        args:
          - name: instance-id
            type: uuid
            required: true
          - name: reason
            type: string
            required: false

      decommission:
        description: "Decommission a service resource instance"
        behavior: plugin
        handler: resource_decommission
        args:
          - name: instance-id
            type: uuid
            required: true
          - name: reason
            type: string
            required: false

  # ===========================================================================
  # DOMAIN: instrument-class (Custody Taxonomy Reference)
  # ===========================================================================
  instrument-class:
    description: "Instrument class with industry taxonomy mappings"

    verbs:
      ensure:
        description: "Create or update instrument class with CFI/SMPG/ISDA mappings"
        behavior: crud
        crud:
          operation: upsert
          table: instrument_classes
          schema: custody
          conflict_keys: [code]
          returning: class_id
        args:
          - name: code
            type: string
            required: true
            maps_to: code
          - name: name
            type: string
            required: true
            maps_to: name
          - name: settlement-cycle
            type: string
            required: true
            maps_to: default_settlement_cycle
          - name: swift-family
            type: string
            required: false
            maps_to: swift_message_family
          - name: cfi-category
            type: string
            required: false
            maps_to: cfi_category
          - name: cfi-group
            type: string
            required: false
            maps_to: cfi_group
          - name: smpg-group
            type: string
            required: false
            maps_to: smpg_group
          - name: isda-asset-class
            type: string
            required: false
            maps_to: isda_asset_class
          - name: requires-isda
            type: boolean
            required: false
            maps_to: requires_isda
            default: false
          - name: parent
            type: lookup
            required: false
            maps_to: parent_class_id
            lookup:
              table: instrument_classes
              schema: custody
              code_column: code
              id_column: class_id
        returns:
          type: uuid
          name: class_id
          capture: true

      read:
        description: "Read instrument class by code"
        behavior: crud
        crud:
          operation: select
          table: instrument_classes
          schema: custody
        args:
          - name: code
            type: string
            required: true
            maps_to: code
        returns:
          type: record

      list:
        description: "List instrument classes with filters"
        behavior: crud
        crud:
          operation: select
          table: instrument_classes
          schema: custody
        args:
          - name: smpg-group
            type: string
            required: false
            maps_to: smpg_group
          - name: isda-asset-class
            type: string
            required: false
            maps_to: isda_asset_class
          - name: requires-isda
            type: boolean
            required: false
            maps_to: requires_isda
        returns:
          type: record_set

  # ===========================================================================
  # DOMAIN: security-type (ALERT codes)
  # ===========================================================================
  security-type:
    description: "SMPG/ALERT security type codes"

    verbs:
      ensure:
        description: "Create or update ALERT security type"
        behavior: crud
        crud:
          operation: upsert
          table: security_types
          schema: custody
          conflict_keys: [code]
          returning: security_type_id
        args:
          - name: class
            type: lookup
            required: true
            maps_to: instrument_class_id
            lookup:
              table: instrument_classes
              schema: custody
              code_column: code
              id_column: class_id
          - name: code
            type: string
            required: true
            maps_to: code
          - name: name
            type: string
            required: true
            maps_to: name
          - name: cfi-pattern
            type: string
            required: false
            maps_to: cfi_pattern
        returns:
          type: uuid
          name: security_type_id
          capture: true

      list:
        description: "List security types for an instrument class"
        behavior: crud
        crud:
          operation: list_by_fk
          table: security_types
          schema: custody
          fk_col: class_id
        args:
          - name: class
            type: lookup
            required: true
            maps_to: class_id
            lookup:
              table: instrument_classes
              schema: custody
              code_column: code
              id_column: class_id
        returns:
          type: record_set

  # ===========================================================================
  # DOMAIN: market (Market Reference)
  # ===========================================================================
  market:
    description: "Market/Exchange reference data"

    verbs:
      ensure:
        description: "Create or update market reference"
        behavior: crud
        crud:
          operation: upsert
          table: markets
          schema: custody
          conflict_keys: [mic]
          returning: market_id
        args:
          - name: mic
            type: string
            required: true
            maps_to: mic
          - name: name
            type: string
            required: true
            maps_to: name
          - name: country-code
            type: string
            required: true
            maps_to: country_code
          - name: primary-currency
            type: string
            required: true
            maps_to: primary_currency
          - name: csd-bic
            type: string
            required: false
            maps_to: csd_bic
          - name: timezone
            type: string
            required: true
            maps_to: timezone
        returns:
          type: uuid
          name: market_id
          capture: true

      read:
        description: "Read market by MIC"
        behavior: crud
        crud:
          operation: select
          table: markets
          schema: custody
        args:
          - name: mic
            type: string
            required: true
            maps_to: mic
        returns:
          type: record

      list:
        description: "List markets"
        behavior: crud
        crud:
          operation: select
          table: markets
          schema: custody
        args:
          - name: country-code
            type: string
            required: false
            maps_to: country_code
        returns:
          type: record_set

  # ===========================================================================
  # DOMAIN: subcustodian (Bank's Sub-custodian Network)
  # ===========================================================================
  subcustodian:
    description: "Bank's sub-custodian network (Omgeo Institution Network)"

    verbs:
      ensure:
        description: "Create or update sub-custodian entry for market/currency"
        behavior: crud
        crud:
          operation: upsert
          table: subcustodian_network
          schema: custody
          conflict_keys: [market_id, currency, subcustodian_bic, effective_date]
          returning: network_id
        args:
          - name: market
            type: lookup
            required: true
            maps_to: market_id
            lookup:
              table: markets
              schema: custody
              code_column: mic
              id_column: market_id
          - name: currency
            type: string
            required: true
            maps_to: currency
          - name: subcustodian-bic
            type: string
            required: true
            maps_to: subcustodian_bic
          - name: subcustodian-name
            type: string
            required: false
            maps_to: subcustodian_name
          - name: local-agent-bic
            type: string
            required: false
            maps_to: local_agent_bic
          - name: local-agent-account
            type: string
            required: false
            maps_to: local_agent_account
          - name: pset
            type: string
            required: true
            maps_to: place_of_settlement_bic
          - name: csd-participant
            type: string
            required: false
            maps_to: csd_participant_id
          - name: is-primary
            type: boolean
            required: false
            maps_to: is_primary
            default: true
          - name: effective-date
            type: date
            required: true
            maps_to: effective_date
        returns:
          type: uuid
          name: network_id
          capture: true

      list-by-market:
        description: "List sub-custodian entries for a market"
        behavior: crud
        crud:
          operation: list_by_fk
          table: subcustodian_network
          schema: custody
          fk_col: market_id
        args:
          - name: market
            type: lookup
            required: true
            maps_to: market_id
            lookup:
              table: markets
              schema: custody
              code_column: mic
              id_column: market_id
          - name: currency
            type: string
            required: false
            maps_to: currency
        returns:
          type: record_set

      lookup:
        description: "Find sub-custodian for market/currency"
        behavior: plugin
        handler: subcustodian_lookup
        args:
          - name: market
            type: string
            required: true
          - name: currency
            type: string
            required: true
          - name: as-of-date
            type: date
            required: false
        returns:
          type: record

  # ===========================================================================
  # DOMAIN: cbu-custody (Three-Layer Model)
  # ===========================================================================
  cbu-custody:
    description: "CBU custody operations: Universe, SSIs, and Booking Rules"

    verbs:
      # -----------------------------------------------------------------------
      # LAYER 1: Universe
      # -----------------------------------------------------------------------
      add-universe:
        description: "Declare what a CBU trades (instrument class + market + currencies)"
        behavior: crud
        crud:
          operation: upsert
          table: cbu_instrument_universe
          schema: custody
          conflict_keys:
            [cbu_id, instrument_class_id, market_id, counterparty_entity_id]
          returning: universe_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
          - name: instrument-class
            type: lookup
            required: true
            maps_to: instrument_class_id
            lookup:
              table: instrument_classes
              schema: custody
              code_column: code
              id_column: class_id
          - name: market
            type: lookup
            required: false
            maps_to: market_id
            lookup:
              table: markets
              schema: custody
              code_column: mic
              id_column: market_id
          - name: currencies
            type: string_list
            required: true
            maps_to: currencies
          - name: settlement-types
            type: string_list
            required: false
            maps_to: settlement_types
            default: ["DVP"]
          - name: counterparty
            type: uuid
            required: false
            maps_to: counterparty_entity_id
          - name: is-held
            type: boolean
            required: false
            maps_to: is_held
            default: true
          - name: is-traded
            type: boolean
            required: false
            maps_to: is_traded
            default: true
        returns:
          type: uuid
          name: universe_id
          capture: false

      list-universe:
        description: "List CBU's traded universe"
        behavior: crud
        crud:
          operation: list_by_fk
          table: cbu_instrument_universe
          schema: custody
          fk_col: cbu_id
        args:
          - name: cbu-id
            type: uuid
            required: true
        returns:
          type: record_set

      # -----------------------------------------------------------------------
      # LAYER 2: SSI Data
      # -----------------------------------------------------------------------
      create-ssi:
        description: "Create a Standing Settlement Instruction (pure account data)"
        behavior: crud
        crud:
          operation: insert
          table: cbu_ssi
          schema: custody
          returning: ssi_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
          - name: name
            type: string
            required: true
            maps_to: ssi_name
          - name: type
            type: string
            required: true
            maps_to: ssi_type
            valid_values: [SECURITIES, CASH, COLLATERAL, FX_NOSTRO]
          - name: safekeeping-account
            type: string
            required: false
            maps_to: safekeeping_account
          - name: safekeeping-bic
            type: string
            required: false
            maps_to: safekeeping_bic
          - name: safekeeping-name
            type: string
            required: false
            maps_to: safekeeping_account_name
          - name: cash-account
            type: string
            required: false
            maps_to: cash_account
          - name: cash-bic
            type: string
            required: false
            maps_to: cash_account_bic
          - name: cash-currency
            type: string
            required: false
            maps_to: cash_currency
          - name: collateral-account
            type: string
            required: false
            maps_to: collateral_account
          - name: collateral-bic
            type: string
            required: false
            maps_to: collateral_account_bic
          - name: pset-bic
            type: string
            required: false
            maps_to: pset_bic
          - name: effective-date
            type: date
            required: true
            maps_to: effective_date
        returns:
          type: uuid
          name: ssi_id
          capture: true

      list-ssis:
        description: "List SSIs for a CBU"
        behavior: crud
        crud:
          operation: list_by_fk
          table: cbu_ssi
          schema: custody
          fk_col: cbu_id
        args:
          - name: cbu-id
            type: uuid
            required: true
          - name: status
            type: string
            required: false
            maps_to: status
          - name: type
            type: string
            required: false
            maps_to: ssi_type
        returns:
          type: record_set

      activate-ssi:
        description: "Activate an SSI"
        behavior: crud
        crud:
          operation: update
          table: cbu_ssi
          schema: custody
          key: ssi_id
          set_values:
            status: ACTIVE
        args:
          - name: ssi-id
            type: uuid
            required: true
            maps_to: ssi_id
        returns:
          type: affected

      suspend-ssi:
        description: "Suspend an SSI"
        behavior: crud
        crud:
          operation: update
          table: cbu_ssi
          schema: custody
          key: ssi_id
          set_values:
            status: SUSPENDED
        args:
          - name: ssi-id
            type: uuid
            required: true
            maps_to: ssi_id
        returns:
          type: affected

      # -----------------------------------------------------------------------
      # LAYER 3: Booking Rules (ALERT-style)
      # -----------------------------------------------------------------------
      add-booking-rule:
        description: "Add ALERT-style booking rule for SSI routing"
        behavior: crud
        crud:
          operation: insert
          table: ssi_booking_rules
          schema: custody
          returning: rule_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
          - name: ssi-id
            type: uuid
            required: true
            maps_to: ssi_id
          - name: name
            type: string
            required: true
            maps_to: rule_name
          - name: priority
            type: integer
            required: true
            maps_to: priority
          # Match criteria (all optional = wildcards)
          - name: instrument-class
            type: lookup
            required: false
            maps_to: instrument_class_id
            lookup:
              table: instrument_classes
              schema: custody
              code_column: code
              id_column: class_id
          - name: security-type
            type: lookup
            required: false
            maps_to: security_type_id
            lookup:
              table: security_types
              schema: custody
              code_column: code
              id_column: security_type_id
          - name: market
            type: lookup
            required: false
            maps_to: market_id
            lookup:
              table: markets
              schema: custody
              code_column: mic
              id_column: market_id
          - name: currency
            type: string
            required: false
            maps_to: currency
          - name: settlement-type
            type: string
            required: false
            maps_to: settlement_type
          - name: counterparty
            type: uuid
            required: false
            maps_to: counterparty_entity_id
          # OTC criteria
          - name: isda-asset-class
            type: string
            required: false
            maps_to: isda_asset_class
          - name: isda-base-product
            type: string
            required: false
            maps_to: isda_base_product
          - name: effective-date
            type: date
            required: false
            maps_to: effective_date
        returns:
          type: uuid
          name: rule_id
          capture: true

      list-booking-rules:
        description: "List booking rules for a CBU"
        behavior: crud
        crud:
          operation: list_by_fk
          table: ssi_booking_rules
          schema: custody
          fk_col: cbu_id
          order_by: priority
        args:
          - name: cbu-id
            type: uuid
            required: true
          - name: is-active
            type: boolean
            required: false
            maps_to: is_active
        returns:
          type: record_set

      update-rule-priority:
        description: "Update booking rule priority"
        behavior: crud
        crud:
          operation: update
          table: ssi_booking_rules
          schema: custody
          key: rule_id
        args:
          - name: rule-id
            type: uuid
            required: true
            maps_to: rule_id
          - name: priority
            type: integer
            required: true
            maps_to: priority
        returns:
          type: affected

      deactivate-rule:
        description: "Deactivate a booking rule"
        behavior: crud
        crud:
          operation: update
          table: ssi_booking_rules
          schema: custody
          key: rule_id
          set_values:
            is_active: false
        args:
          - name: rule-id
            type: uuid
            required: true
            maps_to: rule_id
        returns:
          type: affected

      # -----------------------------------------------------------------------
      # Plugins
      # -----------------------------------------------------------------------
      derive-required-coverage:
        description: "Compare universe to booking rules, find gaps"
        behavior: plugin
        handler: derive_required_coverage
        args:
          - name: cbu-id
            type: uuid
            required: true
        returns:
          type: record_set

      validate-booking-coverage:
        description: "Validate that all universe entries have matching booking rules"
        behavior: plugin
        handler: validate_booking_coverage
        args:
          - name: cbu-id
            type: uuid
            required: true
        returns:
          type: record

      lookup-ssi:
        description: "Find SSI for given trade characteristics (simulate ALERT lookup)"
        behavior: plugin
        handler: lookup_ssi_for_trade
        args:
          - name: cbu-id
            type: uuid
            required: true
          - name: instrument-class
            type: string
            required: true
          - name: security-type
            type: string
            required: false
          - name: market
            type: string
            required: false
          - name: currency
            type: string
            required: true
          - name: settlement-type
            type: string
            required: false
          - name: counterparty-bic
            type: string
            required: false
        returns:
          type: record

  # ===========================================================================
  # DOMAIN: isda (ISDA/CSA Agreement Management)
  # ===========================================================================
  isda:
    description: "ISDA and CSA agreement management for OTC derivatives"

    verbs:
      create:
        description: "Create ISDA agreement with counterparty"
        behavior: crud
        crud:
          operation: insert
          table: isda_agreements
          schema: custody
          returning: isda_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
          - name: counterparty
            type: uuid
            required: true
            maps_to: counterparty_entity_id
          - name: agreement-date
            type: date
            required: true
            maps_to: agreement_date
          - name: governing-law
            type: string
            required: false
            maps_to: governing_law
            valid_values: [NY, ENGLISH]
          - name: effective-date
            type: date
            required: true
            maps_to: effective_date
        returns:
          type: uuid
          name: isda_id
          capture: true

      add-coverage:
        description: "Add instrument class coverage to ISDA"
        behavior: crud
        crud:
          operation: insert
          table: isda_product_coverage
          schema: custody
          returning: coverage_id
        args:
          - name: isda-id
            type: uuid
            required: true
            maps_to: isda_id
          - name: instrument-class
            type: lookup
            required: true
            maps_to: instrument_class_id
            lookup:
              table: instrument_classes
              schema: custody
              code_column: code
              id_column: class_id
          - name: isda-taxonomy
            type: lookup
            required: false
            maps_to: isda_taxonomy_id
            lookup:
              table: isda_product_taxonomy
              schema: custody
              code_column: taxonomy_code
              id_column: taxonomy_id
        returns:
          type: uuid
          name: coverage_id

      add-csa:
        description: "Add CSA (Credit Support Annex) to ISDA"
        behavior: crud
        crud:
          operation: insert
          table: csa_agreements
          schema: custody
          returning: csa_id
        args:
          - name: isda-id
            type: uuid
            required: true
            maps_to: isda_id
          - name: csa-type
            type: string
            required: true
            maps_to: csa_type
            valid_values: [VM, IM]
          - name: threshold
            type: decimal
            required: false
            maps_to: threshold_amount
          - name: threshold-currency
            type: string
            required: false
            maps_to: threshold_currency
          - name: mta
            type: decimal
            required: false
            maps_to: minimum_transfer_amount
          - name: collateral-ssi
            type: uuid
            required: false
            maps_to: collateral_ssi_id
          - name: effective-date
            type: date
            required: true
            maps_to: effective_date
        returns:
          type: uuid
          name: csa_id
          capture: true

      list:
        description: "List ISDA agreements for CBU"
        behavior: crud
        crud:
          operation: list_by_fk
          table: isda_agreements
          schema: custody
          fk_col: cbu_id
        args:
          - name: cbu-id
            type: uuid
            required: true
          - name: counterparty
            type: uuid
            required: false
            maps_to: counterparty_entity_id
        returns:
          type: record_set

  # ===========================================================================
  # DOMAIN: entity-settlement (Counterparty SSI from ALERT)
  # ===========================================================================
  entity-settlement:
    description: "Entity settlement identity and SSIs (counterparty data from ALERT)"

    verbs:
      set-identity:
        description: "Set primary settlement identity for an entity"
        behavior: crud
        crud:
          operation: upsert
          table: entity_settlement_identity
          schema: custody
          conflict_keys: [entity_id, primary_bic]
          returning: identity_id
        args:
          - name: entity-id
            type: uuid
            required: true
            maps_to: entity_id
          - name: bic
            type: string
            required: true
            maps_to: primary_bic
          - name: lei
            type: string
            required: false
            maps_to: lei
          - name: alert-id
            type: string
            required: false
            maps_to: alert_participant_id
          - name: ctm-id
            type: string
            required: false
            maps_to: ctm_participant_id
        returns:
          type: uuid
          name: identity_id
          capture: true

      add-ssi:
        description: "Add counterparty SSI (from ALERT or manual)"
        behavior: crud
        crud:
          operation: insert
          table: entity_ssi
          schema: custody
          returning: entity_ssi_id
        args:
          - name: entity-id
            type: uuid
            required: true
            maps_to: entity_id
          - name: instrument-class
            type: lookup
            required: false
            maps_to: instrument_class_id
            lookup:
              table: instrument_classes
              schema: custody
              code_column: code
              id_column: class_id
          - name: security-type
            type: lookup
            required: false
            maps_to: security_type_id
            lookup:
              table: security_types
              schema: custody
              code_column: code
              id_column: security_type_id
          - name: market
            type: lookup
            required: false
            maps_to: market_id
            lookup:
              table: markets
              schema: custody
              code_column: mic
              id_column: market_id
          - name: currency
            type: string
            required: false
            maps_to: currency
          - name: counterparty-bic
            type: string
            required: true
            maps_to: counterparty_bic
          - name: safekeeping-account
            type: string
            required: false
            maps_to: safekeeping_account
          - name: source
            type: string
            required: false
            maps_to: source
            valid_values: [ALERT, MANUAL, CTM]
            default: ALERT
          - name: source-reference
            type: string
            required: false
            maps_to: source_reference
          - name: effective-date
            type: date
            required: true
            maps_to: effective_date
        returns:
          type: uuid
          name: entity_ssi_id
          capture: true

# =============================================================================
# PLUGINS (Custom operations requiring Rust code)
# =============================================================================
plugins:
  document.catalog:
    description: "Catalog a document for an entity within a CBU"
    handler: document_catalog
    args:
      - name: cbu-id
        type: uuid
        required: true
      - name: entity-id
        type: uuid
        required: true
      - name: document-type
        type: lookup
        required: true
        lookup:
          table: document_types
          code_column: type_code
          id_column: type_id
      - name: file-path
        type: string
        required: false
      - name: metadata
        type: json
        required: false
    returns:
      type: uuid
      name: doc_id

  document.extract:
    description: "Extract attributes from a cataloged document"
    handler: document_extract
    args:
      - name: document-id
        type: uuid
        required: true
      - name: attributes
        type: string_list
        required: false
      - name: use-ocr
        type: boolean
        required: false
        default: false

  ubo.calculate:
    description: "Calculate ultimate beneficial ownership chain"
    handler: ubo_calculate
    args:
      - name: cbu-id
        type: uuid
        required: true
      - name: entity-id
        type: uuid
        required: true
      - name: threshold
        type: decimal
        required: false
        default: 25.0

  ubo.validate:
    description: "Validate UBO structure completeness"
    handler: ubo_validate
    args:
      - name: cbu-id
        type: uuid
        required: true

  screening.pep:
    description: "Run PEP screening"
    handler: screening_pep
    args:
      - name: entity-id
        type: uuid
        required: true
      - name: provider
        type: string
        required: false

  screening.sanctions:
    description: "Run sanctions list screening"
    handler: screening_sanctions
    args:
      - name: entity-id
        type: uuid
        required: true
      - name: lists
        type: string_list
        required: false

  screening.adverse-media:
    description: "Run adverse media screening"
    handler: screening_adverse_media
    args:
      - name: entity-id
        type: uuid
        required: true
      - name: lookback-months
        type: integer
        required: false
        default: 24

  kyc.initiate:
    description: "Initiate KYC investigation"
    handler: kyc_initiate
    args:
      - name: cbu-id
        type: uuid
        required: true
      - name: investigation-type
        type: string
        required: true

  kyc.decide:
    description: "Record KYC decision"
    handler: kyc_decide
    args:
      - name: investigation-id
        type: uuid
        required: true
      - name: decision
        type: string
        required: true
        valid_values: [approve, reject, escalate]
      - name: rationale
        type: string
        required: true

  delivery.record:
    description: "Record a service delivery for a CBU"
    handler: delivery_record
    args:
      - name: cbu-id
        type: uuid
        required: true
      - name: product
        type: string
        required: true
      - name: service
        type: string
        required: true
      - name: instance-id
        type: uuid
        required: false
      - name: config
        type: json
        required: false

  delivery.complete:
    description: "Mark a service delivery as complete"
    handler: delivery_complete
    args:
      - name: cbu-id
        type: uuid
        required: true
      - name: product
        type: string
        required: true
      - name: service
        type: string
        required: true
      - name: instance-id
        type: uuid
        required: false

  delivery.fail:
    description: "Mark a service delivery as failed"
    handler: delivery_fail
    args:
      - name: cbu-id
        type: uuid
        required: true
      - name: product
        type: string
        required: true
      - name: service
        type: string
        required: true
      - name: reason
        type: string
        required: true
