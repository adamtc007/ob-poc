# Evaluation Dataset for Agent Intelligence Testing
# This file contains golden test cases for evaluating the agent pipeline
#
# Categories:
#   - investment_manager: IM assignment tests
#   - pricing: Pricing configuration tests
#   - cash_sweep: Cash sweep configuration tests
#   - sla: SLA commitment tests
#   - compound: Multi-intent tests
#   - context: Context-dependent tests
#   - edge_case: Edge cases and error handling

version: "1.0"
description: "Golden dataset for Phase 3 agent evaluation"

evaluation_cases:
  # ==================== Investment Manager Tests ====================

  - id: im_simple_1
    category: investment_manager
    difficulty: easy
    input: "Add BlackRock as our investment manager"
    expected_intents:
      - im_assign
    expected_entities:
      manager_reference: "BlackRock"
    expected_dsl_contains:
      - "investment-manager.assign"
      - "BlackRock"
    expected_dsl_not_contains: []
    notes: "Basic IM assignment without scope"

  - id: im_simple_2
    category: investment_manager
    difficulty: easy
    input: "Use Vanguard for equities"
    expected_intents:
      - im_assign
    expected_entities:
      manager_reference: "Vanguard"
      instrument_class_reference: "EQUITY"
    expected_dsl_contains:
      - "investment-manager.assign"
      - "Vanguard"
      - "EQUITY"

  - id: im_with_region
    category: investment_manager
    difficulty: medium
    input: "Add BlackRock for European equities"
    expected_intents:
      - im_assign
    expected_entities:
      manager_reference: "BlackRock"
      market_reference: "European"
      instrument_class_reference: "EQUITY"
    expected_dsl_contains:
      - "investment-manager.assign"
      - "BlackRock"
    expected_expansion:
      market_reference:
        from: "European"
        to: ["XLON", "XETR", "XPAR", "XAMS"]

  - id: im_with_method
    category: investment_manager
    difficulty: medium
    input: "BlackRock will handle US equities via CTM"
    expected_intents:
      - im_assign
    expected_entities:
      manager_reference: "BlackRock"
      market_reference: "US"
      instrument_class_reference: "EQUITY"
      instruction_method: "CTM"
    expected_dsl_contains:
      - "investment-manager.assign"
      - "BlackRock"
      - "CTM"

  - id: im_multiple_markets
    category: investment_manager
    difficulty: medium
    input: "PIMCO manages bonds in US and Europe"
    expected_intents:
      - im_assign
    expected_entities:
      manager_reference: "PIMCO"
      market_reference: ["US", "European"]
      instrument_class_reference: "FIXED_INCOME"
    expected_dsl_contains:
      - "investment-manager.assign"
      - "PIMCO"

  - id: im_full_spec
    category: investment_manager
    difficulty: hard
    input: "Add Fidelity as investment manager for Asian equities and fixed income, using FIX protocol, priority 50"
    expected_intents:
      - im_assign
    expected_entities:
      manager_reference: "Fidelity"
      market_reference: "Asian"
      instrument_class_reference: ["EQUITY", "FIXED_INCOME"]
      instruction_method: "FIX"
    expected_dsl_contains:
      - "investment-manager.assign"
      - "Fidelity"
      - "FIX"
      - "50"

  # ==================== Pricing Configuration Tests ====================

  - id: pricing_simple_1
    category: pricing
    difficulty: easy
    input: "Use Bloomberg for pricing"
    expected_intents:
      - pricing_set
    expected_entities:
      pricing_source: "BLOOMBERG"
    expected_dsl_contains:
      - "pricing-config.set"
      - "BLOOMBERG"

  - id: pricing_with_scope
    category: pricing
    difficulty: medium
    input: "Get equity prices from Bloomberg"
    expected_intents:
      - pricing_set
    expected_entities:
      pricing_source: "BLOOMBERG"
      instrument_class_reference: "EQUITY"
    expected_dsl_contains:
      - "pricing-config.set"
      - "BLOOMBERG"
      - "EQUITY"

  - id: pricing_refinitiv
    category: pricing
    difficulty: easy
    input: "Use Refinitiv for bond pricing"
    expected_intents:
      - pricing_set
    expected_entities:
      pricing_source: "REFINITIV"
      instrument_class_reference: "FIXED_INCOME"
    expected_dsl_contains:
      - "pricing-config.set"
      - "REFINITIV"

  - id: pricing_all_instruments
    category: pricing
    difficulty: medium
    input: "Bloomberg for all pricing across the board"
    expected_intents:
      - pricing_set
    expected_entities:
      pricing_source: "BLOOMBERG"
    expected_expansion:
      instrument_class_reference:
        all: true
    notes: "Should expand to all configured instrument classes"

  # ==================== Cash Sweep Tests ====================

  - id: sweep_simple_1
    category: cash_sweep
    difficulty: easy
    input: "Sweep EUR to STIF"
    expected_intents:
      - sweep_configure
    expected_entities:
      currency: "EUR"
      sweep_vehicle: "STIF"
    expected_dsl_contains:
      - "cash-sweep.configure"
      - "EUR"
      - "STIF"

  - id: sweep_multiple
    category: cash_sweep
    difficulty: medium
    input: "Sweep EUR and USD to money market"
    expected_intents:
      - sweep_configure
    expected_entities:
      currency: ["EUR", "USD"]
      sweep_vehicle: "MONEY_MARKET"
    expected_dsl_contains:
      - "cash-sweep.configure"

  - id: sweep_with_threshold
    category: cash_sweep
    difficulty: hard
    input: "Sweep USD above 100000 to overnight repo"
    expected_intents:
      - sweep_configure
    expected_entities:
      currency: "USD"
      sweep_vehicle: "OVERNIGHT_REPO"
      threshold: 100000
    expected_dsl_contains:
      - "cash-sweep.configure"
      - "USD"
      - "100000"

  # ==================== SLA Tests ====================

  - id: sla_simple_1
    category: sla
    difficulty: easy
    input: "Commit to T+1 settlement"
    expected_intents:
      - sla_commit
    expected_entities:
      settlement_cycle: "T+1"
    expected_dsl_contains:
      - "sla.commit"
      - "T+1"

  - id: sla_with_scope
    category: sla
    difficulty: medium
    input: "T+2 settlement for European equities"
    expected_intents:
      - sla_commit
    expected_entities:
      settlement_cycle: "T+2"
      market_reference: "European"
      instrument_class_reference: "EQUITY"
    expected_dsl_contains:
      - "sla.commit"
      - "T+2"

  # ==================== Compound Intent Tests ====================

  - id: compound_im_pricing
    category: compound
    difficulty: medium
    input: "BlackRock handles equities and use Bloomberg for pricing"
    expected_intents:
      - im_assign
      - pricing_set
    expected_entities:
      manager_reference: "BlackRock"
      instrument_class_reference: "EQUITY"
      pricing_source: "BLOOMBERG"
    expected_dsl_contains:
      - "investment-manager.assign"
      - "pricing-config.set"
      - "BlackRock"
      - "BLOOMBERG"

  - id: compound_two_ims
    category: compound
    difficulty: medium
    input: "BlackRock for equities, PIMCO for bonds"
    expected_intents:
      - im_assign
      - im_assign
    expected_dsl_statements: 2
    expected_dsl_contains:
      - "investment-manager.assign"
      - "BlackRock"
      - "PIMCO"

  - id: compound_three_ims
    category: compound
    difficulty: hard
    input: "BlackRock handles European equities via CTM, PIMCO does fixed income through SWIFT, and Vanguard covers US markets using FIX"
    expected_intents:
      - im_assign
      - im_assign
      - im_assign
    expected_dsl_statements: 3
    expected_dsl_contains:
      - "BlackRock"
      - "PIMCO"
      - "Vanguard"
      - "CTM"
      - "SWIFT"
      - "FIX"

  - id: compound_full_setup
    category: compound
    difficulty: hard
    input: |
      Set up our Luxembourg fund with:
      BlackRock for European equities via CTM,
      PIMCO for fixed income via SWIFT,
      Bloomberg for all pricing,
      and sweep EUR to STIF
    expected_intents:
      - im_assign
      - im_assign
      - pricing_set
      - sweep_configure
    expected_dsl_statements: 4
    expected_dsl_contains:
      - "investment-manager.assign"
      - "pricing-config.set"
      - "cash-sweep.configure"
      - "BlackRock"
      - "PIMCO"
      - "BLOOMBERG"
      - "EUR"
      - "STIF"

  # ==================== Context-Dependent Tests ====================

  - id: context_coreference_1
    category: context
    difficulty: medium
    input: "Now connect them via CTM"
    context:
      last_intent: "im_assign"
      session_entities:
        manager_reference: "BlackRock"
    expected_intents:
      - im_assign
    expected_entities:
      manager_reference: "BlackRock"
      instruction_method: "CTM"
    notes: "'them' should resolve to BlackRock from context"

  - id: context_followup_1
    category: context
    difficulty: medium
    input: "also add Vanguard"
    context:
      last_intent: "im_assign"
    expected_intents:
      - im_assign
    expected_entities:
      manager_reference: "Vanguard"
    notes: "Followup should inherit intent from previous turn"

  - id: context_implicit_cbu
    category: context
    difficulty: easy
    input: "Add BlackRock as IM"
    context:
      cbu_id: "test-cbu-123"
    expected_dsl_contains:
      - "investment-manager.assign"
      - "test-cbu-123"
    notes: "CBU should be injected from context"

  # ==================== Edge Cases ====================

  - id: edge_empty_input
    category: edge_case
    difficulty: easy
    input: ""
    expected_intents: []
    expected_response_type: clarification
    notes: "Empty input should trigger clarification"

  - id: edge_ambiguous
    category: edge_case
    difficulty: easy
    input: "set it up"
    expected_response_type: clarification
    notes: "Ambiguous input should trigger clarification"

  - id: edge_unknown_manager
    category: edge_case
    difficulty: medium
    input: "Add XYZ Corp as investment manager"
    expected_intents:
      - im_assign
    expected_entities:
      manager_reference: null
    notes: "Unknown manager should not be extracted"

  - id: edge_invalid_market
    category: edge_case
    difficulty: medium
    input: "Trade on INVALID_MIC"
    expected_entities:
      market_reference: null
    notes: "Invalid MIC should not be extracted"

  - id: edge_mixed_valid_invalid
    category: edge_case
    difficulty: hard
    input: "BlackRock handles XLON and INVALID_MIC"
    expected_entities:
      manager_reference: "BlackRock"
      market_reference: "XLON"
    notes: "Should extract valid entities and ignore invalid"

  - id: edge_case_sensitivity
    category: edge_case
    difficulty: easy
    input: "add BLACKROCK as im"
    expected_entities:
      manager_reference: "BlackRock"
    notes: "Case should be normalized"

  - id: edge_partial_phrase
    category: edge_case
    difficulty: medium
    input: "blackrock equities ctm"
    expected_intents:
      - im_assign
    expected_entities:
      manager_reference: "BlackRock"
      instrument_class_reference: "EQUITY"
      instruction_method: "CTM"
    notes: "Should handle telegram-style input"

  # ==================== OTC Derivatives Tests (Phase 3.5) ====================

  # --- Counterparty Tests ---

  - id: otc_counterparty_simple
    category: otc_derivatives
    difficulty: easy
    input: "Add Goldman Sachs as a counterparty"
    expected_intents:
      - counterparty_create
    expected_entities:
      counterparty_reference: "Goldman Sachs"
    expected_dsl_contains:
      - "counterparty.ensure"
      - "Goldman Sachs"
    notes: "Basic counterparty onboarding"

  - id: otc_counterparty_with_lei
    category: otc_derivatives
    difficulty: medium
    input: "Onboard JP Morgan (LEI: 8I5DZWZKVSZI1NUHU748) for derivatives trading"
    expected_intents:
      - counterparty_create
    expected_entities:
      counterparty_reference: "JP Morgan"
      lei: "8I5DZWZKVSZI1NUHU748"
    expected_dsl_contains:
      - "counterparty.ensure"
      - "JP Morgan"
      - "8I5DZWZKVSZI1NUHU748"

  - id: otc_counterparty_short_name
    category: otc_derivatives
    difficulty: easy
    input: "Add GS as counterparty"
    expected_intents:
      - counterparty_create
    expected_entities:
      counterparty_reference: "Goldman Sachs"
    expected_dsl_contains:
      - "counterparty.ensure"
    notes: "Short name should resolve to full name"

  # --- ISDA Tests ---

  - id: otc_isda_simple
    category: otc_derivatives
    difficulty: easy
    input: "Establish ISDA with Goldman Sachs"
    expected_intents:
      - isda_establish
    expected_entities:
      counterparty_reference: "Goldman Sachs"
      isda_version: "2002"
    expected_dsl_contains:
      - "isda.establish"
      - "Goldman Sachs"
      - "2002"
    notes: "Default to 2002 ISDA"

  - id: otc_isda_with_law
    category: otc_derivatives
    difficulty: medium
    input: "2002 ISDA with Deutsche Bank under English law"
    expected_intents:
      - isda_establish
    expected_entities:
      counterparty_reference: "Deutsche Bank"
      isda_version: "2002"
      governing_law: "ENGLISH"
    expected_dsl_contains:
      - "isda.establish"
      - "Deutsche Bank"
      - "ENGLISH"

  - id: otc_isda_product_scope
    category: otc_derivatives
    difficulty: medium
    input: "Add interest rate swaps and FX forwards to the Goldman ISDA"
    expected_intents:
      - isda_add_products
    expected_entities:
      isda_reference: "@isda-goldman"
      derivative_product_type: ["IRS", "FX_FORWARD"]
    expected_dsl_contains:
      - "isda.add-product-scope"
      - "IRS"
      - "FX_FORWARD"

  # --- CSA Tests ---

  - id: otc_csa_simple_vm
    category: otc_derivatives
    difficulty: easy
    input: "Add VM CSA to the Goldman ISDA"
    expected_intents:
      - csa_establish
    expected_entities:
      isda_reference: "@isda-goldman"
      csa_type: "VM"
    expected_dsl_contains:
      - "csa.establish"
      - "VM"

  - id: otc_csa_with_thresholds
    category: otc_derivatives
    difficulty: medium
    input: "Establish CSA with Goldman: zero threshold, 500k MTA, USD"
    expected_intents:
      - csa_establish
    expected_entities:
      counterparty_reference: "Goldman Sachs"
      csa_type: "VM"
      our_threshold: 0
      mta: 500000
      threshold_ccy: "USD"
    expected_dsl_contains:
      - "csa.establish"
      - "500000"
      - "USD"

  - id: otc_csa_im
    category: otc_derivatives
    difficulty: hard
    input: "Set up IM CSA with Morgan Stanley using third-party custody at State Street"
    expected_intents:
      - csa_establish
    expected_entities:
      counterparty_reference: "Morgan Stanley"
      csa_type: "IM"
      custodian_reference: "State Street"
    expected_dsl_contains:
      - "csa.establish"
      - "IM"
      - "State Street"

  - id: otc_csa_eligible_collateral
    category: otc_derivatives
    difficulty: medium
    input: "Accept cash and treasuries with 2% haircut for the Goldman CSA"
    expected_intents:
      - csa_add_eligible_collateral
    expected_entities:
      csa_reference: "@csa-goldman"
      collateral_asset_class: ["CASH", "GOVT_BOND"]
      haircut_percentage: 2.0
    expected_dsl_contains:
      - "csa.add-eligible-collateral"
      - "CASH"
      - "GOVT_BOND"

  # --- Collateral Account Tests ---

  - id: otc_collateral_vm_account
    category: otc_derivatives
    difficulty: medium
    input: "Set up VM collateral account for Goldman"
    expected_intents:
      - collateral_setup_accounts
    expected_entities:
      counterparty_reference: "Goldman Sachs"
      collateral_account_type: "VM_POSTED"
    expected_dsl_contains:
      - "collateral.ensure-account"
      - "VM_POSTED"

  - id: otc_collateral_im_segregated
    category: otc_derivatives
    difficulty: hard
    input: "Create segregated IM account with BNY Mellon as custodian for Morgan Stanley collateral"
    expected_intents:
      - collateral_setup_accounts
    expected_entities:
      counterparty_reference: "Morgan Stanley"
      collateral_account_type: "POSTED_IM"
      custodian_reference: "BNY Mellon"
    expected_dsl_contains:
      - "collateral.ensure-account"
      - "POSTED_IM"
      - "BNY Mellon"

  # --- Confirmation Tests ---

  - id: otc_confirmation_simple
    category: otc_derivatives
    difficulty: easy
    input: "Use DTCC for IRS confirmations with Goldman"
    expected_intents:
      - confirmation_configure
    expected_entities:
      counterparty_reference: "Goldman Sachs"
      confirmation_method: "DTCC_GTR"
      derivative_product_type: "IRS"
    expected_dsl_contains:
      - "confirmation.configure"
      - "DTCC_GTR"
      - "IRS"

  - id: otc_confirmation_multiple
    category: otc_derivatives
    difficulty: medium
    input: "Configure MarkitWire for rates products and DTCC for credit with JP Morgan"
    expected_intents:
      - confirmation_configure
      - confirmation_configure
    expected_entities:
      counterparty_reference: "JP Morgan"
      confirmation_method: ["MARKITWIRE", "DTCC_GTR"]
    expected_dsl_statements: 2
    expected_dsl_contains:
      - "confirmation.configure"
      - "MARKITWIRE"
      - "DTCC_GTR"

  # --- Compound OTC Tests ---

  - id: otc_compound_full_setup
    category: otc_derivatives
    difficulty: hard
    input: |
      Set up Goldman Sachs for OTC trading:
      2002 ISDA under NY law,
      VM CSA with zero threshold,
      accept cash and treasuries,
      use DTCC for confirmations
    expected_intents:
      - counterparty_create
      - isda_establish
      - csa_establish
      - csa_add_eligible_collateral
      - confirmation_configure
    expected_dsl_statements: 5
    expected_dsl_contains:
      - "counterparty.ensure"
      - "isda.establish"
      - "csa.establish"
      - "csa.add-eligible-collateral"
      - "confirmation.configure"
      - "Goldman Sachs"
      - "2002"
      - "NY"
      - "VM"
      - "DTCC"

  - id: otc_compound_im_setup
    category: otc_derivatives
    difficulty: hard
    input: |
      Configure IM for Morgan Stanley:
      IM CSA with State Street custody,
      accept cash, treasuries, and agencies,
      10% haircut on agencies
    expected_intents:
      - csa_establish
      - csa_add_eligible_collateral
      - collateral_setup_accounts
    expected_dsl_contains:
      - "csa.establish"
      - "IM"
      - "State Street"
      - "CASH"
      - "GOVT_BOND"
      - "AGENCY"

  - id: otc_compound_multi_counterparty
    category: otc_derivatives
    difficulty: hard
    input: "Set up ISDAs with Goldman and JP Morgan, both under NY law with VM CSAs"
    expected_intents:
      - isda_establish
      - isda_establish
      - csa_establish
      - csa_establish
    expected_dsl_statements: 4
    expected_dsl_contains:
      - "Goldman"
      - "JP Morgan"
      - "NY"
      - "VM"

  # --- Context-Dependent OTC Tests ---

  - id: otc_context_add_product
    category: otc_derivatives
    difficulty: medium
    input: "Also add CDS coverage"
    context:
      last_intent: "isda_establish"
      session_entities:
        isda_reference: "@isda-goldman"
    expected_intents:
      - isda_add_products
    expected_entities:
      derivative_product_type: "CDS"
    notes: "Should inherit ISDA reference from context"

  - id: otc_context_followup_csa
    category: otc_derivatives
    difficulty: medium
    input: "Now add a CSA to it"
    context:
      last_intent: "isda_establish"
      session_entities:
        isda_reference: "@isda-goldman"
        counterparty_reference: "Goldman Sachs"
    expected_intents:
      - csa_establish
    expected_dsl_contains:
      - "csa.establish"
    notes: "Should link CSA to ISDA from context"

  # --- OTC Edge Cases ---

  - id: otc_edge_unknown_counterparty
    category: otc_derivatives
    difficulty: medium
    input: "Establish ISDA with Unknown Bank Ltd"
    expected_intents:
      - isda_establish
    expected_entities:
      counterparty_reference: null
    expected_response_type: clarification
    notes: "Unknown counterparty should trigger clarification"

  - id: otc_edge_invalid_csa_type
    category: otc_derivatives
    difficulty: easy
    input: "Add XYZ CSA to Goldman ISDA"
    expected_entities:
      csa_type: null
    notes: "Invalid CSA type should not be extracted"

  - id: otc_edge_benchmark_inference
    category: otc_derivatives
    difficulty: medium
    input: "EUR-denominated CSA with Goldman"
    expected_intents:
      - csa_establish
    expected_entities:
      threshold_ccy: "EUR"
      interest_benchmark: "ESTR"
    notes: "Should infer ESTR from EUR currency"

# Metrics configuration for evaluation
metrics:
  intent_classification:
    accuracy_threshold: 0.85
    precision_threshold: 0.80
    recall_threshold: 0.80

  entity_extraction:
    accuracy_threshold: 0.90
    precision_threshold: 0.85
    recall_threshold: 0.85

  dsl_generation:
    validity_threshold: 0.95
    completeness_threshold: 0.90

# Test categories for selective running
categories:
  quick_smoke:
    - im_simple_1
    - pricing_simple_1
    - sweep_simple_1
    - sla_simple_1

  intent_classification:
    - im_simple_1
    - im_simple_2
    - pricing_simple_1
    - pricing_with_scope

  entity_extraction:
    - im_with_region
    - im_with_method
    - im_multiple_markets

  compound_intents:
    - compound_im_pricing
    - compound_two_ims
    - compound_three_ims
    - compound_full_setup

  context_handling:
    - context_coreference_1
    - context_followup_1
    - context_implicit_cbu

  edge_cases:
    - edge_empty_input
    - edge_ambiguous
    - edge_unknown_manager
    - edge_invalid_market

  otc_derivatives:
    - otc_counterparty_simple
    - otc_counterparty_with_lei
    - otc_counterparty_short_name
    - otc_isda_simple
    - otc_isda_with_law
    - otc_isda_product_scope
    - otc_csa_simple_vm
    - otc_csa_with_thresholds
    - otc_csa_im
    - otc_csa_eligible_collateral
    - otc_collateral_vm_account
    - otc_collateral_im_segregated
    - otc_confirmation_simple
    - otc_confirmation_multiple
    - otc_compound_full_setup
    - otc_compound_im_setup
    - otc_compound_multi_counterparty
    - otc_context_add_product
    - otc_context_followup_csa
    - otc_edge_unknown_counterparty
    - otc_edge_invalid_csa_type
    - otc_edge_benchmark_inference
