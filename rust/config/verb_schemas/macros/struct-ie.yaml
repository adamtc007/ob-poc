# Ireland Structure Macros (M4-M6)
#
# Jurisdiction-specific fund structure macros for Ireland.
# These expand business-friendly terms to DSL primitives with
# appropriate document bundles and role cardinality.
#
# M4: struct.ie.ucits.icav - Ireland UCITS ICAV
# M5: struct.ie.aif.icav - Ireland AIF ICAV
# M6: struct.ie.hedge.icav - Ireland Hedge Fund ICAV (composite, uses invoke-macro)

# =============================================================================
# M4: Ireland UCITS ICAV
# =============================================================================
struct.ie.ucits.icav:
  kind: macro

  ui:
    label: "Ireland UCITS ICAV"
    description: "Set up an Irish UCITS fund using ICAV structure"
    target_label: "UCITS ICAV"

  routing:
    mode_tags: [onboarding, structure]
    operator_domain: structure

  target:
    operates_on: client_ref
    produces: structure_ref
    allowed_structure_types: [icav, ucits]

  args:
    style: keyworded
    required:
      name:
        type: str
        ui_label: "Fund Name"
      management_company:
        type: party_ref
        ui_label: "Management Company"
        picker: party_picker
        internal:
          kinds: [company]
      depositary:
        type: party_ref
        ui_label: "Depositary"
        picker: party_picker
        internal:
          kinds: [company]
    optional:
      investment_manager:
        type: party_ref
        ui_label: "Investment Manager"
        picker: party_picker
        internal:
          kinds: [company]
      administrator:
        type: party_ref
        ui_label: "Administrator"
        picker: party_picker
        internal:
          kinds: [company]
      auditor:
        type: party_ref
        ui_label: "Auditor"
        picker: party_picker
        internal:
          kinds: [company]
      secretary:
        type: party_ref
        ui_label: "Company Secretary"
        picker: party_picker
        internal:
          kinds: [company]
      legal_counsel:
        type: party_ref
        ui_label: "Legal Counsel"
        picker: party_picker
        internal:
          kinds: [company]

  prereqs: []

  expands_to:
    # Create the CBU
    - verb: cbu.create
      args:
        name: "${arg.name}"
        kind: icav
        jurisdiction: IE
        structure_type: ucits
      as: "@cbu"

    # Apply document bundle
    - verb: docs-bundle.apply
      args:
        cbu_id: "@cbu"
        bundle_id: docs.bundle.ucits-baseline

    # Assign management company (required for UCITS)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.management_company}"
        kind: company
        placeholder_name: "ManCo TBD"
      as: "@manco"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: management-company
        entity_id: "@manco"

    # Assign depositary (required for UCITS)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.depositary}"
        kind: company
        placeholder_name: "Depositary TBD"
      as: "@depositary"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: depositary
        entity_id: "@depositary"

    # Assign investment manager (optional)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.investment_manager}"
        kind: company
        placeholder_name: "Investment Manager TBD"
        skip_if_empty: true
      as: "@im"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: investment-manager
        entity_id: "@im"
        skip_if_empty: true

    # Assign administrator (optional)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.administrator}"
        kind: company
        placeholder_name: "Administrator TBD"
        skip_if_empty: true
      as: "@admin"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: administrator
        entity_id: "@admin"
        skip_if_empty: true

    # Assign auditor (optional)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.auditor}"
        kind: company
        placeholder_name: "Auditor TBD"
        skip_if_empty: true
      as: "@auditor"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: auditor
        entity_id: "@auditor"
        skip_if_empty: true

    # Assign company secretary (optional)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.secretary}"
        kind: company
        placeholder_name: "Secretary TBD"
        skip_if_empty: true
      as: "@secretary"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: company-secretary
        entity_id: "@secretary"
        skip_if_empty: true

    # Create trading profile
    - verb: trading-profile.create
      args:
        cbu_id: "@cbu"
        name: "${arg.name} Trading"
        profile_type: ucits
      as: "@trading-profile"

  sets_state:
    - key: structure.exists
      value: true
    - key: structure.type
      value: ucits-icav

  unlocks:
    - structure.assign-role
    - mandate.create
    - case.open

# =============================================================================
# M5: Ireland AIF ICAV
# =============================================================================
struct.ie.aif.icav:
  kind: macro

  ui:
    label: "Ireland AIF ICAV"
    description: "Set up an Irish Alternative Investment Fund using ICAV structure"
    target_label: "AIF ICAV"

  routing:
    mode_tags: [onboarding, structure]
    operator_domain: structure

  target:
    operates_on: client_ref
    produces: structure_ref
    allowed_structure_types: [icav, aif]

  args:
    style: keyworded
    required:
      name:
        type: str
        ui_label: "Fund Name"
      aifm:
        type: party_ref
        ui_label: "AIFM"
        description: "Alternative Investment Fund Manager"
        picker: party_picker
        internal:
          kinds: [company]
      depositary:
        type: party_ref
        ui_label: "Depositary"
        picker: party_picker
        internal:
          kinds: [company]
    optional:
      aif_type:
        type: enum
        ui_label: "AIF Type"
        values:
          - key: qiaif
            label: "QIAIF"
            internal: qiaif
          - key: riaif
            label: "RIAIF"
            internal: riaif
        default_key: qiaif
      investment_manager:
        type: party_ref
        ui_label: "Investment Manager"
        picker: party_picker
        internal:
          kinds: [company]
      administrator:
        type: party_ref
        ui_label: "Administrator"
        picker: party_picker
        internal:
          kinds: [company]
      auditor:
        type: party_ref
        ui_label: "Auditor"
        picker: party_picker
        internal:
          kinds: [company]
      prime_broker:
        type: party_ref
        ui_label: "Prime Broker"
        picker: party_picker
        internal:
          kinds: [company]
      secretary:
        type: party_ref
        ui_label: "Company Secretary"
        picker: party_picker
        internal:
          kinds: [company]

  prereqs: []

  expands_to:
    # Create the CBU
    - verb: cbu.create
      args:
        name: "${arg.name}"
        kind: icav
        jurisdiction: IE
        structure_type: aif
        aif_type: "${arg.aif_type.internal}"
      as: "@cbu"

    # Apply document bundle
    - verb: docs-bundle.apply
      args:
        cbu_id: "@cbu"
        bundle_id: docs.bundle.aif-baseline

    # Assign AIFM (required for AIF)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.aifm}"
        kind: company
        placeholder_name: "AIFM TBD"
      as: "@aifm"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: aifm
        entity_id: "@aifm"

    # Assign depositary (required for AIF)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.depositary}"
        kind: company
        placeholder_name: "Depositary TBD"
      as: "@depositary"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: depositary
        entity_id: "@depositary"

    # Assign investment manager (optional)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.investment_manager}"
        kind: company
        placeholder_name: "Investment Manager TBD"
        skip_if_empty: true
      as: "@im"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: investment-manager
        entity_id: "@im"
        skip_if_empty: true

    # Assign administrator (optional)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.administrator}"
        kind: company
        placeholder_name: "Administrator TBD"
        skip_if_empty: true
      as: "@admin"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: administrator
        entity_id: "@admin"
        skip_if_empty: true

    # Assign auditor (optional)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.auditor}"
        kind: company
        placeholder_name: "Auditor TBD"
        skip_if_empty: true
      as: "@auditor"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: auditor
        entity_id: "@auditor"
        skip_if_empty: true

    # Assign prime broker (optional)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.prime_broker}"
        kind: company
        placeholder_name: "Prime Broker TBD"
        skip_if_empty: true
      as: "@pb"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: prime-broker
        entity_id: "@pb"
        skip_if_empty: true

    # Create trading profile
    - verb: trading-profile.create
      args:
        cbu_id: "@cbu"
        name: "${arg.name} Trading"
        profile_type: aif
      as: "@trading-profile"

  sets_state:
    - key: structure.exists
      value: true
    - key: structure.type
      value: aif-icav

  unlocks:
    - structure.assign-role
    - mandate.create
    - case.open

# =============================================================================
# M6: Ireland Hedge Fund ICAV (Composite - uses invoke-macro)
# =============================================================================
struct.ie.hedge.icav:
  kind: macro

  ui:
    label: "Ireland Hedge Fund ICAV"
    description: "Set up an Irish Hedge Fund using ICAV/QIAIF structure with prime brokerage"
    target_label: "Hedge ICAV"

  routing:
    mode_tags: [onboarding, structure]
    operator_domain: structure

  target:
    operates_on: client_ref
    produces: structure_ref
    allowed_structure_types: [icav, hedge, qiaif]

  args:
    style: keyworded
    required:
      name:
        type: str
        ui_label: "Fund Name"
      aifm:
        type: party_ref
        ui_label: "AIFM"
        picker: party_picker
        internal:
          kinds: [company]
      depositary:
        type: party_ref
        ui_label: "Depositary"
        picker: party_picker
        internal:
          kinds: [company]
      prime_broker:
        type: party_ref
        ui_label: "Prime Broker"
        description: "Primary prime broker"
        picker: party_picker
        internal:
          kinds: [company]
    optional:
      investment_manager:
        type: party_ref
        ui_label: "Investment Manager"
        picker: party_picker
        internal:
          kinds: [company]
      administrator:
        type: party_ref
        ui_label: "Administrator"
        picker: party_picker
        internal:
          kinds: [company]
      auditor:
        type: party_ref
        ui_label: "Auditor"
        picker: party_picker
        internal:
          kinds: [company]
      secondary_prime_broker:
        type: party_ref
        ui_label: "Secondary Prime Broker"
        picker: party_picker
        internal:
          kinds: [company]
      executing_broker:
        type: party_ref
        ui_label: "Executing Broker"
        picker: party_picker
        internal:
          kinds: [company]

  prereqs: []

  expands_to:
    # Invoke the base AIF ICAV macro to set up the core structure
    - invoke-macro: struct.ie.aif.icav
      args:
        name: "${arg.name}"
        aifm: "${arg.aifm}"
        depositary: "${arg.depositary}"
        investment_manager: "${arg.investment_manager}"
        administrator: "${arg.administrator}"
        auditor: "${arg.auditor}"
        prime_broker: "${arg.prime_broker}"
      import-symbols:
        - "@cbu"
        - "@trading-profile"

    # Apply hedge-specific document bundle (extends AIF baseline)
    - verb: docs-bundle.apply
      args:
        cbu_id: "@cbu"
        bundle_id: docs.bundle.hedge-baseline

    # Add secondary prime broker if provided
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.secondary_prime_broker}"
        kind: company
        placeholder_name: "Secondary PB TBD"
        skip_if_empty: true
      as: "@secondary-pb"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: prime-broker
        entity_id: "@secondary-pb"
        skip_if_empty: true

    # Add executing broker if provided
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.executing_broker}"
        kind: company
        placeholder_name: "Executing Broker TBD"
        skip_if_empty: true
      as: "@exec-broker"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: executing-broker
        entity_id: "@exec-broker"
        skip_if_empty: true

    # Update trading profile for hedge fund specifics
    - verb: trading-profile.update
      args:
        trading_profile_id: "@trading-profile"
        profile_type: hedge
        leverage_permitted: true
        short_selling_permitted: true

  sets_state:
    - key: structure.exists
      value: true
    - key: structure.type
      value: hedge-icav

  unlocks:
    - structure.assign-role
    - mandate.create
    - case.open
