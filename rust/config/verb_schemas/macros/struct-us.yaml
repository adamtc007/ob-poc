# US Structure Macros (M13-M16)
#
# Jurisdiction-specific fund structure macros for United States.
# These expand business-friendly terms to DSL primitives with
# appropriate document bundles and role cardinality.
#
# M13: struct.us.40act.open-end - US 40 Act Open-End Fund
# M14: struct.us.40act.closed-end - US 40 Act Closed-End Fund
# M15: struct.us.etf.40act - US 40 Act ETF
# M16: struct.us.private-fund.delaware-lp - US Private Fund Delaware LP

# =============================================================================
# M13: US 40 Act Open-End Fund
# =============================================================================
struct.us.40act.open-end:
  kind: macro

  ui:
    label: "US 40 Act Open-End Fund"
    description: "Set up a US Investment Company Act registered open-end mutual fund"
    target-label: "Open-End Fund"

  routing:
    mode-tags: [onboarding, structure]
    operator-domain: structure

  target:
    operates-on: client-ref
    produces: structure-ref
    allowed-structure-types: [40act, open-end, mutual-fund]

  args:
    style: keyworded
    required:
      name:
        type: str
        ui-label: "Fund Name"
      investment_adviser:
        type: party-ref
        ui-label: "Investment Adviser"
        description: "SEC-registered investment adviser"
        picker: party_picker
        internal:
          kinds: [company]
      custodian:
        type: party-ref
        ui-label: "Custodian"
        picker: party_picker
        internal:
          kinds: [company]
    optional:
      sub_adviser:
        type: party-ref
        ui-label: "Sub-Adviser"
        picker: party_picker
        internal:
          kinds: [company]
      administrator:
        type: party-ref
        ui-label: "Administrator"
        picker: party_picker
        internal:
          kinds: [company]
      transfer_agent:
        type: party-ref
        ui-label: "Transfer Agent"
        picker: party_picker
        internal:
          kinds: [company]
      distributor:
        type: party-ref
        ui-label: "Principal Underwriter/Distributor"
        picker: party_picker
        internal:
          kinds: [company]
      auditor:
        type: party-ref
        ui-label: "Independent Auditor"
        picker: party_picker
        internal:
          kinds: [company]
      legal_counsel:
        type: party-ref
        ui-label: "Legal Counsel"
        picker: party_picker
        internal:
          kinds: [company]
      cik_number:
        type: str
        ui-label: "SEC CIK Number"

  prereqs: []

  expands-to:
    # Create the CBU
    - verb: cbu.create
      args:
        name: "${arg.name}"
        kind: open-end-fund
        jurisdiction: US
        structure-type: 40act
        regulatory_status: registered
      as: "@cbu"

    # Apply document bundle
    - verb: docs-bundle.apply
      args:
        cbu_id: "@cbu"
        bundle_id: docs.bundle.us-40act-baseline

    # Assign investment adviser (required)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.investment_adviser}"
        kind: company
        placeholder_name: "Investment Adviser TBD"
      as: "@adviser"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: investment-adviser
        entity_id: "@adviser"

    # Assign custodian (required)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.custodian}"
        kind: company
        placeholder_name: "Custodian TBD"
      as: "@custodian"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: custodian
        entity_id: "@custodian"

    # Assign sub-adviser (optional)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.sub_adviser}"
        kind: company
        placeholder_name: "Sub-Adviser TBD"
        skip_if_empty: true
      as: "@subadviser"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: sub-adviser
        entity_id: "@subadviser"
        skip_if_empty: true

    # Assign administrator (optional)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.administrator}"
        kind: company
        placeholder_name: "Administrator TBD"
        skip_if_empty: true
      as: "@admin"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: administrator
        entity_id: "@admin"
        skip_if_empty: true

    # Assign transfer agent (optional)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.transfer_agent}"
        kind: company
        placeholder_name: "Transfer Agent TBD"
        skip_if_empty: true
      as: "@ta"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: transfer-agent
        entity_id: "@ta"
        skip_if_empty: true

    # Assign distributor (optional)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.distributor}"
        kind: company
        placeholder_name: "Distributor TBD"
        skip_if_empty: true
      as: "@distributor"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: distributor
        entity_id: "@distributor"
        skip_if_empty: true

    # Assign auditor (optional)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.auditor}"
        kind: company
        placeholder_name: "Auditor TBD"
        skip_if_empty: true
      as: "@auditor"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: auditor
        entity_id: "@auditor"
        skip_if_empty: true

    # Create trading profile
    - verb: trading-profile.create
      args:
        cbu_id: "@cbu"
        name: "${arg.name} Trading"
        profile_type: 40act
      as: "@trading-profile"

  sets-state:
    - key: structure.exists
      value: true
    - key: structure.type
      value: 40act-open-end

  unlocks:
    - structure.assign-role
    - mandate.create
    - case.open

# =============================================================================
# M14: US 40 Act Closed-End Fund
# =============================================================================
struct.us.40act.closed-end:
  kind: macro

  ui:
    label: "US 40 Act Closed-End Fund"
    description: "Set up a US Investment Company Act registered closed-end fund"
    target-label: "Closed-End Fund"

  routing:
    mode-tags: [onboarding, structure]
    operator-domain: structure

  target:
    operates-on: client-ref
    produces: structure-ref
    allowed-structure-types: [40act, closed-end]

  args:
    style: keyworded
    required:
      name:
        type: str
        ui-label: "Fund Name"
      investment_adviser:
        type: party-ref
        ui-label: "Investment Adviser"
        picker: party_picker
        internal:
          kinds: [company]
      custodian:
        type: party-ref
        ui-label: "Custodian"
        picker: party_picker
        internal:
          kinds: [company]
    optional:
      sub_adviser:
        type: party-ref
        ui-label: "Sub-Adviser"
        picker: party_picker
        internal:
          kinds: [company]
      administrator:
        type: party-ref
        ui-label: "Administrator"
        picker: party_picker
        internal:
          kinds: [company]
      transfer_agent:
        type: party-ref
        ui-label: "Transfer Agent"
        picker: party_picker
        internal:
          kinds: [company]
      auditor:
        type: party-ref
        ui-label: "Independent Auditor"
        picker: party_picker
        internal:
          kinds: [company]
      legal_counsel:
        type: party-ref
        ui-label: "Legal Counsel"
        picker: party_picker
        internal:
          kinds: [company]
      listing_exchange:
        type: enum
        ui-label: "Listing Exchange"
        values:
          - key: nyse
            label: "NYSE"
            internal: NYSE
          - key: nasdaq
            label: "NASDAQ"
            internal: NASDAQ
          - key: amex
            label: "NYSE American"
            internal: AMEX
        default-key: nyse

  prereqs: []

  expands-to:
    # Create the CBU
    - verb: cbu.create
      args:
        name: "${arg.name}"
        kind: closed-end-fund
        jurisdiction: US
        structure-type: 40act
        regulatory_status: registered
        listing_exchange: "${arg.listing_exchange.internal}"
      as: "@cbu"

    # Apply document bundle
    - verb: docs-bundle.apply
      args:
        cbu_id: "@cbu"
        bundle_id: docs.bundle.us-40act-baseline

    # Assign investment adviser (required)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.investment_adviser}"
        kind: company
        placeholder_name: "Investment Adviser TBD"
      as: "@adviser"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: investment-adviser
        entity_id: "@adviser"

    # Assign custodian (required)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.custodian}"
        kind: company
        placeholder_name: "Custodian TBD"
      as: "@custodian"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: custodian
        entity_id: "@custodian"

    # Assign sub-adviser (optional)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.sub_adviser}"
        kind: company
        placeholder_name: "Sub-Adviser TBD"
        skip_if_empty: true
      as: "@subadviser"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: sub-adviser
        entity_id: "@subadviser"
        skip_if_empty: true

    # Assign administrator (optional)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.administrator}"
        kind: company
        placeholder_name: "Administrator TBD"
        skip_if_empty: true
      as: "@admin"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: administrator
        entity_id: "@admin"
        skip_if_empty: true

    # Assign transfer agent (optional)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.transfer_agent}"
        kind: company
        placeholder_name: "Transfer Agent TBD"
        skip_if_empty: true
      as: "@ta"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: transfer-agent
        entity_id: "@ta"
        skip_if_empty: true

    # Assign auditor (optional)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.auditor}"
        kind: company
        placeholder_name: "Auditor TBD"
        skip_if_empty: true
      as: "@auditor"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: auditor
        entity_id: "@auditor"
        skip_if_empty: true

    # Create trading profile
    - verb: trading-profile.create
      args:
        cbu_id: "@cbu"
        name: "${arg.name} Trading"
        profile_type: 40act
      as: "@trading-profile"

  sets-state:
    - key: structure.exists
      value: true
    - key: structure.type
      value: 40act-closed-end

  unlocks:
    - structure.assign-role
    - mandate.create
    - case.open

# =============================================================================
# M15: US 40 Act ETF
# =============================================================================
struct.us.etf.40act:
  kind: macro

  ui:
    label: "US 40 Act ETF"
    description: "Set up a US Exchange-Traded Fund registered under the Investment Company Act"
    target-label: "ETF"

  routing:
    mode-tags: [onboarding, structure]
    operator-domain: structure

  target:
    operates-on: client-ref
    produces: structure-ref
    allowed-structure-types: [etf, 40act]

  args:
    style: keyworded
    required:
      name:
        type: str
        ui-label: "Fund Name"
      investment_adviser:
        type: party-ref
        ui-label: "Investment Adviser"
        picker: party_picker
        internal:
          kinds: [company]
      custodian:
        type: party-ref
        ui-label: "Custodian"
        picker: party_picker
        internal:
          kinds: [company]
      authorized_participant:
        type: party-ref
        ui-label: "Authorized Participant"
        description: "AP for creation/redemption"
        picker: party_picker
        internal:
          kinds: [company]
    optional:
      sub_adviser:
        type: party-ref
        ui-label: "Sub-Adviser"
        picker: party_picker
        internal:
          kinds: [company]
      administrator:
        type: party-ref
        ui-label: "Administrator"
        picker: party_picker
        internal:
          kinds: [company]
      transfer_agent:
        type: party-ref
        ui-label: "Transfer Agent"
        picker: party_picker
        internal:
          kinds: [company]
      distributor:
        type: party-ref
        ui-label: "Distributor"
        picker: party_picker
        internal:
          kinds: [company]
      auditor:
        type: party-ref
        ui-label: "Independent Auditor"
        picker: party_picker
        internal:
          kinds: [company]
      market_maker:
        type: party-ref
        ui-label: "Market Maker"
        picker: party_picker
        internal:
          kinds: [company]
      etf_type:
        type: enum
        ui-label: "ETF Type"
        values:
          - key: index
            label: "Index ETF"
            internal: index
          - key: active
            label: "Active ETF"
            internal: active
          - key: transparent
            label: "Transparent Active"
            internal: transparent-active
          - key: semi_transparent
            label: "Semi-Transparent"
            internal: semi-transparent
        default-key: index
      listing_exchange:
        type: enum
        ui-label: "Listing Exchange"
        values:
          - key: nyse_arca
            label: "NYSE Arca"
            internal: NYSE-ARCA
          - key: nasdaq
            label: "NASDAQ"
            internal: NASDAQ
          - key: cboe
            label: "Cboe BZX"
            internal: CBOE-BZX
        default-key: nyse_arca

  prereqs: []

  expands-to:
    # Create the CBU
    - verb: cbu.create
      args:
        name: "${arg.name}"
        kind: etf
        jurisdiction: US
        structure-type: 40act
        regulatory_status: registered
        etf_type: "${arg.etf_type.internal}"
        listing_exchange: "${arg.listing_exchange.internal}"
      as: "@cbu"

    # Apply document bundle
    - verb: docs-bundle.apply
      args:
        cbu_id: "@cbu"
        bundle_id: docs.bundle.etf-baseline

    # Assign investment adviser (required)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.investment_adviser}"
        kind: company
        placeholder_name: "Investment Adviser TBD"
      as: "@adviser"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: investment-adviser
        entity_id: "@adviser"

    # Assign custodian (required)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.custodian}"
        kind: company
        placeholder_name: "Custodian TBD"
      as: "@custodian"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: custodian
        entity_id: "@custodian"

    # Assign authorized participant (required for ETF)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.authorized_participant}"
        kind: company
        placeholder_name: "Authorized Participant TBD"
      as: "@ap"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: authorized-participant
        entity_id: "@ap"

    # Assign sub-adviser (optional)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.sub_adviser}"
        kind: company
        placeholder_name: "Sub-Adviser TBD"
        skip_if_empty: true
      as: "@subadviser"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: sub-adviser
        entity_id: "@subadviser"
        skip_if_empty: true

    # Assign administrator (optional)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.administrator}"
        kind: company
        placeholder_name: "Administrator TBD"
        skip_if_empty: true
      as: "@admin"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: administrator
        entity_id: "@admin"
        skip_if_empty: true

    # Assign transfer agent (optional)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.transfer_agent}"
        kind: company
        placeholder_name: "Transfer Agent TBD"
        skip_if_empty: true
      as: "@ta"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: transfer-agent
        entity_id: "@ta"
        skip_if_empty: true

    # Assign distributor (optional)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.distributor}"
        kind: company
        placeholder_name: "Distributor TBD"
        skip_if_empty: true
      as: "@distributor"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: distributor
        entity_id: "@distributor"
        skip_if_empty: true

    # Assign auditor (optional)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.auditor}"
        kind: company
        placeholder_name: "Auditor TBD"
        skip_if_empty: true
      as: "@auditor"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: auditor
        entity_id: "@auditor"
        skip_if_empty: true

    # Assign market maker (optional)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.market_maker}"
        kind: company
        placeholder_name: "Market Maker TBD"
        skip_if_empty: true
      as: "@mm"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: market-maker
        entity_id: "@mm"
        skip_if_empty: true

    # Create trading profile (ETF style)
    - verb: trading-profile.create
      args:
        cbu_id: "@cbu"
        name: "${arg.name} Trading"
        profile_type: etf
      as: "@trading-profile"

  sets-state:
    - key: structure.exists
      value: true
    - key: structure.type
      value: etf-40act

  unlocks:
    - structure.assign-role
    - mandate.create
    - case.open

# =============================================================================
# M16: US Private Fund Delaware LP
# =============================================================================
struct.us.private-fund.delaware-lp:
  kind: macro

  ui:
    label: "US Private Fund Delaware LP"
    description: "Set up a US private fund using Delaware Limited Partnership structure"
    target-label: "Delaware LP"

  routing:
    mode-tags: [onboarding, structure]
    operator-domain: structure

  target:
    operates-on: client-ref
    produces: structure-ref
    allowed-structure-types: [delaware-lp, private-fund, pe, hedge]

  args:
    style: keyworded
    required:
      name:
        type: str
        ui-label: "Fund Name"
      general_partner:
        type: party-ref
        ui-label: "General Partner"
        picker: party_picker
        internal:
          kinds: [company]
      investment_manager:
        type: party-ref
        ui-label: "Investment Manager"
        description: "SEC-registered or exempt adviser"
        picker: party_picker
        internal:
          kinds: [company]
    optional:
      fund_type:
        type: enum
        ui-label: "Fund Type"
        values:
          - key: pe
            label: "Private Equity"
            internal: private-equity
          - key: vc
            label: "Venture Capital"
            internal: venture-capital
          - key: hedge
            label: "Hedge Fund"
            internal: hedge
          - key: real_estate
            label: "Real Estate"
            internal: real-estate
          - key: credit
            label: "Private Credit"
            internal: private-credit
        default-key: pe
      custodian:
        type: party-ref
        ui-label: "Custodian"
        picker: party_picker
        internal:
          kinds: [company]
      administrator:
        type: party-ref
        ui-label: "Administrator"
        picker: party_picker
        internal:
          kinds: [company]
      prime_broker:
        type: party-ref
        ui-label: "Prime Broker"
        description: "For hedge fund strategies"
        picker: party_picker
        internal:
          kinds: [company]
      auditor:
        type: party-ref
        ui-label: "Independent Auditor"
        picker: party_picker
        internal:
          kinds: [company]
      legal_counsel:
        type: party-ref
        ui-label: "Legal Counsel"
        picker: party_picker
        internal:
          kinds: [company]
      tax_advisor:
        type: party-ref
        ui-label: "Tax Advisor"
        picker: party_picker
        internal:
          kinds: [company]
      exemption:
        type: enum
        ui-label: "Regulatory Exemption"
        values:
          - key: 3c1
            label: "3(c)(1) - 100 Investor Limit"
            internal: 3c1
          - key: 3c7
            label: "3(c)(7) - Qualified Purchasers"
            internal: 3c7
        default-key: 3c7
      vintage_year:
        type: str
        ui-label: "Vintage Year"
      target_size:
        type: str
        ui-label: "Target Size"

  prereqs: []

  expands-to:
    # Create the CBU
    - verb: cbu.create
      args:
        name: "${arg.name}"
        kind: delaware-lp
        jurisdiction: US
        structure-type: private-fund
        fund_type: "${arg.fund_type.internal}"
        exemption: "${arg.exemption.internal}"
      as: "@cbu"

    # Apply document bundle
    - verb: docs-bundle.apply
      args:
        cbu_id: "@cbu"
        bundle_id: docs.bundle.private-equity-baseline

    # Assign general partner (required)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.general_partner}"
        kind: company
        placeholder_name: "GP TBD"
      as: "@gp"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: general-partner
        entity_id: "@gp"

    # Assign investment manager (required)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.investment_manager}"
        kind: company
        placeholder_name: "Investment Manager TBD"
      as: "@im"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: investment-manager
        entity_id: "@im"

    # Assign custodian (optional)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.custodian}"
        kind: company
        placeholder_name: "Custodian TBD"
        skip_if_empty: true
      as: "@custodian"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: custodian
        entity_id: "@custodian"
        skip_if_empty: true

    # Assign administrator (optional)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.administrator}"
        kind: company
        placeholder_name: "Administrator TBD"
        skip_if_empty: true
      as: "@admin"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: administrator
        entity_id: "@admin"
        skip_if_empty: true

    # Assign prime broker (optional, for hedge strategies)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.prime_broker}"
        kind: company
        placeholder_name: "Prime Broker TBD"
        skip_if_empty: true
      as: "@pb"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: prime-broker
        entity_id: "@pb"
        skip_if_empty: true

    # Assign auditor (optional)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.auditor}"
        kind: company
        placeholder_name: "Auditor TBD"
        skip_if_empty: true
      as: "@auditor"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: auditor
        entity_id: "@auditor"
        skip_if_empty: true

    # Assign legal counsel (optional)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.legal_counsel}"
        kind: company
        placeholder_name: "Legal Counsel TBD"
        skip_if_empty: true
      as: "@legal"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: legal-counsel
        entity_id: "@legal"
        skip_if_empty: true

    # Assign tax advisor (optional)
    - verb: entity.ensure-or-placeholder
      args:
        ref: "${arg.tax_advisor}"
        kind: company
        placeholder_name: "Tax Advisor TBD"
        skip_if_empty: true
      as: "@tax"

    - verb: cbu-role.assign
      args:
        cbu_id: "@cbu"
        role: tax-advisor
        entity_id: "@tax"
        skip_if_empty: true

    # Create trading profile
    - verb: trading-profile.create
      args:
        cbu_id: "@cbu"
        name: "${arg.name} Trading"
        profile_type: "${arg.fund_type.internal}"
      as: "@trading-profile"

  sets-state:
    - key: structure.exists
      value: true
    - key: structure.type
      value: delaware-lp

  unlocks:
    - structure.assign-role
    - case.open
