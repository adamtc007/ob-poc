# Mandate Domain Macros
#
# Operator vocabulary for investment mandate operations.
# These macros wrap DSL primitives (trading-profile.*) with business terminology.
#
# INVARIANTS:
# - UI labels NEVER contain: trading-profile, trading_profile
# - Mandate = the investment mandate/trading authority
# - Products, instruments, markets attached to mandates

mandate.create:
  kind: macro

  ui:
    label: "Create Mandate"
    description: "Create an investment mandate for a structure"
    target-label: "Mandate"

  routing:
    mode-tags: [trading, onboarding]
    operator-domain: mandate

  target:
    operates-on: structure-ref
    produces: mandate-ref

  args:
    style: keyworded
    required:
      structure:
        type: structure-ref
        ui-label: "Structure"
        autofill-from: session.current_structure
        picker: structure_picker
      name:
        type: str
        ui-label: "Mandate Name"
    optional:
      investment_manager:
        type: party-ref
        ui-label: "Investment Manager"
        picker: party_picker
      strategy:
        type: enum
        ui-label: "Strategy"
        values:
          - key: equity
            label: "Equity"
            internal: equity
          - key: fixed_income
            label: "Fixed Income"
            internal: fixed-income
          - key: multi_asset
            label: "Multi-Asset"
            internal: multi-asset
          - key: alternatives
            label: "Alternatives"
            internal: alternatives
          - key: quant
            label: "Quantitative"
            internal: quantitative
        default-key: multi_asset

  prereqs:
    - type: state_exists
      key: structure.exists

  expands-to:
    - verb: trading-profile.create
      args:
        cbu_id: "${arg.structure}"
        name: "${arg.name}"
        investment_manager_id: "${arg.investment_manager}"
        strategy: "${arg.strategy.internal}"

  sets-state:
    - key: mandate.exists
      value: true

  unlocks:
    - mandate.add-product
    - mandate.set-instruments
    - mandate.set-markets

mandate.add-product:
  kind: macro

  ui:
    label: "Add Product"
    description: "Add a product to the mandate"
    target-label: "Product"

  routing:
    mode-tags: [trading]
    operator-domain: mandate

  target:
    operates-on: mandate-ref
    produces: null

  args:
    style: keyworded
    required:
      mandate:
        type: mandate-ref
        ui-label: "Mandate"
        autofill-from: session.current_mandate
        picker: mandate_picker
      product:
        type: enum
        ui-label: "Product"
        values:
          - key: custody
            label: "Custody"
            internal: CUSTODY
          - key: execution
            label: "Execution"
            internal: EXECUTION
          - key: clearing
            label: "Clearing"
            internal: CLEARING
          - key: prime_brokerage
            label: "Prime Brokerage"
            internal: PRIME_BROKERAGE
          - key: securities_lending
            label: "Securities Lending"
            internal: SECURITIES_LENDING
          - key: fx
            label: "FX"
            internal: FX
          - key: otc
            label: "OTC Derivatives"
            internal: OTC_DERIVATIVES
    optional: {}

  prereqs:
    - type: state_exists
      key: mandate.exists

  expands-to:
    - verb: trading-profile.add-product
      args:
        trading_profile_id: "${arg.mandate}"
        product_code: "${arg.product.internal}"

  unlocks: []

mandate.set-instruments:
  kind: macro

  ui:
    label: "Set Instruments"
    description: "Configure permitted instruments for the mandate"
    target-label: "Instruments"

  routing:
    mode-tags: [trading]
    operator-domain: mandate

  target:
    operates-on: mandate-ref
    produces: null

  args:
    style: keyworded
    required:
      mandate:
        type: mandate-ref
        ui-label: "Mandate"
        autofill-from: session.current_mandate
        picker: mandate_picker
      instruments:
        type: list
        item-type: enum
        ui-label: "Instruments"
        values:
          - key: equities
            label: "Equities"
            internal: EQUITIES
          - key: government_bonds
            label: "Government Bonds"
            internal: GOVERNMENT_BONDS
          - key: corporate_bonds
            label: "Corporate Bonds"
            internal: CORPORATE_BONDS
          - key: etfs
            label: "ETFs"
            internal: ETFS
          - key: futures
            label: "Futures"
            internal: FUTURES
          - key: options
            label: "Options"
            internal: OPTIONS
          - key: swaps
            label: "Swaps"
            internal: SWAPS
          - key: fx_spot
            label: "FX Spot"
            internal: FX_SPOT
          - key: fx_forward
            label: "FX Forward"
            internal: FX_FORWARD
    optional: {}

  prereqs:
    - type: state_exists
      key: mandate.exists

  expands-to:
    - verb: trading-profile.set-instruments
      args:
        trading_profile_id: "${arg.mandate}"
        instruments: "${arg.instruments.internal}"

  unlocks: []

mandate.set-markets:
  kind: macro

  ui:
    label: "Set Markets"
    description: "Configure permitted markets for the mandate"
    target-label: "Markets"

  routing:
    mode-tags: [trading]
    operator-domain: mandate

  target:
    operates-on: mandate-ref
    produces: null

  args:
    style: keyworded
    required:
      mandate:
        type: mandate-ref
        ui-label: "Mandate"
        autofill-from: session.current_mandate
        picker: mandate_picker
      markets:
        type: list
        item-type: enum
        ui-label: "Markets"
        values:
          - key: us
            label: "United States"
            internal: US
          - key: uk
            label: "United Kingdom"
            internal: UK
          - key: eu
            label: "European Union"
            internal: EU
          - key: jp
            label: "Japan"
            internal: JP
          - key: hk
            label: "Hong Kong"
            internal: HK
          - key: sg
            label: "Singapore"
            internal: SG
          - key: au
            label: "Australia"
            internal: AU
          - key: ch
            label: "Switzerland"
            internal: CH
    optional: {}

  prereqs:
    - type: state_exists
      key: mandate.exists

  expands-to:
    - verb: trading-profile.set-markets
      args:
        trading_profile_id: "${arg.mandate}"
        markets: "${arg.markets.internal}"

  unlocks: []

mandate.list:
  kind: macro

  ui:
    label: "List Mandates"
    description: "Show mandates for a structure"
    target-label: "Mandates"

  routing:
    mode-tags: [trading, onboarding]
    operator-domain: mandate

  target:
    operates-on: structure-ref
    produces: null

  args:
    style: keyworded
    required: {}
    optional:
      structure:
        type: structure-ref
        ui-label: "For Structure"
        autofill-from: session.current_structure
        picker: structure_picker

  prereqs: []

  expands-to:
    - verb: trading-profile.list
      args:
        cbu_id: "${arg.structure}"

  unlocks: []

mandate.select:
  kind: macro

  ui:
    label: "Select Mandate"
    description: "Set the current working mandate"
    target-label: "Mandate"

  routing:
    mode-tags: [trading]
    operator-domain: mandate

  target:
    operates-on: mandate-ref
    produces: null

  args:
    style: keyworded
    required:
      mandate:
        type: mandate-ref
        ui-label: "Mandate"
        picker: mandate_picker
    optional: {}

  prereqs: []

  expands-to:
    - verb: session.set-mandate
      args:
        mandate_id: "${arg.mandate}"

  sets-state:
    - key: mandate.selected
      value: true
    - key: mandate.exists
      value: true

  unlocks:
    - mandate.add-product
    - mandate.set-instruments
    - mandate.set-markets

mandate.details:
  kind: macro

  ui:
    label: "Mandate Details"
    description: "Show details of a mandate"
    target-label: "Mandate"

  routing:
    mode-tags: [trading]
    operator-domain: mandate

  target:
    operates-on: mandate-ref
    produces: null

  args:
    style: keyworded
    required:
      mandate:
        type: mandate-ref
        ui-label: "Mandate"
        autofill-from: session.current_mandate
        picker: mandate_picker
    optional: {}

  prereqs: []

  expands-to:
    - verb: trading-profile.get
      args:
        trading_profile_id: "${arg.mandate}"

  unlocks: []
