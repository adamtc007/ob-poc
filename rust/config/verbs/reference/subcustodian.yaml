domains:
  subcustodian:
    description: Bank's sub-custodian network (Omgeo Institution Network)
    verbs:
      ensure:
        description: Create or update sub-custodian entry for market/currency
        behavior: crud
        crud:
          operation: upsert
          table: subcustodian_network
          schema: custody
          conflict_keys:
          - market_id
          - currency
          - subcustodian_bic
          - effective_date
          returning: network_id
        args:
        - name: market
          type: lookup
          required: true
          maps_to: market_id
          lookup:
            table: markets
            entity_type: market
            schema: custody
            code_column: mic
            id_column: market_id
        - name: currency
          type: string
          required: true
          maps_to: currency
        - name: subcustodian-bic
          type: string
          required: true
          maps_to: subcustodian_bic
        - name: subcustodian-name
          type: string
          required: false
          maps_to: subcustodian_name
        - name: local-agent-bic
          type: string
          required: false
          maps_to: local_agent_bic
        - name: local-agent-account
          type: string
          required: false
          maps_to: local_agent_account
        - name: pset
          type: string
          required: true
          maps_to: place_of_settlement_bic
        - name: csd-participant
          type: string
          required: false
          maps_to: csd_participant_id
        - name: is-primary
          type: boolean
          required: false
          maps_to: is_primary
          default: true
        - name: effective-date
          type: date
          required: true
          maps_to: effective_date
        returns:
          type: uuid
          name: network_id
          capture: true
      list-by-market:
        description: List sub-custodian entries for a market
        behavior: crud
        crud:
          operation: list_by_fk
          table: subcustodian_network
          schema: custody
          fk_col: market_id
        args:
        - name: market
          type: lookup
          required: true
          maps_to: market_id
          lookup:
            table: markets
            entity_type: market
            schema: custody
            code_column: mic
            id_column: market_id
        - name: currency
          type: string
          required: false
          maps_to: currency
        returns:
          type: record_set
      lookup:
        description: Find sub-custodian for market/currency
        behavior: plugin
        handler: subcustodian_lookup
        args:
        - name: market
          type: string
          required: true
        - name: currency
          type: string
          required: true
        - name: as-of-date
          type: date
          required: false
        returns:
          type: record
