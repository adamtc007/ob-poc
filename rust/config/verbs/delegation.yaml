domains:
  delegation:
    description: Service provider delegation chains - ManCo to sub-advisor, administrator to sub-contractor
    verbs:
      add:
        description: Add a delegation relationship (idempotent by delegator+delegate+scope+cbu)
        metadata:
          tier: intent
          source_of_truth: operational
          scope: cbu
        behavior: crud
        crud:
          operation: upsert
          table: delegation_relationships
          schema: ob-poc
          returning: delegation_id
          conflict_keys:
            - delegator_entity_id
            - delegate_entity_id
            - delegation_scope
            - applies_to_cbu_id
        args:
          - name: delegator-entity-id
            type: uuid
            required: true
            maps_to: delegator_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: delegate-entity-id
            type: uuid
            required: true
            maps_to: delegate_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: scope
            type: string
            required: true
            maps_to: delegation_scope
            validation:
              enum:
                - INVESTMENT_MANAGEMENT
                - RISK_MANAGEMENT
                - PORTFOLIO_ADMINISTRATION
                - DISTRIBUTION
                - TRANSFER_AGENCY
          - name: description
            type: string
            required: false
            maps_to: delegation_description
          - name: applies-to-cbu-id
            type: uuid
            required: false
            maps_to: applies_to_cbu_id
            description: Which fund/CBU this delegation applies to (optional - may be firm-wide)
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: regulatory-notification-date
            type: date
            required: false
            maps_to: regulatory_notification_date
          - name: effective-from
            type: date
            required: true
            maps_to: effective_from
          - name: contract-doc-id
            type: uuid
            required: false
            maps_to: contract_doc_id
            lookup:
              table: document_catalog
              entity_type: document
              schema: ob-poc
              search_key: document_name
              primary_key: doc_id
        returns:
          type: uuid
          name: delegation_id
          capture: true

      end:
        description: End a delegation
        metadata:
          tier: intent
          source_of_truth: operational
          scope: cbu
        behavior: crud
        crud:
          operation: update
          table: delegation_relationships
          schema: ob-poc
          key: delegation_id
        args:
          - name: delegation-id
            type: uuid
            required: true
            maps_to: delegation_id
          - name: effective-to
            type: date
            required: true
            maps_to: effective_to
        returns:
          type: affected

      list-delegates:
        description: List who an entity delegates to
        metadata:
          tier: reference
          source_of_truth: operational
          scope: cbu
        behavior: crud
        crud:
          operation: list_by_fk
          table: delegation_relationships
          schema: ob-poc
          fk_col: delegator_entity_id
        args:
          - name: entity-id
            type: uuid
            required: true
            maps_to: delegator_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
        returns:
          type: record_set

      list-delegations-received:
        description: List delegations an entity has received
        metadata:
          tier: reference
          source_of_truth: operational
          scope: cbu
        behavior: crud
        crud:
          operation: list_by_fk
          table: delegation_relationships
          schema: ob-poc
          fk_col: delegate_entity_id
        args:
          - name: entity-id
            type: uuid
            required: true
            maps_to: delegate_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
        returns:
          type: record_set
