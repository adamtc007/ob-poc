domains:
  fund:
    description: Fund structure operations - umbrellas, sub-funds, share classes, master-feeder
    verbs:
      # =========================================================================
      # FUND CREATION VERBS
      # =========================================================================

      create-umbrella:
        description: Create an umbrella fund structure (SICAV, ICAV, OEIC, etc.)
        invocation_phrases:
          - "create umbrella fund"
          - "new SICAV"
          - "create SICAV"
          - "establish umbrella"
          - "new ICAV"
          - "create OEIC"
          - "set up umbrella fund"
          - "register new umbrella"
          - "create fund umbrella"
          - "establish new SICAV"
          - "new umbrella structure"
          - "create VCC fund"
        metadata:
          tier: intent
          source_of_truth: register
          scope: cbu
          noun: fund
          subject_kinds: [fund]
        behavior: crud
        produces:
          type: entity
          subtype: fund_umbrella
          resolved: false
        crud:
          operation: entity_create
          base_table: entities
          schema: ob-poc
          extension_table: entity_funds
          type_code: fund_umbrella
          returning: entity_id
        args:
          - name: name
            type: string
            required: true
            maps_to: name
            description: Legal name of the umbrella fund
          - name: cbu-id
            type: uuid
            required: false
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: jurisdiction
            type: string
            required: true
            maps_to: jurisdiction
            lookup:
              table: master_jurisdictions
              entity_type: jurisdiction
              schema: ob-poc
              search_key: jurisdiction_code
              primary_key: jurisdiction_code
          - name: fund-structure-type
            type: string
            required: true
            maps_to: fund_structure_type
            description: Legal structure type
            validation:
              enum:
                - SICAV # Luxembourg
                - ICAV # Ireland
                - OEIC # UK
                - VCC # Singapore
                - UNIT_TRUST # Various
                - FCP # Luxembourg/France
                - OTHER
          - name: regulatory-status
            type: string
            required: true
            maps_to: regulatory_status
            validation:
              enum:
                - UCITS
                - AIF
                - RAIF
                - PART_II
                - UNREGULATED
          - name: registration-number
            type: string
            required: false
            maps_to: registration_number
          - name: incorporation-date
            type: date
            required: false
            maps_to: incorporation_date
          - name: financial-year-end
            type: string
            required: false
            maps_to: financial_year_end
            description: "Month-day format, e.g., 12-31"
          # GLEIF fields
          - name: lei
            type: string
            required: false
            maps_to: lei
            description: Legal Entity Identifier (20 chars)
          - name: gleif-status
            type: string
            required: false
            maps_to: gleif_status
            validation:
              enum: [ACTIVE, INACTIVE, NULL]
          - name: gleif-category
            type: string
            required: false
            maps_to: gleif_category
            validation:
              enum: [FUND, GENERAL, BRANCH, SOLE_PROPRIETOR]
          - name: gleif-legal-form-id
            type: string
            required: false
            maps_to: gleif_legal_form_id
            description: ELF code (e.g., UDY2)
          - name: gleif-registered-as
            type: string
            required: false
            maps_to: gleif_registered_as
            description: Registry identifier
          - name: gleif-registered-at
            type: string
            required: false
            maps_to: gleif_registered_at
            description: Registration authority code
          - name: legal-address-city
            type: string
            required: false
            maps_to: legal_address_city
          - name: legal-address-country
            type: string
            required: false
            maps_to: legal_address_country
            description: ISO 2-letter country code
        returns:
          type: uuid
          name: entity_id
          capture: true

      create-subfund:
        description: Create a sub-fund/compartment within an umbrella
        invocation_phrases:
          - "create sub-fund"
          - "new compartment"
          - "add sub-fund"
          - "create fund compartment"
          - "new sub-fund under umbrella"
          - "establish sub-fund"
          - "add compartment to umbrella"
          - "create new sub-fund"
          - "set up compartment"
        metadata:
          tier: intent
          source_of_truth: register
          scope: cbu
          noun: fund
          subject_kinds: [fund]
        behavior: crud
        produces:
          type: entity
          subtype: fund_subfund
          resolved: false
        crud:
          operation: entity_create
          base_table: entities
          schema: ob-poc
          extension_table: entity_funds
          type_code: fund_subfund
          returning: entity_id
        args:
          - name: name
            type: string
            required: true
            maps_to: name
            description: Sub-fund name
          - name: umbrella-id
            type: uuid
            required: true
            maps_to: parent_fund_id
            description: Parent umbrella fund
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: cbu-id
            type: uuid
            required: false
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: investment-objective
            type: string
            required: false
            maps_to: investment_objective
          - name: base-currency
            type: string
            required: true
            maps_to: base_currency
          - name: launch-date
            type: date
            required: false
            maps_to: launch_date
          - name: isin-base
            type: string
            required: false
            maps_to: isin_base
            description: Base ISIN (share classes will have variants)
          # GLEIF fields
          - name: lei
            type: string
            required: false
            maps_to: lei
            description: Legal Entity Identifier (20 chars)
          - name: gleif-status
            type: string
            required: false
            maps_to: gleif_status
          - name: gleif-category
            type: string
            required: false
            maps_to: gleif_category
          - name: legal-address-city
            type: string
            required: false
            maps_to: legal_address_city
          - name: legal-address-country
            type: string
            required: false
            maps_to: legal_address_country
        returns:
          type: uuid
          name: entity_id
          capture: true

      create-share-class:
        description: Create a share class within a sub-fund
        invocation_phrases:
          - "create share class"
          - "add share class"
          - "new share class"
          - "create institutional class"
          - "add retail class"
          - "create accumulating class"
          - "new distributing class"
          - "set up share class"
          - "add new share class"
        metadata:
          tier: intent
          source_of_truth: register
          scope: cbu
          noun: fund
          subject_kinds: [fund]
        behavior: crud
        produces:
          type: entity
          subtype: fund_share_class
          resolved: false
        crud:
          operation: entity_create
          base_table: entities
          schema: ob-poc
          extension_table: entity_share_classes
          type_code: fund_share_class
          returning: entity_id
        args:
          - name: name
            type: string
            required: true
            maps_to: name
            description: "Share class designation (e.g., I ACC EUR)"
          - name: subfund-id
            type: uuid
            required: true
            maps_to: parent_fund_id
            description: Parent sub-fund
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: share-class-type
            type: string
            required: true
            maps_to: share_class_type
            validation:
              enum:
                - INSTITUTIONAL
                - RETAIL
                - SEED
                - FOUNDER
                - CLEAN # No trailer fees
          - name: distribution-type
            type: string
            required: true
            maps_to: distribution_type
            validation:
              enum:
                - ACC # Accumulating
                - DIST # Distributing
                - FLEX # Flexible
          - name: currency
            type: string
            required: true
            maps_to: currency
          - name: hedged
            type: boolean
            required: false
            maps_to: is_hedged
            default: false
          - name: isin
            type: string
            required: false
            maps_to: isin
          - name: minimum-investment
            type: decimal
            required: false
            maps_to: minimum_investment
          - name: management-fee-bps
            type: integer
            required: false
            maps_to: management_fee_bps
            description: Management fee in basis points
        returns:
          type: uuid
          name: entity_id
          capture: true

      create-standalone:
        description: Create a standalone fund (not part of umbrella structure)
        invocation_phrases:
          - "create standalone fund"
          - "new hedge fund"
          - "create PE fund"
          - "new private equity fund"
          - "create real estate fund"
          - "establish standalone fund"
          - "new standalone vehicle"
          - "create independent fund"
        metadata:
          tier: intent
          source_of_truth: register
          scope: cbu
          noun: fund
          subject_kinds: [fund]
        behavior: crud
        produces:
          type: entity
          subtype: fund_standalone
          resolved: false
        crud:
          operation: entity_create
          base_table: entities
          schema: ob-poc
          extension_table: entity_funds
          type_code: fund_standalone
          returning: entity_id
        args:
          - name: name
            type: string
            required: true
            maps_to: name
          - name: cbu-id
            type: uuid
            required: false
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: jurisdiction
            type: string
            required: true
            maps_to: jurisdiction
          - name: fund-type
            type: string
            required: true
            maps_to: fund_type
            validation:
              enum:
                - HEDGE_FUND
                - PRIVATE_EQUITY
                - REAL_ESTATE
                - INFRASTRUCTURE
                - CREDIT
                - MULTI_STRATEGY
          - name: regulatory-status
            type: string
            required: true
            maps_to: regulatory_status
          - name: base-currency
            type: string
            required: true
            maps_to: base_currency
          # GLEIF fields
          - name: lei
            type: string
            required: false
            maps_to: lei
            description: Legal Entity Identifier (20 chars)
          - name: gleif-status
            type: string
            required: false
            maps_to: gleif_status
          - name: gleif-category
            type: string
            required: false
            maps_to: gleif_category
          - name: legal-address-city
            type: string
            required: false
            maps_to: legal_address_city
          - name: legal-address-country
            type: string
            required: false
            maps_to: legal_address_country
        returns:
          type: uuid
          name: entity_id
          capture: true

      # =========================================================================
      # ENSURE (UPSERT) VERBS - Idempotent fund creation
      # =========================================================================

      ensure-umbrella:
        description: Create or update an umbrella fund (idempotent by name)
        invocation_phrases:
          - "ensure umbrella exists"
          - "upsert umbrella fund"
          - "create or update umbrella"
          - "ensure SICAV"
          - "idempotent umbrella create"
          - "make sure umbrella exists"
          - "upsert fund umbrella"
        metadata:
          tier: intent
          source_of_truth: register
          scope: cbu
          noun: fund
          subject_kinds: [fund]
        behavior: crud
        produces:
          type: entity
          subtype: fund_umbrella
          resolved: false
        crud:
          operation: entity_upsert
          base_table: entities
          schema: ob-poc
          extension_table: entity_funds
          type_code: fund_umbrella
          returning: entity_id
        args:
          - name: name
            type: string
            required: true
            maps_to: name
          - name: cbu-id
            type: uuid
            required: false
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: jurisdiction
            type: string
            required: true
            maps_to: jurisdiction
          - name: fund-structure-type
            type: string
            required: true
            maps_to: fund_structure_type
          - name: regulatory-status
            type: string
            required: true
            maps_to: regulatory_status
          - name: registration-number
            type: string
            required: false
            maps_to: registration_number
          - name: incorporation-date
            type: date
            required: false
            maps_to: incorporation_date
          - name: financial-year-end
            type: string
            required: false
            maps_to: financial_year_end
          # GLEIF fields
          - name: lei
            type: string
            required: false
            maps_to: lei
            description: Legal Entity Identifier (20 chars)
          - name: gleif-status
            type: string
            required: false
            maps_to: gleif_status
          - name: gleif-category
            type: string
            required: false
            maps_to: gleif_category
          - name: gleif-legal-form-id
            type: string
            required: false
            maps_to: gleif_legal_form_id
          - name: gleif-registered-as
            type: string
            required: false
            maps_to: gleif_registered_as
          - name: gleif-registered-at
            type: string
            required: false
            maps_to: gleif_registered_at
          - name: legal-address-city
            type: string
            required: false
            maps_to: legal_address_city
          - name: legal-address-country
            type: string
            required: false
            maps_to: legal_address_country
        returns:
          type: uuid
          name: entity_id
          capture: true

      ensure-subfund:
        description: Create or update a sub-fund (idempotent by name)
        invocation_phrases:
          - "ensure sub-fund exists"
          - "upsert sub-fund"
          - "create or update subfund"
          - "idempotent compartment"
          - "ensure compartment exists"
        metadata:
          tier: intent
          source_of_truth: register
          scope: cbu
          noun: fund
          subject_kinds: [fund]
        behavior: crud
        produces:
          type: entity
          subtype: fund_subfund
          resolved: false
        crud:
          operation: entity_upsert
          base_table: entities
          schema: ob-poc
          extension_table: entity_funds
          type_code: fund_subfund
          returning: entity_id
        args:
          - name: name
            type: string
            required: true
            maps_to: name
          - name: umbrella-id
            type: uuid
            required: true
            maps_to: parent_fund_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: cbu-id
            type: uuid
            required: false
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: investment-objective
            type: string
            required: false
            maps_to: investment_objective
          - name: base-currency
            type: string
            required: true
            maps_to: base_currency
          - name: launch-date
            type: date
            required: false
            maps_to: launch_date
          - name: isin-base
            type: string
            required: false
            maps_to: isin_base
          # GLEIF fields
          - name: lei
            type: string
            required: false
            maps_to: lei
          - name: gleif-status
            type: string
            required: false
            maps_to: gleif_status
          - name: gleif-category
            type: string
            required: false
            maps_to: gleif_category
          - name: legal-address-city
            type: string
            required: false
            maps_to: legal_address_city
          - name: legal-address-country
            type: string
            required: false
            maps_to: legal_address_country
        returns:
          type: uuid
          name: entity_id
          capture: true

      ensure-share-class:
        description: Create or update a share class (idempotent by name)
        invocation_phrases:
          - "ensure share class"
          - "upsert share class"
          - "create or update class"
          - "idempotent share class"
          - "ensure class exists"
        metadata:
          tier: intent
          source_of_truth: register
          scope: cbu
          noun: fund
          subject_kinds: [fund]
        behavior: crud
        produces:
          type: entity
          subtype: fund_share_class
          resolved: false
        crud:
          operation: entity_upsert
          base_table: entities
          schema: ob-poc
          extension_table: entity_share_classes
          type_code: fund_share_class
          returning: entity_id
        args:
          - name: name
            type: string
            required: true
            maps_to: name
          - name: subfund-id
            type: uuid
            required: true
            maps_to: parent_fund_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: share-class-type
            type: string
            required: true
            maps_to: share_class_type
          - name: distribution-type
            type: string
            required: true
            maps_to: distribution_type
          - name: currency
            type: string
            required: true
            maps_to: currency
          - name: hedged
            type: boolean
            required: false
            maps_to: is_hedged
            default: false
          - name: isin
            type: string
            required: false
            maps_to: isin
          - name: minimum-investment
            type: decimal
            required: false
            maps_to: minimum_investment
          - name: management-fee-bps
            type: integer
            required: false
            maps_to: management_fee_bps
        returns:
          type: uuid
          name: entity_id
          capture: true

      # =========================================================================
      # MASTER-FEEDER STRUCTURE
      # =========================================================================

      create-master:
        description: Create a master fund (for master-feeder structures)
        invocation_phrases:
          - "create master fund"
          - "new master fund"
          - "establish master"
          - "set up master fund"
          - "create master vehicle"
          - "new master for feeders"
        metadata:
          tier: intent
          source_of_truth: register
          scope: cbu
          noun: fund
          subject_kinds: [fund]
        behavior: crud
        produces:
          type: entity
          subtype: fund_master
          resolved: false
        crud:
          operation: entity_create
          base_table: entities
          schema: ob-poc
          extension_table: entity_funds
          type_code: fund_master
          returning: entity_id
        args:
          - name: name
            type: string
            required: true
            maps_to: name
          - name: cbu-id
            type: uuid
            required: false
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: jurisdiction
            type: string
            required: true
            maps_to: jurisdiction
          - name: base-currency
            type: string
            required: true
            maps_to: base_currency
          # GLEIF fields
          - name: lei
            type: string
            required: false
            maps_to: lei
          - name: gleif-status
            type: string
            required: false
            maps_to: gleif_status
          - name: gleif-category
            type: string
            required: false
            maps_to: gleif_category
          - name: legal-address-city
            type: string
            required: false
            maps_to: legal_address_city
          - name: legal-address-country
            type: string
            required: false
            maps_to: legal_address_country
        returns:
          type: uuid
          name: entity_id
          capture: true

      create-feeder:
        description: Create a feeder fund linked to a master
        invocation_phrases:
          - "create feeder fund"
          - "new feeder"
          - "add feeder fund"
          - "create US feeder"
          - "establish feeder"
          - "set up feeder fund"
          - "new feeder vehicle"
        metadata:
          tier: intent
          source_of_truth: register
          scope: cbu
          noun: fund
          subject_kinds: [fund]
        behavior: crud
        produces:
          type: entity
          subtype: fund_feeder
          resolved: false
        crud:
          operation: entity_create
          base_table: entities
          schema: ob-poc
          extension_table: entity_funds
          type_code: fund_feeder
          returning: entity_id
        args:
          - name: name
            type: string
            required: true
            maps_to: name
          - name: master-id
            type: uuid
            required: true
            maps_to: master_fund_id
            description: The master fund this feeder invests into
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: cbu-id
            type: uuid
            required: false
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: jurisdiction
            type: string
            required: true
            maps_to: jurisdiction
            description: Feeder domicile (often different from master)
          - name: investor-type
            type: string
            required: false
            maps_to: investor_type
            description: Target investor base for this feeder
            validation:
              enum:
                - US_TAXABLE
                - US_TAX_EXEMPT
                - NON_US
                - INSTITUTIONAL
                - RETAIL
          # GLEIF fields
          - name: lei
            type: string
            required: false
            maps_to: lei
          - name: gleif-status
            type: string
            required: false
            maps_to: gleif_status
          - name: gleif-category
            type: string
            required: false
            maps_to: gleif_category
          - name: legal-address-city
            type: string
            required: false
            maps_to: legal_address_city
          - name: legal-address-country
            type: string
            required: false
            maps_to: legal_address_country
        returns:
          type: uuid
          name: entity_id
          capture: true

      link-feeder:
        description: Link an existing feeder fund to a master fund (idempotent by parent+child+type)
        invocation_phrases:
          - "link feeder to master"
          - "connect feeder"
          - "attach feeder fund"
          - "link to master"
          - "associate feeder"
          - "connect to master fund"
        metadata:
          tier: intent
          source_of_truth: register
          scope: cbu
          noun: fund
          subject_kinds: [fund]
        behavior: crud
        crud:
          operation: upsert
          table: fund_structure
          schema: ob-poc
          returning: structure_id
          conflict_keys:
            - parent_entity_id
            - child_entity_id
            - relationship_type
        args:
          - name: feeder-id
            type: uuid
            required: true
            maps_to: child_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: master-id
            type: uuid
            required: true
            maps_to: parent_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: effective-from
            type: date
            required: false
            maps_to: effective_from
        returns:
          type: uuid
          name: structure_id

      # =========================================================================
      # FUND STRUCTURE OPERATIONS
      # =========================================================================

      add-to-umbrella:
        description: Add an existing sub-fund to an umbrella (idempotent by parent+child+type)
        invocation_phrases:
          - "add to umbrella"
          - "attach sub-fund"
          - "link to umbrella"
          - "add fund to umbrella"
          - "connect to umbrella"
          - "put under umbrella"
        metadata:
          tier: intent
          source_of_truth: register
          scope: cbu
          noun: fund
          subject_kinds: [fund]
        behavior: crud
        crud:
          operation: upsert
          table: fund_structure
          schema: ob-poc
          returning: structure_id
          conflict_keys:
            - parent_entity_id
            - child_entity_id
            - relationship_type
        args:
          - name: umbrella-id
            type: uuid
            required: true
            maps_to: parent_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: subfund-id
            type: uuid
            required: true
            maps_to: child_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: effective-from
            type: date
            required: false
            maps_to: effective_from
        returns:
          type: uuid
          name: structure_id

      add-share-class:
        description: Add a share class to a sub-fund (idempotent by parent+child+type)
        invocation_phrases:
          - "add share class to fund"
          - "attach share class"
          - "link share class"
          - "add class to subfund"
          - "connect share class"
        metadata:
          tier: intent
          source_of_truth: register
          scope: cbu
          noun: fund
          subject_kinds: [fund]
        behavior: crud
        crud:
          operation: upsert
          table: fund_structure
          schema: ob-poc
          returning: structure_id
          conflict_keys:
            - parent_entity_id
            - child_entity_id
            - relationship_type
        args:
          - name: subfund-id
            type: uuid
            required: true
            maps_to: parent_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: share-class-id
            type: uuid
            required: true
            maps_to: child_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: effective-from
            type: date
            required: false
            maps_to: effective_from
        returns:
          type: uuid
          name: structure_id

      list-subfunds:
        description: List all sub-funds within an umbrella
        invocation_phrases:
          - "list sub-funds"
          - "show compartments"
          - "view umbrella contents"
          - "list fund compartments"
          - "show sub-funds in umbrella"
          - "display all sub-funds"
        metadata:
          tier: reference
          source_of_truth: register
          scope: cbu
          noun: fund
          subject_kinds: [fund]
        behavior: crud
        crud:
          operation: list_by_fk
          table: fund_structure
          schema: ob-poc
          fk_col: parent_entity_id
        args:
          - name: umbrella-id
            type: uuid
            required: true
            maps_to: parent_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
        returns:
          type: record_set

      list-share-classes:
        description: List all share classes for a sub-fund
        invocation_phrases:
          - "list share classes"
          - "show fund classes"
          - "view share classes"
          - "display all classes"
          - "show classes for subfund"
          - "list fund share classes"
        metadata:
          tier: reference
          source_of_truth: register
          scope: cbu
          noun: fund
          subject_kinds: [fund]
        behavior: crud
        crud:
          operation: list_by_fk
          table: fund_structure
          schema: ob-poc
          fk_col: parent_entity_id
        args:
          - name: subfund-id
            type: uuid
            required: true
            maps_to: parent_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
        returns:
          type: record_set

      list-feeders:
        description: List all feeder funds for a master
        invocation_phrases:
          - "list feeder funds"
          - "show feeders"
          - "view master feeders"
          - "display feeder structure"
          - "list connected feeders"
          - "show all feeders"
        metadata:
          tier: reference
          source_of_truth: register
          scope: cbu
          noun: fund
          subject_kinds: [fund]
        behavior: crud
        crud:
          operation: list_by_fk
          table: fund_structure
          schema: ob-poc
          fk_col: parent_entity_id
        args:
          - name: master-id
            type: uuid
            required: true
            maps_to: parent_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
        returns:
          type: record_set

      # =========================================================================
      # FUND-OF-FUNDS INVESTMENT LINKS
      # =========================================================================

      add-investment:
        description: Record a fund's investment in another fund (idempotent by investor+investee)
        invocation_phrases:
          - "add fund investment"
          - "record fund holding"
          - "add FoF investment"
          - "create investment link"
          - "fund invests in fund"
          - "record fund allocation"
          - "add underlying investment"
        metadata:
          tier: intent
          source_of_truth: register
          scope: cbu
          noun: fund
          subject_kinds: [fund]
        behavior: crud
        crud:
          operation: upsert
          table: fund_investments
          schema: ob-poc
          returning: investment_id
          conflict_keys:
            - investor_entity_id
            - investee_entity_id
        args:
          - name: investor-fund-id
            type: uuid
            required: true
            maps_to: investor_entity_id
            description: The Fund-of-Funds making the investment
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: investee-fund-id
            type: uuid
            required: true
            maps_to: investee_entity_id
            description: The underlying fund being invested in
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: percentage-of-nav
            type: decimal
            required: true
            maps_to: percentage_of_investor_nav
            description: "% of investor fund's NAV allocated to this investment"
          - name: percentage-of-investee
            type: decimal
            required: false
            maps_to: percentage_of_investee_aum
            description: "% of investee fund's AUM held by this investor"
          - name: investment-date
            type: date
            required: false
            maps_to: investment_date
          - name: investment-type
            type: string
            required: false
            maps_to: investment_type
            validation:
              enum:
                - DIRECT
                - VIA_SHARE_CLASS
                - SIDE_POCKET
        returns:
          type: uuid
          name: investment_id

      update-investment:
        description: Update investment allocation percentage
        invocation_phrases:
          - "update investment"
          - "change allocation"
          - "modify investment percentage"
          - "update fund holding"
          - "adjust investment"
          - "change NAV allocation"
        metadata:
          tier: intent
          source_of_truth: register
          scope: cbu
          noun: fund
          subject_kinds: [fund]
        behavior: crud
        crud:
          operation: update
          table: fund_investments
          schema: ob-poc
          key: investment_id
        args:
          - name: investment-id
            type: uuid
            required: true
            maps_to: investment_id
          - name: percentage-of-nav
            type: decimal
            required: false
            maps_to: percentage_of_investor_nav
          - name: percentage-of-investee
            type: decimal
            required: false
            maps_to: percentage_of_investee_aum
        returns:
          type: affected

      end-investment:
        description: End/redeem a fund investment
        invocation_phrases:
          - "end investment"
          - "redeem investment"
          - "close fund position"
          - "terminate investment"
          - "exit fund investment"
          - "redeem fund holding"
        metadata:
          tier: intent
          source_of_truth: register
          scope: cbu
          noun: fund
          subject_kinds: [fund]
        behavior: crud
        crud:
          operation: update
          table: fund_investments
          schema: ob-poc
          key: investment_id
        args:
          - name: investment-id
            type: uuid
            required: true
            maps_to: investment_id
          - name: redemption-date
            type: date
            required: true
            maps_to: redemption_date
        returns:
          type: affected

      list-investments:
        description: List all investments made by a fund (what does this FoF hold)
        invocation_phrases:
          - "list fund investments"
          - "show fund holdings"
          - "what does fund hold"
          - "display investments"
          - "show underlying funds"
          - "list portfolio holdings"
        metadata:
          tier: reference
          source_of_truth: register
          scope: cbu
          noun: fund
          subject_kinds: [fund]
        behavior: crud
        crud:
          operation: list_by_fk
          table: fund_investments
          schema: ob-poc
          fk_col: investor_entity_id
        args:
          - name: fund-id
            type: uuid
            required: true
            maps_to: investor_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
        returns:
          type: record_set

      list-investors:
        description: List all fund investors in a fund (who holds this fund)
        invocation_phrases:
          - "list fund investors"
          - "show who invests"
          - "view investor list"
          - "who holds this fund"
          - "display fund investors"
          - "show fund shareholders"
        metadata:
          tier: reference
          source_of_truth: register
          scope: cbu
          noun: fund
          subject_kinds: [fund]
        behavior: crud
        crud:
          operation: list_by_fk
          table: fund_investments
          schema: ob-poc
          fk_col: investee_entity_id
        args:
          - name: fund-id
            type: uuid
            required: true
            maps_to: investee_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
        returns:
          type: record_set

      # =========================================================================
      # FUND VISUALIZATION (TODO: implement handlers before enabling)
      # =========================================================================
      # show-structure and calculate-lookthrough verbs removed - no plugin handlers exist
      # Re-add when FundShowStructureOp and FundLookthroughOp are implemented
