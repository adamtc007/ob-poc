# ============================================================================
# Ownership Computation & Reconciliation Verbs
# ============================================================================
# Ownership snapshots, special rights, reconciliation against BODS/GLEIF

domains:
  ownership:
    description: Ownership computation, snapshots, special rights, and reconciliation

    verbs:
      # --------------------------------------------------------------------------
      # Ownership Computation
      # --------------------------------------------------------------------------

      compute:
        description: Derive ownership snapshots from register holdings
        behavior: plugin
        plugin:
          handler: OwnershipComputeOp
        args:
          - name: issuer-entity-id
            type: uuid
            required: true
            lookup:
              table: entities
              schema: ob-poc
              entity_type: entity
              search_key: name
              primary_key: entity_id
          - name: as-of
            type: date
            required: false
            description: Defaults to today
          - name: basis
            type: string
            required: false
            default: "VOTES"
            validation:
              enum:
                - VOTES
                - ECONOMIC
                - BOTH
        returns:
          type: record
          fields:
            - name: issuer_entity_id
              type: uuid
            - name: as_of_date
              type: date
            - name: snapshots_created
              type: integer

      snapshot.list:
        description: List ownership snapshots for an issuer
        behavior: plugin
        plugin:
          handler: OwnershipSnapshotListOp
        args:
          - name: issuer-entity-id
            type: uuid
            required: true
            lookup:
              table: entities
              schema: ob-poc
              entity_type: entity
              search_key: name
              primary_key: entity_id
          - name: as-of
            type: date
            required: false
          - name: derived-from
            type: string
            required: false
            default: "ALL"
            validation:
              enum:
                - REGISTER
                - BODS
                - GLEIF
                - PSC
                - MANUAL
                - ALL
          - name: min-pct
            type: decimal
            required: false
            description: Filter to holdings above this percentage
          - name: basis
            type: string
            required: false
            default: "VOTES"
            validation:
              enum:
                - VOTES
                - ECONOMIC
                - UNITS
                - CAPITAL
                - DECLARED
        returns:
          type: record_set

      snapshot.get:
        description: Get a specific ownership snapshot
        behavior: crud
        crud:
          operation: select
          table: ownership_snapshots
          schema: kyc
          key: snapshot_id
        args:
          - name: snapshot-id
            type: uuid
            required: true
            maps_to: snapshot_id
        returns:
          type: record

      snapshot.import-bods:
        description: Import ownership snapshot from BODS statement
        behavior: plugin
        plugin:
          handler: OwnershipSnapshotImportBodsOp
        args:
          - name: issuer-entity-id
            type: uuid
            required: true
            lookup:
              table: entities
              schema: ob-poc
              entity_type: entity
              search_key: name
              primary_key: entity_id
          - name: bods-statement-id
            type: string
            required: true
            description: BODS statement ID from kyc.bods_statements
          - name: as-of
            type: date
            required: false
        returns:
          type: uuid
          name: snapshot_id
          capture: true

      snapshot.import-gleif:
        description: Import ownership snapshot from GLEIF relationship
        behavior: plugin
        plugin:
          handler: OwnershipSnapshotImportGleifOp
        args:
          - name: issuer-entity-id
            type: uuid
            required: true
            lookup:
              table: entities
              schema: ob-poc
              entity_type: entity
              search_key: name
              primary_key: entity_id
          - name: gleif-rel-id
            type: uuid
            required: true
            description: GLEIF relationship ID
          - name: as-of
            type: date
            required: false
        returns:
          type: uuid
          name: snapshot_id
          capture: true

      # --------------------------------------------------------------------------
      # Control Position Queries
      # --------------------------------------------------------------------------

      control-positions:
        description: Get control positions for an issuer (who controls what %)
        behavior: plugin
        plugin:
          handler: OwnershipControlPositionsOp
        args:
          - name: issuer-entity-id
            type: uuid
            required: true
            lookup:
              table: entities
              schema: ob-poc
              entity_type: entity
              search_key: name
              primary_key: entity_id
          - name: as-of
            type: date
            required: false
          - name: basis
            type: string
            required: false
            default: "VOTES"
            validation:
              enum:
                - VOTES
                - ECONOMIC
                - FULLY_DILUTED
                - EXERCISABLE
        returns:
          type: record_set
          fields:
            - name: holder_entity_id
              type: uuid
            - name: holder_name
              type: string
            - name: voting_pct
              type: decimal
            - name: economic_pct
              type: decimal
            - name: has_control
              type: boolean
            - name: has_significant_influence
              type: boolean
            - name: has_board_rights
              type: boolean
            - name: board_seats
              type: integer

      who-controls:
        description: Find who controls an issuer (>50% voting or board majority)
        behavior: plugin
        plugin:
          handler: OwnershipWhoControlsOp
        args:
          - name: issuer-entity-id
            type: uuid
            required: true
            lookup:
              table: entities
              schema: ob-poc
              entity_type: entity
              search_key: name
              primary_key: entity_id
          - name: as-of
            type: date
            required: false
        returns:
          type: record_set

      # --------------------------------------------------------------------------
      # Special Rights
      # --------------------------------------------------------------------------

      right.add-to-class:
        description: Add a special right attached to a share class
        behavior: crud
        crud:
          operation: insert
          table: special_rights
          schema: kyc
          returning: right_id
        args:
          - name: share-class-id
            type: uuid
            required: true
            maps_to: share_class_id
            lookup:
              table: share_classes
              schema: kyc
              search_key: name
              primary_key: id
          - name: issuer-entity-id
            type: uuid
            required: true
            maps_to: issuer_entity_id
            lookup:
              table: entities
              schema: ob-poc
              entity_type: entity
              search_key: name
              primary_key: entity_id
          - name: right-type
            type: string
            required: true
            maps_to: right_type
            validation:
              enum:
                - BOARD_APPOINTMENT
                - BOARD_OBSERVER
                - VETO_MA
                - VETO_FUNDRAISE
                - VETO_DIVIDEND
                - VETO_LIQUIDATION
                - ANTI_DILUTION
                - DRAG_ALONG
                - TAG_ALONG
                - FIRST_REFUSAL
                - REDEMPTION
                - CONVERSION_TRIGGER
                - PROTECTIVE_PROVISION
                - INFORMATION_RIGHTS
                - OTHER
          - name: board-seats
            type: integer
            required: false
            maps_to: board_seats
          - name: threshold-pct
            type: decimal
            required: false
            maps_to: threshold_pct
          - name: threshold-basis
            type: string
            required: false
            maps_to: threshold_basis
            validation:
              enum:
                - VOTES
                - ECONOMIC
                - UNITS
          - name: source-type
            type: string
            required: false
            maps_to: source_type
            validation:
              enum:
                - ARTICLES
                - SHA
                - SIDE_LETTER
                - BOARD_RESOLUTION
                - INVESTMENT_AGREEMENT
          - name: source-clause-ref
            type: string
            required: false
            maps_to: source_clause_ref
          - name: effective-from
            type: date
            required: false
            maps_to: effective_from
          - name: notes
            type: string
            required: false
            maps_to: notes
        returns:
          type: uuid
          name: right_id
          capture: true

      right.add-to-holder:
        description: Add a special right attached to a specific holder (side letter)
        behavior: crud
        crud:
          operation: insert
          table: special_rights
          schema: kyc
          returning: right_id
        args:
          - name: holder-entity-id
            type: uuid
            required: true
            maps_to: holder_entity_id
            lookup:
              table: entities
              schema: ob-poc
              entity_type: entity
              search_key: name
              primary_key: entity_id
          - name: issuer-entity-id
            type: uuid
            required: true
            maps_to: issuer_entity_id
            lookup:
              table: entities
              schema: ob-poc
              entity_type: entity
              search_key: name
              primary_key: entity_id
          - name: right-type
            type: string
            required: true
            maps_to: right_type
            validation:
              enum:
                - BOARD_APPOINTMENT
                - BOARD_OBSERVER
                - VETO_MA
                - VETO_FUNDRAISE
                - VETO_DIVIDEND
                - VETO_LIQUIDATION
                - ANTI_DILUTION
                - DRAG_ALONG
                - TAG_ALONG
                - FIRST_REFUSAL
                - INFORMATION_RIGHTS
                - PROTECTIVE_PROVISION
                - OTHER
          - name: board-seats
            type: integer
            required: false
            maps_to: board_seats
          - name: board-seat-type
            type: string
            required: false
            maps_to: board_seat_type
            validation:
              enum:
                - DIRECTOR
                - OBSERVER
                - ALTERNATE
                - CHAIRMAN
          - name: threshold-pct
            type: decimal
            required: false
            maps_to: threshold_pct
          - name: threshold-basis
            type: string
            required: false
            maps_to: threshold_basis
            validation:
              enum:
                - VOTES
                - ECONOMIC
                - UNITS
          - name: source-type
            type: string
            required: false
            maps_to: source_type
            validation:
              enum:
                - SHA
                - SIDE_LETTER
                - INVESTMENT_AGREEMENT
          - name: source-clause-ref
            type: string
            required: false
            maps_to: source_clause_ref
          - name: source-document-id
            type: uuid
            required: false
            maps_to: source_document_id
            lookup:
              table: document_catalog
              schema: ob-poc
              search_key: document_name
              primary_key: doc_id
          - name: effective-from
            type: date
            required: false
            maps_to: effective_from
          - name: notes
            type: string
            required: false
            maps_to: notes
        returns:
          type: uuid
          name: right_id
          capture: true

      right.end:
        description: End a special right (set effective_to date)
        behavior: crud
        crud:
          operation: update
          table: special_rights
          schema: kyc
          key: right_id
        args:
          - name: right-id
            type: uuid
            required: true
            maps_to: right_id
          - name: effective-to
            type: date
            required: true
            maps_to: effective_to
        returns:
          type: affected

      right.list-for-issuer:
        description: List all special rights for an issuer
        behavior: crud
        crud:
          operation: list_by_fk
          table: special_rights
          schema: kyc
          fk_col: issuer_entity_id
          filter:
            effective_to: null
        args:
          - name: issuer-entity-id
            type: uuid
            required: true
            maps_to: issuer_entity_id
            lookup:
              table: entities
              schema: ob-poc
              entity_type: entity
              search_key: name
              primary_key: entity_id
        returns:
          type: record_set

      right.list-for-holder:
        description: List all special rights held by an entity
        behavior: crud
        crud:
          operation: list_by_fk
          table: special_rights
          schema: kyc
          fk_col: holder_entity_id
          filter:
            effective_to: null
        args:
          - name: holder-entity-id
            type: uuid
            required: true
            maps_to: holder_entity_id
            lookup:
              table: entities
              schema: ob-poc
              entity_type: entity
              search_key: name
              primary_key: entity_id
        returns:
          type: record_set

      # --------------------------------------------------------------------------
      # Reconciliation
      # --------------------------------------------------------------------------

      reconcile:
        description: Compare ownership from different sources
        behavior: plugin
        plugin:
          handler: OwnershipReconcileOp
        args:
          - name: issuer-entity-id
            type: uuid
            required: true
            lookup:
              table: entities
              schema: ob-poc
              entity_type: entity
              search_key: name
              primary_key: entity_id
          - name: as-of
            type: date
            required: false
          - name: source-a
            type: string
            required: false
            default: "REGISTER"
            validation:
              enum:
                - REGISTER
                - BODS
                - GLEIF
          - name: source-b
            type: string
            required: false
            default: "BODS"
            validation:
              enum:
                - REGISTER
                - BODS
                - GLEIF
          - name: basis
            type: string
            required: false
            default: "VOTES"
            validation:
              enum:
                - VOTES
                - ECONOMIC
          - name: tolerance-bps
            type: integer
            required: false
            default: 100
            description: Tolerance in basis points (100 = 1%)
        returns:
          type: uuid
          name: run_id
          capture: true
        produces:
          type: reconciliation_run

      reconcile.findings:
        description: List findings from a reconciliation run
        behavior: plugin
        plugin:
          handler: OwnershipReconcileFindingsOp
        args:
          - name: run-id
            type: uuid
            required: true
            lookup:
              table: ownership_reconciliation_runs
              schema: kyc
              search_key: run_id
              primary_key: run_id
          - name: severity
            type: string
            required: false
            default: "ALL"
            validation:
              enum:
                - INFO
                - WARN
                - ERROR
                - CRITICAL
                - ALL
          - name: status
            type: string
            required: false
            default: "OPEN"
            validation:
              enum:
                - OPEN
                - ACKNOWLEDGED
                - INVESTIGATING
                - RESOLVED
                - FALSE_POSITIVE
                - ALL
        returns:
          type: record_set

      reconcile.resolve-finding:
        description: Resolve a reconciliation finding
        behavior: crud
        crud:
          operation: update
          table: ownership_reconciliation_findings
          schema: kyc
          key: finding_id
        args:
          - name: finding-id
            type: uuid
            required: true
            maps_to: finding_id
          - name: resolution-status
            type: string
            required: true
            maps_to: resolution_status
            validation:
              enum:
                - ACKNOWLEDGED
                - INVESTIGATING
                - RESOLVED
                - FALSE_POSITIVE
          - name: resolution-notes
            type: string
            required: false
            maps_to: resolution_notes
          - name: resolved-by
            type: string
            required: false
            maps_to: resolved_by
        defaults:
          resolved_at: now()
        returns:
          type: affected

      reconcile.list-runs:
        description: List reconciliation runs for an issuer
        behavior: crud
        crud:
          operation: list_by_fk
          table: ownership_reconciliation_runs
          schema: kyc
          fk_col: issuer_entity_id
        args:
          - name: issuer-entity-id
            type: uuid
            required: true
            maps_to: issuer_entity_id
            lookup:
              table: entities
              schema: ob-poc
              entity_type: entity
              search_key: name
              primary_key: entity_id
          - name: status
            type: string
            required: false
            validation:
              enum:
                - RUNNING
                - COMPLETED
                - FAILED
                - CANCELLED
        returns:
          type: record_set

      # --------------------------------------------------------------------------
      # Ownership Analysis
      # --------------------------------------------------------------------------

      analyze-gaps:
        description: Analyze ownership gaps for an issuer
        behavior: plugin
        plugin:
          handler: OwnershipAnalyzeGapsOp
        args:
          - name: issuer-entity-id
            type: uuid
            required: true
            lookup:
              table: entities
              schema: ob-poc
              entity_type: entity
              search_key: name
              primary_key: entity_id
          - name: as-of
            type: date
            required: false
        returns:
          type: record
          fields:
            - name: total_ownership_pct
              type: decimal
            - name: gap_pct
              type: decimal
            - name: unidentified_holders
              type: array
            - name: is_reconciled
              type: boolean

      trace-chain:
        description: Trace ownership chain from one entity to another
        behavior: plugin
        plugin:
          handler: OwnershipTraceChainOp
        args:
          - name: from-entity-id
            type: uuid
            required: true
            lookup:
              table: entities
              schema: ob-poc
              entity_type: entity
              search_key: name
              primary_key: entity_id
          - name: to-entity-id
            type: uuid
            required: true
            lookup:
              table: entities
              schema: ob-poc
              entity_type: entity
              search_key: name
              primary_key: entity_id
          - name: max-depth
            type: integer
            required: false
            default: 10
        returns:
          type: record
          fields:
            - name: path_exists
              type: boolean
            - name: path
              type: array
            - name: cumulative_pct
              type: decimal
