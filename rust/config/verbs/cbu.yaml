domains:
  cbu:
    description: Client Business Unit operations
    invocation_hints:
      - CBU
      - client
      - fund
      - account
      - portfolio
    verbs:
      create:
        description: Create a new Client Business Unit (idempotent by name)
        behavior: crud
        invocation_phrases:
          - create CBU
          - create client
          - create fund
          - onboard client
          - set up CBU
        metadata:
          tier: intent
          source_of_truth: operational
          scope: global
          noun: cbu
          tags: [lifecycle, write]
        produces:
          type: cbu
          resolved: false
        crud:
          operation: upsert
          table: cbus
          schema: ob-poc
          returning: cbu_id
          conflict_keys:
            - name
            - jurisdiction
        args:
          - name: name
            type: string
            required: true
            maps_to: name
          - name: jurisdiction
            type: string
            required: true
            maps_to: jurisdiction
            description: Jurisdiction code (e.g., US, GB, LU, IE, KY)
            lookup:
              table: master_jurisdictions
              entity_type: jurisdiction
              schema: ob-poc
              search_key: jurisdiction_code
              primary_key: jurisdiction_code
              resolution_mode: reference # small static table - autocomplete
          - name: client-type
            type: string
            required: false
            maps_to: client_type
          - name: nature-purpose
            type: string
            required: false
            maps_to: nature_purpose
          - name: description
            type: string
            required: false
            maps_to: description
          - name: commercial-client-entity-id
            type: uuid
            required: false
            maps_to: commercial_client_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
              resolution_mode: entity # growing table - search modal
        returns:
          type: uuid
          name: cbu_id
          capture: true
      read:
        description: Read a CBU by ID
        behavior: crud
        metadata:
          tier: diagnostics
          source_of_truth: operational
          scope: global
          noun: cbu
          tags: [read, query]
        crud:
          operation: select
          table: cbus
          schema: ob-poc
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
              resolution_mode: entity # growing table - search modal
        returns:
          type: record
      update:
        description: Update a CBU
        behavior: crud
        metadata:
          tier: intent
          source_of_truth: operational
          scope: global
          noun: cbu
          tags: [lifecycle, write]
        crud:
          operation: update
          table: cbus
          schema: ob-poc
          key: cbu_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: name
            type: string
            required: false
            maps_to: name
          - name: status
            type: string
            required: false
            maps_to: status
          - name: client-type
            type: string
            required: false
            maps_to: client_type
          - name: jurisdiction
            type: string
            required: false
            maps_to: jurisdiction
          - name: commercial-client-entity-id
            type: uuid
            required: false
            maps_to: commercial_client_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
        returns:
          type: affected
      delete:
        description: Delete a CBU (fails if has dependencies - use delete-cascade for full cleanup)
        behavior: crud
        metadata:
          tier: intent
          source_of_truth: operational
          scope: global
          noun: cbu
          tags: [lifecycle, write, destructive]
        crud:
          operation: delete
          table: cbus
          schema: ob-poc
          key: cbu_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
        returns:
          type: affected

      delete-cascade:
        description: Delete a CBU and all related data (entities, roles, documents, etc.)
        behavior: plugin
        metadata:
          tier: intent
          source_of_truth: operational
          scope: global
          noun: cbu
          tags: [lifecycle, write, destructive, cascade]
        plugin:
          handler: CbuDeleteCascadeOp
        args:
          - name: cbu-id
            type: uuid
            required: true
            description: CBU to delete with all dependencies
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: delete-entities
            type: boolean
            required: false
            default: true
            description: Also delete entities linked only to this CBU
        returns:
          type: record
          description: Summary of deleted records by table
      list:
        description: List CBUs with optional filters
        behavior: crud
        metadata:
          tier: diagnostics
          source_of_truth: operational
          scope: global
          noun: cbu
          tags: [read, query, list]
        crud:
          operation: select
          table: cbus
          schema: ob-poc
        args:
          - name: status
            type: string
            required: false
            maps_to: status
          - name: client-type
            type: string
            required: false
            maps_to: client_type
          - name: jurisdiction
            type: string
            required: false
            maps_to: jurisdiction
          - name: limit
            type: integer
            required: false
            default: 100
          - name: offset
            type: integer
            required: false
            default: 0
        returns:
          type: record_set
      ensure:
        description: Create or update a CBU by natural key
        behavior: crud
        metadata:
          tier: intent
          source_of_truth: operational
          scope: global
          noun: cbu
          tags: [lifecycle, write, idempotent]
        produces:
          type: cbu
          resolved: false
        crud:
          operation: upsert
          table: cbus
          schema: ob-poc
          conflict_keys:
            - name
            - jurisdiction
          returning: cbu_id
        args:
          - name: name
            type: string
            required: true
            maps_to: name
            fuzzy_check:
              entity_type: cbu
              threshold: 0.5
          - name: jurisdiction
            type: string
            required: true
            maps_to: jurisdiction
            description: Jurisdiction code (e.g., US, GB, LU, IE, KY)
            lookup:
              table: master_jurisdictions
              entity_type: jurisdiction
              schema: ob-poc
              search_key: jurisdiction_code
              primary_key: jurisdiction_code
          - name: client-type
            type: string
            required: false
            maps_to: client_type
          - name: nature-purpose
            type: string
            required: false
            maps_to: nature_purpose
          - name: commercial-client-entity-id
            type: uuid
            required: false
            maps_to: commercial_client_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
        returns:
          type: uuid
          name: cbu_id
          capture: true
      assign-role:
        description: Assign a role to an entity within a CBU
        behavior: crud
        metadata:
          tier: intent
          source_of_truth: operational
          scope: global
          noun: cbu
          tags: [relationship, write, role]
        consumes:
          - arg: cbu-id
            type: cbu
            required: true
          - arg: entity-id
            type: entity
            required: true
        crud:
          operation: role_link
          junction: cbu_entity_roles
          schema: ob-poc
          from_col: cbu_id
          to_col: entity_id
          role_table: roles
          role_col: role_id
          returning: cbu_entity_role_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: entity-id
            type: uuid
            required: true
            maps_to: entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: role
            type: lookup
            required: true
            lookup:
              schema: ob-poc
              table: roles
              entity_type: role
              code_column: name
              id_column: role_id
        returns:
          type: uuid
          name: cbu_entity_role_id
          capture: false
      remove-role:
        description: Remove a specific role from an entity within a CBU
        behavior: crud
        metadata:
          tier: intent
          source_of_truth: operational
          scope: global
          noun: cbu
          tags: [relationship, write, role]
        crud:
          operation: role_unlink
          junction: cbu_entity_roles
          schema: ob-poc
          from_col: cbu_id
          to_col: entity_id
          role_table: roles
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: entity-id
            type: uuid
            required: true
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: role
            type: lookup
            required: true
            lookup:
              schema: ob-poc
              table: roles
              entity_type: role
              code_column: name
              id_column: role_id
        returns:
          type: affected
      parties:
        description: List all parties (entities with their roles) for a CBU
        behavior: crud
        metadata:
          tier: diagnostics
          source_of_truth: operational
          scope: global
          noun: cbu
          tags: [read, query, relationship]
        crud:
          operation: list_parties
          junction: cbu_entity_roles
          schema: ob-poc
          fk_col: cbu_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: as-of-date
            type: date
            required: false
            description: Point-in-time date for temporal query (defaults to today)
        returns:
          type: record_set
      set-category:
        description: Set CBU relationship category (FUND_MANDATE, CORPORATE_GROUP, etc.)
        behavior: crud
        metadata:
          tier: intent
          source_of_truth: operational
          scope: global
          noun: cbu
          tags: [lifecycle, write, classification]
        crud:
          operation: update
          table: cbus
          schema: ob-poc
          key: cbu_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: category
            type: string
            required: true
            maps_to: cbu_category
            validation:
              enum:
                - FUND_MANDATE
                - CORPORATE_GROUP
                - INSTITUTIONAL_ACCOUNT
                - RETAIL_CLIENT
                - FAMILY_TRUST
                - INTERNAL_TEST
                - CORRESPONDENT_BANK
        returns:
          type: affected
      show:
        description: Show full CBU structure including entities, roles, documents, screenings
        behavior: plugin
        metadata:
          tier: diagnostics
          source_of_truth: operational
          scope: global
          noun: cbu
          tags: [read, query, detailed]
        plugin:
          handler: CbuShowOp
        args:
          - name: cbu-id
            type: uuid
            required: true
            description: CBU to display
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: as-of-date
            type: date
            required: false
            description: Point-in-time date for temporal query (defaults to today)
        returns:
          type: record
          description: Full CBU structure with nested entities, roles, documents, screenings

      add-product:
        description: Add a product to a CBU (creates service_delivery_map entries for all services)
        behavior: plugin
        metadata:
          tier: intent
          source_of_truth: operational
          scope: global
          noun: cbu
          tags: [relationship, write, product]
        plugin:
          handler: CbuAddProductOp
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: product
            type: string
            required: true
            description: Product code (e.g., CUSTODY, FUND_ACCOUNTING)
            lookup:
              table: products
              entity_type: product
              schema: ob-poc
              search_key: product_code
              primary_key: product_code
        returns:
          type: affected
          description: Number of service delivery entries created

      remove-product:
        description: Remove a product from a CBU (deletes service_delivery_map entries)
        behavior: crud
        metadata:
          tier: intent
          source_of_truth: operational
          scope: global
          noun: cbu
          tags: [relationship, write, product]
        crud:
          operation: delete
          table: service_delivery_map
          schema: ob-poc
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: product
            type: string
            required: true
            description: Product code (e.g., CUSTODY, FUND_ACCOUNTING)
            lookup:
              table: products
              entity_type: product
              schema: ob-poc
              search_key: product_code
              primary_key: product_id
            maps_to: product_id
        returns:
          type: affected
          description: Number of service delivery entries removed

      decide:
        description: Record KYC/AML decision for CBU collective state (entities, UBOs, documents)
        behavior: plugin
        metadata:
          tier: intent
          source_of_truth: operational
          scope: global
          noun: cbu
          tags: [lifecycle, write, decision, kyc]
        plugin:
          handler: CbuDecideOp
        consumes:
          - arg: cbu-id
            type: cbu
            required: true
        lifecycle:
          entity_arg: cbu-id
          requires_states:
            - VALIDATION_PENDING
        args:
          - name: cbu-id
            type: uuid
            required: true
            description: CBU to decide
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: decision
            type: string
            required: true
            description: Decision outcome
            validation:
              enum:
                - APPROVED
                - REJECTED
                - REFERRED
          - name: decided-by
            type: string
            required: true
            description: User/agent making the decision
          - name: rationale
            type: string
            required: true
            description: Reason for decision
          - name: case-id
            type: uuid
            required: false
            description: Associated KYC case (optional, inferred if single active case)
            lookup:
              table: cases
              entity_type: kyc_case
              schema: kyc
              search_key: case_id
              primary_key: case_id
          - name: conditions
            type: string
            required: false
            description: Conditions attached to approval (if any)
          - name: escalation-reason
            type: string
            required: false
            description: Reason for referral (required if decision=REFERRED)
        returns:
          type: record
          description: Decision record with outcome and resulting CBU status
      attach-evidence:
        description: Attach evidence (document or attestation) to CBU
        behavior: crud
        metadata:
          tier: intent
          source_of_truth: operational
          scope: global
          noun: cbu
          tags: [evidence, write, kyc]
        crud:
          operation: insert
          table: cbu_evidence
          schema: ob-poc
          returning: evidence_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: document-id
            type: uuid
            required: false
            maps_to: document_id
            lookup:
              table: document_catalog
              entity_type: document
              schema: ob-poc
              search_key: document_name
              primary_key: doc_id
          - name: attestation-ref
            type: string
            required: false
            maps_to: attestation_ref
          - name: evidence-type
            type: string
            required: true
            maps_to: evidence_type
            valid_values:
              - DOCUMENT
              - ATTESTATION
              - SCREENING
              - REGISTRY_CHECK
              - MANUAL_VERIFICATION
          - name: evidence-category
            type: string
            required: false
            maps_to: evidence_category
          - name: description
            type: string
            required: false
            maps_to: description
          - name: attached-by
            type: string
            required: false
            maps_to: attached_by
        returns:
          type: uuid
          name: evidence_id
          capture: true
      verify-evidence:
        description: Mark evidence as verified or rejected
        behavior: crud
        metadata:
          tier: intent
          source_of_truth: operational
          scope: global
          noun: cbu
          tags: [evidence, write, kyc, verification]
        crud:
          operation: update
          table: cbu_evidence
          schema: ob-poc
          key: evidence_id
          set_values:
            verified_at: now()
        args:
          - name: evidence-id
            type: uuid
            required: true
            maps_to: evidence_id
          - name: verification-status
            type: string
            required: true
            maps_to: verification_status
            valid_values:
              - PENDING
              - VERIFIED
              - REJECTED
              - EXPIRED
          - name: verified-by
            type: string
            required: true
            maps_to: verified_by
          - name: verification-notes
            type: string
            required: false
            maps_to: verification_notes
        returns:
          type: affected
      list-evidence:
        description: List evidence for a CBU
        behavior: crud
        metadata:
          tier: diagnostics
          source_of_truth: operational
          scope: global
          noun: cbu
          tags: [evidence, read, query, kyc]
        crud:
          operation: list_by_fk
          table: cbu_evidence
          schema: ob-poc
          fk_col: cbu_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: evidence-type
            type: string
            required: false
            maps_to: evidence_type
          - name: verification-status
            type: string
            required: false
            maps_to: verification_status
        returns:
          type: record_set
