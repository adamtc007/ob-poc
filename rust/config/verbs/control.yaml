domains:
  control:
    description: Control relationships (distinct from ownership) - voting rights, board control, veto powers
    verbs:
      add:
        description: Add a control relationship between entities (idempotent by controller+controlled+type)
        metadata:
          tier: intent
          source_of_truth: workflow
          scope: cbu
          noun: control
        behavior: crud
        crud:
          operation: upsert
          table: entity_relationships
          schema: ob-poc
          returning: relationship_id
          conflict_keys:
            - from_entity_id
            - to_entity_id
            - control_type
        args:
          - name: controller-entity-id
            type: uuid
            required: true
            maps_to: from_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: controlled-entity-id
            type: uuid
            required: true
            maps_to: to_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: control-type
            type: string
            required: true
            maps_to: control_type
            validation:
              enum:
                - VOTING_RIGHTS
                - BOARD_APPOINTMENT
                - VETO_POWER
                - MANAGEMENT_CONTROL
                - RESERVED_MATTERS
          - name: control-percentage
            type: decimal
            required: false
            maps_to: percentage
            description: Control percentage (may differ from ownership %)
          - name: description
            type: string
            required: false
            maps_to: notes
          - name: effective-from
            type: date
            required: false
            maps_to: effective_from
          - name: evidence-doc-id
            type: uuid
            required: false
            maps_to: source_document_id
            lookup:
              table: document_catalog
              entity_type: document
              schema: ob-poc
              search_key: document_name
              primary_key: doc_id
        defaults:
          relationship_type: CONTROL
          source: DSL
        returns:
          type: uuid
          name: relationship_id
          capture: true

      end:
        description: End a control relationship
        metadata:
          tier: intent
          source_of_truth: workflow
          scope: cbu
          noun: control
        behavior: crud
        crud:
          operation: update
          table: entity_relationships
          schema: ob-poc
          key: relationship_id
        args:
          - name: relationship-id
            type: uuid
            required: true
            maps_to: relationship_id
            lookup:
              table: entity_relationships
              schema: ob-poc
              search_key: relationship_id
              primary_key: relationship_id
          - name: effective-to
            type: date
            required: true
            maps_to: effective_to
        returns:
          type: affected

      list-controllers:
        description: List who controls an entity
        metadata:
          tier: reference
          source_of_truth: workflow
          scope: cbu
          noun: control
        behavior: crud
        crud:
          operation: list_by_fk
          table: entity_relationships_current
          schema: ob-poc
          fk_col: to_entity_id
          filter:
            relationship_type: CONTROL
        args:
          - name: entity-id
            type: uuid
            required: true
            maps_to: to_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
        returns:
          type: record_set

      list-controlled:
        description: List what an entity controls
        metadata:
          tier: reference
          source_of_truth: workflow
          scope: cbu
          noun: control
        behavior: crud
        crud:
          operation: list_by_fk
          table: entity_relationships_current
          schema: ob-poc
          fk_col: from_entity_id
          filter:
            relationship_type: CONTROL
        args:
          - name: entity-id
            type: uuid
            required: true
            maps_to: from_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
        returns:
          type: record_set

      # ============================================================
      # Unified Control Analysis Verbs (Phase C.6 KYC Enhancement)
      # Aggregates ownership, board, trust, and partnership control
      # ============================================================

      analyze:
        description: |
          Comprehensive control analysis for any entity type.
          Routes to appropriate analyzer based on entity_type.
          Aggregates all control vectors: ownership, board, trust, partnership.
        metadata:
          tier: intent
          source_of_truth: workflow
          scope: cbu
          noun: control
        behavior: plugin
        plugin:
          handler: ControlAnalyzeOp
        args:
          - name: entity-id
            type: uuid
            required: true
            lookup:
              table: entities
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: include-indirect
            type: boolean
            required: false
            default: true
            description: "Include indirect control through chains"
          - name: control-threshold
            type: decimal
            required: false
            default: 25.0
            description: "Minimum percentage for ownership control"
        returns:
          type: record
          fields:
            - name: entity_type
              type: string
              description: "Type of entity analyzed"
            - name: ownership_controllers
              type: array
              description: "Entities with ≥25% ownership"
            - name: board_controllers
              type: array
              description: "Entities with board control"
            - name: other_controllers
              type: array
              description: "SHA rights, trust powers, etc."
            - name: ubo_candidates
              type: array
              description: "Natural persons identified as potential UBOs"

      build-graph:
        description: |
          Build full control graph for a CBU.
          Nodes: entities, persons, positions
          Edges: OWNS, CONTROLS, APPOINTS, INFLUENCES, HOLDS_POSITION
        metadata:
          tier: intent
          source_of_truth: workflow
          scope: cbu
          noun: control
        behavior: plugin
        plugin:
          handler: ControlBuildGraphOp
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: depth
            type: integer
            required: false
            default: 10
            description: "Maximum traversal depth"
          - name: include-inactive
            type: boolean
            required: false
            default: false
            description: "Include historical/inactive relationships"
        returns:
          type: record
          fields:
            - name: nodes
              type: array
              description: "All entities/persons in the control graph"
            - name: edges
              type: array
              description: "All relationships between nodes"
            - name: terminus_entities
              type: array
              description: "Entities with no further upstream owners"
            - name: cycles_detected
              type: array
              description: "Any circular ownership/control detected"

      identify-ubos:
        description: |
          Identify all UBOs for a CBU across all control vectors:
          - Ownership ≥25% (direct or indirect)
          - Board majority control
          - Trust control (trustee discretion, appointor power)
          - Partnership GP control
        metadata:
          tier: intent
          source_of_truth: workflow
          scope: cbu
          noun: control
        behavior: plugin
        plugin:
          handler: ControlIdentifyUbosOp
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: ownership-threshold
            type: decimal
            required: false
            default: 25.0
            description: "Ownership percentage threshold for UBO"
          - name: include-indirect
            type: boolean
            required: false
            default: true
            description: "Include indirect ownership chains"
        returns:
          type: record_set
          fields:
            - name: person_entity_id
              type: uuid
            - name: person_name
              type: string
            - name: control_vectors
              type: array
              description: "Array of {type, path, percentage}"
            - name: highest_percentage
              type: decimal
              description: "Highest ownership/control percentage"
            - name: verification_status
              type: string
              description: "DISCOVERED, ALLEGED, EVIDENCED, VERIFIED"
            - name: evidence_documents
              type: array
              description: "Supporting document IDs"

      trace-chain:
        description: |
          Trace a specific control chain from one entity to another.
          Returns the path and cumulative control percentage.
        metadata:
          tier: intent
          source_of_truth: workflow
          scope: cbu
          noun: control
        behavior: plugin
        plugin:
          handler: ControlTraceChainOp
        args:
          - name: from-entity-id
            type: uuid
            required: true
            lookup:
              table: entities
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: to-entity-id
            type: uuid
            required: true
            lookup:
              table: entities
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: relationship-types
            type: string_list
            required: false
            description: "Filter by relationship types (OWNERSHIP, CONTROL, TRUST_ROLE)"
        returns:
          type: record
          fields:
            - name: path_exists
              type: boolean
            - name: path
              type: array
              description: "Ordered list of entities in chain"
            - name: relationships
              type: array
              description: "Relationship details for each hop"
            - name: cumulative_percentage
              type: decimal
              description: "Multiplicative ownership through chain"
            - name: control_basis
              type: string
              description: "Primary basis: OWNERSHIP, BOARD, TRUST, PARTNERSHIP"

      reconcile-ownership:
        description: |
          Reconcile ownership for an entity:
            - Verify voting shares sum to 100%
            - Identify gaps or overlaps
            - Flag discrepancies
        metadata:
          tier: intent
          source_of_truth: workflow
          scope: cbu
          noun: control
        behavior: plugin
        plugin:
          handler: ControlReconcileOwnershipOp
        args:
          - name: entity-id
            type: uuid
            required: true
            lookup:
              table: entities
              schema: ob-poc
              search_key: name
              primary_key: entity_id
        returns:
          type: record
          fields:
            - name: is_reconciled
              type: boolean
              description: "True if ownership sums to 100%"
            - name: total_ownership_pct
              type: decimal
              description: "Sum of all ownership percentages"
            - name: gap_pct
              type: decimal
              description: "Missing percentage (if any)"
            - name: overlap_pct
              type: decimal
              description: "Overlapping claims (if any)"
            - name: shareholders
              type: array
              description: "List of shareholders with percentages"
            - name: discrepancies
              type: array
              description: "Any discrepancy details"

      # ============================================================
      # Board Controller Verbs (Phase 2f - Control Anchors)
      # Computes and manages board controller designation
      # ============================================================

      show-board-controller:
        description: |
          Show the computed board controller for a CBU.
          Returns the natural person or entity that controls the board,
          with derivation explanation, confidence level, and data gaps.
        invocation_phrases:
          - "show board controller"
          - "who controls the board"
          - "board controller for"
          - "get board controller"
        metadata:
          tier: diagnostics
          source_of_truth: workflow
          scope: cbu
          noun: board_controller
        behavior: plugin
        plugin:
          handler: ShowBoardControllerOp
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
        returns:
          type: record
          fields:
            - name: cbu_id
              type: uuid
            - name: cbu_name
              type: string
            - name: board_controller_entity_id
              type: uuid
              description: "The entity that controls the board (may be null if unknown)"
            - name: board_controller_name
              type: string
            - name: board_controller_type
              type: string
              description: "NATURAL_PERSON, LEGAL_ENTITY, or UNKNOWN"
            - name: confidence
              type: string
              description: "HIGH, MEDIUM, or LOW"
            - name: derivation_rule
              type: string
              description: "Rule used to determine controller (e.g., MAJORITY_APPOINTER)"
            - name: derivation_explanation
              type: string
              description: "Human-readable explanation of derivation"
            - name: data_gaps
              type: array
              description: "Missing information that affects confidence"
            - name: evidence_sources
              type: array
              description: "Sources used: GLEIF, PSC_REGISTER, MANUAL, COMPUTED"
            - name: computed_at
              type: timestamp

      recompute-board-controller:
        description: |
          Recompute the board controller for a CBU.
          Traverses ownership/control graph, analyzes board compositions,
          and determines who has effective control.
        invocation_phrases:
          - "recompute board controller"
          - "recalculate board controller"
          - "refresh board controller"
        metadata:
          tier: composite
          source_of_truth: workflow
          scope: cbu
          noun: board_controller
        behavior: plugin
        plugin:
          handler: RecomputeBoardControllerOp
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: force
            type: boolean
            required: false
            default: false
            description: "Force recomputation even if recently computed"
        returns:
          type: record
          fields:
            - name: cbu_id
              type: uuid
            - name: board_controller_entity_id
              type: uuid
            - name: board_controller_name
              type: string
            - name: confidence
              type: string
            - name: derivation_rule
              type: string
            - name: previous_controller_entity_id
              type: uuid
              description: "Previous board controller if changed"
            - name: changed
              type: boolean
              description: "True if controller changed from previous computation"
            - name: recomputed_at
              type: timestamp

      set-board-controller:
        description: |
          Manually set the board controller for a CBU.
          Creates an override that takes precedence over computed values.
          Requires justification and evidence document.
        invocation_phrases:
          - "set board controller"
          - "override board controller"
          - "manually set board controller"
        metadata:
          tier: intent
          source_of_truth: workflow
          scope: cbu
          noun: board_controller
        behavior: plugin
        plugin:
          handler: SetBoardControllerOp
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: controller-entity-id
            type: uuid
            required: true
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: justification
            type: string
            required: true
            description: "Reason for manual override"
          - name: evidence-doc-id
            type: uuid
            required: false
            lookup:
              table: document_catalog
              entity_type: document
              schema: ob-poc
              search_key: document_name
              primary_key: doc_id
        returns:
          type: record
          fields:
            - name: cbu_id
              type: uuid
            - name: board_controller_entity_id
              type: uuid
            - name: override_id
              type: uuid
              description: "ID of the manual override record"
            - name: set_at
              type: timestamp

      clear-board-controller-override:
        description: |
          Clear a manual board controller override.
          Returns to computed value.
        invocation_phrases:
          - "clear board controller override"
          - "remove board controller override"
        metadata:
          tier: intent
          source_of_truth: workflow
          scope: cbu
          noun: board_controller
        behavior: plugin
        plugin:
          handler: ClearBoardControllerOverrideOp
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
        returns:
          type: record
          fields:
            - name: cbu_id
              type: uuid
            - name: override_cleared
              type: boolean
            - name: now_using_computed
              type: boolean
            - name: computed_controller_entity_id
              type: uuid

      import-psc-register:
        description: |
          Import board controller data from a PSC (Persons with Significant Control) register.
          Supports UK Companies House PSC format.
        invocation_phrases:
          - "import psc register"
          - "import persons with significant control"
          - "load psc data"
        metadata:
          tier: composite
          source_of_truth: external
          scope: cbu
          noun: board_controller
        behavior: plugin
        plugin:
          handler: ImportPscRegisterOp
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: company-number
            type: string
            required: true
            description: "Companies House company number"
          - name: source
            type: string
            required: false
            default: "COMPANIES_HOUSE"
            validation:
              enum:
                - COMPANIES_HOUSE
                - MANUAL
        returns:
          type: record
          fields:
            - name: cbu_id
              type: uuid
            - name: company_number
              type: string
            - name: pscs_imported
              type: integer
            - name: board_controller_updated
              type: boolean
            - name: imported_at
              type: timestamp

      import-gleif-control:
        description: |
          Import control data from GLEIF (Global LEI Foundation).
          Uses the LEI-RR (Relationship Record) data for parent/child control.
        invocation_phrases:
          - "import gleif control"
          - "import lei control data"
          - "load gleif hierarchy"
        metadata:
          tier: composite
          source_of_truth: external
          scope: cbu
          noun: board_controller
        behavior: plugin
        plugin:
          handler: ImportGleifControlOp
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: lei
            type: string
            required: true
            description: "Legal Entity Identifier"
          - name: include-ultimate-parent
            type: boolean
            required: false
            default: true
            description: "Also import ultimate parent chain"
        returns:
          type: record
          fields:
            - name: cbu_id
              type: uuid
            - name: lei
              type: string
            - name: direct_parent_imported
              type: boolean
            - name: ultimate_parent_imported
              type: boolean
            - name: control_relationships_created
              type: integer
            - name: board_controller_updated
              type: boolean
            - name: imported_at
              type: timestamp
