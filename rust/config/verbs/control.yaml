domains:
  control:
    description: Control relationships (distinct from ownership) - voting rights, board control, veto powers
    verbs:
      add:
        description: Add a control relationship between entities
        behavior: crud
        crud:
          operation: insert
          table: entity_relationships
          schema: ob-poc
          returning: relationship_id
        args:
          - name: controller-entity-id
            type: uuid
            required: true
            maps_to: from_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: controlled-entity-id
            type: uuid
            required: true
            maps_to: to_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: control-type
            type: string
            required: true
            maps_to: control_type
            validation:
              enum:
                - VOTING_RIGHTS
                - BOARD_APPOINTMENT
                - VETO_POWER
                - MANAGEMENT_CONTROL
                - RESERVED_MATTERS
          - name: control-percentage
            type: decimal
            required: false
            maps_to: percentage
            description: Control percentage (may differ from ownership %)
          - name: description
            type: string
            required: false
            maps_to: notes
          - name: effective-from
            type: date
            required: false
            maps_to: effective_from
          - name: evidence-doc-id
            type: uuid
            required: false
            maps_to: source_document_id
            lookup:
              table: document_catalog
              entity_type: document
              schema: ob-poc
              search_key: document_name
              primary_key: doc_id
        defaults:
          relationship_type: CONTROL
          source: DSL
        returns:
          type: uuid
          name: relationship_id
          capture: true

      end:
        description: End a control relationship
        behavior: crud
        crud:
          operation: update
          table: entity_relationships
          schema: ob-poc
          key: relationship_id
        args:
          - name: relationship-id
            type: uuid
            required: true
            maps_to: relationship_id
            lookup:
              table: entity_relationships
              schema: ob-poc
              search_key: relationship_id
              primary_key: relationship_id
          - name: effective-to
            type: date
            required: true
            maps_to: effective_to
        returns:
          type: affected

      list-controllers:
        description: List who controls an entity
        behavior: crud
        crud:
          operation: list_by_fk
          table: entity_relationships_current
          schema: ob-poc
          fk_col: to_entity_id
          filter:
            relationship_type: CONTROL
        args:
          - name: entity-id
            type: uuid
            required: true
            maps_to: to_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
        returns:
          type: record_set

      list-controlled:
        description: List what an entity controls
        behavior: crud
        crud:
          operation: list_by_fk
          table: entity_relationships_current
          schema: ob-poc
          fk_col: from_entity_id
          filter:
            relationship_type: CONTROL
        args:
          - name: entity-id
            type: uuid
            required: true
            maps_to: from_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
        returns:
          type: record_set
