domains:
  control:
    description: Control relationships (distinct from ownership) - voting rights, board control, veto powers
    verbs:

      add:
        description: Add a control relationship between entities
        behavior: crud
        crud:
          operation: insert
          table: control_relationships
          schema: ob-poc
          returning: control_id
        args:
          - name: controller-entity-id
            type: uuid
            required: true
            maps_to: controller_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: controlled-entity-id
            type: uuid
            required: true
            maps_to: controlled_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: control-type
            type: string
            required: true
            maps_to: control_type
            validation:
              enum:
                - VOTING_RIGHTS
                - BOARD_APPOINTMENT
                - VETO_POWER
                - MANAGEMENT_CONTROL
                - RESERVED_MATTERS
          - name: control-percentage
            type: decimal
            required: false
            maps_to: control_percentage
            description: Control percentage (may differ from ownership %)
          - name: description
            type: string
            required: false
            maps_to: control_description
          - name: effective-from
            type: date
            required: false
            maps_to: effective_from
          - name: evidence-doc-id
            type: uuid
            required: false
            maps_to: evidence_doc_id
            lookup:
              table: document_catalog
              entity_type: document
              schema: ob-poc
              search_key: document_name
              primary_key: doc_id
        returns:
          type: uuid
          name: control_id
          capture: true

      end:
        description: End a control relationship
        behavior: crud
        crud:
          operation: update
          table: control_relationships
          schema: ob-poc
          key: control_id
        args:
          - name: control-id
            type: uuid
            required: true
            maps_to: control_id
          - name: effective-to
            type: date
            required: true
            maps_to: effective_to
        returns:
          type: affected

      list-controllers:
        description: List who controls an entity
        behavior: crud
        crud:
          operation: list_by_fk
          table: control_relationships
          schema: ob-poc
          fk_col: controlled_entity_id
        args:
          - name: entity-id
            type: uuid
            required: true
            maps_to: controlled_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
        returns:
          type: record_set

      list-controlled:
        description: List what an entity controls
        behavior: crud
        crud:
          operation: list_by_fk
          table: control_relationships
          schema: ob-poc
          fk_col: controller_entity_id
        args:
          - name: entity-id
            type: uuid
            required: true
            maps_to: controller_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
        returns:
          type: record_set
