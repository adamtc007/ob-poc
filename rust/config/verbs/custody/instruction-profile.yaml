domains:
  instruction-profile:
    description: "Trade instruction message configuration - defines how trades are communicated to gateways"

    verbs:
      # =========================================================================
      # MESSAGE TYPE DEFINITIONS
      # =========================================================================

      define-message-type:
        description: "Define instruction message type for a lifecycle event"
        metadata:
          tier: intent
          source_of_truth: operational
          scope: cbu
          noun: instruction_profile
        behavior: crud
        crud:
          operation: upsert
          table: instruction_message_types
          schema: custody
          conflict_keys:
            - lifecycle_event
            - message_standard
            - message_type
          returning: message_type_id
        args:
          - name: lifecycle-event
            type: string
            required: true
            maps_to: lifecycle_event
            description: "TRADE_INSTRUCTION, SETTLEMENT_INSTRUCTION, CONFIRMATION, AFFIRMATION, ALLOCATION, CA_INSTRUCTION, CA_RESPONSE, COLLATERAL_CALL, COLLATERAL_RESPONSE, INCOME_INSTRUCTION, TAX_RECLAIM"
          - name: message-standard
            type: string
            required: true
            maps_to: message_standard
            description: "MT (SWIFT legacy), MX (ISO 20022), FIX, FPML, PROPRIETARY"
          - name: message-type
            type: string
            required: true
            maps_to: message_type
            description: "e.g., MT540, MT542, sese.023.001.09, FIX NewOrderSingle"
          - name: direction
            type: string
            required: true
            maps_to: direction
            description: "SEND, RECEIVE, or BOTH"
          - name: description
            type: string
            required: false
            maps_to: description
          - name: schema-version
            type: string
            required: false
            maps_to: schema_version
            description: "Message schema version (e.g., SR2023 for SWIFT)"
        returns:
          type: uuid
          name: message_type_id
          capture: true

      list-message-types:
        description: "List available message types"
        metadata:
          tier: reference
          source_of_truth: operational
          scope: cbu
          noun: instruction_profile
        behavior: crud
        crud:
          operation: select
          table: instruction_message_types
          schema: custody
        args:
          - name: lifecycle-event
            type: string
            required: false
            maps_to: lifecycle_event
          - name: message-standard
            type: string
            required: false
            maps_to: message_standard
        returns:
          type: record_set

      # =========================================================================
      # TEMPLATE DEFINITIONS
      # =========================================================================

      create-template:
        description: "Create instruction message template"
        metadata:
          tier: intent
          source_of_truth: operational
          scope: cbu
          noun: instruction_profile
        behavior: crud
        crud:
          operation: upsert
          table: instruction_templates
          schema: custody
          conflict_keys:
            - template_code
          returning: template_id
        args:
          - name: code
            type: string
            required: true
            maps_to: template_code
          - name: name
            type: string
            required: true
            maps_to: template_name
          - name: message-type-id
            type: uuid
            required: true
            maps_to: message_type_id
            lookup:
              table: instruction_message_types
              schema: custody
              search_key: message_type
              primary_key: message_type_id
          - name: base-template
            type: json
            required: true
            maps_to: base_template
            description: "JSON template with placeholders"
          - name: field-mappings
            type: json
            required: false
            maps_to: field_mappings
            description: "Map placeholders to data sources"
          - name: validation-rules
            type: json
            required: false
            maps_to: validation_rules
        returns:
          type: uuid
          name: template_id
          capture: true

      read-template:
        description: "Read instruction template"
        metadata:
          tier: reference
          source_of_truth: operational
          scope: cbu
          noun: instruction_profile
        behavior: crud
        crud:
          operation: select
          table: instruction_templates
          schema: custody
        args:
          - name: template-id
            type: uuid
            required: false
            maps_to: template_id
          - name: code
            type: string
            required: false
            maps_to: template_code
        returns:
          type: record

      list-templates:
        description: "List instruction templates"
        metadata:
          tier: reference
          source_of_truth: operational
          scope: cbu
          noun: instruction_profile
        behavior: crud
        crud:
          operation: select
          table: instruction_templates
          schema: custody
        args:
          - name: message-type-id
            type: uuid
            required: false
            maps_to: message_type_id
        returns:
          type: record_set

      # =========================================================================
      # CBU TEMPLATE ASSIGNMENTS (Diagnostics Only)
      # Write operations removed - use trading-profile verbs for authoring
      # =========================================================================

      list-assignments:
        description: "List instruction template assignments for CBU"
        metadata:
          tier: reference
          source_of_truth: operational
          scope: cbu
          noun: instruction_profile
        behavior: crud
        crud:
          operation: list_by_fk
          table: cbu_instruction_assignments
          schema: custody
          fk_col: cbu_id
          order_by: priority
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: lifecycle-event
            type: string
            required: false
            maps_to: lifecycle_event
        returns:
          type: record_set
        lifecycle:
          reads_tables:
            - custody.cbu_instruction_assignments

      # =========================================================================
      # FIELD OVERRIDES (Diagnostics Only)
      # Write operations removed - use trading-profile verbs for authoring
      # =========================================================================

      list-field-overrides:
        description: "List field overrides for assignment"
        metadata:
          tier: reference
          source_of_truth: operational
          scope: cbu
          noun: instruction_profile
        behavior: crud
        crud:
          operation: list_by_fk
          table: cbu_instruction_field_overrides
          schema: custody
          fk_col: assignment_id
        args:
          - name: assignment-id
            type: uuid
            required: true
            maps_to: assignment_id
        returns:
          type: record_set

      # =========================================================================
      # RESOLUTION & VALIDATION
      # =========================================================================
