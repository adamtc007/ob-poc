domains:
  cbu-custody:
    description: "CBU custody operations: Universe, SSIs, and Booking Rules"
    verbs:
      add-universe:
        description: Declare what a CBU trades (instrument class + market + currencies)
        behavior: crud
        crud:
          operation: upsert
          table: cbu_instrument_universe
          schema: custody
          conflict_keys:
            - cbu_id
            - instrument_class_id
            - market_id
            - counterparty_entity_id
          returning: universe_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
          - name: instrument-class
            type: lookup
            required: true
            maps_to: instrument_class_id
            lookup:
              table: instrument_classes
              schema: custody
              code_column: code
              id_column: class_id
          - name: market
            type: lookup
            required: false
            maps_to: market_id
            lookup:
              table: markets
              schema: custody
              code_column: mic
              id_column: market_id
          - name: currencies
            type: string_list
            required: true
            maps_to: currencies
          - name: settlement-types
            type: string_list
            required: false
            maps_to: settlement_types
            default:
              - DVP
          - name: counterparty
            type: uuid
            required: false
            maps_to: counterparty_entity_id
          - name: is-held
            type: boolean
            required: false
            maps_to: is_held
            default: true
          - name: is-traded
            type: boolean
            required: false
            maps_to: is_traded
            default: true
        returns:
          type: uuid
          name: universe_id
          capture: false
      list-universe:
        description: List CBU's traded universe
        behavior: crud
        crud:
          operation: list_by_fk
          table: cbu_instrument_universe
          schema: custody
          fk_col: cbu_id
        args:
          - name: cbu-id
            type: uuid
            required: true
        returns:
          type: record_set
      create-ssi:
        description: Create a Standing Settlement Instruction (pure account data)
        behavior: crud
        crud:
          operation: insert
          table: cbu_ssi
          schema: custody
          returning: ssi_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
          - name: name
            type: string
            required: true
            maps_to: ssi_name
          - name: type
            type: string
            required: true
            maps_to: ssi_type
            valid_values:
              - SECURITIES
              - CASH
              - COLLATERAL
              - FX_NOSTRO
          - name: safekeeping-account
            type: string
            required: false
            maps_to: safekeeping_account
          - name: safekeeping-bic
            type: string
            required: false
            maps_to: safekeeping_bic
          - name: safekeeping-name
            type: string
            required: false
            maps_to: safekeeping_account_name
          - name: cash-account
            type: string
            required: false
            maps_to: cash_account
          - name: cash-bic
            type: string
            required: false
            maps_to: cash_account_bic
          - name: cash-currency
            type: string
            required: false
            maps_to: cash_currency
          - name: collateral-account
            type: string
            required: false
            maps_to: collateral_account
          - name: collateral-bic
            type: string
            required: false
            maps_to: collateral_account_bic
          - name: pset-bic
            type: string
            required: false
            maps_to: pset_bic
          - name: effective-date
            type: date
            required: true
            maps_to: effective_date
        returns:
          type: uuid
          name: ssi_id
          capture: true
      list-ssis:
        description: List SSIs for a CBU
        behavior: crud
        crud:
          operation: list_by_fk
          table: cbu_ssi
          schema: custody
          fk_col: cbu_id
        args:
          - name: cbu-id
            type: uuid
            required: true
          - name: status
            type: string
            required: false
            maps_to: status
          - name: type
            type: string
            required: false
            maps_to: ssi_type
        returns:
          type: record_set
      activate-ssi:
        description: Activate an SSI
        behavior: crud
        crud:
          operation: update
          table: cbu_ssi
          schema: custody
          key: ssi_id
          set_values:
            status: ACTIVE
        args:
          - name: ssi-id
            type: uuid
            required: true
            maps_to: ssi_id
        returns:
          type: affected
      suspend-ssi:
        description: Suspend an SSI
        behavior: crud
        crud:
          operation: update
          table: cbu_ssi
          schema: custody
          key: ssi_id
          set_values:
            status: SUSPENDED
        args:
          - name: ssi-id
            type: uuid
            required: true
            maps_to: ssi_id
        returns:
          type: affected
      add-booking-rule:
        description: Add ALERT-style booking rule for SSI routing
        behavior: crud
        crud:
          operation: insert
          table: ssi_booking_rules
          schema: custody
          returning: rule_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
          - name: ssi-id
            type: uuid
            required: true
            maps_to: ssi_id
          - name: name
            type: string
            required: true
            maps_to: rule_name
          - name: priority
            type: integer
            required: true
            maps_to: priority
          - name: instrument-class
            type: lookup
            required: false
            maps_to: instrument_class_id
            lookup:
              table: instrument_classes
              schema: custody
              code_column: code
              id_column: class_id
          - name: security-type
            type: lookup
            required: false
            maps_to: security_type_id
            lookup:
              table: security_types
              schema: custody
              code_column: code
              id_column: security_type_id
          - name: market
            type: lookup
            required: false
            maps_to: market_id
            lookup:
              table: markets
              schema: custody
              code_column: mic
              id_column: market_id
          - name: currency
            type: string
            required: false
            maps_to: currency
          - name: settlement-type
            type: string
            required: false
            maps_to: settlement_type
          - name: counterparty
            type: uuid
            required: false
            maps_to: counterparty_entity_id
          - name: isda-asset-class
            type: string
            required: false
            maps_to: isda_asset_class
          - name: isda-base-product
            type: string
            required: false
            maps_to: isda_base_product
          - name: effective-date
            type: date
            required: false
            maps_to: effective_date
        returns:
          type: uuid
          name: rule_id
          capture: true
      list-booking-rules:
        description: List booking rules for a CBU
        behavior: crud
        crud:
          operation: list_by_fk
          table: ssi_booking_rules
          schema: custody
          fk_col: cbu_id
          order_by: priority
        args:
          - name: cbu-id
            type: uuid
            required: true
          - name: is-active
            type: boolean
            required: false
            maps_to: is_active
        returns:
          type: record_set
      update-rule-priority:
        description: Update booking rule priority
        behavior: crud
        crud:
          operation: update
          table: ssi_booking_rules
          schema: custody
          key: rule_id
        args:
          - name: rule-id
            type: uuid
            required: true
            maps_to: rule_id
          - name: priority
            type: integer
            required: true
            maps_to: priority
        returns:
          type: affected
      deactivate-rule:
        description: Deactivate a booking rule
        behavior: crud
        crud:
          operation: update
          table: ssi_booking_rules
          schema: custody
          key: rule_id
          set_values:
            is_active: false
        args:
          - name: rule-id
            type: uuid
            required: true
            maps_to: rule_id
        returns:
          type: affected
      derive-required-coverage:
        description: Compare universe to booking rules, find gaps
        behavior: plugin
        handler: derive_required_coverage
        args:
          - name: cbu-id
            type: uuid
            required: true
        returns:
          type: record_set
      validate-booking-coverage:
        description: Validate that all universe entries have matching booking rules
        behavior: plugin
        handler: validate_booking_coverage
        args:
          - name: cbu-id
            type: uuid
            required: true
        returns:
          type: record
      lookup-ssi:
        description: Find SSI for given trade characteristics (simulate ALERT lookup)
        behavior: plugin
        handler: lookup_ssi_for_trade
        args:
          - name: cbu-id
            type: uuid
            required: true
          - name: instrument-class
            type: string
            required: true
          - name: security-type
            type: string
            required: false
          - name: market
            type: string
            required: false
          - name: currency
            type: string
            required: true
          - name: settlement-type
            type: string
            required: false
          - name: counterparty-bic
            type: string
            required: false
        returns:
          type: record
      add-agent-override:
        description: Add intermediary agent to SSI settlement chain
        behavior: crud
        crud:
          operation: insert
          table: cbu_ssi_agent_override
          schema: custody
          returning: override_id
        args:
          - name: ssi-id
            type: uuid
            required: true
            maps_to: ssi_id
          - name: agent-role
            type: string
            required: true
            maps_to: agent_role
            valid_values:
              - REAG
              - DEAG
              - INT1
              - INT2
              - RECU
              - DECU
          - name: agent-bic
            type: string
            required: true
            maps_to: agent_bic
          - name: agent-account
            type: string
            required: false
            maps_to: agent_account
          - name: agent-name
            type: string
            required: false
            maps_to: agent_name
          - name: sequence-order
            type: integer
            required: true
            maps_to: sequence_order
          - name: reason
            type: string
            required: false
            maps_to: reason
        returns:
          type: uuid
          name: override_id
          capture: true
      list-agent-overrides:
        description: List agent overrides for an SSI
        behavior: crud
        crud:
          operation: list_by_fk
          table: cbu_ssi_agent_override
          schema: custody
          fk_col: ssi_id
          order_by: sequence_order
        args:
          - name: ssi-id
            type: uuid
            required: true
            maps_to: ssi_id
        returns:
          type: record_set
      setup-ssi:
        description: Bulk import SSIs from SSI_ONBOARDING document
        behavior: plugin
        handler: setup_ssi_from_document
        args:
          - name: cbu-id
            type: uuid
            required: true
          - name: document-id
            type: uuid
            required: true
          - name: validation-mode
            type: string
            required: false
            default: STRICT
            valid_values:
              - STRICT
              - PERMISSIVE
        returns:
          type: record
