domains:
  cbu-custody:
    description: "CBU custody diagnostics: Query operational universe, SSIs, and Booking Rules"
    verbs:
      # ========================================
      # DIAGNOSTICS - Query operational state
      # ========================================
      # These verbs query the operational tables that are WRITTEN by trading-profile:materialize.
      # For authoring/editing, use trading-profile:* verbs instead.

      list-universe:
        description: List CBU's traded universe (read from operational tables)
        behavior: crud
        metadata:
          tier: diagnostics
          source_of_truth: operational
          scope: cbu
          noun: universe
          tags: [read, operational-state]
        crud:
          operation: list_by_fk
          table: cbu_instrument_universe
          schema: custody
          fk_col: cbu_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
        returns:
          type: record_set

      list-ssis:
        description: List SSIs for a CBU (read from operational tables)
        behavior: crud
        metadata:
          tier: diagnostics
          source_of_truth: operational
          scope: cbu
          noun: ssi
          tags: [read, operational-state]
        crud:
          operation: list_by_fk
          table: cbu_ssi
          schema: custody
          fk_col: cbu_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: status
            type: string
            required: false
            maps_to: status
          - name: type
            type: string
            required: false
            maps_to: ssi_type
        returns:
          type: record_set

      list-booking-rules:
        description: List booking rules for a CBU (read from operational tables)
        behavior: crud
        metadata:
          tier: diagnostics
          source_of_truth: operational
          scope: cbu
          noun: booking_rule
          tags: [read, operational-state]
        crud:
          operation: list_by_fk
          table: ssi_booking_rules
          schema: custody
          fk_col: cbu_id
          order_by: priority
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: is-active
            type: boolean
            required: false
            maps_to: is_active
        returns:
          type: record_set

      list-agent-overrides:
        description: List agent overrides for an SSI
        behavior: crud
        metadata:
          tier: diagnostics
          source_of_truth: operational
          scope: cbu
          noun: agent_override
          tags: [read, operational-state]
        crud:
          operation: list_by_fk
          table: cbu_ssi_agent_override
          schema: custody
          fk_col: ssi_id
          order_by: sequence_order
        args:
          - name: ssi-id
            type: uuid
            required: true
            maps_to: ssi_id
            lookup:
              table: cbu_ssi
              entity_type: ssi
              schema: custody
              search_key: ssi_name
              primary_key: ssi_id
        returns:
          type: record_set

      # ========================================
      # VALIDATION - Check coverage and gaps
      # ========================================

      derive-required-coverage:
        description: Compare universe to booking rules, find gaps
        behavior: plugin
        handler: derive_required_coverage
        metadata:
          tier: diagnostics
          source_of_truth: operational
          scope: cbu
          noun: coverage_gap
          tags: [read, validation, gap-analysis]
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
        returns:
          type: record_set

      validate-booking-coverage:
        description: Validate that all universe entries have matching booking rules
        behavior: plugin
        handler: validate_booking_coverage
        metadata:
          tier: diagnostics
          source_of_truth: operational
          scope: cbu
          noun: coverage_validation
          tags: [read, validation, coverage-check]
        lifecycle:
          reads_tables:
            - custody.cbu_instrument_universe
            - custody.cbu_ssi
            - custody.ssi_booking_rules
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
        returns:
          type: record

      lookup-ssi:
        description: Find SSI for given trade characteristics (simulate ALERT lookup)
        behavior: plugin
        handler: lookup_ssi_for_trade
        metadata:
          tier: diagnostics
          source_of_truth: operational
          scope: cbu
          noun: ssi_lookup
          tags: [read, routing, alert-simulation]
        lifecycle:
          reads_tables:
            - custody.cbu_ssi
            - custody.ssi_booking_rules
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: instrument-class
            type: string
            required: true
          - name: security-type
            type: string
            required: false
          - name: market
            type: string
            required: false
          - name: currency
            type: string
            required: true
          - name: settlement-type
            type: string
            required: false
          - name: counterparty-bic
            type: string
            required: false
        returns:
          type: record

      # ========================================
      # COMPOSITE - Bulk import
      # ========================================

      setup-ssi:
        description: Bulk import SSIs from SSI_ONBOARDING document
        behavior: plugin
        handler: setup_ssi_from_document
        metadata:
          tier: composite
          source_of_truth: operational
          scope: cbu
          writes_operational: true
          noun: ssi_setup
          tags: [bulk-import, document-driven]
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: document-id
            type: uuid
            required: true
            lookup:
              table: document_catalog
              entity_type: document
              schema: ob-poc
              search_key: document_name
              primary_key: doc_id
          - name: validation-mode
            type: string
            required: false
            default: STRICT
            valid_values:
              - STRICT
              - PERMISSIVE
        returns:
          type: record
