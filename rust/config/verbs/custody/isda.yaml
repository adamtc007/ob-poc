domains:
  isda:
    description: ISDA and CSA agreement management for OTC derivatives
    verbs:
      create:
        description: Create ISDA agreement with counterparty (idempotent by cbu+counterparty)
        behavior: crud
        crud:
          operation: upsert
          table: isda_agreements
          schema: custody
          returning: isda_id
          conflict_keys:
            - cbu_id
            - counterparty_entity_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: counterparty
            type: uuid
            required: true
            maps_to: counterparty_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: agreement-date
            type: date
            required: true
            maps_to: agreement_date
          - name: governing-law
            type: string
            required: false
            maps_to: governing_law
            valid_values:
              - NY
              - ENGLISH
          - name: effective-date
            type: date
            required: true
            maps_to: effective_date
        returns:
          type: uuid
          name: isda_id
          capture: true
      add-coverage:
        description: Add instrument class coverage to ISDA (idempotent by isda+instrument_class)
        behavior: crud
        crud:
          operation: upsert
          table: isda_product_coverage
          schema: custody
          returning: coverage_id
          conflict_keys:
            - isda_id
            - instrument_class_id
        args:
          - name: isda-id
            type: uuid
            required: true
            maps_to: isda_id
            lookup:
              table: isda_agreements
              entity_type: isda
              schema: custody
              search_key: isda_id
              primary_key: isda_id
          - name: instrument-class
            type: lookup
            required: true
            maps_to: instrument_class_id
            lookup:
              table: instrument_classes
              entity_type: instrument_class
              schema: custody
              code_column: code
              id_column: class_id
          - name: isda-taxonomy
            type: lookup
            required: false
            maps_to: isda_taxonomy_id
            lookup:
              table: isda_product_taxonomy
              schema: custody
              code_column: taxonomy_code
              id_column: taxonomy_id
        returns:
          type: uuid
          name: coverage_id
      add-csa:
        description: Add CSA (Credit Support Annex) to ISDA (idempotent by isda+csa_type)
        behavior: crud
        crud:
          operation: upsert
          table: csa_agreements
          schema: custody
          returning: csa_id
          conflict_keys:
            - isda_id
            - csa_type
        args:
          - name: isda-id
            type: uuid
            required: true
            maps_to: isda_id
            lookup:
              table: isda_agreements
              entity_type: isda
              schema: custody
              search_key: isda_id
              primary_key: isda_id
          - name: csa-type
            type: string
            required: true
            maps_to: csa_type
            valid_values:
              - VM
              - IM
          - name: threshold
            type: decimal
            required: false
            maps_to: threshold_amount
          - name: threshold-currency
            type: string
            required: false
            maps_to: threshold_currency
          - name: mta
            type: decimal
            required: false
            maps_to: minimum_transfer_amount
          - name: collateral-ssi
            type: uuid
            required: false
            maps_to: collateral_ssi_id
          - name: effective-date
            type: date
            required: true
            maps_to: effective_date
        returns:
          type: uuid
          name: csa_id
          capture: true
      remove-coverage:
        description: Remove instrument class coverage from ISDA
        behavior: crud
        crud:
          operation: delete
          table: isda_product_coverage
          schema: custody
        args:
          - name: coverage-id
            type: uuid
            required: true
            maps_to: coverage_id
        returns:
          type: affected
      remove-csa:
        description: Remove CSA from ISDA
        behavior: crud
        crud:
          operation: delete
          table: csa_agreements
          schema: custody
        args:
          - name: csa-id
            type: uuid
            required: true
            maps_to: csa_id
        returns:
          type: affected
      list:
        description: List ISDA agreements for CBU
        behavior: crud
        crud:
          operation: list_by_fk
          table: isda_agreements
          schema: custody
          fk_col: cbu_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: counterparty
            type: uuid
            required: false
            maps_to: counterparty_entity_id
        returns:
          type: record_set
