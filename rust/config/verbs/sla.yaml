# Service Level Agreement Verbs
# =============================================================================
# Manages SLA commitments, measurements, and breach tracking
# =============================================================================

domains:
  sla:
    description: "Service Level Agreement management and monitoring"
    verbs:
      # === Template Operations (read-only reference data) ===
      list-templates:
        description: List available SLA templates
        metadata:
          tier: reference
          source_of_truth: operational
          scope: cbu
          noun: sla
        behavior: crud
        crud:
          operation: select
          table: sla_templates
          schema: ob-poc
        args:
          - name: applies-to-type
            type: string
            required: false
            maps_to: applies_to_type
            valid_values:
              - SERVICE
              - RESOURCE_TYPE
              - ISDA
              - CSA
              - PRODUCT
          - name: applies-to-code
            type: string
            required: false
            maps_to: applies_to_code
          - name: is-active
            type: boolean
            required: false
            default: true
            maps_to: is_active
        returns:
          type: record_set

      read-template:
        description: Read SLA template by code
        metadata:
          tier: reference
          source_of_truth: operational
          scope: cbu
          noun: sla
        behavior: crud
        crud:
          operation: select
          table: sla_templates
          schema: ob-poc
        args:
          - name: template-code
            type: string
            required: true
            maps_to: template_code
        returns:
          type: record

      # === Commitment Operations ===
      commit:
        description: Create SLA commitment for CBU (idempotent by cbu+template+profile)
        metadata:
          tier: intent
          source_of_truth: operational
          scope: cbu
          noun: sla
        behavior: crud
        crud:
          operation: upsert
          table: cbu_sla_commitments
          schema: ob-poc
          returning: commitment_id
          conflict_keys:
            - cbu_id
            - template_id
            - profile_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: template-code
            type: string
            required: true
            lookup:
              table: sla_templates
              schema: ob-poc
              code_column: template_code
              id_column: template_id
            maps_to: template_id
          - name: profile-id
            type: uuid
            required: false
            maps_to: profile_id
            lookup:
              table: cbu_trading_profiles
              schema: ob-poc
              search_key: profile_id
              primary_key: profile_id
          - name: override-target
            type: decimal
            required: false
            maps_to: override_target_value
          - name: override-warning
            type: decimal
            required: false
            maps_to: override_warning_threshold
          - name: scope-instrument-classes
            type: string_list
            required: false
            maps_to: scope_instrument_classes
          - name: scope-markets
            type: string_list
            required: false
            maps_to: scope_markets
          - name: scope-currencies
            type: string_list
            required: false
            maps_to: scope_currencies
          - name: effective-date
            type: date
            required: false
            maps_to: effective_date
          - name: negotiated-by
            type: string
            required: false
            maps_to: negotiated_by
          - name: source-document-id
            type: uuid
            required: false
            maps_to: source_document_id
            lookup:
              table: document_catalog
              schema: ob-poc
              search_key: document_name
              primary_key: doc_id
        returns:
          type: uuid
          name: commitment_id
          capture: true

      bind-to-profile:
        description: Bind SLA commitment to trading profile
        metadata:
          tier: intent
          source_of_truth: operational
          scope: cbu
          noun: sla
        behavior: crud
        crud:
          operation: update
          table: cbu_sla_commitments
          schema: ob-poc
          key: commitment_id
        args:
          - name: commitment-id
            type: uuid
            required: true
            maps_to: commitment_id
          - name: profile-id
            type: uuid
            required: true
            maps_to: profile_id
            lookup:
              table: cbu_trading_profiles
              schema: ob-poc
              search_key: profile_id
              primary_key: profile_id
        returns:
          type: affected

      bind-to-service:
        description: Bind SLA commitment to service
        metadata:
          tier: intent
          source_of_truth: operational
          scope: cbu
          noun: sla
        behavior: crud
        crud:
          operation: update
          table: cbu_sla_commitments
          schema: ob-poc
          key: commitment_id
        args:
          - name: commitment-id
            type: uuid
            required: true
            maps_to: commitment_id
          - name: service-id
            type: uuid
            required: true
            maps_to: bound_service_id
            lookup:
              table: services
              entity_type: service
              schema: ob-poc
              search_key: name
              primary_key: service_id
        returns:
          type: affected

      bind-to-resource:
        description: Bind SLA commitment to service resource instance
        metadata:
          tier: intent
          source_of_truth: operational
          scope: cbu
          noun: sla
        behavior: crud
        crud:
          operation: update
          table: cbu_sla_commitments
          schema: ob-poc
          key: commitment_id
        args:
          - name: commitment-id
            type: uuid
            required: true
            maps_to: commitment_id
          - name: resource-instance-id
            type: uuid
            required: true
            maps_to: bound_resource_instance_id
            lookup:
              table: cbu_resource_instances
              entity_type: resource_instance
              schema: ob-poc
              search_key: instance_name
              primary_key: instance_id
        returns:
          type: affected

      bind-to-isda:
        description: Bind SLA commitment to ISDA agreement
        metadata:
          tier: intent
          source_of_truth: operational
          scope: cbu
          noun: sla
        behavior: crud
        crud:
          operation: update
          table: cbu_sla_commitments
          schema: ob-poc
          key: commitment_id
        args:
          - name: commitment-id
            type: uuid
            required: true
            maps_to: commitment_id
          - name: isda-id
            type: uuid
            required: true
            maps_to: bound_isda_id
        returns:
          type: affected

      bind-to-csa:
        description: Bind SLA commitment to CSA agreement
        metadata:
          tier: intent
          source_of_truth: operational
          scope: cbu
          noun: sla
        behavior: crud
        crud:
          operation: update
          table: cbu_sla_commitments
          schema: ob-poc
          key: commitment_id
        args:
          - name: commitment-id
            type: uuid
            required: true
            maps_to: commitment_id
          - name: csa-id
            type: uuid
            required: true
            maps_to: bound_csa_id
        returns:
          type: affected

      list-commitments:
        description: List SLA commitments for CBU
        metadata:
          tier: reference
          source_of_truth: operational
          scope: cbu
          noun: sla
        behavior: crud
        crud:
          operation: list_by_fk
          table: cbu_sla_commitments
          schema: ob-poc
          fk_col: cbu_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: status
            type: string
            required: false
            maps_to: status
        returns:
          type: record_set

      suspend-commitment:
        description: Suspend an SLA commitment
        metadata:
          tier: intent
          source_of_truth: operational
          scope: cbu
          noun: sla
        behavior: crud
        crud:
          operation: update
          table: cbu_sla_commitments
          schema: ob-poc
          key: commitment_id
          set_values:
            status: SUSPENDED
        args:
          - name: commitment-id
            type: uuid
            required: true
            maps_to: commitment_id
        returns:
          type: affected

      # === Measurement Operations ===
      record-measurement:
        description: Record SLA measurement for period
        metadata:
          tier: intent
          source_of_truth: operational
          scope: cbu
          noun: sla
        behavior: crud
        crud:
          operation: insert
          table: sla_measurements
          schema: ob-poc
          returning: measurement_id
        args:
          - name: commitment-id
            type: uuid
            required: true
            maps_to: commitment_id
          - name: period-start
            type: date
            required: true
            maps_to: period_start
          - name: period-end
            type: date
            required: true
            maps_to: period_end
          - name: measured-value
            type: decimal
            required: true
            maps_to: measured_value
          - name: sample-size
            type: integer
            required: false
            maps_to: sample_size
          - name: status
            type: string
            required: true
            maps_to: status
            valid_values:
              - MET
              - WARNING
              - BREACH
          - name: variance-pct
            type: decimal
            required: false
            maps_to: variance_pct
          - name: measurement-method
            type: string
            required: false
            maps_to: measurement_method
            valid_values:
              - AUTOMATED
              - MANUAL
              - ESTIMATED
              - SYSTEM
          - name: notes
            type: string
            required: false
            maps_to: measurement_notes
        returns:
          type: uuid
          name: measurement_id
          capture: true

      list-measurements:
        description: List measurements for SLA commitment
        metadata:
          tier: reference
          source_of_truth: operational
          scope: cbu
          noun: sla
        behavior: crud
        crud:
          operation: list_by_fk
          table: sla_measurements
          schema: ob-poc
          fk_col: commitment_id
          order_by: period_end DESC
        args:
          - name: commitment-id
            type: uuid
            required: true
            maps_to: commitment_id
          - name: status
            type: string
            required: false
            maps_to: status
          - name: limit
            type: integer
            required: false
            default: 12
        returns:
          type: record_set

      # === Breach Operations ===
      report-breach:
        description: Report SLA breach
        metadata:
          tier: intent
          source_of_truth: operational
          scope: cbu
          noun: sla
        behavior: crud
        crud:
          operation: insert
          table: sla_breaches
          schema: ob-poc
          returning: breach_id
        args:
          - name: measurement-id
            type: uuid
            required: true
            maps_to: measurement_id
          - name: commitment-id
            type: uuid
            required: true
            maps_to: commitment_id
          - name: severity
            type: string
            required: true
            maps_to: breach_severity
            valid_values:
              - MINOR
              - MAJOR
              - CRITICAL
          - name: breach-date
            type: date
            required: true
            maps_to: breach_date
          - name: root-cause-category
            type: string
            required: true
            maps_to: root_cause_category
            valid_values:
              - SYSTEM
              - VENDOR
              - MARKET
              - CLIENT
              - INTERNAL
              - EXTERNAL
              - UNKNOWN
          - name: root-cause-description
            type: string
            required: true
            maps_to: root_cause_description
          - name: remediation-plan
            type: string
            required: false
            maps_to: remediation_plan
          - name: remediation-due-date
            type: date
            required: false
            maps_to: remediation_due_date
        returns:
          type: uuid
          name: breach_id
          capture: true

      update-remediation:
        description: Update breach remediation status
        metadata:
          tier: intent
          source_of_truth: operational
          scope: cbu
          noun: sla
        behavior: crud
        crud:
          operation: update
          table: sla_breaches
          schema: ob-poc
          key: breach_id
        args:
          - name: breach-id
            type: uuid
            required: true
            maps_to: breach_id
          - name: status
            type: string
            required: true
            maps_to: remediation_status
            valid_values:
              - OPEN
              - IN_PROGRESS
              - RESOLVED
              - WAIVED
              - ESCALATED
          - name: remediation-plan
            type: string
            required: false
            maps_to: remediation_plan
          - name: remediation-due-date
            type: date
            required: false
            maps_to: remediation_due_date
        returns:
          type: affected

      resolve-breach:
        description: Mark breach as resolved
        metadata:
          tier: intent
          source_of_truth: operational
          scope: cbu
          noun: sla
        behavior: crud
        crud:
          operation: update
          table: sla_breaches
          schema: ob-poc
          key: breach_id
          set_values:
            remediation_status: RESOLVED
        args:
          - name: breach-id
            type: uuid
            required: true
            maps_to: breach_id
        returns:
          type: affected

      escalate-breach:
        description: Escalate breach
        metadata:
          tier: intent
          source_of_truth: operational
          scope: cbu
          noun: sla
        behavior: crud
        crud:
          operation: update
          table: sla_breaches
          schema: ob-poc
          key: breach_id
        args:
          - name: breach-id
            type: uuid
            required: true
            maps_to: breach_id
          - name: escalate-to
            type: string
            required: true
            maps_to: escalated_to
        returns:
          type: affected

      list-open-breaches:
        description: List open breaches for CBU
        metadata:
          tier: reference
          source_of_truth: operational
          scope: cbu
          noun: sla
        behavior: plugin
        handler: list_open_sla_breaches
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: severity
            type: string
            required: false
            valid_values:
              - MINOR
              - MAJOR
              - CRITICAL
        returns:
          type: record_set
