# Pricing Configuration Verbs
# =============================================================================
# Manages pricing source configuration by instrument class
# =============================================================================

domains:
  pricing-config:
    description: "Pricing source configuration management"
    verbs:
      set:
        description: Set pricing source for instrument class
        behavior: crud
        crud:
          operation: upsert
          table: cbu_pricing_config
          schema: custody
          conflict_keys:
            - cbu_id
            - instrument_class_id
            - market_id
            - priority
          returning: config_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: profile-id
            type: uuid
            required: false
            maps_to: profile_id
            lookup:
              table: cbu_trading_profiles
              schema: ob-poc
              search_key: profile_id
              primary_key: profile_id
          - name: instrument-class
            type: lookup
            required: true
            maps_to: instrument_class_id
            lookup:
              table: instrument_classes
              entity_type: instrument_class
              schema: custody
              code_column: code
              id_column: class_id
          - name: market
            type: lookup
            required: false
            maps_to: market_id
            lookup:
              table: markets
              entity_type: market
              schema: custody
              code_column: mic
              id_column: market_id
          - name: currency
            type: string
            required: false
            maps_to: currency
          - name: priority
            type: integer
            required: true
            maps_to: priority
          - name: source
            type: string
            required: true
            maps_to: source
            valid_values:
              - BLOOMBERG
              - REUTERS
              - MARKIT
              - REFINITIV
              - ICE
              - MODEL
              - INTERNAL
              - VENDOR
              - COUNTERPARTY
          - name: price-type
            type: string
            required: false
            default: CLOSING
            maps_to: price_type
            valid_values:
              - CLOSING
              - MID
              - BID
              - ASK
              - VWAP
              - OFFICIAL
          - name: fallback-source
            type: string
            required: false
            maps_to: fallback_source
          - name: max-age-hours
            type: integer
            required: false
            default: 24
            maps_to: max_age_hours
          - name: tolerance-pct
            type: decimal
            required: false
            default: 5.0
            maps_to: tolerance_pct
          - name: stale-action
            type: string
            required: false
            default: WARN
            maps_to: stale_action
            valid_values:
              - WARN
              - BLOCK
              - USE_FALLBACK
              - ESCALATE
          - name: effective-date
            type: date
            required: false
            maps_to: effective_date
        returns:
          type: uuid
          name: config_id
          capture: true

      link-resource:
        description: Link pricing config to pricing feed resource
        behavior: crud
        crud:
          operation: update
          table: cbu_pricing_config
          schema: custody
          key: config_id
        args:
          - name: config-id
            type: uuid
            required: true
            maps_to: config_id
          - name: pricing-resource-id
            type: uuid
            required: true
            maps_to: pricing_resource_id
            lookup:
              table: cbu_resource_instances
              entity_type: resource_instance
              schema: ob-poc
              search_key: instance_name
              primary_key: instance_id
        returns:
          type: affected

      list:
        description: List pricing configurations for CBU
        behavior: crud
        crud:
          operation: list_by_fk
          table: cbu_pricing_config
          schema: custody
          fk_col: cbu_id
          order_by: priority
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: instrument-class
            type: string
            required: false
          - name: is-active
            type: boolean
            required: false
            default: true
            maps_to: is_active
        returns:
          type: record_set

      remove:
        description: Remove pricing configuration
        behavior: crud
        crud:
          operation: delete
          table: cbu_pricing_config
          schema: custody
        args:
          - name: config-id
            type: uuid
            required: true
            maps_to: config_id
        returns:
          type: affected

      deactivate:
        description: Deactivate pricing configuration
        behavior: crud
        crud:
          operation: update
          table: cbu_pricing_config
          schema: custody
          key: config_id
          set_values:
            is_active: false
        args:
          - name: config-id
            type: uuid
            required: true
            maps_to: config_id
        returns:
          type: affected

      find-for-instrument:
        description: Find pricing source for given instrument characteristics
        behavior: plugin
        handler: find_pricing_for_instrument
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: instrument-class
            type: string
            required: true
          - name: market
            type: string
            required: false
          - name: currency
            type: string
            required: false
        returns:
          type: record
          description: Matching pricing config with source and parameters
