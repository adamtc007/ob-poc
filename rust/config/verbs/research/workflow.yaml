domains:
  research.workflow:
    description: "Research workflow management - decision tracking, audit trail, corrections"

    invocation_hints:
      - "research decision"
      - "audit trail"
      - "what research was done"
      - "how did we get this data"
      - "correction"
      - "fix the mistake"
      - "wrong entity"
      - "undo selection"

    verbs:
      # =======================================================================
      # DECISION MANAGEMENT
      # =======================================================================

      record-decision:
        description: "Record a research decision (Phase 1 outcome)"
        metadata:
          tier: intent
          source_of_truth: workflow
          scope: global
          noun: research_decision
          tags: [write, workflow, audit-trail]
        behavior: crud
        crud:
          operation: insert
          table: research_decisions
          schema: kyc
          returning: decision_id
        args:
          - name: target-entity-id
            type: uuid
            required: false
            maps_to: target_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: search-query
            type: string
            required: true
            maps_to: search_query
          - name: source-provider
            type: string
            required: true
            maps_to: source_provider
          - name: candidates-found
            type: object
            required: true
            maps_to: candidates_found
          - name: candidates-count
            type: integer
            required: false
            maps_to: candidates_count
          - name: selected-key
            type: string
            required: false
            maps_to: selected_key
          - name: selected-key-type
            type: string
            required: false
            maps_to: selected_key_type
          - name: confidence
            type: decimal
            required: false
            maps_to: selection_confidence
          - name: reasoning
            type: string
            required: true
            maps_to: selection_reasoning
          - name: decision-type
            type: string
            required: true
            maps_to: decision_type
          - name: auto-selected
            type: boolean
            required: false
            maps_to: auto_selected
        returns:
          type: uuid
          capture: true

      confirm-decision:
        description: "User confirms an ambiguous decision"
        invocation_phrases:
          - "confirm this"
          - "yes that's right"
          - "use that one"
          - "select this match"
        metadata:
          tier: intent
          source_of_truth: workflow
          scope: global
          noun: research_decision
          tags: [write, workflow, user-confirmation]
        behavior: plugin
        handler: WorkflowConfirmDecisionOp
        args:
          - name: decision-id
            type: uuid
            required: true
          - name: selected-key
            type: string
            required: true
          - name: selected-key-type
            type: string
            required: true
        returns:
          type: record

      reject-decision:
        description: "User rejects a suggested decision"
        invocation_phrases:
          - "no that's wrong"
          - "reject"
          - "not that one"
          - "none of these"
        metadata:
          tier: intent
          source_of_truth: workflow
          scope: global
          noun: research_decision
          tags: [write, workflow, user-rejection]
        behavior: plugin
        handler: WorkflowRejectDecisionOp
        args:
          - name: decision-id
            type: uuid
            required: true
          - name: rejection-reason
            type: string
            required: true
        returns:
          type: record

      # =======================================================================
      # ACTION MANAGEMENT
      # =======================================================================

      record-action:
        description: "Record a research action (Phase 2 execution)"
        metadata:
          tier: intent
          source_of_truth: workflow
          scope: global
          noun: research_action
          tags: [write, workflow, audit-trail]
        behavior: crud
        crud:
          operation: insert
          table: research_actions
          schema: kyc
          returning: action_id
        args:
          - name: target-entity-id
            type: uuid
            required: true
            maps_to: target_entity_id
          - name: decision-id
            type: uuid
            required: false
            maps_to: decision_id
          - name: action-type
            type: string
            required: true
            maps_to: action_type
          - name: source-provider
            type: string
            required: true
            maps_to: source_provider
          - name: source-key
            type: string
            required: true
            maps_to: source_key
          - name: source-key-type
            type: string
            required: true
            maps_to: source_key_type
          - name: verb-domain
            type: string
            required: true
            maps_to: verb_domain
          - name: verb-name
            type: string
            required: true
            maps_to: verb_name
          - name: verb-args
            type: object
            required: false
            maps_to: verb_args
          - name: success
            type: boolean
            required: true
            maps_to: success
          - name: entities-created
            type: integer
            required: false
            maps_to: entities_created
          - name: entities-updated
            type: integer
            required: false
            maps_to: entities_updated
          - name: relationships-created
            type: integer
            required: false
            maps_to: relationships_created
          - name: error-code
            type: string
            required: false
            maps_to: error_code
          - name: error-message
            type: string
            required: false
            maps_to: error_message
          - name: duration-ms
            type: integer
            required: false
            maps_to: duration_ms
        returns:
          type: uuid
          capture: true

      # =======================================================================
      # CORRECTIONS
      # =======================================================================

      record-correction:
        description: "Record a correction to a previous decision"
        invocation_phrases:
          - "correct this"
          - "fix the mistake"
          - "wrong entity was selected"
          - "undo that selection"
        metadata:
          tier: intent
          source_of_truth: workflow
          scope: global
          noun: research_correction
          tags: [write, workflow, correction]
        behavior: crud
        crud:
          operation: insert
          table: research_corrections
          schema: kyc
          returning: correction_id
        args:
          - name: original-decision-id
            type: uuid
            required: true
            maps_to: original_decision_id
          - name: original-action-id
            type: uuid
            required: false
            maps_to: original_action_id
          - name: correction-type
            type: string
            required: true
            maps_to: correction_type
          - name: wrong-key
            type: string
            required: false
            maps_to: wrong_key
          - name: wrong-key-type
            type: string
            required: false
            maps_to: wrong_key_type
          - name: correct-key
            type: string
            required: false
            maps_to: correct_key
          - name: correct-key-type
            type: string
            required: false
            maps_to: correct_key_type
          - name: correction-reason
            type: string
            required: true
            maps_to: correction_reason
        returns:
          type: uuid
          capture: true

      # =======================================================================
      # ANOMALIES
      # =======================================================================

      record-anomaly:
        description: "Record a post-import validation anomaly"
        metadata:
          tier: intent
          source_of_truth: workflow
          scope: global
          noun: research_anomaly
          tags: [write, workflow, validation]
        behavior: crud
        crud:
          operation: insert
          table: research_anomalies
          schema: kyc
          returning: anomaly_id
        args:
          - name: action-id
            type: uuid
            required: true
            maps_to: action_id
          - name: entity-id
            type: uuid
            required: true
            maps_to: entity_id
          - name: rule-code
            type: string
            required: true
            maps_to: rule_code
          - name: severity
            type: string
            required: true
            maps_to: severity
          - name: description
            type: string
            required: true
            maps_to: description
          - name: expected-value
            type: string
            required: false
            maps_to: expected_value
          - name: actual-value
            type: string
            required: false
            maps_to: actual_value
        returns:
          type: uuid
          capture: true

      resolve-anomaly:
        description: "Resolve an anomaly"
        metadata:
          tier: intent
          source_of_truth: workflow
          scope: global
          noun: research_anomaly
          tags: [write, workflow, validation, resolution]
        behavior: crud
        crud:
          operation: update
          table: research_anomalies
          schema: kyc
        args:
          - name: anomaly-id
            type: uuid
            required: true
            maps_to: anomaly_id
          - name: status
            type: string
            required: true
            maps_to: status
          - name: resolution
            type: string
            required: false
            maps_to: resolution
        returns:
          type: affected

      # =======================================================================
      # QUERIES
      # =======================================================================

      audit-trail:
        description: "Get research audit trail for an entity including import run history"
        invocation_phrases:
          - "show audit trail"
          - "what research was done"
          - "history of decisions"
          - "how did we get this data"
          - "where did this come from"
          - "show import history"
        metadata:
          tier: diagnostics
          source_of_truth: workflow
          scope: global
          noun: research_audit
          tags: [read, query, workflow, audit-trail]
        behavior: plugin
        handler: WorkflowAuditTrailOp
        args:
          - name: entity-id
            type: uuid
            required: true
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: include-decisions
            type: boolean
            required: false
            default: true
          - name: include-actions
            type: boolean
            required: false
            default: true
          - name: include-corrections
            type: boolean
            required: false
            default: true
          - name: include-anomalies
            type: boolean
            required: false
            default: true
          - name: include-import-runs
            type: boolean
            required: false
            default: true
            description: "Include graph import run history (supersession chain)"
        returns:
          type: record

      supersession-trail:
        description: "Get the full supersession chain for a KYC case â€” import runs, corrections, stale UBO runs, reset outreach plans, stale tollgates"
        invocation_phrases:
          - "show supersession trail"
          - "what was superseded"
          - "import run rollback history"
          - "correction chain"
          - "what changed after rollback"
          - "supersession impact"
        metadata:
          tier: diagnostics
          source_of_truth: workflow
          scope: global
          noun: supersession_trail
          tags: [read, query, workflow, audit-trail, correction, supersession]
        behavior: plugin
        handler: WorkflowSupersessionTrailOp
        args:
          - name: case-id
            type: uuid
            required: true
            description: "KYC case to trace supersession chain for"
            lookup:
              table: cases
              entity_type: kyc_case
              schema: kyc
              search_key: case_id
              primary_key: case_id
        returns:
          type: record

      pending-decisions:
        description: "List decisions awaiting user input"
        metadata:
          tier: diagnostics
          source_of_truth: workflow
          scope: global
          noun: research_decision
          tags: [read, query, workflow]
        behavior: crud
        crud:
          operation: select
          table: research_decisions
          schema: kyc
        args:
          - name: source-provider
            type: string
            required: false
            maps_to: source_provider
          - name: limit
            type: integer
            required: false
            default: 50
        returns:
          type: record_set
