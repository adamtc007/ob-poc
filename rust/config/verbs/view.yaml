# View DSL Domain
#
# Semantic view operations - set session scope and selection
# These verbs manage the "it" that the session is looking at.
#
# Session = Intent Scope = Visual State = Operation Target
# One source of truth. Three expressions:
#   - Agent context: "You're looking at 12 LU equity CBUs with CUSTODY pending"
#   - DSL REPL: `@_selection = [12 UUIDs]`
#   - Visualization: 12 highlighted nodes in the taxonomy view

version: "1.0"

domains:
  view:
    description: "Semantic view operations - set session scope and selection"
    verbs:
      # =========================================================================
      # SCOPE SELECTION
      # =========================================================================

      universe:
        description: "View all CBUs with optional filters"
        invocation_phrases:
          - "show me everything"
          - "view all CBUs"
          - "show the universe"
          - "display all clients"
          - "show me all entities"
          - "view entire portfolio"
          - "show global view"
          - "display everything"
          - "see all CBUs"
          - "give me the full picture"
          - "show complete universe"
          - "view all records"
        behavior: plugin
        plugin:
          handler: ViewUniverseOp
        metadata:
          tier: intent
          source_of_truth: session
          scope: global
          noun: view_state
          tags: [navigation, universe, filtering]
        args:
          - name: client
            type: uuid
            required: false
            description: "Filter to CBUs for this client entity"
            lookup:
              table: entities
              schema: ob-poc
              entity_type: entity
              search_key: name
              primary_key: entity_id
              resolution_mode: entity
          - name: jurisdiction
            type: string_list
            required: false
            description: "Filter by jurisdiction(s)"
          - name: fund-type
            type: string_list
            required: false
            description: "Filter by fund type(s)"
          - name: status
            type: string_list
            required: false
            description: "Filter by status (RED, AMBER, GREEN)"
            valid_values:
              - RED
              - AMBER
              - GREEN
          - name: needs-attention
            type: boolean
            required: false
            description: "Filter to items needing attention"
        returns:
          type: view_state
          capture: true
          description: "Sets session view state, returns summary"

      book:
        description: "View all CBUs for a commercial client (book view)"
        invocation_phrases:
          - "show client book"
          - "view the book"
          - "display client CBUs"
          - "show me client portfolio"
          - "open the book view"
          - "view client entities"
          - "show book for client"
          - "display commercial book"
          - "see client CBUs"
          - "open client view"
          - "show all CBUs for client"
        behavior: plugin
        plugin:
          handler: ViewBookOp
        metadata:
          tier: intent
          source_of_truth: session
          scope: cbu
          noun: view_state
          tags: [navigation, book, client]
        args:
          - name: client
            type: uuid
            required: true
            description: "Commercial client entity"
            lookup:
              table: entities
              schema: ob-poc
              entity_type: entity
              search_key: name
              primary_key: entity_id
              resolution_mode: entity
        returns:
          type: view_state
          capture: true

      cbu:
        description: "Focus on a single CBU with specified view mode"
        invocation_phrases:
          - "focus on CBU"
          - "view this CBU"
          - "show CBU details"
          - "open the CBU"
          - "zoom into CBU"
          - "display CBU view"
          - "focus view on CBU"
          - "show me the CBU"
          - "select this CBU"
          - "drill into CBU"
        behavior: plugin
        plugin:
          handler: ViewCbuOp
        metadata:
          tier: intent
          source_of_truth: session
          scope: cbu
          noun: view_state
          tags: [navigation, focus, cbu]
        args:
          - name: cbu-id
            type: uuid
            required: true
            description: "CBU to focus on"
            lookup:
              table: cbus
              schema: ob-poc
              entity_type: cbu
              search_key: name
              primary_key: cbu_id
              resolution_mode: entity
          - name: mode
            type: string
            required: false
            default: "trading"
            valid_values:
              - trading # Trading network view
              - ubo # UBO ownership view
            description: "View mode for CBU focus"
        returns:
          type: view_state
          capture: true

      entity-forest:
        description: "View entities by type/ownership filters"
        invocation_phrases:
          - "show entity tree"
          - "view entity forest"
          - "display entity hierarchy"
          - "show me entities by type"
          - "view ownership forest"
          - "show entity structure"
          - "display entity relationships"
          - "see the entity tree"
          - "open entity view"
          - "show entities filtered by"
        behavior: plugin
        plugin:
          handler: ViewEntityForestOp
        metadata:
          tier: intent
          source_of_truth: session
          scope: global
          noun: view_state
          tags: [navigation, entity, filtering]
        args:
          - name: entity-type
            type: string_list
            required: false
            description: "Filter by entity types"
          - name: jurisdiction
            type: string_list
            required: false
            description: "Filter by jurisdictions"
          - name: role
            type: string_list
            required: false
            description: "Filter by roles"
        returns:
          type: view_state
          capture: true

      # =========================================================================
      # REFINEMENT
      # =========================================================================

      refine:
        description: "Refine current view with additional filter"
        invocation_phrases:
          - "filter the view"
          - "refine current selection"
          - "narrow down results"
          - "add a filter"
          - "filter by status"
          - "refine by jurisdiction"
          - "narrow the view"
          - "apply filter to view"
          - "restrict to matching"
          - "filter down to"
          - "show only matching"
        behavior: plugin
        plugin:
          handler: ViewRefineOp
        metadata:
          tier: intent
          source_of_truth: session
          scope: global
          noun: view_state
          tags: [refinement, filtering]
        args:
          - name: include
            type: object
            required: false
            description: "Filter to include (narrows selection)"
          - name: exclude
            type: object
            required: false
            description: "Filter to exclude (removes from selection)"
          - name: add
            type: uuid_list
            required: false
            description: "Specific IDs to add to selection"
          - name: remove
            type: uuid_list
            required: false
            description: "Specific IDs to remove from selection"
        returns:
          type: view_state
          capture: true

      clear:
        description: "Clear refinements, return to base view"
        invocation_phrases:
          - "clear all filters"
          - "reset the view"
          - "remove all refinements"
          - "clear current filters"
          - "start fresh"
          - "reset to base view"
          - "clear refinements"
          - "remove filters"
          - "reset filters"
          - "go back to unfiltered"
        behavior: plugin
        plugin:
          handler: ViewClearOp
        metadata:
          tier: intent
          source_of_truth: session
          scope: global
          noun: view_state
          tags: [refinement, reset]
        args: []
        returns:
          type: view_state
          capture: true

      # =========================================================================
      # SELECTION
      # =========================================================================

      select:
        description: "Explicitly set selection within current view"
        invocation_phrases:
          - "select these items"
          - "select all visible"
          - "mark as selected"
          - "select everything"
          - "clear selection"
          - "select none"
          - "choose these nodes"
          - "select current items"
          - "pick these entities"
          - "highlight selected"
        behavior: plugin
        plugin:
          handler: ViewSelectOp
        metadata:
          tier: intent
          source_of_truth: session
          scope: global
          noun: view_state
          tags: [selection]
        args:
          - name: ids
            type: uuid_list
            required: false
            description: "Explicit IDs to select"
          - name: all
            type: boolean
            required: false
            description: "Select all nodes in current view"
          - name: none
            type: boolean
            required: false
            description: "Clear selection"
        returns:
          type: view_state
          capture: true

      # =========================================================================
      # LAYOUT
      # =========================================================================

      layout:
        description: "Change layout strategy for current view"
        invocation_phrases:
          - "change layout"
          - "switch to grid view"
          - "use tree layout"
          - "show as network"
          - "arrange as pyramid"
          - "change display layout"
          - "switch visualization"
          - "use galaxy layout"
          - "arrange nodes differently"
          - "show in grid format"
          - "display as hierarchy"
        behavior: plugin
        plugin:
          handler: ViewLayoutOp
        metadata:
          tier: intent
          source_of_truth: session
          scope: global
          noun: view_state
          tags: [visualization, layout]
        args:
          - name: mode
            type: string
            required: false
            valid_values:
              - auto # Derive from taxonomy shape
              - galaxy # Semantic clustering
              - grid # Rows/columns
              - tree # Hierarchical
              - network # Force directed
              - pyramid # Ownership pyramid
            description: "Layout algorithm to use"
          - name: primary-axis
            type: string
            required: false
            valid_values:
              - jurisdiction
              - fund_type
              - status
              - manco
              - role_category
            description: "Primary grouping dimension for layout"
          - name: size-by
            type: string
            required: false
            description: "Attribute to map to node size"
          - name: color-by
            type: string
            required: false
            description: "Attribute to map to node color"
        returns:
          type: layout_result
          capture: true

      # =========================================================================
      # FRACTAL NAVIGATION - Zoom in/out through taxonomy
      # =========================================================================

      zoom-in:
        description: "Zoom into a node, expanding it into its child taxonomy"
        invocation_phrases:
          - "zoom in"
          - "zoom into this"
          - "expand this node"
          - "go deeper"
          - "dive into details"
          - "expand and zoom"
          - "zoom closer"
          - "magnify this area"
          - "zoom in for detail"
          - "get closer view"
        behavior: plugin
        plugin:
          handler: ViewZoomInOp
        metadata:
          tier: intent
          source_of_truth: session
          scope: global
          noun: view_state
          tags: [navigation, fractal, zoom]
        args:
          - name: node-id
            type: uuid
            required: true
            description: "Node to zoom into"
        returns:
          type: view_state
          capture: true
          description: "Sets session view state to child taxonomy"

      zoom-out:
        description: "Zoom out to the parent taxonomy"
        invocation_phrases:
          - "zoom out"
          - "zoom back out"
          - "see bigger picture"
          - "widen the view"
          - "expand view outward"
          - "zoom to parent"
          - "pull back view"
          - "see wider context"
          - "zoom out one level"
          - "show less detail"
        behavior: plugin
        plugin:
          handler: ViewZoomOutOp
        metadata:
          tier: intent
          source_of_truth: session
          scope: global
          noun: view_state
          tags: [navigation, fractal, zoom]
        args: []
        returns:
          type: view_state
          capture: true
          description: "Pops current frame, returns to parent view"

      back-to:
        description: "Jump back to a specific breadcrumb level"
        invocation_phrases:
          - "go back to"
          - "jump back to"
          - "return to level"
          - "back to breadcrumb"
          - "go to parent level"
          - "jump to root"
          - "return to start"
          - "back to beginning"
          - "go back several levels"
          - "return to previous"
        behavior: plugin
        plugin:
          handler: ViewBackToOp
        metadata:
          tier: intent
          source_of_truth: session
          scope: global
          noun: view_state
          tags: [navigation, fractal, breadcrumbs]
        args:
          - name: depth
            type: integer
            required: false
            description: "Breadcrumb depth (0 = root, 1 = first zoom, etc.)"
          - name: frame-id
            type: uuid
            required: false
            description: "Specific frame ID to jump to"
        returns:
          type: view_state
          capture: true
          description: "Pops frames until reaching target level"

      breadcrumbs:
        description: "Get current navigation breadcrumbs"
        invocation_phrases:
          - "show breadcrumbs"
          - "where am I"
          - "show navigation path"
          - "display current path"
          - "show my location"
          - "what level am I at"
          - "show navigation trail"
          - "display breadcrumb trail"
          - "current navigation path"
        behavior: plugin
        plugin:
          handler: ViewBreadcrumbsOp
        metadata:
          tier: intent
          source_of_truth: session
          scope: global
          noun: view_state
          tags: [navigation, fractal, breadcrumbs, introspection]
        args: []
        returns:
          type: object
          capture: true
          description: "Returns breadcrumb labels and frame IDs"

      # =========================================================================
      # INTROSPECTION
      # =========================================================================

      status:
        description: "Get current view state summary"
        invocation_phrases:
          - "show current status"
          - "what's the status"
          - "view state summary"
          - "show view status"
          - "current view state"
          - "where am I now"
          - "show session status"
          - "display current state"
        metadata:
          tier: diagnostics
          source_of_truth: operational
          scope: cbu
          noun: view
        behavior: plugin
        plugin:
          handler: ViewStatusOp
        args: []
        returns:
          type: view_state
          capture: true

      selection-info:
        description: "Get detailed info about current selection"
        invocation_phrases:
          - "show selection details"
          - "what's selected"
          - "selection summary"
          - "show selected info"
          - "details on selection"
          - "info about selected"
          - "selected items info"
          - "describe selection"
        metadata:
          tier: intent
          source_of_truth: operational
          scope: cbu
          noun: view
        behavior: plugin
        plugin:
          handler: ViewSelectionInfoOp
        args: []
        returns:
          type: selection_info
          capture: true
