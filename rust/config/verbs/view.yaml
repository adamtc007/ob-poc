# View DSL Domain
#
# Semantic view operations - set session scope and selection
# These verbs manage the "it" that the session is looking at.
#
# Session = Intent Scope = Visual State = Operation Target
# One source of truth. Three expressions:
#   - Agent context: "You're looking at 12 LU equity CBUs with CUSTODY pending"
#   - DSL REPL: `@_selection = [12 UUIDs]`
#   - Visualization: 12 highlighted nodes in the taxonomy view

version: "1.0"

domains:
  view:
    description: "Semantic view operations - set session scope and selection"
    verbs:
      # =========================================================================
      # SCOPE SELECTION
      # =========================================================================

      universe:
        description: "View all CBUs with optional filters"
        behavior: plugin
        plugin:
          handler: ViewUniverseOp
        metadata:
          tier: intent
          source_of_truth: session
          scope: global
          noun: view_state
          tags: [navigation, universe, filtering]
        args:
          - name: client
            type: uuid
            required: false
            description: "Filter to CBUs for this client entity"
            lookup:
              table: entities
              schema: ob-poc
              entity_type: entity
              search_key: name
              primary_key: entity_id
              resolution_mode: entity
          - name: jurisdiction
            type: string_list
            required: false
            description: "Filter by jurisdiction(s)"
          - name: fund-type
            type: string_list
            required: false
            description: "Filter by fund type(s)"
          - name: status
            type: string_list
            required: false
            description: "Filter by status (RED, AMBER, GREEN)"
            valid_values:
              - RED
              - AMBER
              - GREEN
          - name: needs-attention
            type: boolean
            required: false
            description: "Filter to items needing attention"
        returns:
          type: view_state
          capture: true
          description: "Sets session view state, returns summary"

      book:
        description: "View all CBUs for a commercial client (book view)"
        behavior: plugin
        plugin:
          handler: ViewBookOp
        metadata:
          tier: intent
          source_of_truth: session
          scope: cbu
          noun: view_state
          tags: [navigation, book, client]
        args:
          - name: client
            type: uuid
            required: true
            description: "Commercial client entity"
            lookup:
              table: entities
              schema: ob-poc
              entity_type: entity
              search_key: name
              primary_key: entity_id
              resolution_mode: entity
        returns:
          type: view_state
          capture: true

      cbu:
        description: "Focus on a single CBU with specified view mode"
        behavior: plugin
        plugin:
          handler: ViewCbuOp
        metadata:
          tier: intent
          source_of_truth: session
          scope: cbu
          noun: view_state
          tags: [navigation, focus, cbu]
        args:
          - name: cbu-id
            type: uuid
            required: true
            description: "CBU to focus on"
            lookup:
              table: cbus
              schema: ob-poc
              entity_type: cbu
              search_key: name
              primary_key: cbu_id
              resolution_mode: entity
          - name: mode
            type: string
            required: false
            default: "trading"
            valid_values:
              - trading # Trading network view
              - ubo # UBO ownership view
            description: "View mode for CBU focus"
        returns:
          type: view_state
          capture: true

      entity-forest:
        description: "View entities by type/ownership filters"
        behavior: plugin
        plugin:
          handler: ViewEntityForestOp
        metadata:
          tier: intent
          source_of_truth: session
          scope: global
          noun: view_state
          tags: [navigation, entity, filtering]
        args:
          - name: entity-type
            type: string_list
            required: false
            description: "Filter by entity types"
          - name: jurisdiction
            type: string_list
            required: false
            description: "Filter by jurisdictions"
          - name: role
            type: string_list
            required: false
            description: "Filter by roles"
        returns:
          type: view_state
          capture: true

      # =========================================================================
      # REFINEMENT
      # =========================================================================

      refine:
        description: "Refine current view with additional filter"
        behavior: plugin
        plugin:
          handler: ViewRefineOp
        metadata:
          tier: intent
          source_of_truth: session
          scope: global
          noun: view_state
          tags: [refinement, filtering]
        args:
          - name: include
            type: object
            required: false
            description: "Filter to include (narrows selection)"
          - name: exclude
            type: object
            required: false
            description: "Filter to exclude (removes from selection)"
          - name: add
            type: uuid_list
            required: false
            description: "Specific IDs to add to selection"
          - name: remove
            type: uuid_list
            required: false
            description: "Specific IDs to remove from selection"
        returns:
          type: view_state
          capture: true

      clear:
        description: "Clear refinements, return to base view"
        behavior: plugin
        plugin:
          handler: ViewClearOp
        metadata:
          tier: intent
          source_of_truth: session
          scope: global
          noun: view_state
          tags: [refinement, reset]
        args: []
        returns:
          type: view_state
          capture: true

      # =========================================================================
      # SELECTION
      # =========================================================================

      select:
        description: "Explicitly set selection within current view"
        behavior: plugin
        plugin:
          handler: ViewSelectOp
        metadata:
          tier: intent
          source_of_truth: session
          scope: global
          noun: view_state
          tags: [selection]
        args:
          - name: ids
            type: uuid_list
            required: false
            description: "Explicit IDs to select"
          - name: all
            type: boolean
            required: false
            description: "Select all nodes in current view"
          - name: none
            type: boolean
            required: false
            description: "Clear selection"
        returns:
          type: view_state
          capture: true

      # =========================================================================
      # LAYOUT
      # =========================================================================

      layout:
        description: "Change layout strategy for current view"
        behavior: plugin
        plugin:
          handler: ViewLayoutOp
        metadata:
          tier: intent
          source_of_truth: session
          scope: global
          noun: view_state
          tags: [visualization, layout]
        args:
          - name: mode
            type: string
            required: false
            valid_values:
              - auto # Derive from taxonomy shape
              - galaxy # Semantic clustering
              - grid # Rows/columns
              - tree # Hierarchical
              - network # Force directed
              - pyramid # Ownership pyramid
            description: "Layout algorithm to use"
          - name: primary-axis
            type: string
            required: false
            valid_values:
              - jurisdiction
              - fund_type
              - status
              - manco
              - role_category
            description: "Primary grouping dimension for layout"
          - name: size-by
            type: string
            required: false
            description: "Attribute to map to node size"
          - name: color-by
            type: string
            required: false
            description: "Attribute to map to node color"
        returns:
          type: layout_result
          capture: true

      # =========================================================================
      # FRACTAL NAVIGATION - Zoom in/out through taxonomy
      # =========================================================================

      zoom-in:
        description: "Zoom into a node, expanding it into its child taxonomy"
        behavior: plugin
        plugin:
          handler: ViewZoomInOp
        metadata:
          tier: intent
          source_of_truth: session
          scope: global
          noun: view_state
          tags: [navigation, fractal, zoom]
        args:
          - name: node-id
            type: uuid
            required: true
            description: "Node to zoom into"
        returns:
          type: view_state
          capture: true
          description: "Sets session view state to child taxonomy"

      zoom-out:
        description: "Zoom out to the parent taxonomy"
        behavior: plugin
        plugin:
          handler: ViewZoomOutOp
        metadata:
          tier: intent
          source_of_truth: session
          scope: global
          noun: view_state
          tags: [navigation, fractal, zoom]
        args: []
        returns:
          type: view_state
          capture: true
          description: "Pops current frame, returns to parent view"

      back-to:
        description: "Jump back to a specific breadcrumb level"
        behavior: plugin
        plugin:
          handler: ViewBackToOp
        metadata:
          tier: intent
          source_of_truth: session
          scope: global
          noun: view_state
          tags: [navigation, fractal, breadcrumbs]
        args:
          - name: depth
            type: integer
            required: false
            description: "Breadcrumb depth (0 = root, 1 = first zoom, etc.)"
          - name: frame-id
            type: uuid
            required: false
            description: "Specific frame ID to jump to"
        returns:
          type: view_state
          capture: true
          description: "Pops frames until reaching target level"

      breadcrumbs:
        description: "Get current navigation breadcrumbs"
        behavior: plugin
        plugin:
          handler: ViewBreadcrumbsOp
        metadata:
          tier: intent
          source_of_truth: session
          scope: global
          noun: view_state
          tags: [navigation, fractal, breadcrumbs, introspection]
        args: []
        returns:
          type: object
          capture: true
          description: "Returns breadcrumb labels and frame IDs"

      # =========================================================================
      # ESPER NAVIGATION - Phase 1 (Core Navigation)
      # =========================================================================

      drill:
        description: "Drill into an entity, showing subsidiaries or parent chain"
        behavior: plugin
        plugin:
          handler: ViewDrillOp
        metadata:
          tier: intent
          source_of_truth: session
          scope: global
          noun: view_state
          tags: [navigation, esper, drill]
        args:
          - name: entity-id
            type: uuid
            required: true
            description: "Entity to drill into"
            lookup:
              table: entities
              schema: ob-poc
              entity_type: entity
              search_key: name
              primary_key: entity_id
              resolution_mode: entity
          - name: direction
            type: string
            required: false
            default: "down"
            valid_values:
              - down # Into subsidiaries/children
              - up # Into parents/owners
            description: "Drill direction"
          - name: depth
            type: integer
            required: false
            default: 1
            description: "How many levels to drill"
        returns:
          type: view_state
          capture: true
          description: "Updates view to show drilled entity and its relationships"

      surface:
        description: "Surface up from current drill (pop navigation stack)"
        behavior: plugin
        plugin:
          handler: ViewSurfaceOp
        metadata:
          tier: intent
          source_of_truth: session
          scope: global
          noun: view_state
          tags: [navigation, esper, drill]
        args:
          - name: levels
            type: integer
            required: false
            default: 1
            description: "How many levels to surface (or 'all' for universe)"
          - name: to-universe
            type: boolean
            required: false
            default: false
            description: "Surface all the way to universe view"
        returns:
          type: view_state
          capture: true
          description: "Returns to previous navigation level"

      trace:
        description: "Follow money, control, or risk threads from an entity"
        behavior: plugin
        plugin:
          handler: ViewTraceOp
        metadata:
          tier: intent
          source_of_truth: session
          scope: global
          noun: view_state
          tags: [navigation, esper, trace]
        args:
          - name: mode
            type: string
            required: true
            valid_values:
              - money # Follow financial flows
              - control # Follow control relationships
              - risk # Follow risk indicators
              - documents # Follow document chains
              - alerts # Follow alert threads
            description: "What to trace"
          - name: from-entity
            type: uuid
            required: false
            description: "Entity to trace from (defaults to current focus)"
            lookup:
              table: entities
              schema: ob-poc
              entity_type: entity
              search_key: name
              primary_key: entity_id
              resolution_mode: entity
          - name: depth
            type: integer
            required: false
            default: 5
            description: "Maximum trace depth"
        returns:
          type: view_state
          capture: true
          description: "Highlights trace path in current view"

      xray:
        description: "Show hidden layers transparently (see through structure)"
        behavior: plugin
        plugin:
          handler: ViewXrayOp
        metadata:
          tier: intent
          source_of_truth: session
          scope: global
          noun: view_state
          tags: [visualization, esper, transparency]
        args:
          - name: layers
            type: string_list
            required: false
            description: "Which layers to make transparent"
            valid_values:
              - custody
              - ubo
              - services
              - documents
              - screenings
          - name: off
            type: boolean
            required: false
            default: false
            description: "Turn off x-ray mode"
        returns:
          type: view_state
          capture: true
          description: "Toggles layer transparency"

      peel:
        description: "Remove outer layer to reveal inner structure"
        behavior: plugin
        plugin:
          handler: ViewPeelOp
        metadata:
          tier: intent
          source_of_truth: session
          scope: global
          noun: view_state
          tags: [visualization, esper, layers]
        args:
          - name: layer
            type: string
            required: false
            description: "Specific layer to peel"
          - name: reset
            type: boolean
            required: false
            default: false
            description: "Restore all peeled layers"
        returns:
          type: view_state
          capture: true
          description: "Updates view with peeled layer hidden"

      illuminate:
        description: "Highlight a specific aspect across all visible entities"
        behavior: plugin
        plugin:
          handler: ViewIlluminateOp
        metadata:
          tier: intent
          source_of_truth: session
          scope: global
          noun: view_state
          tags: [visualization, esper, highlighting]
        args:
          - name: aspect
            type: string
            required: true
            valid_values:
              - risks # Highlight risk indicators
              - documents # Highlight document status
              - screenings # Highlight screening results
              - gaps # Highlight data gaps
              - pending # Highlight pending items
            description: "What aspect to illuminate"
          - name: off
            type: boolean
            required: false
            default: false
            description: "Turn off illumination"
        returns:
          type: view_state
          capture: true
          description: "Applies visual highlighting"

      # =========================================================================
      # ESPER NAVIGATION - Phase 1 (Risk Highlighting)
      # =========================================================================

      shadow:
        description: "Dim non-risk items to emphasize risk (shadow mode)"
        behavior: plugin
        plugin:
          handler: ViewShadowOp
        metadata:
          tier: intent
          source_of_truth: session
          scope: global
          noun: view_state
          tags: [visualization, esper, risk, highlighting]
        args:
          - name: threshold
            type: string
            required: false
            default: "any"
            valid_values:
              - high # Only high risk highlighted
              - medium # Medium and high risk highlighted
              - any # Any risk level highlighted
            description: "Risk threshold for highlighting"
          - name: off
            type: boolean
            required: false
            default: false
            description: "Turn off shadow mode"
        returns:
          type: view_state
          capture: true
          description: "Toggles shadow mode"

      red-flag:
        description: "Scan and highlight red flags"
        behavior: plugin
        plugin:
          handler: ViewRedFlagOp
        args:
          - name: category
            type: string
            required: false
            valid_values:
              - pep # PEP flags
              - sanctions # Sanctions flags
              - adverse-media # Adverse media flags
              - all # All flag types
            description: "Category of red flags to scan"
          - name: off
            type: boolean
            required: false
            default: false
            description: "Turn off red flag scan"
        returns:
          type: view_state
          capture: true
          description: "Highlights red flags in current view"

      black-holes:
        description: "Show data gaps as 'black holes'"
        behavior: plugin
        plugin:
          handler: ViewBlackHolesOp
        args:
          - name: type
            type: string
            required: false
            valid_values:
              - ownership # Missing ownership data
              - documents # Missing documents
              - screening # Missing screenings
              - all # All gap types
            description: "Type of gaps to highlight"
          - name: off
            type: boolean
            required: false
            default: false
            description: "Turn off black hole mode"
        returns:
          type: view_state
          capture: true
          description: "Highlights data gaps"

      # =========================================================================
      # ESPER NAVIGATION - Phase 1 (Detail & Context)
      # =========================================================================

      detail:
        description: "Change detail level for current focus"
        behavior: plugin
        plugin:
          handler: ViewDetailOp
        args:
          - name: level
            type: string
            required: true
            valid_values:
              - graph # Normal graph view
              - attributes # Expanded attribute cards
              - raw # JSON/raw data view
            description: "Detail level to set"
        returns:
          type: view_state
          capture: true
          description: "Changes detail level"

      context:
        description: "Set UI context mode (changes workflow adaptation)"
        behavior: plugin
        plugin:
          handler: ViewContextOp
        args:
          - name: mode
            type: string
            required: true
            valid_values:
              - onboarding # New client onboarding
              - review # Periodic review
              - investigation # Investigation/deep dive
              - monitoring # Ongoing monitoring
              - remediation # Remediation workflow
            description: "Context mode to set"
        returns:
          type: view_state
          capture: true
          description: "Changes context mode"

      # =========================================================================
      # INTROSPECTION
      # =========================================================================

      status:
        description: "Get current view state summary"
        behavior: plugin
        plugin:
          handler: ViewStatusOp
        args: []
        returns:
          type: view_state
          capture: true

      selection-info:
        description: "Get detailed info about current selection"
        behavior: plugin
        plugin:
          handler: ViewSelectionInfoOp
        args: []
        returns:
          type: selection_info
          capture: true
