domains:
  trading-profile:
    description: "Trading profile document management - single source of truth for CBU trading configuration"
    verbs:
      import:
        description: Import a trading profile document from YAML/JSON file or inline content
        behavior: plugin
        handler: import_trading_profile
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: file-path
            type: string
            required: false
            description: Path to YAML/JSON file containing the trading profile
          - name: document
            type: json
            required: false
            description: Inline JSON document (alternative to file-path)
          - name: version
            type: integer
            required: false
            default: 1
            description: Version number for the profile
          - name: status
            type: string
            required: false
            default: DRAFT
            valid_values:
              - DRAFT
              - PENDING_REVIEW
              - ACTIVE
          - name: notes
            type: string
            required: false
            description: Import notes
        returns:
          type: uuid
          name: profile_id
          capture: true

      read:
        description: Read a trading profile by ID
        behavior: crud
        crud:
          operation: select
          table: cbu_trading_profiles
          schema: ob-poc
        args:
          - name: profile-id
            type: uuid
            required: true
            maps_to: profile_id
        returns:
          type: record

      get-active:
        description: Get the active trading profile for a CBU
        behavior: plugin
        handler: get_active_trading_profile
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
        returns:
          type: record

      list-versions:
        description: List all versions of trading profiles for a CBU
        behavior: crud
        crud:
          operation: list_by_fk
          table: cbu_trading_profiles
          schema: ob-poc
          fk_col: cbu_id
          order_by: version DESC
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
        returns:
          type: record_set

      activate:
        description: Activate a trading profile (sets status to ACTIVE, supersedes previous active)
        behavior: plugin
        handler: activate_trading_profile
        args:
          - name: profile-id
            type: uuid
            required: true
            description: The profile to activate
          - name: activated-by
            type: string
            required: false
            description: User who activated the profile
        returns:
          type: record

      materialize:
        description: Materialize trading profile to operational tables (universe, SSIs, booking rules)
        behavior: plugin
        handler: materialize_trading_profile
        lifecycle:
          writes_tables:
            - custody.cbu_instrument_universe
            - custody.cbu_ssi
            - custody.ssi_booking_rules
            - custody.isda_agreements
            - custody.csa_agreements
        args:
          - name: profile-id
            type: uuid
            required: true
            description: The profile to materialize
          - name: sections
            type: string_list
            required: false
            description: "Sections to materialize (default: all). Options: universe, ssis, booking_rules, isda, subcustodians"
          - name: dry-run
            type: boolean
            required: false
            default: false
            description: If true, show what would be created without actually creating
          - name: force
            type: boolean
            required: false
            default: false
            description: If true, overwrite existing records instead of skipping
        returns:
          type: record
          description: Materialization result with counts of records created/updated/deleted

      validate:
        description: Validate a trading profile document without importing
        behavior: plugin
        handler: validate_trading_profile
        args:
          - name: file-path
            type: string
            required: false
            description: Path to YAML/JSON file
          - name: document
            type: json
            required: false
            description: Inline JSON document
        returns:
          type: record
          description: Validation result with any errors or warnings

      diff:
        description: Compare two trading profile versions
        behavior: plugin
        handler: diff_trading_profiles
        args:
          - name: profile-id-1
            type: uuid
            required: true
            description: First profile to compare
          - name: profile-id-2
            type: uuid
            required: true
            description: Second profile to compare
        returns:
          type: record
          description: Diff result showing additions, removals, and changes

      export:
        description: Export a trading profile to YAML format
        behavior: plugin
        handler: export_trading_profile
        args:
          - name: profile-id
            type: uuid
            required: true
          - name: output-path
            type: string
            required: false
            description: Path to write output (if omitted, returns content)
        returns:
          type: record

      # =========================================================================
      # FULL MATRIX EXPORT (Phase 4)
      # =========================================================================

      export-full-matrix:
        description: Export complete trading matrix document with all configuration sections
        behavior: plugin
        handler: export_full_trading_matrix
        lifecycle:
          reads_tables:
            - custody.cbu_instrument_universe
            - custody.cbu_ssi
            - custody.ssi_booking_rules
            - custody.cbu_instruction_assignments
            - custody.cbu_gateway_routing
            - custody.cbu_ca_preferences
            - custody.cbu_pricing_configs
            - custody.cbu_withholding_profiles
            - custody.cbu_settlement_chains
            - custody.cbu_tax_status
            - custody.isda_agreements
            - custody.csa_agreements
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: format
            type: string
            required: false
            default: YAML
            valid_values:
              - YAML
              - JSON
              - PDF
          - name: sections
            type: string_list
            required: false
            description: "Sections to include (default: all)"
            default:
              - universe
              - instruction_profile
              - gateway_routing
              - ssis
              - booking_rules
              - corporate_actions
              - pricing
              - settlement
              - tax
              - isda
          - name: include-gaps
            type: boolean
            required: false
            default: true
            description: Include gap analysis results in export
          - name: include-dependencies
            type: boolean
            required: false
            default: true
            description: Include resource dependency graph
          - name: as-of-date
            type: date
            required: false
            description: "Point-in-time export (default: now)"
        returns:
          type: record
          description: "{ document: string, format: string, sections: [...], gaps: [...] }"

      export-instruction-section:
        description: Export instruction profile section only
        behavior: plugin
        handler: export_instruction_profile_section
        lifecycle:
          reads_tables:
            - custody.cbu_instruction_assignments
            - custody.cbu_instruction_field_overrides
            - custody.instruction_templates
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: format
            type: string
            required: false
            default: YAML
            valid_values:
              - YAML
              - JSON
        returns:
          type: record

      export-gateway-section:
        description: Export gateway routing section only
        behavior: plugin
        handler: export_gateway_section
        lifecycle:
          reads_tables:
            - custody.cbu_gateway_connectivity
            - custody.cbu_gateway_routing
            - custody.cbu_gateway_fallbacks
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: format
            type: string
            required: false
            default: YAML
            valid_values:
              - YAML
              - JSON
        returns:
          type: record

      export-settlement-section:
        description: Export settlement configuration section only
        behavior: plugin
        handler: export_settlement_section
        lifecycle:
          reads_tables:
            - custody.cbu_ssi
            - custody.ssi_booking_rules
            - custody.cbu_settlement_chains
            - custody.settlement_chain_hops
            - custody.cbu_cross_border_config
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: format
            type: string
            required: false
            default: YAML
            valid_values:
              - YAML
              - JSON
        returns:
          type: record

      export-pricing-section:
        description: Export pricing configuration section only
        behavior: plugin
        handler: export_pricing_section
        lifecycle:
          reads_tables:
            - custody.cbu_pricing_configs
            - custody.cbu_valuation_schedule
            - custody.cbu_pricing_fallback_chains
            - custody.cbu_stale_price_policies
            - custody.cbu_nav_impact_thresholds
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: format
            type: string
            required: false
            default: YAML
            valid_values:
              - YAML
              - JSON
        returns:
          type: record

      export-tax-section:
        description: Export tax configuration section only
        behavior: plugin
        handler: export_tax_section
        lifecycle:
          reads_tables:
            - custody.cbu_tax_status
            - custody.cbu_tax_reclaim_config
            - custody.cbu_tax_reporting
            - custody.tax_treaty_rates
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: format
            type: string
            required: false
            default: YAML
            valid_values:
              - YAML
              - JSON
        returns:
          type: record

      export-corporate-actions-section:
        description: Export corporate actions configuration section only
        behavior: plugin
        handler: export_corporate_actions_section
        lifecycle:
          reads_tables:
            - custody.cbu_ca_preferences
            - custody.cbu_ca_instruction_windows
            - custody.cbu_ca_ssi_mappings
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: format
            type: string
            required: false
            default: YAML
            valid_values:
              - YAML
              - JSON
        returns:
          type: record

      # =========================================================================
      # VALIDATION & GAP ANALYSIS (Phase 4)
      # =========================================================================

      validate-matrix-completeness:
        description: Validate entire trading matrix is complete for go-live
        behavior: plugin
        handler: validate_trading_matrix_completeness
        lifecycle:
          reads_tables:
            - custody.cbu_instrument_universe
            - custody.cbu_ssi
            - custody.ssi_booking_rules
            - custody.cbu_instruction_assignments
            - custody.cbu_gateway_routing
            - custody.cbu_pricing_configs
            - custody.cbu_withholding_profiles
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: validation-level
            type: string
            required: false
            default: STRICT
            valid_values:
              - STRICT
              - STANDARD
              - PERMISSIVE
            description: "STRICT=all gaps are errors, STANDARD=critical gaps are errors, PERMISSIVE=all gaps are warnings"
        returns:
          type: record
          description: "{ ready_for_golive: bool, critical_gaps: [...], warnings: [...], coverage_summary: {...} }"

      generate-gap-remediation-plan:
        description: Generate DSL plan to remediate matrix gaps
        behavior: plugin
        handler: generate_matrix_remediation_plan
        lifecycle:
          reads_tables:
            - custody.cbu_instrument_universe
            - custody.cbu_ssi
            - custody.ssi_booking_rules
            - custody.cbu_instruction_assignments
            - custody.cbu_gateway_routing
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: priority
            type: string
            required: false
            default: CRITICAL_FIRST
            valid_values:
              - CRITICAL_FIRST
              - BY_SECTION
              - DEPENDENCY_ORDER
            description: Order in which to generate remediation steps
        returns:
          type: record
          description: "{ dsl_statements: [...], pending_inputs: [...], estimated_effort: string }"
