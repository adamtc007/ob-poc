domains:
  trading-profile:
    description: "Trading profile document management - single source of truth for CBU trading configuration"
    invocation_hints:
      - trading profile
      - trading setup
      - trading configuration
      - ISDA
      - CSA
      - counterparty
      - instruments
      - markets
    verbs:
      import:
        description: Import a trading profile document from YAML/JSON file or inline content
        behavior: plugin
        handler: import_trading_profile
        metadata:
          tier: intent
          source_of_truth: matrix
          scope: cbu
          noun: trading_matrix
          tags: [lifecycle, authoring]
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: file-path
            type: string
            required: false
            description: Path to YAML/JSON file containing the trading profile
          - name: document
            type: json
            required: false
            description: Inline JSON document (alternative to file-path)
          - name: version
            type: integer
            required: false
            default: 1
            description: Version number for the profile
          - name: status
            type: string
            required: false
            default: DRAFT
            valid_values:
              - DRAFT
              - VALIDATED
              - PENDING_REVIEW
              - ACTIVE
              - SUPERSEDED
              - ARCHIVED
          - name: notes
            type: string
            required: false
            description: Import notes
        returns:
          type: uuid
          name: profile_id
          capture: true

      read:
        description: Read a trading profile by ID
        behavior: crud
        metadata:
          tier: diagnostics
          source_of_truth: matrix
          scope: cbu
          noun: trading_matrix
          tags: [read]
        crud:
          operation: select
          table: cbu_trading_profiles
          schema: ob-poc
        args:
          - name: profile-id
            type: uuid
            required: true
            maps_to: profile_id
        returns:
          type: record

      get-active:
        description: Get the active trading profile for a CBU
        behavior: plugin
        handler: get_active_trading_profile
        metadata:
          tier: diagnostics
          source_of_truth: matrix
          scope: cbu
          noun: trading_matrix
          tags: [read, lookup]
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
        returns:
          type: record

      list-versions:
        description: List all versions of trading profiles for a CBU
        behavior: crud
        metadata:
          tier: diagnostics
          source_of_truth: matrix
          scope: cbu
          noun: trading_matrix
          tags: [read, versioning]
        crud:
          operation: list_by_fk
          table: cbu_trading_profiles
          schema: ob-poc
          fk_col: cbu_id
          order_by: version DESC
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
        returns:
          type: record_set

      activate:
        description: Activate a trading profile (sets status to ACTIVE, supersedes previous active)
        behavior: plugin
        handler: activate_trading_profile
        metadata:
          tier: intent
          source_of_truth: matrix
          scope: cbu
          noun: trading_matrix
          tags: [lifecycle, activation]
        args:
          - name: profile-id
            type: uuid
            required: true
            description: The profile to activate
          - name: activated-by
            type: string
            required: false
            description: User who activated the profile
        returns:
          type: record

      materialize:
        description: Materialize trading profile to operational tables (universe, SSIs, booking rules)
        behavior: plugin
        handler: materialize_trading_profile
        metadata:
          tier: composite
          source_of_truth: matrix
          scope: cbu
          writes_operational: true
          noun: trading_matrix
          tags: [projection, sync, critical]
        lifecycle:
          writes_tables:
            - custody.cbu_instrument_universe
            - custody.cbu_ssi
            - custody.ssi_booking_rules
            - custody.isda_agreements
            - custody.csa_agreements
        args:
          - name: profile-id
            type: uuid
            required: true
            description: The profile to materialize
          - name: sections
            type: string_list
            required: false
            description: "Sections to materialize (default: all). Options: universe, ssis, booking_rules, isda, subcustodians"
          - name: dry-run
            type: boolean
            required: false
            default: false
            description: If true, show what would be created without actually creating
          - name: force
            type: boolean
            required: false
            default: false
            description: If true, overwrite existing records instead of skipping
        returns:
          type: record
          description: Materialization result with counts of records created/updated/deleted

      diff:
        description: Compare two trading profile versions
        behavior: plugin
        handler: diff_trading_profiles
        metadata:
          tier: diagnostics
          source_of_truth: matrix
          scope: cbu
          noun: trading_matrix
          tags: [read, versioning, comparison]
        args:
          - name: profile-id-1
            type: uuid
            required: true
            description: First profile to compare
          - name: profile-id-2
            type: uuid
            required: true
            description: Second profile to compare
        returns:
          type: record
          description: Diff result showing additions, removals, and changes

      # =========================================================================
      # DOCUMENT CONSTRUCTION VERBS
      # These verbs modify the JSONB document directly (source of truth)
      # =========================================================================

      create-draft:
        description: Create a new draft trading profile for a CBU (use clone-to to copy from existing)
        behavior: plugin
        handler: create_draft_trading_profile
        metadata:
          tier: intent
          source_of_truth: matrix
          scope: cbu
          noun: trading_matrix
          tags: [lifecycle, authoring]
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: notes
            type: string
            required: false
            description: Notes about this draft
        returns:
          type: uuid
          name: profile_id
          capture: true

      clone-to:
        description: Clone a trading profile to another CBU, creating a new DRAFT profile
        behavior: plugin
        handler: clone_trading_profile_to_cbu
        metadata:
          tier: intent
          source_of_truth: matrix
          scope: cbu
          noun: trading_matrix
          tags: [lifecycle, authoring, cloning]
        args:
          - name: profile-id
            type: uuid
            required: true
            description: Source profile to clone from
          - name: target-cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
            description: Target CBU to clone the profile to
          - name: cloned-by
            type: string
            required: false
            description: User or system that performed the clone
          - name: adapt-base-currency
            type: string
            required: false
            description: Optionally change the base currency in the cloned profile
          - name: include-isda
            type: boolean
            required: false
            default: true
            description: Include ISDA agreements (may need counterparty adjustment)
          - name: notes
            type: string
            required: false
            description: Notes about the cloned profile
        returns:
          type: uuid
          name: profile_id
          capture: true

      create-new-version:
        description: Create a new draft version from the current ACTIVE profile. Used when modifying a live trading matrix.
        behavior: plugin
        handler: create_new_version_trading_profile
        metadata:
          tier: intent
          source_of_truth: matrix
          scope: cbu
          noun: trading_matrix
          tags: [lifecycle, authoring, versioning]
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
            description: CBU to create new version for (must have an ACTIVE profile)
          - name: created-by
            type: string
            required: false
            description: User or system creating the new version
          - name: notes
            type: string
            required: false
            description: Notes about why a new version is being created
        returns:
          type: uuid
          name: profile_id
          capture: true
          description: The new DRAFT profile ID (version = previous + 1)

      # --- Universe Section ---

      add-instrument-class:
        description: Add instrument class to trading profile universe
        behavior: plugin
        handler: add_instrument_class_to_profile
        invocation_phrases:
          - add instruments
          - add instrument class
          - enable trading
          - add to universe
          - add equities
          - add bonds
          - add derivatives
        metadata:
          tier: intent
          source_of_truth: matrix
          scope: cbu
          noun: universe
          tags: [authoring, universe]
        args:
          - name: profile-id
            type: uuid
            required: true
          - name: class-code
            type: string
            required: true
            description: "Instrument class code (EQUITY, FIXED_INCOME, IRS, FX_FORWARD, etc.)"
          - name: cfi-prefixes
            type: string_list
            required: false
            description: CFI code prefixes for matching
          - name: isda-asset-classes
            type: string_list
            required: false
            description: ISDA taxonomy codes if OTC (RATES, CREDIT, FX, EQUITY, COMMODITY)
          - name: is-held
            type: boolean
            required: false
            default: true
            description: Whether positions are held
          - name: is-traded
            type: boolean
            required: false
            default: true
            description: Whether actively traded
        returns:
          type: record
          description: Updated universe section

      remove-instrument-class:
        description: Remove instrument class from trading profile universe
        behavior: plugin
        handler: remove_instrument_class_from_profile
        metadata:
          tier: intent
          source_of_truth: matrix
          scope: cbu
          noun: universe
          tags: [authoring, universe]
        args:
          - name: profile-id
            type: uuid
            required: true
          - name: class-code
            type: string
            required: true
        returns:
          type: affected

      add-market:
        description: Add market to trading profile universe under an instrument class
        behavior: plugin
        handler: add_market_to_profile
        invocation_phrases:
          - add market
          - add exchange
          - add NYSE
          - add LSE
          - enable market
          - trade on
        metadata:
          tier: intent
          source_of_truth: matrix
          scope: cbu
          noun: universe
          tags: [authoring, universe, market]
        args:
          - name: profile-id
            type: uuid
            required: true
          - name: instrument-class
            type: string
            required: true
            description: "Parent instrument class code (e.g., EQUITY, GOVT_BOND)"
          - name: mic
            type: string
            required: true
            description: "Market Identifier Code (ISO 10383), e.g., XNYS, XLON"
          - name: market-name
            type: string
            required: false
            description: "Human-readable market name (looked up from reference data if not provided)"
          - name: country-code
            type: string
            required: false
            description: "ISO 2-letter country code (looked up from reference data if not provided)"
        returns:
          type: record
          description: Updated document version and status

      remove-market:
        description: Remove market from trading profile universe
        behavior: plugin
        handler: remove_market_from_profile
        metadata:
          tier: intent
          source_of_truth: matrix
          scope: cbu
          noun: universe
          tags: [authoring, universe, market]
        args:
          - name: profile-id
            type: uuid
            required: true
          - name: instrument-class
            type: string
            required: true
            description: "Parent instrument class code (e.g., EQUITY)"
          - name: mic
            type: string
            required: true
            description: "Market MIC code to remove"
        returns:
          type: record
          description: "Removed market info with version"

      set-base-currency:
        description: Set base currency for trading profile
        behavior: plugin
        handler: set_profile_base_currency
        metadata:
          tier: intent
          source_of_truth: matrix
          scope: cbu
          noun: trading_matrix
          tags: [authoring, currency]
        args:
          - name: profile-id
            type: uuid
            required: true
          - name: currency
            type: string
            required: true
        returns:
          type: affected

      add-allowed-currency:
        description: Add currency to allowed currencies list
        behavior: plugin
        handler: add_allowed_currency_to_profile
        metadata:
          tier: intent
          source_of_truth: matrix
          scope: cbu
          noun: trading_matrix
          tags: [authoring, currency]
        args:
          - name: profile-id
            type: uuid
            required: true
          - name: currency
            type: string
            required: true
        returns:
          type: affected

      # --- Standing Instructions Section ---

      add-standing-instruction:
        description: Add SSI to trading profile standing instructions
        behavior: plugin
        handler: add_ssi_to_profile
        metadata:
          tier: intent
          source_of_truth: matrix
          scope: cbu
          noun: ssi
          tags: [authoring, ssi]
        args:
          - name: profile-id
            type: uuid
            required: true
          - name: ssi-type
            type: string
            required: true
            valid_values: [SECURITIES, CASH, OTC_COLLATERAL, FUND_ACCOUNTING]
            description: "SSI type (category)"
          - name: ssi-name
            type: string
            required: true
            description: "Unique SSI name (will be prefixed with type to create ssi-id)"
          - name: safekeeping-account
            type: string
            required: false
            description: "Securities safekeeping account number"
          - name: safekeeping-bic
            type: string
            required: false
            description: "Securities custodian BIC"
          - name: cash-account
            type: string
            required: false
            description: "Cash account number"
          - name: cash-bic
            type: string
            required: false
            description: "Cash correspondent BIC"
          - name: cash-currency
            type: string
            required: false
            description: "Settlement currency (ISO 4217)"
          - name: pset-bic
            type: string
            required: false
            description: "Place of settlement BIC (CSD/ICSD)"
        returns:
          type: record

      remove-standing-instruction:
        description: Remove SSI from trading profile
        behavior: plugin
        handler: remove_ssi_from_profile
        metadata:
          tier: intent
          source_of_truth: matrix
          scope: cbu
          noun: ssi
          tags: [authoring, ssi]
        args:
          - name: profile-id
            type: uuid
            required: true
          - name: ssi-name
            type: string
            required: true
            description: "SSI name to remove"
        returns:
          type: record
          description: "Removed SSI info with version"

      # --- Booking Rules Section ---

      add-booking-rule:
        description: Add ALERT-style booking rule to trading profile
        behavior: plugin
        handler: add_booking_rule_to_profile
        metadata:
          tier: intent
          source_of_truth: matrix
          scope: cbu
          noun: booking_rule
          tags: [authoring, booking-rules]
        args:
          - name: profile-id
            type: uuid
            required: true
          - name: rule-name
            type: string
            required: true
            description: "Unique rule name (combined with ssi-ref to create rule-id)"
          - name: priority
            type: integer
            required: true
            description: "Lower priority = evaluated first"
          - name: ssi-ref
            type: string
            required: true
            description: "Reference to SSI name in standing_instructions"
          - name: match-instrument-class
            type: string
            required: false
            description: "Instrument class to match (e.g., EQUITY, GOVT_BOND)"
          - name: match-security-type
            type: string
            required: false
            description: "Security type to match"
          - name: match-mic
            type: string
            required: false
            description: "Market MIC to match"
          - name: match-currency
            type: string
            required: false
            description: "Currency to match"
          - name: match-settlement-type
            type: string
            required: false
            description: "Settlement type to match (DVP, FOP, RVP)"
          - name: match-counterparty-id
            type: string
            required: false
            description: "Counterparty entity ID for OTC matching"
        returns:
          type: record

      remove-booking-rule:
        description: Remove booking rule from trading profile
        behavior: plugin
        handler: remove_booking_rule_from_profile
        metadata:
          tier: intent
          source_of_truth: matrix
          scope: cbu
          noun: booking_rule
          tags: [authoring, booking-rules]
        args:
          - name: profile-id
            type: uuid
            required: true
          - name: ssi-ref
            type: string
            required: true
            description: "Parent SSI name that contains this booking rule"
          - name: rule-id
            type: string
            required: true
            description: "Booking rule ID to remove"
        returns:
          type: record
          description: "Removed booking rule info with version"

      # --- ISDA/CSA Section ---

      add-isda-config:
        description: Add ISDA master agreement to trading profile
        behavior: plugin
        handler: add_isda_config_to_profile
        invocation_phrases:
          - add ISDA
          - establish ISDA
          - create ISDA
          - set up ISDA
          - add counterparty
          - add counterparty for derivatives
        metadata:
          tier: intent
          source_of_truth: matrix
          scope: cbu
          noun: isda
          tags: [authoring, isda, otc]
        args:
          - name: profile-id
            type: uuid
            required: true
            description: "Trading profile ID"
          - name: counterparty-entity-id
            type: string
            required: true
            description: "Counterparty entity UUID"
          - name: counterparty-name
            type: string
            required: true
            description: "Counterparty display name"
          - name: counterparty-lei
            type: string
            required: false
            description: "Counterparty LEI (optional)"
          - name: governing-law
            type: string
            required: false
            valid_values: [NY, ENGLISH]
            description: "Governing law jurisdiction"
          - name: agreement-date
            type: string
            required: false
            description: "Agreement date (YYYY-MM-DD)"
        returns:
          type: record
          description: Created ISDA config with isda_id

      add-isda-coverage:
        description: Add product coverage to ISDA config
        behavior: plugin
        handler: TradingProfileAddIsdaCoverageOp
        metadata:
          tier: intent
          source_of_truth: matrix
          scope: cbu
          noun: isda
          tags: [authoring, isda, otc]
        args:
          - name: profile-id
            type: uuid
            required: true
            description: "Trading profile ID"
          - name: isda-ref
            type: string
            required: true
            description: "ISDA counterparty name or ID to add coverage to"
          - name: asset-class
            type: string
            required: true
            description: "ISDA asset class (RATES, CREDIT, FX, EQUITY, COMMODITY)"
          - name: base-products
            type: string_list
            required: false
            description: "Specific products (IRS, CDS, FX_FORWARD, etc.)"
        returns:
          type: record
          description: Created product coverage with coverage_id

      add-csa-config:
        description: Add CSA (Credit Support Annex) to ISDA agreement
        behavior: plugin
        handler: add_csa_config_to_profile
        invocation_phrases:
          - add CSA
          - add credit support annex
          - add VM CSA
          - add IM CSA
          - add collateral agreement
        metadata:
          tier: intent
          source_of_truth: matrix
          scope: cbu
          noun: csa
          tags: [authoring, csa, otc, collateral]
        args:
          - name: profile-id
            type: uuid
            required: true
            description: "Trading profile ID"
          - name: isda-ref
            type: string
            required: true
            description: "ISDA counterparty name or ID to add CSA to"
          - name: csa-type
            type: string
            required: true
            valid_values: [VM, VM_IM, IM]
            description: "CSA type (VM=Variation Margin, IM=Initial Margin)"
          - name: threshold-currency
            type: string
            required: false
            description: "Threshold currency (ISO 4217)"
          - name: threshold-amount
            type: decimal
            required: false
            description: "Threshold amount before margin call triggered"
          - name: minimum-transfer-amount
            type: decimal
            required: false
            description: "Minimum transfer amount (MTA)"
          - name: collateral-ssi-ref
            type: string
            required: false
            description: "Reference to SSI for collateral transfers"
        returns:
          type: record
          description: Created CSA config with csa_id

      add-csa-collateral:
        description: Add eligible collateral to CSA
        behavior: plugin
        handler: TradingProfileAddCsaCollateralOp
        metadata:
          tier: intent
          source_of_truth: matrix
          scope: cbu
          noun: csa
          tags: [authoring, csa, collateral]
        args:
          - name: profile-id
            type: uuid
            required: true
          - name: counterparty-ref
            type: string
            required: true
          - name: collateral-type
            type: string
            required: true
            valid_values: [CASH, GOVT_BOND, CORP_BOND, EQUITY, MONEY_MARKET]
          - name: currencies
            type: string_list
            required: false
          - name: issuers
            type: string_list
            required: false
            description: Allowed issuer countries or entities
          - name: min-rating
            type: string
            required: false
            description: "Minimum credit rating (e.g., A-)"
          - name: haircut-pct
            type: decimal
            required: true
            description: "Haircut percentage (e.g., 2.0 for 2%)"
        returns:
          type: affected

      link-csa-ssi:
        description: Link CSA to collateral SSI in standing instructions
        behavior: plugin
        handler: link_csa_ssi_in_profile
        metadata:
          tier: intent
          source_of_truth: matrix
          scope: cbu
          noun: csa
          tags: [authoring, csa, ssi, collateral]
        args:
          - name: profile-id
            type: uuid
            required: true
          - name: counterparty-ref
            type: string
            required: true
          - name: ssi-name
            type: string
            required: true
            description: SSI name from OTC_COLLATERAL category
        returns:
          type: affected

      remove-isda-config:
        description: Remove ISDA master agreement from trading profile
        behavior: plugin
        handler: remove_isda_config_from_profile
        metadata:
          tier: intent
          source_of_truth: matrix
          scope: cbu
          noun: isda
          tags: [authoring, isda, otc]
        args:
          - name: profile-id
            type: uuid
            required: true
            description: "Trading profile ID"
          - name: counterparty-ref
            type: string
            required: true
            description: "Counterparty entity name or ID to remove"
        returns:
          type: affected
          description: Number of ISDA configs removed (0 or 1)

      remove-csa-config:
        description: Remove CSA from ISDA agreement in trading profile
        behavior: plugin
        handler: remove_csa_config_from_profile
        metadata:
          tier: intent
          source_of_truth: matrix
          scope: cbu
          noun: csa
          tags: [authoring, csa, otc]
        args:
          - name: profile-id
            type: uuid
            required: true
            description: "Trading profile ID"
          - name: counterparty-ref
            type: string
            required: true
            description: "Counterparty entity name or ID"
          - name: csa-type
            type: string
            required: false
            valid_values: [VM, VM_IM, IM]
            description: "CSA type to remove (if omitted, removes all CSAs for this counterparty)"
        returns:
          type: affected
          description: Number of CSA configs removed

      # --- Investment Managers Section ---

      add-im-mandate:
        description: Add investment manager mandate to trading profile
        behavior: plugin
        handler: add_im_mandate_to_profile
        metadata:
          tier: intent
          source_of_truth: matrix
          scope: cbu
          noun: im_mandate
          tags: [authoring, investment-manager]
        args:
          - name: profile-id
            type: uuid
            required: true
          - name: manager-ref
            type: string
            required: true
            description: "Manager reference (LEI, BIC, or name)"
          - name: manager-ref-type
            type: string
            required: true
            valid_values: [LEI, BIC, NAME, UUID]
          - name: priority
            type: integer
            required: true
          - name: role
            type: string
            required: false
            default: INVESTMENT_MANAGER
          - name: scope-all
            type: boolean
            required: false
            default: false
            description: If true, IM can trade all universe
          - name: scope-mics
            type: string_list
            required: false
            description: Markets this IM can trade
          - name: scope-instrument-classes
            type: string_list
            required: false
          - name: instruction-method
            type: string
            required: false
            valid_values: [SWIFT, CTM, FIX, API, ALERT, MANUAL]
          - name: can-trade
            type: boolean
            required: false
            default: true
          - name: can-settle
            type: boolean
            required: false
            default: true
        returns:
          type: record
          description: Updated IM mandates list

      update-im-scope:
        description: Update scope for existing IM mandate
        behavior: plugin
        handler: update_im_scope_in_profile
        metadata:
          tier: intent
          source_of_truth: matrix
          scope: cbu
          noun: im_mandate
          tags: [authoring, investment-manager]
        args:
          - name: profile-id
            type: uuid
            required: true
          - name: manager-ref
            type: string
            required: true
          - name: scope-all
            type: boolean
            required: false
          - name: scope-mics
            type: string_list
            required: false
          - name: scope-instrument-classes
            type: string_list
            required: false
        returns:
          type: affected

      remove-im-mandate:
        description: Remove investment manager mandate from profile
        behavior: plugin
        handler: remove_im_mandate_from_profile
        metadata:
          tier: intent
          source_of_truth: matrix
          scope: cbu
          noun: im_mandate
          tags: [authoring, investment-manager]
        args:
          - name: profile-id
            type: uuid
            required: true
          - name: manager-ref
            type: string
            required: true
        returns:
          type: affected

      # --- Validation Verbs ---

      validate-go-live-ready:
        description: Full validation for production readiness
        behavior: plugin
        handler: validate_profile_go_live_ready
        metadata:
          tier: diagnostics
          source_of_truth: matrix
          scope: cbu
          noun: trading_matrix
          tags: [validation, readiness-check]
        args:
          - name: profile-id
            type: uuid
            required: true
          - name: strictness
            type: string
            required: false
            default: STRICT
            valid_values: [STRICT, STANDARD, PERMISSIVE]
        returns:
          type: record
          description: "{ ready: bool, blockers: [...], warnings: [...], coverage_pct: float }"

      validate-universe-coverage:
        description: Validate all universe entries have required SSIs and booking rules
        behavior: plugin
        handler: validate_universe_coverage
        metadata:
          tier: diagnostics
          source_of_truth: matrix
          scope: cbu
          noun: universe
          tags: [validation, coverage-check]
        args:
          - name: profile-id
            type: uuid
            required: true
        returns:
          type: record
          description: "{ complete: bool, gaps: [...] }"

      # =========================================================================
      # DOCUMENT LIFECYCLE VERBS (Phase 6)
      # State machine: DRAFT -> VALIDATED -> PENDING_REVIEW -> ACTIVE -> SUPERSEDED/ARCHIVED
      #   - DRAFT: Initial editing, can have errors
      #   - VALIDATED: Ops team cleanup complete, structurally valid, ready for client
      #   - PENDING_REVIEW: Sent to client for approval
      #   - ACTIVE: Client approved, materialized to operational tables
      #   - SUPERSEDED: Replaced by newer active version
      #   - ARCHIVED: Soft deleted
      # =========================================================================

      submit:
        description: Submit a validated trading profile for client review (transitions VALIDATED -> PENDING_REVIEW)
        behavior: plugin
        handler: submit_trading_profile
        metadata:
          tier: intent
          source_of_truth: matrix
          scope: cbu
          noun: trading_matrix
          tags: [lifecycle, state-transition]
        args:
          - name: profile-id
            type: uuid
            required: true
          - name: submitted-by
            type: string
            required: false
            description: User or system submitting the profile
          - name: notes
            type: string
            required: false
            description: Submission notes
        returns:
          type: record
          description: Updated profile with PENDING_REVIEW status

      approve:
        description: Approve a pending trading profile, activating it (transitions PENDING_REVIEW -> ACTIVE)
        behavior: plugin
        handler: approve_trading_profile
        metadata:
          tier: intent
          source_of_truth: matrix
          scope: cbu
          noun: trading_matrix
          tags: [lifecycle, state-transition, activation]
        args:
          - name: profile-id
            type: uuid
            required: true
          - name: approved-by
            type: string
            required: false
            description: User or system approving the profile
          - name: notes
            type: string
            required: false
            description: Approval notes
        returns:
          type: record
          description: Updated profile with ACTIVE status

      reject:
        description: Reject a pending trading profile (transitions PENDING_REVIEW -> DRAFT with rejection reason)
        behavior: plugin
        handler: reject_trading_profile
        metadata:
          tier: intent
          source_of_truth: matrix
          scope: cbu
          noun: trading_matrix
          tags: [lifecycle, state-transition]
        args:
          - name: profile-id
            type: uuid
            required: true
          - name: rejection-reason
            type: string
            required: true
            description: Reason for rejection
          - name: rejected-by
            type: string
            required: false
            description: User or system rejecting the profile
        returns:
          type: record
          description: Updated profile with DRAFT status and rejection notes

      archive:
        description: Archive a trading profile (soft delete, transitions to ARCHIVED status)
        behavior: plugin
        handler: archive_trading_profile
        metadata:
          tier: intent
          source_of_truth: matrix
          scope: cbu
          noun: trading_matrix
          tags: [lifecycle, state-transition, soft-delete]
        args:
          - name: profile-id
            type: uuid
            required: true
          - name: archived-by
            type: string
            required: false
            description: User or system archiving the profile
          - name: notes
            type: string
            required: false
            description: Archive reason/notes
        returns:
          type: record
          description: Updated profile with ARCHIVED status

      # =========================================================================
      # CORPORATE ACTIONS POLICY (Intent - writes matrix JSONB)
      # =========================================================================

      ca.enable-event-types:
        description: Enable CA event types for this trading profile
        behavior: plugin
        handler: TradingProfileCaEnableEventTypesOp
        metadata:
          tier: intent
          source_of_truth: matrix
          scope: cbu
          noun: corporate_actions
          tags: [authoring, ca-policy]
        args:
          - name: profile-id
            type: uuid
            required: true
            description: Trading profile ID to update
          - name: event-types
            type: string_list
            required: true
            description: "Event codes to enable: DVCA, DVOP, RHTS, TEND, MRGR, etc."
        returns:
          type: record
          fields:
            - name: enabled_count
              type: integer

      ca.disable-event-types:
        description: Disable CA event types for this trading profile
        behavior: plugin
        handler: TradingProfileCaDisableEventTypesOp
        metadata:
          tier: intent
          source_of_truth: matrix
          scope: cbu
          noun: corporate_actions
          tags: [authoring, ca-policy]
        args:
          - name: profile-id
            type: uuid
            required: true
          - name: event-types
            type: string_list
            required: true
            description: "Event codes to disable"
        returns:
          type: affected

      ca.set-notification-policy:
        description: Configure CA notification settings
        behavior: plugin
        handler: TradingProfileCaSetNotificationOp
        metadata:
          tier: intent
          source_of_truth: matrix
          scope: cbu
          noun: corporate_actions
          tags: [authoring, ca-policy]
        args:
          - name: profile-id
            type: uuid
            required: true
          - name: channels
            type: string_list
            required: true
            description: "Notification channels: email, portal, swift"
          - name: sla-hours
            type: integer
            required: false
            default: 24
            description: SLA hours for notification delivery
          - name: escalation-contact
            type: string
            required: false
            description: Email or contact for escalations
        returns:
          type: affected

      ca.set-election-policy:
        description: Configure who makes CA elections and requirements
        behavior: plugin
        handler: TradingProfileCaSetElectionOp
        metadata:
          tier: intent
          source_of_truth: matrix
          scope: cbu
          noun: corporate_actions
          tags: [authoring, ca-policy]
        args:
          - name: profile-id
            type: uuid
            required: true
          - name: elector
            type: string
            required: true
            valid_values:
              - investment_manager
              - admin
              - client
            description: Who makes election decisions
          - name: evidence-required
            type: boolean
            required: false
            default: true
            description: Whether documentation is required for elections
          - name: auto-instruct-threshold
            type: decimal
            required: false
            description: Value threshold below which auto-instruct applies
        returns:
          type: affected

      ca.set-default-option:
        description: Set default election for specific event type
        behavior: plugin
        handler: TradingProfileCaSetDefaultOp
        metadata:
          tier: intent
          source_of_truth: matrix
          scope: cbu
          noun: corporate_actions
          tags: [authoring, ca-policy]
        args:
          - name: profile-id
            type: uuid
            required: true
          - name: event-type
            type: string
            required: true
            description: "Event code: DVOP, RHTS, TEND, EXOF, etc."
          - name: default-option
            type: string
            required: true
            valid_values:
              - CASH
              - STOCK
              - ROLLOVER
              - LAPSE
              - DECLINE
            description: Default election option for this event type
        returns:
          type: affected

      ca.remove-default-option:
        description: Remove default election for specific event type
        behavior: plugin
        handler: TradingProfileCaRemoveDefaultOp
        metadata:
          tier: intent
          source_of_truth: matrix
          scope: cbu
          noun: corporate_actions
          tags: [authoring, ca-policy]
        args:
          - name: profile-id
            type: uuid
            required: true
          - name: event-type
            type: string
            required: true
        returns:
          type: affected

      ca.add-cutoff-rule:
        description: Add deadline cutoff rule for market/depository
        behavior: plugin
        handler: TradingProfileCaAddCutoffOp
        metadata:
          tier: intent
          source_of_truth: matrix
          scope: cbu
          noun: corporate_actions
          tags: [authoring, ca-policy]
        args:
          - name: profile-id
            type: uuid
            required: true
          - name: event-type
            type: string
            required: false
            description: "Event code (if rule is event-specific)"
          - name: market-code
            type: string
            required: false
            description: "MIC code (e.g., XNYS, XLON)"
          - name: depository-code
            type: string
            required: false
            description: "Depository (e.g., DTCC, CREST, EUROCLEAR)"
          - name: days-before
            type: integer
            required: true
            description: Days before market deadline for internal cutoff
          - name: warning-days
            type: integer
            required: false
            default: 3
            description: Days before cutoff to send warning
          - name: escalation-days
            type: integer
            required: false
            default: 1
            description: Days before cutoff to escalate
        returns:
          type: affected

      ca.remove-cutoff-rule:
        description: Remove cutoff rule by market/depository
        behavior: plugin
        handler: TradingProfileCaRemoveCutoffOp
        metadata:
          tier: intent
          source_of_truth: matrix
          scope: cbu
          noun: corporate_actions
          tags: [authoring, ca-policy]
        args:
          - name: profile-id
            type: uuid
            required: true
          - name: market-code
            type: string
            required: false
          - name: depository-code
            type: string
            required: false
        returns:
          type: affected

      ca.link-proceeds-ssi:
        description: Map CA proceeds to settlement instruction
        behavior: plugin
        handler: TradingProfileCaLinkSsiOp
        metadata:
          tier: intent
          source_of_truth: matrix
          scope: cbu
          noun: corporate_actions
          tags: [authoring, ca-policy, ssi]
        args:
          - name: profile-id
            type: uuid
            required: true
          - name: proceeds-type
            type: string
            required: true
            valid_values:
              - cash
              - stock
            description: Type of proceeds (cash or stock)
          - name: currency
            type: string
            required: false
            description: "Currency code (if currency-specific mapping)"
          - name: ssi-name
            type: string
            required: true
            description: SSI name from standing instructions section
        returns:
          type: affected

      ca.remove-proceeds-ssi:
        description: Remove CA proceeds SSI mapping
        behavior: plugin
        handler: TradingProfileCaRemoveSsiOp
        metadata:
          tier: intent
          source_of_truth: matrix
          scope: cbu
          noun: corporate_actions
          tags: [authoring, ca-policy, ssi]
        args:
          - name: profile-id
            type: uuid
            required: true
          - name: proceeds-type
            type: string
            required: true
            valid_values:
              - cash
              - stock
          - name: currency
            type: string
            required: false
        returns:
          type: affected

      ca.get-policy:
        description: Get current CA policy configuration from trading profile
        behavior: plugin
        handler: TradingProfileCaGetPolicyOp
        metadata:
          tier: diagnostics
          source_of_truth: matrix
          scope: cbu
          noun: corporate_actions
          tags: [read, ca-policy]
        args:
          - name: profile-id
            type: uuid
            required: true
        returns:
          type: record
          description: "{ enabled_event_types: [...], notification_policy: {...}, election_policy: {...}, default_options: [...], cutoff_rules: [...], proceeds_ssi_mappings: [...] }"
