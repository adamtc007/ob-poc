domains:
  billing:
    description: "Fee billing management - bridges commercial deals to operational billing cycles"

    invocation_hints:
      - "billing"
      - "invoice"
      - "fee"
      - "revenue"
      - "billing period"

    verbs:
      # =========================================================================
      # BILLING PROFILE CRUD
      # =========================================================================

      create-profile:
        description: "Create a fee billing profile - bridges commercial to operational"
        behavior: plugin
        lifecycle:
          precondition_checks:
            - "requires_prior:deal.create"
            - "requires_prior:deal.agree-rate-card"
        metadata:
          tier: intent
          source_of_truth: operational
          scope: global
          noun: billing_profile
        invocation_phrases:
          - "create billing profile"
          - "new billing profile"
          - "set up billing"
          - "create fee profile"
        args:
          - name: deal-id
            type: uuid
            required: true
            maps_to: deal_id
          - name: contract-id
            type: uuid
            required: true
            maps_to: contract_id
          - name: rate-card-id
            type: uuid
            required: true
            maps_to: rate_card_id
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: product-id
            type: uuid
            required: true
            maps_to: product_id
            lookup:
              table: products
              entity_type: product
              schema: ob-poc
              search_key: name
              primary_key: product_id
          - name: invoice-entity-id
            type: uuid
            required: true
            maps_to: invoice_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: search_name
              primary_key: entity_id
          - name: profile-name
            type: string
            required: false
            maps_to: profile_name
          - name: billing-frequency
            type: string
            required: false
            maps_to: billing_frequency
            default: "MONTHLY"
            valid_values: [DAILY, WEEKLY, MONTHLY, QUARTERLY, ANNUALLY]
          - name: invoice-currency
            type: string
            required: false
            maps_to: invoice_currency
            default: "USD"
          - name: payment-method
            type: string
            required: false
            maps_to: payment_method
            valid_values: [ACH, WIRE, DEBIT_FROM_ACCOUNT]
          - name: payment-account-ref
            type: string
            required: false
            maps_to: payment_account_ref
          - name: effective-from
            type: date
            required: true
            maps_to: effective_from
        returns:
          type: uuid
          name: profile_id
          capture: true

      activate-profile:
        description: "Activate a billing profile (CBU is live and generating activity)"
        behavior: plugin
        metadata:
          tier: intent
          source_of_truth: operational
          scope: global
          noun: billing_profile
        invocation_phrases:
          - "activate billing profile"
          - "start billing"
          - "enable billing"
        args:
          - name: profile-id
            type: uuid
            required: true
            maps_to: profile_id
        returns:
          type: affected

      suspend-profile:
        description: "Suspend billing (e.g. dispute, investigation)"
        behavior: plugin
        metadata:
          tier: intent
          source_of_truth: operational
          scope: global
          noun: billing_profile
        invocation_phrases:
          - "suspend billing profile"
          - "pause billing"
          - "hold billing"
        args:
          - name: profile-id
            type: uuid
            required: true
            maps_to: profile_id
          - name: reason
            type: string
            required: true
            description: "Reason for suspension"
        returns:
          type: affected

      close-profile:
        description: "Close billing profile (offboarding)"
        behavior: plugin
        metadata:
          tier: intent
          source_of_truth: operational
          scope: global
          noun: billing_profile
        invocation_phrases:
          - "close billing profile"
          - "end billing"
          - "terminate billing"
        args:
          - name: profile-id
            type: uuid
            required: true
            maps_to: profile_id
          - name: effective-to
            type: date
            required: true
            maps_to: effective_to
        returns:
          type: affected

      get-profile:
        description: "Retrieve billing profile with account targets"
        behavior: crud
        crud:
          operation: select
          table: v_billing_profile_summary
          schema: ob-poc
        metadata:
          tier: intent
          source_of_truth: operational
          scope: global
          noun: billing_profile
        invocation_phrases:
          - "get billing profile"
          - "show billing profile"
          - "billing profile details"
        args:
          - name: profile-id
            type: uuid
            required: true
            maps_to: profile_id
        returns:
          type: record

      list-profiles:
        description: "List billing profiles for a deal or CBU"
        behavior: crud
        crud:
          operation: select
          table: v_billing_profile_summary
          schema: ob-poc
        metadata:
          tier: intent
          source_of_truth: operational
          scope: global
          noun: billing_profile
        invocation_phrases:
          - "list billing profiles"
          - "show billing profiles"
          - "all billing profiles"
        args:
          - name: deal-id
            type: uuid
            required: false
            maps_to: deal_id
          - name: cbu-id
            type: uuid
            required: false
            maps_to: cbu_id
          - name: status
            type: string
            required: false
            maps_to: status
            valid_values: [PENDING, ACTIVE, SUSPENDED, CLOSED]
        returns:
          type: record_set

      # =========================================================================
      # ACCOUNT TARGETS (Closed Loop)
      # =========================================================================

      add-account-target:
        description: "Link a CBU resource instance (account) to a billing profile"
        behavior: plugin
        lifecycle:
          precondition_checks:
            - "requires_prior:billing.create-profile"
        metadata:
          tier: intent
          source_of_truth: operational
          scope: global
          noun: billing_account_target
        invocation_phrases:
          - "add billing account target"
          - "link account to billing"
          - "add billable account"
        args:
          - name: profile-id
            type: uuid
            required: true
            maps_to: profile_id
          - name: cbu-resource-instance-id
            type: uuid
            required: true
            maps_to: cbu_resource_instance_id
          - name: rate-card-line-id
            type: uuid
            required: false
            maps_to: rate_card_line_id
          - name: resource-type
            type: string
            required: false
            maps_to: resource_type
            description: "Type of resource (e.g., CUSTODY_ACCOUNT, FUND, PORTFOLIO)"
          - name: resource-ref
            type: string
            required: false
            maps_to: resource_ref
            description: "Account number or fund code"
          - name: activity-type
            type: string
            required: false
            maps_to: activity_type
            valid_values: [TRANSACTIONS, AUM, NAV, POSITIONS]
          - name: has-override
            type: boolean
            required: false
            maps_to: has_override
            default: false
          - name: override-rate
            type: decimal
            required: false
            maps_to: override_rate
          - name: override-model
            type: string
            required: false
            maps_to: override_model
        returns:
          type: uuid
          name: target_id
          capture: true

      remove-account-target:
        description: "Soft-remove an account target from billing"
        behavior: plugin
        metadata:
          tier: intent
          source_of_truth: operational
          scope: global
          noun: billing_account_target
        invocation_phrases:
          - "remove billing account target"
          - "unlink account from billing"
          - "deactivate billing account"
        args:
          - name: target-id
            type: uuid
            required: true
            maps_to: target_id
        returns:
          type: affected

      list-account-targets:
        description: "List account targets for a billing profile"
        behavior: crud
        crud:
          operation: select
          table: fee_billing_account_targets
          schema: ob-poc
        metadata:
          tier: intent
          source_of_truth: operational
          scope: global
          noun: billing_account_target
        invocation_phrases:
          - "list billing account targets"
          - "show billable accounts"
          - "billing accounts"
        args:
          - name: profile-id
            type: uuid
            required: true
            maps_to: profile_id
        returns:
          type: record_set

      # =========================================================================
      # FEE CALCULATION RUNS
      # =========================================================================

      create-period:
        description: "Create a billing period for calculation"
        behavior: plugin
        lifecycle:
          precondition_checks:
            - "requires_prior:billing.create-profile"
            - "requires_prior:billing.activate-profile"
        metadata:
          tier: intent
          source_of_truth: operational
          scope: global
          noun: billing_period
        invocation_phrases:
          - "create billing period"
          - "new billing period"
          - "start billing cycle"
        args:
          - name: profile-id
            type: uuid
            required: true
            maps_to: profile_id
          - name: period-start
            type: date
            required: true
            maps_to: period_start
          - name: period-end
            type: date
            required: true
            maps_to: period_end
        returns:
          type: uuid
          name: period_id
          capture: true

      calculate-period:
        description: "Run fee calculation for a billing period"
        behavior: plugin
        lifecycle:
          precondition_checks:
            - "requires_prior:billing.create-period"
        metadata:
          tier: intent
          source_of_truth: operational
          scope: global
          noun: billing_period
        invocation_phrases:
          - "calculate billing period"
          - "run fee calculation"
          - "calculate fees"
        args:
          - name: period-id
            type: uuid
            required: true
            maps_to: period_id
        returns:
          type: record

      review-period:
        description: "Mark billing period as reviewed, optionally apply adjustments"
        behavior: plugin
        lifecycle:
          precondition_checks:
            - "requires_prior:billing.calculate-period"
        metadata:
          tier: intent
          source_of_truth: operational
          scope: global
          noun: billing_period
        invocation_phrases:
          - "review billing period"
          - "mark billing reviewed"
          - "apply billing adjustments"
        args:
          - name: period-id
            type: uuid
            required: true
            maps_to: period_id
          - name: reviewed-by
            type: string
            required: true
            maps_to: reviewed_by
          - name: adjustments
            type: json
            required: false
            description: "Array of {period_line_id, adjustment_amount, reason}"
        returns:
          type: affected

      approve-period:
        description: "Approve billing period for invoicing"
        behavior: plugin
        lifecycle:
          precondition_checks:
            - "requires_prior:billing.review-period"
        metadata:
          tier: intent
          source_of_truth: operational
          scope: global
          noun: billing_period
        invocation_phrases:
          - "approve billing period"
          - "approve fees"
          - "sign off billing"
        args:
          - name: period-id
            type: uuid
            required: true
            maps_to: period_id
          - name: approved-by
            type: string
            required: true
            maps_to: approved_by
        returns:
          type: affected

      generate-invoice:
        description: "Generate invoice from approved billing period"
        behavior: plugin
        lifecycle:
          precondition_checks:
            - "requires_prior:billing.approve-period"
        metadata:
          tier: intent
          source_of_truth: operational
          scope: global
          noun: billing_period
        invocation_phrases:
          - "generate invoice"
          - "create invoice"
          - "invoice billing period"
        args:
          - name: period-id
            type: uuid
            required: true
            maps_to: period_id
        returns:
          type: uuid
          name: invoice_id
          capture: true

      dispute-period:
        description: "Client disputes a billing period"
        behavior: plugin
        metadata:
          tier: intent
          source_of_truth: operational
          scope: global
          noun: billing_period
        invocation_phrases:
          - "dispute billing period"
          - "raise billing dispute"
          - "contest fees"
        args:
          - name: period-id
            type: uuid
            required: true
            maps_to: period_id
          - name: dispute-reason
            type: string
            required: true
            description: "Reason for dispute"
          - name: disputed-lines
            type: json
            required: false
            description: "Array of period_line_ids being disputed"
        returns:
          type: affected

      period-summary:
        description: "Get billing period with line-level detail"
        behavior: plugin
        metadata:
          tier: intent
          source_of_truth: operational
          scope: global
          noun: billing_period
        invocation_phrases:
          - "billing period summary"
          - "show billing period"
          - "billing period details"
        args:
          - name: period-id
            type: uuid
            required: true
            maps_to: period_id
        returns:
          type: record

      revenue-summary:
        description: "Revenue summary across deals, periods, products"
        behavior: plugin
        metadata:
          tier: intent
          source_of_truth: operational
          scope: global
          noun: billing_revenue
        invocation_phrases:
          - "revenue summary"
          - "billing revenue report"
          - "fee revenue"
          - "total revenue"
        args:
          - name: deal-id
            type: uuid
            required: false
            maps_to: deal_id
          - name: cbu-id
            type: uuid
            required: false
            maps_to: cbu_id
          - name: from-date
            type: date
            required: false
            description: "Revenue from this date"
          - name: to-date
            type: date
            required: false
            description: "Revenue to this date"
        returns:
          type: record
