domains:
  movement:
    description: Fund subscription, redemption, transfer, and PE/VC capital transactions
    verbs:
      subscribe:
        description: Record a subscription (investor buying units). Idempotent via (holding_id, trade_date, reference).
        metadata:
          tier: intent
          source_of_truth: register
          scope: cbu
        behavior: crud
        crud:
          operation: upsert
          table: movements
          schema: kyc
          returning: id
          conflict_keys:
            - holding_id
            - trade_date
            - reference
        args:
          - name: holding-id
            type: uuid
            required: true
            maps_to: holding_id
            lookup:
              table: holdings
              entity_type: holding
              schema: kyc
              search_key: id
              primary_key: id
          - name: units
            type: decimal
            required: true
            maps_to: units
          - name: price-per-unit
            type: decimal
            required: true
            maps_to: price_per_unit
          - name: amount
            type: decimal
            required: false
            maps_to: amount
          - name: currency
            type: string
            required: false
            maps_to: currency
            default: EUR
          - name: trade-date
            type: date
            required: true
            maps_to: trade_date
          - name: settlement-date
            type: date
            required: false
            maps_to: settlement_date
          - name: reference
            type: string
            required: true
            maps_to: reference
          - name: notes
            type: string
            required: false
            maps_to: notes
        returns:
          type: uuid
          name: movement_id
          capture: true
        set_values:
          movement_type: subscription

      redeem:
        description: Record a redemption (investor selling units). Idempotent via (holding_id, trade_date, reference).
        metadata:
          tier: intent
          source_of_truth: register
          scope: cbu
        behavior: crud
        crud:
          operation: upsert
          table: movements
          schema: kyc
          returning: id
          conflict_keys:
            - holding_id
            - trade_date
            - reference
        args:
          - name: holding-id
            type: uuid
            required: true
            maps_to: holding_id
            lookup:
              table: holdings
              entity_type: holding
              schema: kyc
              search_key: id
              primary_key: id
          - name: units
            type: decimal
            required: true
            maps_to: units
          - name: price-per-unit
            type: decimal
            required: true
            maps_to: price_per_unit
          - name: amount
            type: decimal
            required: false
            maps_to: amount
          - name: currency
            type: string
            required: false
            maps_to: currency
            default: EUR
          - name: trade-date
            type: date
            required: true
            maps_to: trade_date
          - name: settlement-date
            type: date
            required: false
            maps_to: settlement_date
          - name: reference
            type: string
            required: true
            maps_to: reference
          - name: notes
            type: string
            required: false
            maps_to: notes
        returns:
          type: uuid
          name: movement_id
          capture: true
        set_values:
          movement_type: redemption

      transfer-in:
        description: Record an incoming transfer of units. Idempotent via (holding_id, trade_date, reference).
        metadata:
          tier: intent
          source_of_truth: register
          scope: cbu
        behavior: crud
        crud:
          operation: upsert
          table: movements
          schema: kyc
          returning: id
          conflict_keys:
            - holding_id
            - trade_date
            - reference
        args:
          - name: holding-id
            type: uuid
            required: true
            maps_to: holding_id
            lookup:
              table: holdings
              entity_type: holding
              schema: kyc
              search_key: id
              primary_key: id
          - name: units
            type: decimal
            required: true
            maps_to: units
          - name: price-per-unit
            type: decimal
            required: false
            maps_to: price_per_unit
          - name: trade-date
            type: date
            required: true
            maps_to: trade_date
          - name: reference
            type: string
            required: true
            maps_to: reference
          - name: notes
            type: string
            required: false
            maps_to: notes
        returns:
          type: uuid
          name: movement_id
          capture: true
        set_values:
          movement_type: transfer_in

      transfer-out:
        description: Record an outgoing transfer of units. Idempotent via (holding_id, trade_date, reference).
        metadata:
          tier: intent
          source_of_truth: register
          scope: cbu
        behavior: crud
        crud:
          operation: upsert
          table: movements
          schema: kyc
          returning: id
          conflict_keys:
            - holding_id
            - trade_date
            - reference
        args:
          - name: holding-id
            type: uuid
            required: true
            maps_to: holding_id
            lookup:
              table: holdings
              entity_type: holding
              schema: kyc
              search_key: id
              primary_key: id
          - name: units
            type: decimal
            required: true
            maps_to: units
          - name: price-per-unit
            type: decimal
            required: false
            maps_to: price_per_unit
          - name: trade-date
            type: date
            required: true
            maps_to: trade_date
          - name: reference
            type: string
            required: true
            maps_to: reference
          - name: notes
            type: string
            required: false
            maps_to: notes
        returns:
          type: uuid
          name: movement_id
          capture: true
        set_values:
          movement_type: transfer_out

      # PE/VC specific movement types
      commitment:
        description: Record LP commitment to PE/VC fund (total amount investor commits to invest)
        metadata:
          tier: intent
          source_of_truth: register
          scope: cbu
        behavior: crud
        crud:
          operation: upsert
          table: movements
          schema: kyc
          returning: id
          conflict_keys:
            - holding_id
            - trade_date
            - reference
        args:
          - name: holding-id
            type: uuid
            required: true
            maps_to: holding_id
            lookup:
              table: holdings
              entity_type: holding
              schema: kyc
              search_key: id
              primary_key: id
          - name: amount
            type: decimal
            required: true
            maps_to: amount
            description: Total commitment amount
          - name: currency
            type: string
            required: false
            maps_to: currency
            default: EUR
          - name: trade-date
            type: date
            required: true
            maps_to: trade_date
            description: Commitment date
          - name: reference
            type: string
            required: true
            maps_to: reference
          - name: commitment-period-end
            type: date
            required: false
            maps_to: commitment_period_end
            description: End of investment period
          - name: notes
            type: string
            required: false
            maps_to: notes
        returns:
          type: uuid
          name: movement_id
          capture: true
        set_values:
          movement_type: commitment

      capital-call:
        description: Record capital call (drawdown from LP commitment)
        metadata:
          tier: intent
          source_of_truth: register
          scope: cbu
        behavior: crud
        crud:
          operation: upsert
          table: movements
          schema: kyc
          returning: id
          conflict_keys:
            - holding_id
            - trade_date
            - reference
        args:
          - name: holding-id
            type: uuid
            required: true
            maps_to: holding_id
            lookup:
              table: holdings
              entity_type: holding
              schema: kyc
              search_key: id
              primary_key: id
          - name: amount
            type: decimal
            required: true
            maps_to: amount
            description: Capital call amount
          - name: currency
            type: string
            required: false
            maps_to: currency
            default: EUR
          - name: trade-date
            type: date
            required: true
            maps_to: trade_date
            description: Call date
          - name: settlement-date
            type: date
            required: false
            maps_to: settlement_date
            description: Due date for payment
          - name: reference
            type: string
            required: true
            maps_to: reference
          - name: call-number
            type: integer
            required: false
            maps_to: call_number
            description: Sequential call number (1st, 2nd, etc.)
          - name: notes
            type: string
            required: false
            maps_to: notes
        returns:
          type: uuid
          name: movement_id
          capture: true
        set_values:
          movement_type: capital_call

      distribution:
        description: Record distribution to LP (return of capital or profit)
        metadata:
          tier: intent
          source_of_truth: register
          scope: cbu
        behavior: crud
        crud:
          operation: upsert
          table: movements
          schema: kyc
          returning: id
          conflict_keys:
            - holding_id
            - trade_date
            - reference
        args:
          - name: holding-id
            type: uuid
            required: true
            maps_to: holding_id
            lookup:
              table: holdings
              entity_type: holding
              schema: kyc
              search_key: id
              primary_key: id
          - name: amount
            type: decimal
            required: true
            maps_to: amount
            description: Distribution amount
          - name: currency
            type: string
            required: false
            maps_to: currency
            default: EUR
          - name: trade-date
            type: date
            required: true
            maps_to: trade_date
            description: Distribution date
          - name: settlement-date
            type: date
            required: false
            maps_to: settlement_date
          - name: reference
            type: string
            required: true
            maps_to: reference
          - name: distribution-type
            type: string
            required: false
            maps_to: distribution_type
            description: "return_of_capital, profit_distribution, dividend, interest"
            validation:
              enum:
                - return_of_capital
                - profit_distribution
                - dividend
                - interest
          - name: is-recallable
            type: boolean
            required: false
            maps_to: is_recallable
            default: false
            description: Whether distribution can be recalled by GP
          - name: notes
            type: string
            required: false
            maps_to: notes
        returns:
          type: uuid
          name: movement_id
          capture: true
        set_values:
          movement_type: distribution

      recallable-distribution:
        description: Record a recallable distribution (can be called back by GP)
        metadata:
          tier: intent
          source_of_truth: register
          scope: cbu
        behavior: crud
        crud:
          operation: upsert
          table: movements
          schema: kyc
          returning: id
          conflict_keys:
            - holding_id
            - trade_date
            - reference
        args:
          - name: holding-id
            type: uuid
            required: true
            maps_to: holding_id
            lookup:
              table: holdings
              entity_type: holding
              schema: kyc
              search_key: id
              primary_key: id
          - name: amount
            type: decimal
            required: true
            maps_to: amount
          - name: currency
            type: string
            required: false
            maps_to: currency
            default: EUR
          - name: trade-date
            type: date
            required: true
            maps_to: trade_date
          - name: reference
            type: string
            required: true
            maps_to: reference
          - name: recall-deadline
            type: date
            required: false
            maps_to: recall_deadline
            description: Date by which GP can recall the distribution
          - name: notes
            type: string
            required: false
            maps_to: notes
        returns:
          type: uuid
          name: movement_id
          capture: true
        set_values:
          movement_type: recallable_distribution
          is_recallable: true

      confirm:
        description: Confirm a pending movement
        metadata:
          tier: intent
          source_of_truth: register
          scope: cbu
        behavior: crud
        crud:
          operation: update
          table: movements
          schema: kyc
          key: id
          set_values:
            status: confirmed
        args:
          - name: movement-id
            type: uuid
            required: true
            maps_to: id
            lookup:
              table: movements
              entity_type: movement
              schema: kyc
              search_key: id
              primary_key: id
        returns:
          type: affected

      settle:
        description: Mark a movement as settled
        metadata:
          tier: intent
          source_of_truth: register
          scope: cbu
        behavior: crud
        crud:
          operation: update
          table: movements
          schema: kyc
          key: id
          set_values:
            status: settled
        args:
          - name: movement-id
            type: uuid
            required: true
            maps_to: id
            lookup:
              table: movements
              entity_type: movement
              schema: kyc
              search_key: id
              primary_key: id
          - name: settlement-date
            type: date
            required: false
            maps_to: settlement_date
        returns:
          type: affected

      cancel:
        description: Cancel a pending movement
        metadata:
          tier: intent
          source_of_truth: register
          scope: cbu
        behavior: crud
        crud:
          operation: update
          table: movements
          schema: kyc
          key: id
          set_values:
            status: cancelled
        args:
          - name: movement-id
            type: uuid
            required: true
            maps_to: id
            lookup:
              table: movements
              entity_type: movement
              schema: kyc
              search_key: id
              primary_key: id
          - name: notes
            type: string
            required: false
            maps_to: notes
        returns:
          type: affected

      fail:
        description: Mark a movement as failed
        metadata:
          tier: intent
          source_of_truth: register
          scope: cbu
        behavior: crud
        crud:
          operation: update
          table: movements
          schema: kyc
          key: id
          set_values:
            status: failed
        args:
          - name: movement-id
            type: uuid
            required: true
            maps_to: id
            lookup:
              table: movements
              entity_type: movement
              schema: kyc
              search_key: id
              primary_key: id
          - name: failure-reason
            type: string
            required: false
            maps_to: failure_reason
          - name: notes
            type: string
            required: false
            maps_to: notes
        returns:
          type: affected

      list-by-holding:
        description: List movements for a holding
        metadata:
          tier: reference
          source_of_truth: register
          scope: cbu
        behavior: crud
        crud:
          operation: list_by_fk
          table: movements
          schema: kyc
          fk_col: holding_id
        args:
          - name: holding-id
            type: uuid
            required: true
            lookup:
              table: holdings
              entity_type: holding
              schema: kyc
              search_key: id
              primary_key: id
          - name: movement-type
            type: string
            required: false
            maps_to: movement_type
          - name: status
            type: string
            required: false
            maps_to: status
        returns:
          type: record_set

      list-capital-activity:
        description: List PE/VC capital activity (commitments, calls, distributions)
        metadata:
          tier: reference
          source_of_truth: register
          scope: cbu
        behavior: plugin
        plugin_handler: movement_list_capital_activity
        args:
          - name: holding-id
            type: uuid
            required: false
            maps_to: holding_id
            lookup:
              table: holdings
              entity_type: holding
              schema: kyc
              search_key: id
              primary_key: id
          - name: movement-type
            type: string
            required: false
            maps_to: movement_type
        returns:
          type: record_set

      read:
        description: Read a movement by ID
        metadata:
          tier: reference
          source_of_truth: register
          scope: cbu
        behavior: crud
        crud:
          operation: select
          table: movements
          schema: kyc
        args:
          - name: movement-id
            type: uuid
            required: true
            maps_to: id
            lookup:
              table: movements
              entity_type: movement
              schema: kyc
              search_key: id
              primary_key: id
        returns:
          type: record
