domains:
  holding:
    description: Investor position management in share classes
    verbs:
      create:
        description: Create a new investor holding in a share class
        behavior: crud
        crud:
          operation: insert
          table: holdings
          schema: kyc
          returning: id
        args:
        - name: share-class-id
          type: uuid
          required: true
          maps_to: share_class_id
            lookup:
              table: share_classes
              schema: kyc
              search_key: name
              primary_key: id
        - name: investor-entity-id
          type: uuid
          required: true
          maps_to: investor_entity_id
            lookup:
              table: entities
              schema: ob-poc
              search_key: name
              primary_key: entity_id
        - name: units
          type: decimal
          required: false
          maps_to: units
          default: 0
        - name: cost-basis
          type: decimal
          required: false
          maps_to: cost_basis
        - name: acquisition-date
          type: date
          required: false
          maps_to: acquisition_date
        returns:
          type: uuid
          name: holding_id
          capture: true
      ensure:
        description: Ensure investor holding exists (upsert)
        behavior: crud
        crud:
          operation: upsert
          table: holdings
          schema: kyc
          conflict_keys:
          - share_class_id
          - investor_entity_id
          returning: id
        args:
        - name: share-class-id
          type: uuid
          required: true
          maps_to: share_class_id
            lookup:
              table: share_classes
              schema: kyc
              search_key: name
              primary_key: id
        - name: investor-entity-id
          type: uuid
          required: true
          maps_to: investor_entity_id
            lookup:
              table: entities
              schema: ob-poc
              search_key: name
              primary_key: entity_id
        - name: units
          type: decimal
          required: false
          maps_to: units
        - name: cost-basis
          type: decimal
          required: false
          maps_to: cost_basis
        - name: acquisition-date
          type: date
          required: false
          maps_to: acquisition_date
        returns:
          type: uuid
          name: holding_id
          capture: true
      update-units:
        description: Update holding units (for position adjustments)
        behavior: crud
        crud:
          operation: update
          table: holdings
          schema: kyc
          key: id
        args:
        - name: holding-id
          type: uuid
          required: true
          maps_to: id
            lookup:
              table: holdings
              schema: kyc
              search_key: id
              primary_key: id
        - name: units
          type: decimal
          required: true
          maps_to: units
        - name: cost-basis
          type: decimal
          required: false
          maps_to: cost_basis
        returns:
          type: affected
      read:
        description: Read a holding by ID
        behavior: crud
        crud:
          operation: select
          table: holdings
          schema: kyc
        args:
        - name: holding-id
          type: uuid
          required: true
          maps_to: id
            lookup:
              table: holdings
              schema: kyc
              search_key: id
              primary_key: id
        returns:
          type: record
      list-by-share-class:
        description: List holdings for a share class
        behavior: crud
        crud:
          operation: list_by_fk
          table: holdings
          schema: kyc
          fk_col: share_class_id
        args:
        - name: share-class-id
          type: uuid
          required: true
        - name: status
          type: string
          required: false
          maps_to: status
        returns:
          type: record_set
      list-by-investor:
        description: List holdings for an investor across all share classes
        behavior: crud
        crud:
          operation: list_by_fk
          table: holdings
          schema: kyc
          fk_col: investor_entity_id
        args:
        - name: investor-entity-id
          type: uuid
          required: true
        returns:
          type: record_set
      close:
        description: Close a holding (mark as inactive)
        behavior: crud
        crud:
          operation: update
          table: holdings
          schema: kyc
          key: id
          set_values:
            status: closed
        args:
        - name: holding-id
          type: uuid
          required: true
          maps_to: id
            lookup:
              table: holdings
              schema: kyc
              search_key: id
              primary_key: id
        returns:
          type: affected
