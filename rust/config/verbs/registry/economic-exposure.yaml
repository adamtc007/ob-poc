domains:
  economic-exposure:
    description: |
      Economic exposure look-through computation for investor register analysis.

      PURPOSE: Computes indirect/ultimate economic ownership through multi-level fund chains
      with bounded recursion, cycle detection, and configurable stop conditions. Essential for
      understanding "who really owns what" when ownership passes through intermediaries.

      KEY CONCEPTS:
      - Look-through: Tracing ownership through intermediary entities (FoFs, master funds, nominees)
        to find ultimate beneficial owners. Required by AML regulations for certain structures.
      - Bounded recursion: Prevents infinite loops and runaway computation. Configurable max depth.
      - Cycle detection: Handles circular ownership (A owns B owns C owns A) gracefully.
      - Stop conditions: Multiple criteria for terminating traversal (role type, policy, data availability).

      DOMAIN JARGON:
      - Economic interest: The right to receive distributions/proceeds (vs voting/control rights)
      - Diluted ownership: Cumulative percentage after traversing multiple levels
      - Chain depth: Number of hops from root entity to a particular holder
      - Terminal holder: End of look-through chain (END_INVESTOR or policy=NONE)
      - Coverage: Percentage of ownership that has been successfully looked-through

      STOP CONDITIONS (in precedence order):
      1. CYCLE_DETECTED - Circular ownership found (path already includes this entity)
      2. MAX_DEPTH - Traversal depth limit reached (default: 6 levels)
      3. BELOW_MIN_PCT - Cumulative ownership drops below threshold (default: 0.01%)
      4. END_INVESTOR - Holder has role_type=END_INVESTOR (terminal beneficial owner)
      5. POLICY_NONE - Holder has lookthrough_policy=NONE (no look-through permitted)
      6. NO_BO_DATA - Holder has beneficial_owner_data_available=false (can't look through)

      OUTPUT: For each discovered holder, returns:
      - holder_entity_id, holder_name: The discovered beneficial owner
      - cumulative_pct: Economic percentage after multiplying through all levels
      - chain_depth: Number of hops from root
      - path_ids, path_names: Full ownership path (for audit trail)
      - stop_reason: Why traversal stopped at this holder

    invocation_hints:
      - "economic exposure"
      - "look-through"
      - "ultimate ownership"
      - "beneficial owner chain"
      - "indirect ownership"
      - "ownership path"
      - "trace ownership"
      - "who owns what"
      - "diluted ownership"

    verbs:
      # ============================================
      # Look-Through Computation
      # ============================================
      compute:
        description: |
          Compute economic exposure from a root entity through ownership chains.

          Performs bounded recursive traversal of the ownership graph starting from
          a root entity (typically a fund), following ECONOMIC edges and applying
          look-through rules based on investor role profiles.

          USE CASES:
          - "Show me who ultimately owns Fund A after looking through all intermediaries"
          - "What is BlackRock's diluted economic interest across our fund complex?"
          - "Identify all beneficial owners above 5% after look-through"
          - "Generate AML economic exposure report for regulatory filing"
          - "Trace ownership path from fund to ultimate beneficial owner"

          ALGORITHM:
          1. Start at root entity with 100% ownership
          2. For each outgoing ECONOMIC edge:
             a. Multiply current percentage by edge percentage
             b. Check if holder should be traversed (based on role profile)
             c. If yes and not stopped, recurse into holder's ownership
             d. If no, record holder as terminal with stop_reason
          3. Apply stop conditions (cycle, depth, min_pct, role, policy, data)
          4. Return all discovered holders with cumulative percentages

          EXAMPLE OUTPUT:
          | holder_name    | cumulative_pct | depth | stop_reason    |
          |----------------|----------------|-------|----------------|
          | BlackRock Inc  | 15.2%          | 2     | END_INVESTOR   |
          | State Street   | 8.1%           | 1     | POLICY_NONE    |
          | Unknown Feeder | 3.4%           | 3     | NO_BO_DATA     |
        metadata:
          tier: diagnostics
          source_of_truth: operational
          scope: cbu
          noun: economic_exposure
        invocation_phrases:
          - "compute economic exposure"
          - "calculate look-through"
          - "find ultimate owners"
          - "trace ownership chain"
          - "economic ownership analysis"
          - "diluted ownership report"
          - "who are the real owners"
          - "look through intermediaries"
          - "AML exposure analysis"
          - "beneficial owner chain"
          - "indirect ownership"
        behavior: plugin
        handler: EconomicExposureComputeOp
        args:
          - name: root-entity-id
            type: uuid
            required: true
            maps_to: root_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
            description: "Starting entity (typically a fund or issuer) for look-through computation. Traversal begins here with 100% ownership."
          - name: as-of-date
            type: date
            required: false
            maps_to: as_of_date
            description: "Point-in-time date for ownership data and role profiles. Defaults to today. Use for historical analysis or regulatory as-of reporting."
          - name: max-depth
            type: integer
            required: false
            maps_to: max_depth
            default: 6
            description: "Maximum traversal depth. Prevents runaway recursion in deep structures. Default 6 is sufficient for most fund-of-funds chains."
          - name: min-pct
            type: decimal
            required: false
            maps_to: min_pct
            default: 0.0001
            description: "Minimum cumulative percentage to continue traversal. Default 0.01% (0.0001). Below this, ownership is de minimis and excluded."
          - name: max-rows
            type: integer
            required: false
            maps_to: max_rows
            default: 200
            description: "Maximum result set size. Prevents memory issues with very large ownership structures. Default 200 terminal holders."
          - name: stop-on-no-bo-data
            type: boolean
            required: false
            maps_to: stop_on_no_bo_data
            default: true
            description: "Stop traversal when holder has beneficial_owner_data_available=false. Set to false to continue even without data (will show UNKNOWN stop_reason)."
          - name: stop-on-policy-none
            type: boolean
            required: false
            maps_to: stop_on_policy_none
            default: true
            description: "Stop traversal when holder has lookthrough_policy=NONE. Set to false to ignore policy restrictions (e.g., for regulatory override)."
        returns:
          type: record_set

      summary:
        description: |
          Get aggregated economic exposure summary for an issuer.

          Returns a condensed view of significant economic owners, aggregated by
          investor type, with counts of smaller holders. Useful for dashboards
          and high-level reporting where you don't need the full chain detail.

          USE CASES:
          - "Show me the top 10 economic owners of Fund A"
          - "What's the ownership breakdown by investor type?"
          - "How many beneficial owners are above 5%?"
          - "Dashboard summary of significant shareholders"

          OUTPUT includes:
          - Significant holders (above threshold_pct) with individual details
          - Aggregation of smaller holders by category
          - Total coverage percentage
          - Count of terminal vs intermediate holders
        metadata:
          tier: diagnostics
          source_of_truth: operational
          scope: cbu
          noun: economic_exposure
        invocation_phrases:
          - "economic exposure summary"
          - "ownership summary"
          - "top shareholders"
          - "significant owners"
          - "ownership breakdown"
          - "investor concentration"
          - "major holders"
        behavior: plugin
        handler: EconomicExposureSummaryOp
        args:
          - name: issuer-entity-id
            type: uuid
            required: true
            maps_to: issuer_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
            description: "Issuer entity (fund/company) to analyze economic exposure for."
          - name: as-of-date
            type: date
            required: false
            maps_to: as_of_date
            description: "Point-in-time date for analysis. Defaults to today."
          - name: threshold-pct
            type: decimal
            required: false
            maps_to: threshold_pct
            default: 5.0
            description: "Threshold for 'significant' holders. Holders above this percentage are listed individually; below are aggregated. Default 5% (disclosure threshold)."
        returns:
          type: record_set

  issuer-control-config:
    description: |
      Per-issuer configuration for control/disclosure thresholds and look-through parameters.

      PURPOSE: Different issuers (funds, companies) have different regulatory requirements
      and visualization preferences for ownership thresholds. This allows customization
      per issuer rather than using global defaults.

      THRESHOLD HIERARCHY:
      - disclosure_threshold_pct (5%): Above this → individual node in visualization
      - material_threshold_pct (10%): Highlighted as material holding
      - significant_threshold_pct (25%): ⚡ indicator, blocking minority
      - control_threshold_pct (50%): Control edge, majority shareholder

      These thresholds affect:
      1. Investor register visualization (node vs aggregate)
      2. Regulatory filing triggers (13D/13G, TR-1)
      3. Look-through depth for economic exposure

      REGULATORY CONTEXT:
      - US: 5% triggers 13D/13G filing (SEC beneficial ownership)
      - EU: Various thresholds per jurisdiction (TR-1 major holdings)
      - UK: 3% disclosure threshold (DTR5)
      - Many jurisdictions have tiered disclosure (5%, 10%, 25%, 50%)

    invocation_hints:
      - "control threshold"
      - "disclosure threshold"
      - "ownership threshold"
      - "configure thresholds"
      - "issuer config"

    verbs:
      upsert:
        description: |
          Set control and disclosure thresholds for an issuer.

          Configures the percentage thresholds that determine:
          - When a holder appears as individual node vs aggregated
          - Highlighting levels in visualization (material, significant, control)
          - Look-through computation parameters

          USE CASES:
          - "Set Fund A to use UK 3% disclosure threshold"
          - "Configure custom thresholds for regulatory compliance"
          - "Adjust look-through depth for complex structures"

          These settings are temporal (effective_from) for audit trail and
          can be changed when regulations or fund policies change.
        metadata:
          tier: intent
          source_of_truth: register
          scope: cbu
          noun: issuer_control_config
        invocation_phrases:
          - "set control thresholds"
          - "configure disclosure threshold"
          - "set ownership thresholds"
          - "customize issuer config"
          - "adjust threshold levels"
          - "set regulatory thresholds"
        behavior: crud
        crud:
          operation: upsert
          table: issuer_control_config
          schema: kyc
          returning: config_id
          conflict_keys:
            - issuer_entity_id
            - effective_from
        args:
          - name: issuer-entity-id
            type: uuid
            required: true
            maps_to: issuer_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
            description: "Issuer entity (fund/company) to configure thresholds for."
          - name: disclosure-threshold-pct
            type: decimal
            required: false
            maps_to: disclosure_threshold_pct
            default: 5.0
            description: "Disclosure threshold - holders above this appear as individual nodes. Default 5% (SEC 13D/13G trigger). Use 3% for UK DTR5 compliance."
          - name: material-threshold-pct
            type: decimal
            required: false
            maps_to: material_threshold_pct
            default: 10.0
            description: "Material holding threshold - highlighted in visualization. Default 10%."
          - name: significant-threshold-pct
            type: decimal
            required: false
            maps_to: significant_threshold_pct
            default: 25.0
            description: "Significant holding threshold - blocking minority indicator (⚡). Default 25%."
          - name: control-threshold-pct
            type: decimal
            required: false
            maps_to: control_threshold_pct
            default: 50.0
            description: "Control threshold - creates control edge, majority shareholder. Default 50%."
          - name: control-basis
            type: string
            required: false
            maps_to: control_basis
            default: VOTES
            description: "Basis for control calculation (VOTES, ECONOMIC, UNITS). Determines which rights are counted for thresholds."
            validation:
              enum:
                - VOTES
                - ECONOMIC
                - UNITS
          - name: disclosure-basis
            type: string
            required: false
            maps_to: disclosure_basis
            default: ECONOMIC
            description: "Basis for disclosure calculation (VOTES, ECONOMIC, UNITS). US typically uses economic, EU often uses voting."
            validation:
              enum:
                - VOTES
                - ECONOMIC
                - UNITS
          - name: effective-from
            type: date
            required: false
            maps_to: effective_from
            description: "Effective date for this configuration. Defaults to today."
        returns:
          type: uuid
          name: config_id
          capture: true

      read:
        description: |
          Read the current control/disclosure thresholds for an issuer.

          Returns the active configuration including all threshold levels
          and look-through parameters.
        metadata:
          tier: diagnostics
          source_of_truth: register
          scope: cbu
          noun: issuer_control_config
        invocation_phrases:
          - "get control thresholds"
          - "read issuer config"
          - "what are the thresholds"
          - "check disclosure threshold"
        behavior: crud
        crud:
          operation: select
          table: issuer_control_config
          schema: kyc
          where_clause: "effective_to IS NULL"
        args:
          - name: issuer-entity-id
            type: uuid
            required: true
            maps_to: issuer_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
        returns:
          type: record
