# ============================================================================
# Capital Structure Verbs
# ============================================================================
# Issuer-side supply management: share classes, issuance, splits, buybacks,
# dilution instruments (options, warrants, SAFEs), control configuration.

domains:
  capital:
    description: Capital structure management - share classes, issuance events, dilution instruments

    verbs:
      # --------------------------------------------------------------------------
      # Share Class Management
      # --------------------------------------------------------------------------

      share-class.create:
        description: Create a new share class for an issuer
        behavior: plugin
        plugin:
          handler: CapitalShareClassCreateOp
        args:
          - name: issuer-entity-id
            type: uuid
            required: true
            description: The issuing entity
            lookup:
              table: entities
              schema: ob-poc
              entity_type: entity
              search_key: name
              primary_key: entity_id
          - name: name
            type: string
            required: true
            description: Share class name (e.g., "Series A Preferred")
          - name: instrument-kind
            type: string
            required: true
            description: Type of instrument
            validation:
              enum:
                - ORDINARY_EQUITY
                - PREFERENCE_EQUITY
                - DEFERRED_EQUITY
                - FUND_UNIT
                - FUND_SHARE
                - LP_INTEREST
                - GP_INTEREST
                - DEBT
                - CONVERTIBLE
                - WARRANT
                - OTHER
          - name: votes-per-unit
            type: decimal
            required: false
            default: "1.0"
            description: "0 = non-voting, 1 = standard, >1 = super-voting"
          - name: economic-per-unit
            type: decimal
            required: false
            default: "1.0"
          - name: currency
            type: string
            required: false
            default: "EUR"
          - name: authorized-units
            type: decimal
            required: false
            description: Maximum units that can be issued
          - name: cbu-id
            type: uuid
            required: false
            description: Optional CBU association
            lookup:
              table: cbus
              schema: ob-poc
              entity_type: cbu
              search_key: name
              primary_key: cbu_id
        returns:
          type: uuid
          name: share_class_id
          capture: true
        produces:
          type: share_class

      share-class.add-identifier:
        description: Add an identifier (ISIN, SEDOL, etc.) to a share class
        behavior: crud
        crud:
          operation: insert
          table: share_class_identifiers
          schema: kyc
          returning: identifier_id
        args:
          - name: share-class-id
            type: uuid
            required: true
            maps_to: share_class_id
            lookup:
              table: share_classes
              schema: kyc
              search_key: name
              primary_key: id
          - name: scheme
            type: string
            required: true
            maps_to: scheme_code
            validation:
              enum:
                - ISIN
                - SEDOL
                - CUSIP
                - FIGI
                - LEI
                - INTERNAL
                - FUND_ADMIN
                - REGISTRY
                - TA_REF
          - name: value
            type: string
            required: true
            maps_to: identifier_value
          - name: is-primary
            type: boolean
            required: false
            default: false
            maps_to: is_primary
          - name: source
            type: string
            required: false
            maps_to: source
        returns:
          type: uuid
          name: identifier_id
          capture: true

      share-class.list:
        description: List share classes for an issuer
        behavior: crud
        crud:
          operation: list_by_fk
          table: share_classes
          schema: kyc
          fk_col: issuer_entity_id
        args:
          - name: issuer-entity-id
            type: uuid
            required: true
            maps_to: issuer_entity_id
            lookup:
              table: entities
              schema: ob-poc
              entity_type: entity
              search_key: name
              primary_key: entity_id
        returns:
          type: record_set

      share-class.get-supply:
        description: Get current supply state for a share class
        behavior: plugin
        plugin:
          handler: CapitalShareClassGetSupplyOp
        args:
          - name: share-class-id
            type: uuid
            required: true
            lookup:
              table: share_classes
              schema: kyc
              search_key: name
              primary_key: id
          - name: as-of
            type: date
            required: false
            description: Date for as-of query (defaults to today)
        returns:
          type: record

      # --------------------------------------------------------------------------
      # Issuance Events
      # --------------------------------------------------------------------------

      issue.initial:
        description: Initial issuance of shares (incorporation/fund launch)
        behavior: plugin
        plugin:
          handler: CapitalIssueInitialOp
        args:
          - name: share-class-id
            type: uuid
            required: true
            lookup:
              table: share_classes
              schema: kyc
              search_key: name
              primary_key: id
          - name: units
            type: decimal
            required: true
          - name: price-per-unit
            type: decimal
            required: false
          - name: effective-date
            type: date
            required: false
            description: Defaults to today
          - name: board-resolution-ref
            type: string
            required: false
        returns:
          type: uuid
          name: event_id
          capture: true
        produces:
          type: issuance_event

      issue.new:
        description: Subsequent issuance (capital raise)
        behavior: plugin
        plugin:
          handler: CapitalIssueNewOp
        args:
          - name: share-class-id
            type: uuid
            required: true
            lookup:
              table: share_classes
              schema: kyc
              search_key: name
              primary_key: id
          - name: units
            type: decimal
            required: true
          - name: price-per-unit
            type: decimal
            required: true
          - name: effective-date
            type: date
            required: false
          - name: board-resolution-ref
            type: string
            required: false
        returns:
          type: uuid
          name: event_id
          capture: true
        produces:
          type: issuance_event

      split:
        description: Stock split (e.g., 2:1 doubles shares)
        metadata:
          tier: intent
          source_of_truth: register
          scope: cbu
          noun: capital
        behavior: plugin
        plugin:
          handler: CapitalSplitOp
        args:
          - name: share-class-id
            type: uuid
            required: true
            lookup:
              table: share_classes
              schema: kyc
              search_key: name
              primary_key: id
          - name: ratio-from
            type: integer
            required: true
            description: "Original shares (e.g., 1 in 2:1 split)"
          - name: ratio-to
            type: integer
            required: true
            description: "New shares (e.g., 2 in 2:1 split)"
          - name: effective-date
            type: date
            required: false
          - name: record-date
            type: date
            required: false
        returns:
          type: uuid
          name: event_id
          capture: true
        produces:
          type: issuance_event

      buyback:
        description: Share buyback into treasury
        metadata:
          tier: intent
          source_of_truth: register
          scope: cbu
          noun: capital
        behavior: plugin
        plugin:
          handler: CapitalBuybackOp
        args:
          - name: share-class-id
            type: uuid
            required: true
            lookup:
              table: share_classes
              schema: kyc
              search_key: name
              primary_key: id
          - name: units
            type: decimal
            required: true
          - name: price-per-unit
            type: decimal
            required: true
          - name: effective-date
            type: date
            required: false
        returns:
          type: uuid
          name: event_id
          capture: true
        produces:
          type: issuance_event

      cancel:
        description: Permanent share cancellation
        metadata:
          tier: intent
          source_of_truth: register
          scope: cbu
          noun: capital
        behavior: plugin
        plugin:
          handler: CapitalCancelOp
        args:
          - name: share-class-id
            type: uuid
            required: true
            lookup:
              table: share_classes
              schema: kyc
              search_key: name
              primary_key: id
          - name: units
            type: decimal
            required: true
          - name: effective-date
            type: date
            required: false
          - name: reason
            type: string
            required: false
        returns:
          type: uuid
          name: event_id
          capture: true
        produces:
          type: issuance_event

      # --------------------------------------------------------------------------
      # Dilution Instruments (Options, Warrants, Convertibles)
      # --------------------------------------------------------------------------

      dilution.grant-options:
        description: Grant stock options to a holder
        behavior: plugin
        plugin:
          handler: CapitalDilutionGrantOptionsOp
        args:
          - name: issuer-entity-id
            type: uuid
            required: true
            lookup:
              table: entities
              schema: ob-poc
              entity_type: entity
              search_key: name
              primary_key: entity_id
          - name: converts-to-share-class-id
            type: uuid
            required: true
            description: Share class these options convert into
            lookup:
              table: share_classes
              schema: kyc
              search_key: name
              primary_key: id
          - name: holder-entity-id
            type: uuid
            required: true
            lookup:
              table: entities
              schema: ob-poc
              entity_type: entity
              search_key: name
              primary_key: entity_id
          - name: units
            type: decimal
            required: true
            description: Number of options granted
          - name: exercise-price
            type: decimal
            required: true
          - name: exercise-currency
            type: string
            required: false
            default: "USD"
          - name: vesting-start-date
            type: date
            required: false
          - name: vesting-end-date
            type: date
            required: false
            description: Fully vested by this date
          - name: vesting-cliff-months
            type: integer
            required: false
            default: 12
          - name: expiration-date
            type: date
            required: true
          - name: plan-name
            type: string
            required: false
        returns:
          type: uuid
          name: instrument_id
          capture: true
        produces:
          type: dilution_instrument

      dilution.issue-warrant:
        description: Issue warrants to an investor
        behavior: plugin
        plugin:
          handler: CapitalDilutionIssueWarrantOp
        args:
          - name: issuer-entity-id
            type: uuid
            required: true
            lookup:
              table: entities
              schema: ob-poc
              entity_type: entity
              search_key: name
              primary_key: entity_id
          - name: converts-to-share-class-id
            type: uuid
            required: true
            lookup:
              table: share_classes
              schema: kyc
              search_key: name
              primary_key: id
          - name: holder-entity-id
            type: uuid
            required: true
            lookup:
              table: entities
              schema: ob-poc
              entity_type: entity
              search_key: name
              primary_key: entity_id
          - name: units
            type: decimal
            required: true
          - name: exercise-price
            type: decimal
            required: true
          - name: exercisable-from
            type: date
            required: false
          - name: expiration-date
            type: date
            required: true
        returns:
          type: uuid
          name: instrument_id
          capture: true
        produces:
          type: dilution_instrument

      dilution.create-safe:
        description: Create a SAFE (Simple Agreement for Future Equity)
        behavior: plugin
        plugin:
          handler: CapitalDilutionCreateSafeOp
        args:
          - name: issuer-entity-id
            type: uuid
            required: true
            lookup:
              table: entities
              schema: ob-poc
              entity_type: entity
              search_key: name
              primary_key: entity_id
          - name: converts-to-share-class-id
            type: uuid
            required: false
            description: May be NULL until priced round
            lookup:
              table: share_classes
              schema: kyc
              search_key: name
              primary_key: id
          - name: holder-entity-id
            type: uuid
            required: true
            lookup:
              table: entities
              schema: ob-poc
              entity_type: entity
              search_key: name
              primary_key: entity_id
          - name: principal-amount
            type: decimal
            required: true
          - name: valuation-cap
            type: decimal
            required: false
          - name: discount-pct
            type: decimal
            required: false
            description: Discount to next round price (e.g., 20 for 20%)
        returns:
          type: uuid
          name: instrument_id
          capture: true
        produces:
          type: dilution_instrument

      dilution.create-convertible-note:
        description: Create a convertible note
        behavior: plugin
        plugin:
          handler: CapitalDilutionCreateConvertibleNoteOp
        args:
          - name: issuer-entity-id
            type: uuid
            required: true
            lookup:
              table: entities
              schema: ob-poc
              entity_type: entity
              search_key: name
              primary_key: entity_id
          - name: converts-to-share-class-id
            type: uuid
            required: false
            lookup:
              table: share_classes
              schema: kyc
              search_key: name
              primary_key: id
          - name: holder-entity-id
            type: uuid
            required: true
            lookup:
              table: entities
              schema: ob-poc
              entity_type: entity
              search_key: name
              primary_key: entity_id
          - name: principal-amount
            type: decimal
            required: true
          - name: valuation-cap
            type: decimal
            required: false
          - name: discount-pct
            type: decimal
            required: false
          - name: expiration-date
            type: date
            required: true
        returns:
          type: uuid
          name: instrument_id
          capture: true
        produces:
          type: dilution_instrument

      dilution.exercise:
        description: Exercise options/warrants and convert to shares
        behavior: plugin
        plugin:
          handler: CapitalDilutionExerciseOp
        args:
          - name: instrument-id
            type: uuid
            required: true
            lookup:
              table: dilution_instruments
              schema: kyc
              search_key: instrument_id
              primary_key: instrument_id
          - name: units
            type: decimal
            required: true
            description: Number of instruments to exercise
          - name: exercise-date
            type: date
            required: false
          - name: is-cashless
            type: boolean
            required: false
            default: false
            description: Cashless/net exercise (shares withheld for cost)
        returns:
          type: uuid
          name: exercise_id
          capture: true
        produces:
          type: dilution_exercise_event

      dilution.forfeit:
        description: Forfeit/cancel unvested or unexercised instruments
        behavior: plugin
        plugin:
          handler: CapitalDilutionForfeitOp
        args:
          - name: instrument-id
            type: uuid
            required: true
            lookup:
              table: dilution_instruments
              schema: kyc
              search_key: instrument_id
              primary_key: instrument_id
          - name: units
            type: decimal
            required: true
          - name: reason
            type: string
            required: false
        returns:
          type: affected

      dilution.list:
        description: List dilution instruments for an issuer
        behavior: plugin
        plugin:
          handler: CapitalDilutionListOp
        args:
          - name: issuer-entity-id
            type: uuid
            required: true
            lookup:
              table: entities
              schema: ob-poc
              entity_type: entity
              search_key: name
              primary_key: entity_id
          - name: status
            type: string
            required: false
            default: "ACTIVE"
            validation:
              enum:
                - ACTIVE
                - EXERCISED
                - EXPIRED
                - FORFEITED
                - CANCELLED
                - ALL
          - name: instrument-type
            type: string
            required: false
            validation:
              enum:
                - STOCK_OPTION
                - WARRANT
                - CONVERTIBLE_NOTE
                - SAFE
                - RSU
                - ALL
        returns:
          type: record_set

      dilution.get-summary:
        description: Get dilution summary for an issuer
        behavior: plugin
        plugin:
          handler: CapitalDilutionGetSummaryOp
        args:
          - name: issuer-entity-id
            type: uuid
            required: true
            lookup:
              table: entities
              schema: ob-poc
              entity_type: entity
              search_key: name
              primary_key: entity_id
        returns:
          type: record

      # --------------------------------------------------------------------------
      # Control Configuration
      # --------------------------------------------------------------------------

      control-config.set:
        description: Set control thresholds for an issuer
        behavior: crud
        crud:
          operation: upsert
          table: issuer_control_config
          schema: kyc
          returning: config_id
          conflict_keys:
            - issuer_entity_id
            - effective_from
        args:
          - name: issuer-entity-id
            type: uuid
            required: true
            maps_to: issuer_entity_id
            lookup:
              table: entities
              schema: ob-poc
              entity_type: entity
              search_key: name
              primary_key: entity_id
          - name: control-threshold-pct
            type: decimal
            required: false
            default: "50"
            maps_to: control_threshold_pct
          - name: significant-threshold-pct
            type: decimal
            required: false
            default: "25"
            maps_to: significant_threshold_pct
          - name: material-threshold-pct
            type: decimal
            required: false
            default: "10"
            maps_to: material_threshold_pct
          - name: disclosure-threshold-pct
            type: decimal
            required: false
            default: "5"
            maps_to: disclosure_threshold_pct
          - name: control-basis
            type: string
            required: false
            default: "VOTES"
            maps_to: control_basis
            validation:
              enum:
                - VOTES
                - ECONOMIC
                - UNITS
          - name: voting-basis
            type: string
            required: false
            default: "OUTSTANDING"
            maps_to: voting_basis
            validation:
              enum:
                - ISSUED
                - OUTSTANDING
                - FULLY_DILUTED
                - EXERCISABLE
          - name: jurisdiction
            type: string
            required: false
            maps_to: jurisdiction
          - name: effective-from
            type: date
            required: false
            maps_to: effective_from
        defaults:
          effective_from: CURRENT_DATE
        returns:
          type: uuid
          name: config_id
          capture: true

      control-config.get:
        description: Get control configuration for an issuer
        behavior: crud
        crud:
          operation: select
          table: issuer_control_config
          schema: kyc
          filter:
            effective_to: null
        args:
          - name: issuer-entity-id
            type: uuid
            required: true
            maps_to: issuer_entity_id
            lookup:
              table: entities
              schema: ob-poc
              entity_type: entity
              search_key: name
              primary_key: entity_id
        returns:
          type: record

      # --------------------------------------------------------------------------
      # Cap Table Queries
      # --------------------------------------------------------------------------

      cap-table:
        description: Get full cap table for an issuer
        metadata:
          tier: intent
          source_of_truth: register
          scope: cbu
          noun: capital
        behavior: plugin
        plugin:
          handler: CapitalCapTableOp
        args:
          - name: issuer-entity-id
            type: uuid
            required: true
            lookup:
              table: entities
              schema: ob-poc
              entity_type: entity
              search_key: name
              primary_key: entity_id
          - name: as-of
            type: date
            required: false
            description: Date for as-of query
          - name: basis
            type: string
            required: false
            default: "OUTSTANDING"
            description: Computation basis
            validation:
              enum:
                - ISSUED
                - OUTSTANDING
                - FULLY_DILUTED
                - EXERCISABLE
          - name: include-dilution
            type: boolean
            required: false
            default: true
        returns:
          type: record

      holders:
        description: List all holders for an issuer with ownership percentages
        metadata:
          tier: intent
          source_of_truth: register
          scope: cbu
          noun: capital
        behavior: plugin
        plugin:
          handler: CapitalHoldersOp
        args:
          - name: issuer-entity-id
            type: uuid
            required: true
            lookup:
              table: entities
              schema: ob-poc
              entity_type: entity
              search_key: name
              primary_key: entity_id
          - name: as-of
            type: date
            required: false
          - name: min-pct
            type: decimal
            required: false
            description: Filter to holdings above this percentage
        returns:
          type: record_set
