domains:
  entity:
    description: Entity management operations
    dynamic_verbs:
      - pattern: create-{type_code}
        source:
          table: entity_types
          schema: ob-poc
          code_column: type_code
          name_column: name
          transform: kebab_case
        behavior: crud
        crud:
          operation: entity_create
          base_table: entities
          schema: ob-poc
          extension_table_column: table_name
          type_id_column: entity_type_id
          returning: entity_id
        base_args:
          - name: name
            type: string
            required: true
            maps_to: name
          - name: jurisdiction
            type: string
            required: false
            maps_to: jurisdiction
    verbs:
      create-limited-company:
        description: Create a limited company entity
        behavior: crud
        metadata:
          tier: intent
          source_of_truth: entity
          scope: global
          noun: entity
          tags: [lifecycle, creation]
        produces:
          type: entity
          subtype: limited_company
          resolved: false
        crud:
          operation: entity_create
          base_table: entities
          schema: ob-poc
          extension_table_column: table_name
          type_id_column: entity_type_id
          returning: entity_id
        args:
          - name: name
            type: string
            required: true
            maps_to: company_name
          - name: cbu-id
            type: uuid
            required: false
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: company-number
            type: string
            required: false
            maps_to: registration_number
          - name: jurisdiction
            type: string
            required: false
            maps_to: jurisdiction
        returns:
          type: uuid
          name: entity_id
          capture: true
      create-proper-person:
        description: Create a natural person entity
        behavior: crud
        metadata:
          tier: intent
          source_of_truth: entity
          scope: global
          noun: entity
          tags: [lifecycle, creation]
        produces:
          type: entity
          subtype: proper_person
          resolved: false
        crud:
          operation: entity_create
          base_table: entities
          schema: ob-poc
          extension_table_column: table_name
          type_id_column: entity_type_id
          returning: entity_id
        args:
          - name: first-name
            type: string
            required: true
            maps_to: first_name
          - name: last-name
            type: string
            required: true
            maps_to: last_name
          - name: cbu-id
            type: uuid
            required: false
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: date-of-birth
            type: date
            required: false
            maps_to: date_of_birth
          - name: nationality
            type: string
            required: false
            maps_to: nationality
        returns:
          type: uuid
          name: entity_id
          capture: true
      create-trust-discretionary:
        description: Create a discretionary trust entity
        behavior: crud
        metadata:
          tier: intent
          source_of_truth: entity
          scope: global
          noun: entity
          tags: [lifecycle, creation]
        produces:
          type: entity
          subtype: trust
          resolved: false
        crud:
          operation: entity_create
          base_table: entities
          schema: ob-poc
          extension_table_column: table_name
          type_id_column: entity_type_id
          returning: entity_id
        args:
          - name: name
            type: string
            required: true
            maps_to: trust_name
          - name: cbu-id
            type: uuid
            required: false
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: jurisdiction
            type: string
            required: true
            maps_to: jurisdiction
          - name: establishment-date
            type: date
            required: false
            maps_to: establishment_date
          - name: trust-purpose
            type: string
            required: false
            maps_to: trust_purpose
        returns:
          type: uuid
          name: entity_id
          capture: true
      create-partnership-limited:
        description: Create a limited partnership entity
        behavior: crud
        metadata:
          tier: intent
          source_of_truth: entity
          scope: global
          noun: entity
          tags: [lifecycle, creation]
        produces:
          type: entity
          subtype: partnership
          resolved: false
        crud:
          operation: entity_create
          base_table: entities
          schema: ob-poc
          extension_table_column: table_name
          type_id_column: entity_type_id
          returning: entity_id
        args:
          - name: name
            type: string
            required: true
            maps_to: partnership_name
          - name: cbu-id
            type: uuid
            required: false
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: jurisdiction
            type: string
            required: false
            maps_to: jurisdiction
          - name: formation-date
            type: date
            required: false
            maps_to: formation_date
        returns:
          type: uuid
          name: entity_id
          capture: true

      # =========================================================================
      # ENSURE (UPSERT) VERBS - Idempotent entity creation
      # =========================================================================

      ensure-limited-company:
        description: Create or update a limited company entity (idempotent by name)
        behavior: crud
        metadata:
          tier: intent
          source_of_truth: entity
          scope: global
          noun: entity
          tags: [lifecycle, upsert]
        produces:
          type: entity
          subtype: limited_company
          resolved: false
        crud:
          operation: entity_upsert
          base_table: entities
          schema: ob-poc
          extension_table_column: table_name
          type_id_column: entity_type_id
          returning: entity_id
        args:
          - name: name
            type: string
            required: true
            maps_to: company_name
          - name: cbu-id
            type: uuid
            required: false
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: company-number
            type: string
            required: false
            maps_to: registration_number
          - name: jurisdiction
            type: string
            required: false
            maps_to: jurisdiction
        returns:
          type: uuid
          name: entity_id
          capture: true

      ensure-proper-person:
        description: Create or update a natural person entity (idempotent by name)
        behavior: crud
        metadata:
          tier: intent
          source_of_truth: entity
          scope: global
          noun: entity
          tags: [lifecycle, upsert]
        produces:
          type: entity
          subtype: proper_person
          resolved: false
        crud:
          operation: entity_upsert
          base_table: entities
          schema: ob-poc
          extension_table_column: table_name
          type_id_column: entity_type_id
          returning: entity_id
        args:
          - name: first-name
            type: string
            required: true
            maps_to: first_name
          - name: last-name
            type: string
            required: true
            maps_to: last_name
          - name: cbu-id
            type: uuid
            required: false
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: date-of-birth
            type: date
            required: false
            maps_to: date_of_birth
          - name: nationality
            type: string
            required: false
            maps_to: nationality
        returns:
          type: uuid
          name: entity_id
          capture: true

      ensure-trust-discretionary:
        description: Create or update a discretionary trust entity (idempotent by name)
        behavior: crud
        metadata:
          tier: intent
          source_of_truth: entity
          scope: global
          noun: entity
          tags: [lifecycle, upsert]
        produces:
          type: entity
          subtype: trust
          resolved: false
        crud:
          operation: entity_upsert
          base_table: entities
          schema: ob-poc
          extension_table_column: table_name
          type_id_column: entity_type_id
          returning: entity_id
        args:
          - name: name
            type: string
            required: true
            maps_to: trust_name
          - name: cbu-id
            type: uuid
            required: false
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: jurisdiction
            type: string
            required: true
            maps_to: jurisdiction
          - name: establishment-date
            type: date
            required: false
            maps_to: establishment_date
          - name: trust-purpose
            type: string
            required: false
            maps_to: trust_purpose
        returns:
          type: uuid
          name: entity_id
          capture: true

      ensure-partnership-limited:
        description: Create or update a limited partnership entity (idempotent by name)
        behavior: crud
        metadata:
          tier: intent
          source_of_truth: entity
          scope: global
          noun: entity
          tags: [lifecycle, upsert]
        produces:
          type: entity
          subtype: partnership
          resolved: false
        crud:
          operation: entity_upsert
          base_table: entities
          schema: ob-poc
          extension_table_column: table_name
          type_id_column: entity_type_id
          returning: entity_id
        args:
          - name: name
            type: string
            required: true
            maps_to: partnership_name
          - name: cbu-id
            type: uuid
            required: false
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: jurisdiction
            type: string
            required: false
            maps_to: jurisdiction
          - name: formation-date
            type: date
            required: false
            maps_to: formation_date
        returns:
          type: uuid
          name: entity_id
          capture: true

      read:
        description: Read an entity by ID
        behavior: crud
        metadata:
          tier: diagnostics
          source_of_truth: entity
          noun: entity
          tags: [query]
        crud:
          operation: select
          table: entities
          schema: ob-poc
        args:
          - name: entity-id
            type: uuid
            required: true
            maps_to: entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
        returns:
          type: record
      update:
        description: Update an entity's base fields
        behavior: crud
        metadata:
          tier: intent
          source_of_truth: entity
          scope: global
          noun: entity
          tags: [lifecycle, modification]
        crud:
          operation: update
          table: entities
          schema: ob-poc
          key: entity_id
        args:
          - name: entity-id
            type: uuid
            required: true
            maps_to: entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: name
            type: string
            required: false
            maps_to: name
          - name: status
            type: string
            required: false
            maps_to: status
          - name: jurisdiction
            type: string
            required: false
            maps_to: jurisdiction
        returns:
          type: affected
      delete:
        description: Delete an entity (cascades to type extension)
        behavior: crud
        metadata:
          tier: intent
          source_of_truth: entity
          scope: global
          noun: entity
          tags: [lifecycle, deletion]
        crud:
          operation: delete
          table: entities
          schema: ob-poc
          key: entity_id
        args:
          - name: entity-id
            type: uuid
            required: true
            maps_to: entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
        returns:
          type: affected
      list:
        description: List entities with optional filters
        behavior: crud
        metadata:
          tier: diagnostics
          source_of_truth: entity
          noun: entity
          tags: [query, listing]
        crud:
          operation: select
          table: entities
          schema: ob-poc
        args:
          - name: entity-type
            type: string
            required: false
          - name: jurisdiction
            type: string
            required: false
            maps_to: jurisdiction
          - name: status
            type: string
            required: false
            maps_to: status
          - name: limit
            type: integer
            required: false
            default: 100
          - name: offset
            type: integer
            required: false
            default: 0
        returns:
          type: record_set

      query:
        description: Query entities for batch template iteration (returns entity refs, not records)
        behavior: plugin
        metadata:
          tier: diagnostics
          source_of_truth: entity
          noun: entity
          tags: [query, batch]
        plugin:
          handler: entity_query
        args:
          - name: type
            type: string
            required: false
            description: Entity type filter (fund, proper_person, limited_company, etc.)
          - name: name-like
            type: string
            required: false
            description: Name pattern for ILIKE search (supports % wildcards)
          - name: jurisdiction
            type: string
            required: false
            description: Jurisdiction code filter
          - name: limit
            type: integer
            required: false
            default: 1000
            description: Maximum number of results
        returns:
          type: entity_query_result
          description: List of (entity_id, name) tuples for batch iteration
          capture: true

      # =========================================================================
      # GHOST ENTITY VERBS - Progressive refinement workflow
      # =========================================================================

      ghost:
        description: Create a ghost person entity (name only, minimal attributes)
        behavior: plugin
        metadata:
          tier: intent
          source_of_truth: entity
          scope: global
          noun: entity
          tags: [lifecycle, ghost, creation]
        plugin:
          handler: entity_ghost
        produces:
          type: entity
          subtype: proper_person
          resolved: false
        args:
          - name: name
            type: string
            required: true
            description: Full name as discovered (e.g., "John Smith" from document)
          - name: source
            type: string
            required: false
            description: Discovery source (document, ownership_chain, allegation, gleif)
          - name: source-reference
            type: string
            required: false
            description: Reference to source (document_id, relationship_id, etc.)
          - name: notes
            type: string
            required: false
            description: Context notes about the ghost entity
        returns:
          type: uuid
          name: entity_id
          capture: true

      identify:
        description: Add identifying attributes to a ghost entity (transitions to IDENTIFIED state)
        behavior: plugin
        metadata:
          tier: intent
          source_of_truth: entity
          scope: global
          noun: entity
          tags: [lifecycle, ghost, identification]
        plugin:
          handler: entity_identify
        args:
          - name: entity-id
            type: uuid
            required: true
            lookup:
              table: entity_proper_persons
              entity_type: proper_person
              schema: ob-poc
              # Composite search: name + nationality (usually captured first) + DOB (year approx or exact)
              search_key: "(search_name (nationality :selectivity 0.7) (date_of_birth :selectivity 0.95 :match-mode year-or-exact))"
              primary_key: entity_id
          - name: first-name
            type: string
            required: false
            description: First name (if splitting from full name)
          - name: last-name
            type: string
            required: false
            description: Last name (if splitting from full name)
          - name: date-of-birth
            type: date
            required: false
            description: Date of birth
          - name: nationality
            type: string
            required: false
            description: Nationality/citizenship
          - name: id-document-type
            type: string
            required: false
            description: ID document type (PASSPORT, NATIONAL_ID, etc.)
          - name: id-document-number
            type: string
            required: false
            description: ID document number
        returns:
          type: uuid
          name: entity_id

      verify:
        description: Mark an identified entity as verified (transitions to VERIFIED state)
        behavior: crud
        metadata:
          tier: intent
          source_of_truth: entity
          scope: global
          noun: entity
          tags: [lifecycle, ghost, verification]
        crud:
          operation: update
          table: entity_proper_persons
          schema: ob-poc
        args:
          - name: entity-id
            type: uuid
            required: true
            lookup:
              table: entity_proper_persons
              entity_type: proper_person
              schema: ob-poc
              # Composite search: name + nationality + DOB discriminators
              search_key: "(search_name (nationality :selectivity 0.7) (date_of_birth :selectivity 0.95 :match-mode year-or-exact))"
              primary_key: entity_id
          - name: verification-notes
            type: string
            required: false
            description: Notes about how verification was completed
        returns:
          type: affected

      list-ghosts:
        description: List ghost entities requiring identification
        behavior: crud
        metadata:
          tier: diagnostics
          source_of_truth: entity
          noun: entity
          tags: [query, ghost, listing]
        crud:
          operation: select
          table: entity_proper_persons
          schema: ob-poc
          where_clause: "person_state = 'GHOST'"
        args:
          - name: limit
            type: integer
            required: false
            default: 100
          - name: offset
            type: integer
            required: false
            default: 0
        returns:
          type: record_set
