domains:
  entity:
    description: Entity management operations
    invocation_hints:
      - entity
      - company
      - person
      - counterparty
      - director
      - UBO
    dynamic_verbs:
      - pattern: create-{type_code}
        source:
          table: entity_types
          schema: ob-poc
          code_column: type_code
          name_column: name
          transform: kebab_case
        behavior: crud
        crud:
          operation: entity_create
          base_table: entities
          schema: ob-poc
          extension_table_column: table_name
          type_id_column: entity_type_id
          returning: entity_id
        base_args:
          - name: name
            type: string
            required: true
            maps_to: name
          - name: jurisdiction
            type: string
            required: false
            maps_to: jurisdiction
    verbs:
      create-limited-company:
        description: Create a limited company entity
        behavior: crud
        invocation_phrases:
          - create company
          - add company
          - create limited company
          - register company
        metadata:
          tier: intent
          source_of_truth: entity
          scope: global
          noun: entity
          tags: [lifecycle, creation, onboarding]
        produces:
          type: entity
          subtype: limited_company
          resolved: false
        crud:
          operation: entity_create
          base_table: entities
          schema: ob-poc
          extension_table_column: table_name
          type_id_column: entity_type_id
          returning: entity_id
        args:
          - name: name
            type: string
            required: true
            maps_to: company_name
          - name: cbu-id
            type: uuid
            required: false
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: company-number
            type: string
            required: false
            maps_to: registration_number
          - name: jurisdiction
            type: string
            required: false
            maps_to: jurisdiction
        returns:
          type: uuid
          name: entity_id
          capture: true
      create-proper-person:
        description: Create a natural person entity
        behavior: crud
        invocation_phrases:
          - create person
          - add person
          - add individual
          - create individual
        metadata:
          tier: intent
          source_of_truth: entity
          scope: global
          noun: entity
          tags: [lifecycle, creation, onboarding]
        produces:
          type: entity
          subtype: proper_person
          resolved: false
        crud:
          operation: entity_create
          base_table: entities
          schema: ob-poc
          extension_table_column: table_name
          type_id_column: entity_type_id
          returning: entity_id
        args:
          - name: first-name
            type: string
            required: true
            maps_to: first_name
          - name: last-name
            type: string
            required: true
            maps_to: last_name
          - name: cbu-id
            type: uuid
            required: false
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: date-of-birth
            type: date
            required: false
            maps_to: date_of_birth
          - name: nationality
            type: string
            required: false
            maps_to: nationality
        returns:
          type: uuid
          name: entity_id
          capture: true
      create-trust-discretionary:
        description: Create a discretionary trust entity
        behavior: crud
        metadata:
          tier: intent
          source_of_truth: entity
          scope: global
          noun: entity
          tags: [lifecycle, creation, onboarding]
        produces:
          type: entity
          subtype: trust
          resolved: false
        crud:
          operation: entity_create
          base_table: entities
          schema: ob-poc
          extension_table_column: table_name
          type_id_column: entity_type_id
          returning: entity_id
        args:
          - name: name
            type: string
            required: true
            maps_to: trust_name
          - name: cbu-id
            type: uuid
            required: false
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: jurisdiction
            type: string
            required: true
            maps_to: jurisdiction
          - name: establishment-date
            type: date
            required: false
            maps_to: establishment_date
          - name: trust-purpose
            type: string
            required: false
            maps_to: trust_purpose
        returns:
          type: uuid
          name: entity_id
          capture: true
      create-partnership-limited:
        description: Create a limited partnership entity
        behavior: crud
        metadata:
          tier: intent
          source_of_truth: entity
          scope: global
          noun: entity
          tags: [lifecycle, creation, onboarding]
        produces:
          type: entity
          subtype: partnership
          resolved: false
        crud:
          operation: entity_create
          base_table: entities
          schema: ob-poc
          extension_table_column: table_name
          type_id_column: entity_type_id
          returning: entity_id
        args:
          - name: name
            type: string
            required: true
            maps_to: partnership_name
          - name: cbu-id
            type: uuid
            required: false
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: jurisdiction
            type: string
            required: false
            maps_to: jurisdiction
          - name: formation-date
            type: date
            required: false
            maps_to: formation_date
        returns:
          type: uuid
          name: entity_id
          capture: true

      # =========================================================================
      # ENSURE (UPSERT) VERBS - Idempotent entity creation
      # =========================================================================

      ensure-limited-company:
        description: Create or update a limited company entity (idempotent by name)
        behavior: crud
        invocation_phrases:
          - "ensure company"
          - "add or update company"
          - "upsert company"
          - "ensure counterparty"
        metadata:
          tier: intent
          source_of_truth: entity
          scope: global
          noun: entity
          tags: [lifecycle, upsert, onboarding]
        produces:
          type: entity
          subtype: limited_company
          resolved: false
        crud:
          operation: entity_upsert
          base_table: entities
          schema: ob-poc
          extension_table_column: table_name
          type_id_column: entity_type_id
          returning: entity_id
        args:
          - name: name
            type: string
            required: true
            maps_to: company_name
          - name: cbu-id
            type: uuid
            required: false
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: company-number
            type: string
            required: false
            maps_to: registration_number
          - name: jurisdiction
            type: string
            required: false
            maps_to: jurisdiction
          - name: lei
            type: string
            required: false
            maps_to: lei
            description: Legal Entity Identifier (LEI) from GLEIF
        returns:
          type: uuid
          name: entity_id
          capture: true

      ensure-proper-person:
        description: Create or update a natural person entity (idempotent by name)
        behavior: crud
        invocation_phrases:
          - "ensure person"
          - "add or update person"
          - "upsert person"
        metadata:
          tier: intent
          source_of_truth: entity
          scope: global
          noun: entity
          tags: [lifecycle, upsert, onboarding]
        produces:
          type: entity
          subtype: proper_person
          resolved: false
        crud:
          operation: entity_upsert
          base_table: entities
          schema: ob-poc
          extension_table_column: table_name
          type_id_column: entity_type_id
          returning: entity_id
        args:
          - name: first-name
            type: string
            required: true
            maps_to: first_name
          - name: last-name
            type: string
            required: true
            maps_to: last_name
          - name: cbu-id
            type: uuid
            required: false
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: date-of-birth
            type: date
            required: false
            maps_to: date_of_birth
          - name: nationality
            type: string
            required: false
            maps_to: nationality
        returns:
          type: uuid
          name: entity_id
          capture: true

      ensure-trust-discretionary:
        description: Create or update a discretionary trust entity (idempotent by name)
        behavior: crud
        metadata:
          tier: intent
          source_of_truth: entity
          scope: global
          noun: entity
          tags: [lifecycle, upsert, onboarding]
        produces:
          type: entity
          subtype: trust
          resolved: false
        crud:
          operation: entity_upsert
          base_table: entities
          schema: ob-poc
          extension_table_column: table_name
          type_id_column: entity_type_id
          returning: entity_id
        args:
          - name: name
            type: string
            required: true
            maps_to: trust_name
          - name: cbu-id
            type: uuid
            required: false
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: jurisdiction
            type: string
            required: true
            maps_to: jurisdiction
          - name: establishment-date
            type: date
            required: false
            maps_to: establishment_date
          - name: trust-purpose
            type: string
            required: false
            maps_to: trust_purpose
        returns:
          type: uuid
          name: entity_id
          capture: true

      ensure-partnership-limited:
        description: Create or update a limited partnership entity (idempotent by name)
        behavior: crud
        metadata:
          tier: intent
          source_of_truth: entity
          scope: global
          noun: entity
          tags: [lifecycle, upsert, onboarding]
        produces:
          type: entity
          subtype: partnership
          resolved: false
        crud:
          operation: entity_upsert
          base_table: entities
          schema: ob-poc
          extension_table_column: table_name
          type_id_column: entity_type_id
          returning: entity_id
        args:
          - name: name
            type: string
            required: true
            maps_to: partnership_name
          - name: cbu-id
            type: uuid
            required: false
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: jurisdiction
            type: string
            required: false
            maps_to: jurisdiction
          - name: formation-date
            type: date
            required: false
            maps_to: formation_date
        returns:
          type: uuid
          name: entity_id
          capture: true

      read:
        description: Read an entity by ID
        behavior: crud
        metadata:
          tier: diagnostics
          source_of_truth: entity
          noun: entity
          tags: [query, onboarding]
        crud:
          operation: select
          table: entities
          schema: ob-poc
        args:
          - name: entity-id
            type: uuid
            required: true
            maps_to: entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
        returns:
          type: record
      update:
        description: Update an entity's base fields
        invocation_phrases:
          - "update entity"
          - "modify entity details"
          - "change entity information"
          - "edit entity"
          - "update company details"
          - "modify entity"
          - "change entity name"
          - "update entity attributes"
        behavior: crud
        metadata:
          tier: intent
          source_of_truth: entity
          scope: global
          noun: entity
          tags: [lifecycle, modification, onboarding]
        crud:
          operation: update
          table: entities
          schema: ob-poc
          key: entity_id
        args:
          - name: entity-id
            type: uuid
            required: true
            maps_to: entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: name
            type: string
            required: false
            maps_to: name
          - name: status
            type: string
            required: false
            maps_to: status
          - name: jurisdiction
            type: string
            required: false
            maps_to: jurisdiction
        returns:
          type: affected
      delete:
        description: Delete an entity (cascades to type extension)
        behavior: crud
        metadata:
          tier: intent
          source_of_truth: entity
          scope: global
          noun: entity
          tags: [lifecycle, deletion, onboarding]
        crud:
          operation: delete
          table: entities
          schema: ob-poc
          key: entity_id
        args:
          - name: entity-id
            type: uuid
            required: true
            maps_to: entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
        returns:
          type: affected
      list:
        description: List entities with optional filters
        invocation_phrases:
          - "list entities"
          - "show all entities"
          - "view entity list"
          - "list companies"
          - "show entities by type"
          - "list all entities"
          - "display entities"
          - "get entity list"
        behavior: crud
        metadata:
          tier: diagnostics
          source_of_truth: entity
          noun: entity
          tags: [query, listing, onboarding]
        crud:
          operation: select
          table: entities
          schema: ob-poc
        args:
          - name: entity-type
            type: string
            required: false
          - name: jurisdiction
            type: string
            required: false
            maps_to: jurisdiction
          - name: status
            type: string
            required: false
            maps_to: status
          - name: limit
            type: integer
            required: false
            default: 100
          - name: offset
            type: integer
            required: false
            default: 0
        returns:
          type: record_set

      query:
        description: Query entities for batch template iteration (returns entity refs, not records)
        behavior: plugin
        metadata:
          tier: diagnostics
          source_of_truth: entity
          noun: entity
          tags: [query, batch, onboarding]
        plugin:
          handler: entity_query
        args:
          - name: type
            type: string
            required: false
            description: Entity type filter (fund, proper_person, limited_company, etc.)
          - name: name-like
            type: string
            required: false
            description: Name pattern for ILIKE search (supports % wildcards)
          - name: jurisdiction
            type: string
            required: false
            description: Jurisdiction code filter
          - name: limit
            type: integer
            required: false
            default: 1000
            description: Maximum number of results
        returns:
          type: entity_query_result
          description: List of (entity_id, name) tuples for batch iteration
          capture: true

      # =========================================================================
      # GHOST ENTITY VERBS - Progressive refinement workflow
      # =========================================================================

      ghost:
        description: Create a ghost person entity (name only, minimal attributes)
        behavior: plugin
        metadata:
          tier: intent
          source_of_truth: entity
          scope: global
          noun: entity
          tags: [lifecycle, ghost, creation, onboarding]
        plugin:
          handler: entity_ghost
        produces:
          type: entity
          subtype: proper_person
          resolved: false
        args:
          - name: name
            type: string
            required: true
            description: Full name as discovered (e.g., "John Smith" from document)
          - name: source
            type: string
            required: false
            description: Discovery source (document, ownership_chain, allegation, gleif)
          - name: source-reference
            type: string
            required: false
            description: Reference to source (document_id, relationship_id, etc.)
          - name: notes
            type: string
            required: false
            description: Context notes about the ghost entity
        returns:
          type: uuid
          name: entity_id
          capture: true

      identify:
        description: Add identifying attributes to a ghost entity (transitions to IDENTIFIED state)
        behavior: plugin
        metadata:
          tier: intent
          source_of_truth: entity
          scope: global
          noun: entity
          tags: [lifecycle, ghost, identification, onboarding]
        plugin:
          handler: entity_identify
        args:
          - name: entity-id
            type: uuid
            required: true
            lookup:
              table: entity_proper_persons
              entity_type: proper_person
              schema: ob-poc
              # Composite search: name + nationality (usually captured first) + DOB (year approx or exact)
              search_key: "(search_name (nationality :selectivity 0.7) (date_of_birth :selectivity 0.95 :match-mode year-or-exact))"
              primary_key: entity_id
          - name: first-name
            type: string
            required: false
            description: First name (if splitting from full name)
          - name: last-name
            type: string
            required: false
            description: Last name (if splitting from full name)
          - name: date-of-birth
            type: date
            required: false
            description: Date of birth
          - name: nationality
            type: string
            required: false
            description: Nationality/citizenship
          - name: id-document-type
            type: string
            required: false
            description: ID document type (PASSPORT, NATIONAL_ID, etc.)
          - name: id-document-number
            type: string
            required: false
            description: ID document number
        returns:
          type: uuid
          name: entity_id

      verify:
        description: Mark an identified entity as verified (transitions to VERIFIED state)
        behavior: crud
        metadata:
          tier: intent
          source_of_truth: entity
          scope: global
          noun: entity
          tags: [lifecycle, ghost, verification, onboarding]
        crud:
          operation: update
          table: entity_proper_persons
          schema: ob-poc
        args:
          - name: entity-id
            type: uuid
            required: true
            lookup:
              table: entity_proper_persons
              entity_type: proper_person
              schema: ob-poc
              # Composite search: name + nationality + DOB discriminators
              search_key: "(search_name (nationality :selectivity 0.7) (date_of_birth :selectivity 0.95 :match-mode year-or-exact))"
              primary_key: entity_id
          - name: verification-notes
            type: string
            required: false
            description: Notes about how verification was completed
        returns:
          type: affected

      list-ghosts:
        description: List ghost entities requiring identification
        behavior: crud
        metadata:
          tier: diagnostics
          source_of_truth: entity
          noun: entity
          tags: [query, ghost, listing, onboarding]
        crud:
          operation: select
          table: entity_proper_persons
          schema: ob-poc
          where_clause: "person_state = 'GHOST'"
        args:
          - name: limit
            type: integer
            required: false
            default: 100
          - name: offset
            type: integer
            required: false
            default: 0
        returns:
          type: record_set

      # =========================================================================
      # PLACEHOLDER ENTITY VERBS - Deferred resolution for macro expansion
      # =========================================================================

      ensure-or-placeholder:
        description: Return existing entity or create placeholder for later resolution
        behavior: plugin
        invocation_phrases:
          - "ensure entity or create placeholder"
          - "get or placeholder"
          - "entity placeholder"
          - "deferred entity"
        metadata:
          tier: intent
          source_of_truth: entity
          scope: global
          noun: entity
          tags: [lifecycle, placeholder, macro, onboarding]
        plugin:
          handler: entity_ensure_or_placeholder
        args:
          - name: ref
            type: uuid
            required: false
            description: Optional entity reference to check
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: kind
            type: string
            required: true
            description: Kind of placeholder (depositary, auditor, custodian, etc.)
            valid_values:
              - depositary
              - auditor
              - custodian
              - administrator
              - transfer-agent
              - prime-broker
              - legal-counsel
              - tax-advisor
              - compliance-officer
              - director
              - secretary
              - authorized-signatory
          - name: cbu-id
            type: uuid
            required: true
            description: CBU this placeholder is being created for
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: name-hint
            type: string
            required: false
            description: Optional name hint for the placeholder
        returns:
          type: record
          fields:
            - name: entity_id
              type: uuid
              description: The entity ID (existing or placeholder)
            - name: is_placeholder
              type: boolean
              description: True if a placeholder was created
          capture: true

      resolve-placeholder:
        description: Resolve a placeholder entity to a real entity
        behavior: plugin
        invocation_phrases:
          - "resolve placeholder"
          - "link placeholder to entity"
          - "replace placeholder"
        metadata:
          tier: intent
          source_of_truth: entity
          scope: global
          noun: entity
          tags: [lifecycle, placeholder, resolution, onboarding]
        plugin:
          handler: entity_resolve_placeholder
        args:
          - name: placeholder-id
            type: uuid
            required: true
            description: The placeholder entity ID
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: resolved-entity-id
            type: uuid
            required: true
            description: The real entity to resolve to
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: resolved-by
            type: string
            required: false
            description: Who is performing the resolution
            default: system
        returns:
          type: record
          fields:
            - name: placeholder_entity_id
              type: uuid
            - name: resolved_to_entity_id
              type: uuid
            - name: status
              type: string
            - name: roles_transferred
              type: integer

      list-placeholders:
        description: List pending placeholder entities for a CBU
        behavior: plugin
        invocation_phrases:
          - "list placeholders"
          - "show pending placeholders"
          - "view unresolved entities"
        metadata:
          tier: diagnostics
          source_of_truth: entity
          noun: entity
          tags: [query, placeholder, listing, onboarding]
        plugin:
          handler: entity_list_placeholders
        args:
          - name: cbu-id
            type: uuid
            required: false
            description: Filter by CBU (if not provided, lists all pending)
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
        returns:
          type: record_set

      placeholder-summary:
        description: Get placeholder summary statistics for a CBU
        behavior: plugin
        metadata:
          tier: diagnostics
          source_of_truth: entity
          noun: entity
          tags: [query, placeholder, stats, onboarding]
        plugin:
          handler: entity_placeholder_summary
        args:
          - name: cbu-id
            type: uuid
            required: true
            description: CBU to get summary for
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
        returns:
          type: record
          fields:
            - name: cbu_id
              type: uuid
            - name: pending_count
              type: integer
            - name: by_kind
              type: array
