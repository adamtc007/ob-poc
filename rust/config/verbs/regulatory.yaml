# Regulatory Registration Verbs
# Multi-regulator support for entity regulatory registrations

domains:
  regulatory.registration:
    description: "Entity regulatory registration management (multi-regulator)"
    verbs:
      add:
        description: "Add regulatory registration for an entity (idempotent by entity+regulator+type)"
        behavior: crud
        crud:
          operation: upsert
          table: entity_regulatory_registrations
          schema: ob_kyc
          returning: registration_id
          conflict_keys:
            - entity_id
            - regulator_code
            - registration_type
        args:
          - name: entity-id
            type: uuid
            required: true
            maps_to: entity_id
            lookup:
              entity_type: entity
              table: entities
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: regulator
            type: string
            required: true
            maps_to: regulator_code
            lookup:
              entity_type: regulator
              table: regulators
              schema: ob_ref
              search_key: regulator_code
              primary_key: regulator_code
          - name: registration-number
            type: string
            required: false
            maps_to: registration_number
          - name: registration-type
            type: string
            required: true
            maps_to: registration_type
            default: "PRIMARY"
          - name: activity-scope
            type: string
            required: false
            maps_to: activity_scope
          - name: home-regulator
            type: string
            required: false
            maps_to: home_regulator_code
            description: "For passported/branch registrations"
          - name: effective-date
            type: date
            required: false
            maps_to: effective_date
        returns:
          type: uuid
          capture: true

      list:
        description: "List regulatory registrations for an entity"
        behavior: crud
        crud:
          operation: select
          table: entity_regulatory_registrations
          schema: ob_kyc
          multiple: true
        args:
          - name: entity-id
            type: uuid
            required: true
            maps_to: entity_id
          - name: status
            type: string
            required: false
            default: "ACTIVE"
            maps_to: status
        returns:
          type: record_set

      verify:
        description: "Verify a regulatory registration"
        behavior: plugin
        plugin:
          handler: RegistrationVerifyOp
        args:
          - name: entity-id
            type: uuid
            required: true
            lookup:
              entity_type: entity
              table: entities
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: regulator
            type: string
            required: true
          - name: method
            type: string
            required: true
            description: "MANUAL, REGISTRY_API, DOCUMENT"
          - name: reference
            type: string
            required: false
            description: "Evidence reference or URL"
          - name: expires
            type: date
            required: false
            description: "Verification expiry date"
        returns:
          type: uuid
          capture: true

      remove:
        description: "Remove/withdraw registration"
        behavior: crud
        crud:
          operation: update
          table: entity_regulatory_registrations
          schema: ob_kyc
        args:
          - name: entity-id
            type: uuid
            required: true
            maps_to: entity_id
          - name: regulator
            type: string
            required: true
            maps_to: regulator_code
        computed:
          - column: status
            value: "WITHDRAWN"
          - column: expiry_date
            value: "CURRENT_DATE"
        returns:
          type: uuid

  regulatory.status:
    description: "Entity regulatory status queries"
    verbs:
      check:
        description: "Check entity's overall regulatory status"
        behavior: plugin
        plugin:
          handler: RegulatoryStatusCheckOp
        args:
          - name: entity-id
            type: uuid
            required: true
            lookup:
              entity_type: entity
              table: entities
              schema: ob-poc
              search_key: name
              primary_key: entity_id
        returns:
          type: record
          description: |
            Returns regulatory status summary:
            - is_regulated: boolean
            - registration_count: integer
            - verified_count: integer
            - allows_simplified_dd: boolean
            - active_regulators: array of regulator codes
            - verified_regulators: array of verified regulator codes
            - registrations: array of registration details
            - next_verification_due: date
