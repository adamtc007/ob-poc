domains:
  document:
    description: Document management - solicitation, upload, verification, and lifecycle
    invocation_hints:
      - document
      - passport
      - proof
      - upload
      - verify
      - evidence
      - KYC document
    verbs:
      # ========================================================================
      # Document Solicitation (outbound tasks)
      # ========================================================================
      solicit:
        description: Solicit a single document from an entity (creates pending task)
        behavior: plugin
        invocation_phrases:
          - request document
          - solicit document
          - ask for passport
          - request proof of address
          - get document from entity
        metadata:
          tier: intent
          source_of_truth: operational
          scope: cbu
          noun: document_request
          tags: [workflow, outbound, write]
        args:
          - name: subject-entity-id
            type: uuid
            required: true
            description: Entity to request document from
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: doc-type
            type: string
            required: true
            description: Document type to solicit
            valid_values:
              - passport
              - proof_of_address
              - articles_of_incorporation
              - certificate_of_incumbency
              - board_resolution
              - tax_form
              - financial_statement
              - identity_card
              - utility_bill
              - bank_statement
          - name: workflow-instance-id
            type: uuid
            required: false
            description: Workflow instance for requirement tracking
          - name: due-date
            type: string
            required: false
            description: Due date (YYYY-MM-DD)
          - name: required-state
            type: string
            required: false
            default: verified
            valid_values:
              - received
              - verified
        returns:
          type: record
          fields:
            task_id: uuid
            requirement_id: uuid

      solicit-set:
        description: Solicit multiple documents from an entity (creates single multi-result task)
        behavior: plugin
        invocation_phrases:
          - request documents
          - solicit document set
          - ask for passport and proof of address
          - get KYC documents
          - request identity documents
        metadata:
          tier: intent
          source_of_truth: operational
          scope: cbu
          noun: document_request_set
          tags: [workflow, outbound, write, batch]
        args:
          - name: subject-entity-id
            type: uuid
            required: true
            description: Entity to request documents from
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: doc-types
            type: string_list
            required: true
            description: List of document types to solicit
          - name: workflow-instance-id
            type: uuid
            required: false
            description: Workflow instance for requirement tracking
          - name: due-date
            type: string
            required: false
            description: Due date (YYYY-MM-DD)
        returns:
          type: record
          fields:
            task_id: uuid
            expected_count: integer
            requirement_ids: list

      # ========================================================================
      # Document Creation (for internal/API sources)
      # ========================================================================
      create:
        description: Create a document record (Layer B - logical identity)
        behavior: crud
        invocation_phrases:
          - create document
          - add document record
          - register document
        metadata:
          tier: diagnostics
          source_of_truth: operational
          scope: cbu
          noun: document
          tags: [write]
        crud:
          operation: insert
          table: documents
          schema: ob-poc
          returning: document_id
        args:
          - name: document-type
            type: string
            required: true
            maps_to: document_type
          - name: subject-entity-id
            type: uuid
            required: false
            maps_to: subject_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: subject-cbu-id
            type: uuid
            required: false
            maps_to: subject_cbu_id
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: requirement-id
            type: uuid
            required: false
            maps_to: requirement_id
          - name: source
            type: string
            required: true
            maps_to: source
            description: Source of document (upload, ocr, api, gleif, workflow)
          - name: source-ref
            type: string
            required: false
            maps_to: source_ref
            description: External system reference ID
        returns:
          type: uuid
          name: document_id
          capture: true

      upload-version:
        description: Upload a new version of a document (Layer C - immutable submission)
        behavior: plugin
        invocation_phrases:
          - upload document
          - upload version
          - add document version
          - submit document
        metadata:
          tier: diagnostics
          source_of_truth: operational
          scope: cbu
          noun: document_version
          tags: [write]
        args:
          - name: document-id
            type: uuid
            required: true
            description: Document to add version to
          - name: content-type
            type: string
            required: true
            description: MIME type (application/pdf, image/jpeg, etc.)
          - name: blob-ref
            type: string
            required: false
            description: Storage reference (s3://bucket/key or file:///path)
          - name: structured-data
            type: json
            required: false
            description: Structured content (for JSON documents)
          - name: valid-from
            type: string
            required: false
            description: Document validity start (YYYY-MM-DD)
          - name: valid-to
            type: string
            required: false
            description: Document validity end (YYYY-MM-DD)
        returns:
          type: record
          fields:
            version_id: uuid
            version_no: integer
            cargo_ref: string

      # ========================================================================
      # QA / Verification
      # ========================================================================
      verify:
        description: QA approves a document version
        behavior: plugin
        invocation_phrases:
          - verify document
          - approve document
          - QA approve
          - mark document verified
        metadata:
          tier: intent
          source_of_truth: operational
          scope: cbu
          noun: document_verification
          tags: [workflow, qa, write]
        args:
          - name: version-id
            type: uuid
            required: true
            description: Document version to verify
          - name: verified-by
            type: string
            required: true
            description: QA operator identifier
        returns:
          type: affected

      reject:
        description: QA rejects a document version with reason code
        behavior: plugin
        invocation_phrases:
          - reject document
          - QA reject
          - mark document rejected
          - fail document verification
        metadata:
          tier: intent
          source_of_truth: operational
          scope: cbu
          noun: document_rejection
          tags: [workflow, qa, write]
        args:
          - name: version-id
            type: uuid
            required: true
            description: Document version to reject
          - name: rejection-code
            type: string
            required: true
            description: Standardized rejection code
            valid_values:
              - UNREADABLE
              - CUTOFF
              - GLARE
              - LOW_RESOLUTION
              - WRONG_DOC_TYPE
              - WRONG_PERSON
              - SAMPLE_DOC
              - EXPIRED
              - NOT_YET_VALID
              - UNDATED
              - DOB_MISMATCH
              - NAME_MISMATCH
              - ADDRESS_MISMATCH
              - UNSUPPORTED_FORMAT
              - PASSWORD_PROTECTED
              - CORRUPTED
              - SUSPECTED_ALTERATION
              - INCONSISTENT_FONTS
          - name: rejection-reason
            type: string
            required: false
            description: Optional free-text reason detail
          - name: verified-by
            type: string
            required: true
            description: QA operator identifier
        returns:
          type: affected

      start-qa:
        description: Move document version to QA queue
        behavior: crud
        invocation_phrases:
          - start QA
          - begin verification
          - queue for QA
        metadata:
          tier: diagnostics
          source_of_truth: operational
          scope: cbu
          noun: document_qa
          tags: [workflow, write]
        crud:
          operation: update
          table: document_versions
          schema: ob-poc
        args:
          - name: version-id
            type: uuid
            required: true
            maps_to: version_id
        set:
          - column: verification_status
            value: "'in_qa'"
        returns:
          type: affected

      # ========================================================================
      # Queries
      # ========================================================================
      get:
        description: Get document with latest version status
        behavior: crud
        metadata:
          tier: diagnostics
          source_of_truth: operational
          scope: cbu
          noun: document
          tags: [read]
        crud:
          operation: select
          table: v_documents_with_status
          schema: ob-poc
        args:
          - name: document-id
            type: uuid
            required: true
            maps_to: document_id
        returns:
          type: record

      list-versions:
        description: List all versions of a document
        behavior: crud
        metadata:
          tier: diagnostics
          source_of_truth: operational
          scope: cbu
          noun: document_versions
          tags: [read]
        crud:
          operation: select
          table: document_versions
          schema: ob-poc
        args:
          - name: document-id
            type: uuid
            required: true
            maps_to: document_id
        returns:
          type: record_set

      for-entity:
        description: List all documents for an entity
        behavior: crud
        invocation_phrases:
          - show documents for entity
          - list entity documents
          - what documents does entity have
        metadata:
          tier: intent
          source_of_truth: operational
          scope: cbu
          noun: entity_documents
          tags: [read, query]
        crud:
          operation: select
          table: v_documents_with_status
          schema: ob-poc
        args:
          - name: entity-id
            type: uuid
            required: true
            maps_to: subject_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
        returns:
          type: record_set

      missing-for-entity:
        description: List missing document requirements for an entity
        behavior: plugin
        invocation_phrases:
          - what documents are missing
          - missing documents for entity
          - outstanding documents
          - incomplete document collection
        metadata:
          tier: intent
          source_of_truth: operational
          scope: cbu
          noun: missing_documents
          tags: [read, query, workflow]
        args:
          - name: entity-id
            type: uuid
            required: true
            description: Entity to check requirements for
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: workflow-instance-id
            type: uuid
            required: false
            description: Filter by workflow instance
        returns:
          type: record_set
          fields:
            requirement_id: uuid
            doc_type: string
            status: string
            required_state: string
            attempt_count: integer
            last_rejection_code: string
