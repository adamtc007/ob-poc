domains:
  document:
    description: Document catalog and extraction operations
    verbs:
      catalog:
        description: Catalog a document for an entity within a CBU
        metadata:
          tier: intent
          source_of_truth: document
          scope: cbu
          noun: document
        behavior: plugin
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: entity-id
            type: uuid
            required: true
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: document-type
            type: lookup
            required: true
            lookup:
              table: document_types
              entity_type: document_type
              code_column: type_code
              id_column: type_id
          - name: file-path
            type: string
            required: false
          - name: metadata
            type: json
            required: false
        returns:
          type: uuid
          name: doc_id
          capture: true
      extract:
        description: Extract attributes from a cataloged document
        metadata:
          tier: intent
          source_of_truth: document
          scope: cbu
          noun: document
        behavior: plugin
        args:
          - name: document-id
            type: uuid
            required: true
            lookup:
              table: document_catalog
              entity_type: document
              schema: ob-poc
              search_key: document_name
              primary_key: doc_id
          - name: attributes
            type: string_list
            required: false
          - name: use-ocr
            type: boolean
            required: false
            default: false
        returns:
          type: record
      extract-to-observations:
        description: Extract document data and create observations
        metadata:
          tier: intent
          source_of_truth: document
          scope: cbu
          noun: document
        behavior: plugin
        handler: document_extract_observations
        args:
          - name: document-id
            type: uuid
            required: true
            lookup:
              table: document_catalog
              entity_type: document
              schema: ob-poc
              search_key: document_name
              primary_key: doc_id
          - name: entity-id
            type: uuid
            required: true
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: auto-verify-allegations
            type: boolean
            required: false
            default: true
        returns:
          type: record_set

      # ═══════════════════════════════════════════════════════════════════════════
      # Outstanding Request Integration (fire-and-forget pattern)
      # ═══════════════════════════════════════════════════════════════════════════

      request:
        description: Request a document (creates outstanding request, fire-and-forget)
        metadata:
          tier: intent
          source_of_truth: document
          scope: cbu
          noun: document
        behavior: plugin
        plugin:
          handler: DocumentRequestOp
        args:
          - name: workstream-id
            type: uuid
            required: false
            lookup:
              table: entity_workstreams
              entity_type: entity_workstream
              schema: kyc
              search_key: workstream_id
              primary_key: workstream_id
          - name: entity-id
            type: uuid
            required: false
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: case-id
            type: uuid
            required: false
            lookup:
              table: cases
              entity_type: kyc_case
              schema: kyc
              search_key: case_id
              primary_key: case_id
          - name: type
            type: string
            required: true
            description: Document type code
            valid_values:
              - ID_DOCUMENT
              - PROOF_OF_ADDRESS
              - SOURCE_OF_WEALTH
              - SOURCE_OF_FUNDS
              - CERTIFICATE_OF_INCORPORATION
              - ARTICLES_OF_ASSOCIATION
              - REGISTER_OF_MEMBERS
              - REGISTER_OF_DIRECTORS
              - FINANCIAL_STATEMENTS
              - OWNERSHIP_STRUCTURE
              - BOARD_RESOLUTION
              - POWER_OF_ATTORNEY
              - TAX_FORMS
              - REGULATORY_LICENSE
              - OTHER
          - name: from
            type: string
            required: false
            default: client
          - name: due-in-days
            type: integer
            required: false
          - name: notes
            type: string
            required: false
        returns:
          type: record
        example: |
          (document.request :workstream-id @ws-003 :type "SOURCE_OF_WEALTH" :from "client" :due-in-days 14)

      upload:
        description: Upload a document (auto-fulfills matching outstanding request)
        metadata:
          tier: intent
          source_of_truth: document
          scope: cbu
          noun: document
        behavior: plugin
        plugin:
          handler: DocumentUploadOp
        args:
          - name: workstream-id
            type: uuid
            required: false
            lookup:
              table: entity_workstreams
              entity_type: entity_workstream
              schema: kyc
              search_key: workstream_id
              primary_key: workstream_id
          - name: entity-id
            type: uuid
            required: false
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: case-id
            type: uuid
            required: false
            lookup:
              table: cases
              entity_type: kyc_case
              schema: kyc
              search_key: case_id
              primary_key: case_id
          - name: type
            type: string
            required: true
            description: Document type code
          - name: file-path
            type: string
            required: true
          - name: notes
            type: string
            required: false
        returns:
          type: record
          description: |
            Returns document_id, fulfilled_request_id (if matched), workstream_unblocked (boolean)

      waive-request:
        description: Waive document requirement (for outstanding requests)
        metadata:
          tier: intent
          source_of_truth: document
          scope: cbu
          noun: document
        behavior: plugin
        plugin:
          handler: DocumentWaiveOp
        args:
          - name: workstream-id
            type: uuid
            required: true
            lookup:
              table: entity_workstreams
              entity_type: entity_workstream
              schema: kyc
              search_key: workstream_id
              primary_key: workstream_id
          - name: type
            type: string
            required: true
            description: Document type to waive
          - name: reason
            type: string
            required: true
          - name: approved-by
            type: uuid
            required: true
            description: Senior user approving waiver
        returns:
          type: affected
        example: |
          (document.waive-request :workstream-id @ws-003 :type "SOURCE_OF_WEALTH"
             :reason "Low value account, low risk" :approved-by @senior-analyst)

      # ═══════════════════════════════════════════════════════════════════════════
      # Document-Attribute Catalogue Operations
      # ═══════════════════════════════════════════════════════════════════════════

      list-attributes:
        description: List all attributes linked to a document type with extraction/requirement details
        metadata:
          tier: reference
          source_of_truth: document
          scope: cbu
          noun: document
        behavior: plugin
        handler: document_list_attributes
        args:
          - name: document-type
            type: string
            required: true
            description: Document type code (e.g., PASSPORT, CERT_OF_INCORPORATION)
          - name: direction
            type: string
            required: false
            valid_values: [SOURCE, SINK, BOTH]
            description: Filter by direction - SOURCE (provides), SINK (requires), or BOTH
        returns:
          type: record_set
          description: List of attributes with direction, extraction_method, is_authoritative, proof_strength
        example: |
          (document.list-attributes :document-type "PASSPORT")
          (document.list-attributes :document-type "UBO_DECLARATION" :direction "SINK")

      set-required-attributes:
        description: Set required_attributes JSONB for a document type (validation rules)
        metadata:
          tier: intent
          source_of_truth: document
          scope: cbu
          noun: document
        behavior: crud
        crud:
          operation: update
          table: document_types
          schema: ob-poc
          code_column: type_code
        args:
          - name: document-type
            type: string
            required: true
            description: Document type code
            maps_to: type_code
          - name: required-attributes
            type: json
            required: true
            description: |
              JSONB object defining validation rules. Structure:
              {
                "mandatory": ["attr.identity.full_name", "attr.identity.date_of_birth"],
                "conditional": {
                  "if_jurisdiction_in": ["US", "CA"],
                  "then_require": ["attr.tax.ssn_itin"]
                },
                "at_least_one": [["attr.identity.passport_number", "attr.identity.national_id_number"]]
              }
            maps_to: required_attributes
        example: |
          (document.set-required-attributes
            :document-type "PASSPORT"
            :required-attributes {
              "mandatory": ["attr.identity.full_name", "attr.identity.date_of_birth",
                           "attr.identity.passport_number", "attr.identity.nationality"],
              "conditional": {},
              "at_least_one": []
            })

      get-type:
        description: Get document type details including required_attributes and applicability
        metadata:
          tier: reference
          source_of_truth: document
          scope: cbu
          noun: document
        behavior: crud
        crud:
          operation: select
          table: document_types
          schema: ob-poc
          code_column: type_code
        args:
          - name: document-type
            type: string
            required: true
            maps_to: type_code
        returns:
          type: record

      list-types:
        description: List document types, optionally filtered by category or domain
        metadata:
          tier: reference
          source_of_truth: document
          scope: cbu
          noun: document
        behavior: crud
        crud:
          operation: select
          table: document_types
          schema: ob-poc
        args:
          - name: category
            type: string
            required: false
            description: Filter by category (IDENTITY, CORPORATE, FINANCIAL, ADDRESS_PROOF, TAX, UBO, REGULATORY)
            maps_to: category
          - name: domain
            type: string
            required: false
            description: Filter by domain
            maps_to: domain
        returns:
          type: record_set

      check-extraction-coverage:
        description: Check what percentage of attributes can be extracted from available documents for an entity
        metadata:
          tier: diagnostics
          source_of_truth: document
          scope: cbu
          noun: document
        behavior: plugin
        handler: document_check_extraction_coverage
        args:
          - name: entity-id
            type: uuid
            required: true
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: cbu-id
            type: uuid
            required: false
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
        returns:
          type: record
          description: |
            Returns coverage stats: total_required, total_sourced, coverage_percentage,
            missing_attributes, available_documents

  # ═══════════════════════════════════════════════════════════════════════════
  # Document Type Reference Data Management
  # ═══════════════════════════════════════════════════════════════════════════
  document-type:
    description: Document type reference data management (for catalogue population)
    verbs:
      ensure:
        description: Create or update a document type in the catalogue (upsert by type_code)
        metadata:
          tier: intent
          source_of_truth: document
          scope: cbu
          noun: document
        behavior: crud
        crud:
          operation: upsert
          table: document_types
          schema: ob-poc
          code_column: type_code
          conflict_keys: [type_code]
          returning: type_id
        args:
          - name: type-code
            type: string
            required: true
            description: Unique document type code (e.g., PASSPORT, CERT_OF_INCORPORATION)
            maps_to: type_code
          - name: display-name
            type: string
            required: true
            description: Human-readable name
            maps_to: display_name
          - name: category
            type: string
            required: true
            description: Document category
            valid_values:
              [
                IDENTITY,
                CORPORATE,
                FINANCIAL,
                ADDRESS_PROOF,
                TAX,
                UBO,
                REGULATORY,
                CONTRACT,
                COMPLIANCE,
                SCREENING,
                FUND,
                TRUST,
                PARTNERSHIP,
              ]
            maps_to: category
          - name: domain
            type: string
            required: false
            description: Domain grouping (e.g., kyc, custody, fund)
            maps_to: domain
          - name: description
            type: string
            required: false
            description: Detailed description of the document type
            maps_to: description
          - name: applicability
            type: json
            required: false
            description: |
              CSG applicability rules as JSONB:
              {
                "entity_types": ["PROPER_PERSON", "LIMITED_COMPANY"],
                "jurisdictions": ["US", "GB"],
                "client_types": ["FUND", "CORPORATE"],
                "required_for": ["KYC_ONBOARDING"],
                "excludes": []
              }
            maps_to: applicability
          - name: required-attributes
            type: json
            required: false
            description: |
              Required attributes for document validation:
              {
                "mandatory": ["attr.identity.full_name"],
                "conditional": {},
                "at_least_one": []
              }
            maps_to: required_attributes
        returns:
          type: uuid
          name: type_id
          capture: true
        example: |
          (document-type.ensure
            :type-code "PASSPORT"
            :display-name "Passport"
            :category "IDENTITY"
            :domain "kyc"
            :description "Government-issued passport document"
            :applicability {"entity_types": ["PROPER_PERSON"]})

      read:
        description: Read a document type by code
        metadata:
          tier: reference
          source_of_truth: document
          scope: cbu
          noun: document
        behavior: crud
        crud:
          operation: select
          table: document_types
          schema: ob-poc
          code_column: type_code
        args:
          - name: type-code
            type: string
            required: true
            maps_to: type_code
        returns:
          type: record

      list:
        description: List document types with optional filters
        metadata:
          tier: reference
          source_of_truth: document
          scope: cbu
          noun: document
        behavior: crud
        crud:
          operation: select
          table: document_types
          schema: ob-poc
        args:
          - name: category
            type: string
            required: false
            maps_to: category
          - name: domain
            type: string
            required: false
            maps_to: domain
        returns:
          type: record_set

      delete:
        description: Delete a document type (will fail if documents exist)
        metadata:
          tier: intent
          source_of_truth: document
          scope: cbu
          noun: document
        behavior: crud
        crud:
          operation: delete
          table: document_types
          schema: ob-poc
          code_column: type_code
        args:
          - name: type-code
            type: string
            required: true
            maps_to: type_code
        returns:
          type: affected
