template: onboard-fund-cbu
version: 2

primary_entity:
  type: cbu
  param: cbu
  description: CBU created for the fund entity

metadata:
  name: Onboard Fund as CBU
  summary: Create CBU for a fund entity with shared ManCo and IM
  description: |
    Creates a CBU with the fund's name, then assigns:
    - The fund entity as ASSET_OWNER
    - A shared ManCo entity as MANAGEMENT_COMPANY
    - A shared IM entity as INVESTMENT_MANAGER

    This template is designed for bulk execution where many fund CBUs
    share the same ManCo and IM.
  when_to_use:
    - Bulk onboarding fund entities as CBUs
    - Setting up fund structure with shared service providers
  effects:
    - New CBU created with fund name
    - ASSET_OWNER role assigned to fund entity
    - MANAGEMENT_COMPANY role assigned to ManCo
    - INVESTMENT_MANAGER role assigned to IM

tags:
  - fund
  - cbu
  - bulk
  - onboarding

workflow_context:
  applicable_workflows:
    - fund_onboarding
  resolves_blockers:
    - missing_cbu_for_fund

params:
  # BATCH param - one fund per iteration
  fund_entity:
    type: entity_ref
    required: true
    entity_type: fund
    search_key: name
    cardinality: batch
    prompt: "Fund entity to onboard as CBU"
    description: "The fund entity that will become the ASSET_OWNER of the new CBU"

  # SHARED params - same for all batch items
  manco_entity:
    type: entity_ref
    required: true
    entity_type: limited_company
    search_key: name
    cardinality: shared
    role_hint: MANAGEMENT_COMPANY
    prompt: "Management Company (shared across all funds)"
    description: "ManCo entity assigned MANAGEMENT_COMPANY role on each CBU"

  im_entity:
    type: entity_ref
    required: true
    entity_type: limited_company
    search_key: name
    cardinality: shared
    role_hint: INVESTMENT_MANAGER
    prompt: "Investment Manager (shared across all funds)"
    description: "IM entity assigned INVESTMENT_MANAGER role on each CBU"

  jurisdiction:
    type: string
    required: false
    default: "LU"
    prompt: "Jurisdiction code"
    description: "Default jurisdiction for created CBUs"

  # OUTPUT param - created by template
  cbu:
    type: cbu_ref
    entity_type: cbu
    cardinality: output
    description: "The CBU created by this template"

body: |
  (cbu.ensure
    :name "$fund_entity.name"
    :jurisdiction "$jurisdiction"
    :client-type "FUND"
    :as @cbu)
  (cbu.assign-role
    :cbu-id @cbu
    :entity-id "$fund_entity"
    :role "ASSET_OWNER")
  (cbu.assign-role
    :cbu-id @cbu
    :entity-id "$manco_entity"
    :role "MANAGEMENT_COMPANY")
  (cbu.assign-role
    :cbu-id @cbu
    :entity-id "$im_entity"
    :role "INVESTMENT_MANAGER")

outputs:
  cbu:
    type: cbu_ref
    description: Created CBU ID
    binding: cbu
