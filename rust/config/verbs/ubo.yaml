domains:
  ubo:
    description: UBO ownership and control chain management
    verbs:
      add-ownership:
        description: Add ownership relationship between entities
        behavior: crud
        crud:
          operation: insert
          table: ownership_relationships
          schema: ob-poc
          returning: ownership_id
        args:
          - name: owner-entity-id
            type: uuid
            required: true
            maps_to: owner_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: owned-entity-id
            type: uuid
            required: true
            maps_to: owned_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: percentage
            type: decimal
            required: true
            maps_to: ownership_percent
          - name: ownership-type
            type: string
            required: true
            maps_to: ownership_type
            valid_values:
              - DIRECT
              - INDIRECT
              - BENEFICIAL
          - name: effective-from
            type: date
            required: false
            maps_to: effective_from
          - name: evidence-doc-id
            type: uuid
            required: false
            maps_to: evidence_doc_id
            lookup:
              table: document_catalog
              entity_type: document
              schema: ob-poc
              search_key: document_name
              primary_key: doc_id
          - name: notes
            type: string
            required: false
            maps_to: notes
        returns:
          type: uuid
          name: ownership_id
          capture: true
      update-ownership:
        description: Update ownership percentage or end date
        behavior: crud
        crud:
          operation: update
          table: ownership_relationships
          schema: ob-poc
          key: ownership_id
        args:
          - name: ownership-id
            type: uuid
            required: true
            maps_to: ownership_id
            lookup:
              table: ownership_relationships
              schema: ob-poc
              search_key: ownership_id
              primary_key: ownership_id
          - name: percentage
            type: decimal
            required: false
            maps_to: ownership_percent
          - name: effective-to
            type: date
            required: false
            maps_to: effective_to
          - name: notes
            type: string
            required: false
            maps_to: notes
        returns:
          type: affected
      end-ownership:
        description: End an ownership relationship
        behavior: crud
        crud:
          operation: update
          table: ownership_relationships
          schema: ob-poc
          key: ownership_id
        args:
          - name: ownership-id
            type: uuid
            required: true
            maps_to: ownership_id
            lookup:
              table: ownership_relationships
              schema: ob-poc
              search_key: ownership_id
              primary_key: ownership_id
          - name: effective-to
            type: date
            required: true
            maps_to: effective_to
        returns:
          type: affected
      list-owners:
        description: List owners of an entity (who owns this entity)
        behavior: crud
        crud:
          operation: list_by_fk
          table: ownership_relationships
          schema: ob-poc
          fk_col: owned_entity_id
        args:
          - name: entity-id
            type: uuid
            required: true
            maps_to: owned_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
        returns:
          type: record_set
      list-owned:
        description: List entities owned by an entity (what does this entity own)
        behavior: crud
        crud:
          operation: list_by_fk
          table: ownership_relationships
          schema: ob-poc
          fk_col: owner_entity_id
        args:
          - name: entity-id
            type: uuid
            required: true
            maps_to: owner_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
        returns:
          type: record_set
      register-ubo:
        description: Register a UBO determination for a CBU
        behavior: crud
        crud:
          operation: upsert
          table: ubo_registry
          schema: ob-poc
          conflict_keys:
            - subject_entity_id
            - ubo_proper_person_id
            - relationship_type
          returning: ubo_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: subject-entity-id
            type: uuid
            required: true
            maps_to: subject_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: ubo-person-id
            type: uuid
            required: true
            maps_to: ubo_proper_person_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: relationship-type
            type: string
            required: true
            maps_to: relationship_type
          - name: qualifying-reason
            type: string
            required: true
            maps_to: qualifying_reason
            valid_values:
              - OWNERSHIP_25PCT
              - CONTROL
              - SENIOR_MANAGEMENT
              - OTHER
          - name: ownership-percentage
            type: decimal
            required: false
            maps_to: ownership_percentage
          - name: control-type
            type: string
            required: false
            maps_to: control_type
          - name: workflow-type
            type: string
            required: true
            maps_to: workflow_type
          - name: regulatory-framework
            type: string
            required: false
            maps_to: regulatory_framework
        returns:
          type: uuid
          name: ubo_id
          capture: true
      verify-ubo:
        description: Mark a UBO as verified
        behavior: crud
        crud:
          operation: update
          table: ubo_registry
          schema: ob-poc
          key: ubo_id
        args:
          - name: ubo-id
            type: uuid
            required: true
            maps_to: ubo_id
            lookup:
              table: ubo_registry
              entity_type: ubo
              schema: ob-poc
              search_key: ubo_id
              primary_key: ubo_id
          - name: verification-status
            type: string
            required: true
            maps_to: verification_status
            valid_values:
              - SUSPECTED
              - PENDING
              - PROVEN
              - VERIFIED
              - FAILED
              - DISPUTED
              - REMOVED
          - name: risk-rating
            type: string
            required: false
            maps_to: risk_rating
            valid_values:
              - LOW
              - MEDIUM
              - HIGH
              - PROHIBITED
        returns:
          type: affected
      list-ubos:
        description: List UBOs for a CBU
        behavior: crud
        crud:
          operation: list_by_fk
          table: ubo_registry
          schema: ob-poc
          fk_col: cbu_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: verification-status
            type: string
            required: false
            maps_to: verification_status
        returns:
          type: record_set
      list-by-subject:
        description: List UBOs for a subject entity
        behavior: crud
        crud:
          operation: list_by_fk
          table: ubo_registry
          schema: ob-poc
          fk_col: subject_entity_id
        args:
          - name: subject-entity-id
            type: uuid
            required: true
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
        returns:
          type: record_set
      calculate:
        description: Calculate ultimate beneficial ownership chain
        behavior: plugin
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: entity-id
            type: uuid
            required: true
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: threshold
            type: decimal
            required: false
            default: 25.0
        returns:
          type: record_set
      supersede-ubo:
        description: Supersede a UBO determination when ownership changes
        behavior: crud
        crud:
          operation: update
          table: ubo_registry
          schema: ob-poc
          key: ubo_id
          set_values:
            superseded_at: now()
        args:
          - name: ubo-id
            type: uuid
            required: true
            maps_to: ubo_id
            lookup:
              table: ubo_registry
              entity_type: ubo
              schema: ob-poc
              search_key: ubo_id
              primary_key: ubo_id
          - name: superseded-by
            type: uuid
            required: true
            maps_to: superseded_by
            description: ID of the new UBO determination that replaces this one
            lookup:
              table: ubo_registry
              entity_type: ubo
              schema: ob-poc
              search_key: ubo_id
              primary_key: ubo_id
          - name: reason
            type: string
            required: true
            maps_to: closed_reason
        returns:
          type: affected
      close-ubo:
        description: Close a UBO record (no longer a UBO)
        behavior: crud
        crud:
          operation: update
          table: ubo_registry
          schema: ob-poc
          key: ubo_id
          set_values:
            verification_status: REMOVED
            closed_at: now()
        args:
          - name: ubo-id
            type: uuid
            required: true
            maps_to: ubo_id
            lookup:
              table: ubo_registry
              entity_type: ubo
              schema: ob-poc
              search_key: ubo_id
              primary_key: ubo_id
          - name: removal-reason
            type: string
            required: true
            maps_to: removal_reason
          - name: replacement-ubo-id
            type: uuid
            required: false
            maps_to: replacement_ubo_id
            description: If this UBO is being replaced by another
            lookup:
              table: ubo_registry
              entity_type: ubo
              schema: ob-poc
              search_key: ubo_id
              primary_key: ubo_id
        returns:
          type: affected
