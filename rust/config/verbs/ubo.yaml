domains:
  ubo:
    description: UBO ownership and control chain management
    verbs:
      add-ownership:
        description: Add ownership relationship between entities (idempotent by owner+owned)
        behavior: crud
        crud:
          operation: upsert
          table: entity_relationships
          schema: ob-poc
          returning: relationship_id
          conflict_keys:
            - from_entity_id
            - to_entity_id
            - relationship_type
          set_values:
            relationship_type: ownership
        args:
          - name: owner-entity-id
            type: uuid
            required: true
            maps_to: from_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: owned-entity-id
            type: uuid
            required: true
            maps_to: to_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: percentage
            type: decimal
            required: true
            maps_to: percentage
          - name: ownership-type
            type: string
            required: false
            maps_to: ownership_type
            valid_values:
              - DIRECT
              - INDIRECT
              - BENEFICIAL
              - DIRECTLY_CONSOLIDATED
              - ULTIMATELY_CONSOLIDATED
          - name: interest-type
            type: string
            required: false
            maps_to: interest_type
            default: shareholding
            description: BODS 0.4 interest type code (e.g., shareholding, votingRights, appointmentOfBoard)
            lookup:
              table: bods_interest_types
              entity_type: interest_type
              schema: ob-poc
              search_key: type_code
              primary_key: type_code
          - name: direct-or-indirect
            type: string
            required: false
            maps_to: direct_or_indirect
            description: Whether this is direct or indirect ownership
            valid_values:
              - direct
              - indirect
              - unknown
          - name: effective-from
            type: date
            required: false
            maps_to: effective_from
          - name: evidence-doc-id
            type: uuid
            required: false
            maps_to: source_document_id
            lookup:
              table: document_catalog
              entity_type: document
              schema: ob-poc
              search_key: document_name
              primary_key: doc_id
          - name: notes
            type: string
            required: false
            maps_to: notes
        returns:
          type: uuid
          name: relationship_id
          capture: true
      update-ownership:
        description: Update ownership percentage or end date
        behavior: crud
        crud:
          operation: update
          table: entity_relationships
          schema: ob-poc
          key: relationship_id
        args:
          - name: relationship-id
            type: uuid
            required: true
            maps_to: relationship_id
            lookup:
              table: entity_relationships
              schema: ob-poc
              search_key: relationship_id
              primary_key: relationship_id
          - name: percentage
            type: decimal
            required: false
            maps_to: percentage
          - name: effective-to
            type: date
            required: false
            maps_to: effective_to
          - name: notes
            type: string
            required: false
            maps_to: notes
        returns:
          type: affected
      end-ownership:
        description: End an ownership relationship (soft delete - sets effective_to date)
        behavior: crud
        crud:
          operation: update
          table: entity_relationships
          schema: ob-poc
          key: relationship_id
        args:
          - name: relationship-id
            type: uuid
            required: true
            maps_to: relationship_id
            lookup:
              table: entity_relationships
              entity_type: relationship
              schema: ob-poc
              search_key: relationship_id
              primary_key: relationship_id
          - name: effective-to
            type: date
            required: true
            maps_to: effective_to
        returns:
          type: affected

      delete-ownership:
        description: Hard delete an ownership relationship (removes row from entity_relationships)
        behavior: crud
        crud:
          operation: delete
          table: entity_relationships
          schema: ob-poc
          key: relationship_id
        args:
          - name: relationship-id
            type: uuid
            required: true
            maps_to: relationship_id
            lookup:
              table: entity_relationships
              entity_type: relationship
              schema: ob-poc
              search_key: relationship_id
              primary_key: relationship_id
        returns:
          type: affected

      add-control:
        description: Add control relationship between entities (board, voting rights, etc.)
        behavior: crud
        crud:
          operation: upsert
          table: entity_relationships
          schema: ob-poc
          returning: relationship_id
          conflict_keys:
            - from_entity_id
            - to_entity_id
            - relationship_type
            - control_type
          set_values:
            relationship_type: control
        args:
          - name: controller-entity-id
            type: uuid
            required: true
            maps_to: from_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: controlled-entity-id
            type: uuid
            required: true
            maps_to: to_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: control-type
            type: string
            required: true
            maps_to: control_type
            valid_values:
              - board_member
              - executive
              - voting_rights
              - veto_rights
              - appointee
              - other
          - name: effective-from
            type: date
            required: false
            maps_to: effective_from
          - name: notes
            type: string
            required: false
            maps_to: notes
        returns:
          type: uuid
          name: relationship_id
          capture: true

      end-control:
        description: End a control relationship (soft delete - sets effective_to date)
        behavior: crud
        crud:
          operation: update
          table: entity_relationships
          schema: ob-poc
          key: relationship_id
        args:
          - name: relationship-id
            type: uuid
            required: true
            maps_to: relationship_id
            lookup:
              table: entity_relationships
              entity_type: relationship
              schema: ob-poc
              search_key: relationship_id
              primary_key: relationship_id
          - name: effective-to
            type: date
            required: true
            maps_to: effective_to
        returns:
          type: affected

      delete-control:
        description: Hard delete a control relationship (removes row from entity_relationships)
        behavior: crud
        crud:
          operation: delete
          table: entity_relationships
          schema: ob-poc
          key: relationship_id
        args:
          - name: relationship-id
            type: uuid
            required: true
            maps_to: relationship_id
            lookup:
              table: entity_relationships
              entity_type: relationship
              schema: ob-poc
              search_key: relationship_id
              primary_key: relationship_id
        returns:
          type: affected

      add-trust-role:
        description: Add trust role relationship (settlor, trustee, beneficiary, protector)
        behavior: crud
        crud:
          operation: upsert
          table: entity_relationships
          schema: ob-poc
          returning: relationship_id
          conflict_keys:
            - from_entity_id
            - to_entity_id
            - relationship_type
            - trust_role
          set_values:
            relationship_type: trust_role
        args:
          - name: person-entity-id
            type: uuid
            required: true
            maps_to: from_entity_id
            description: The person holding the trust role
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: trust-entity-id
            type: uuid
            required: true
            maps_to: to_entity_id
            description: The trust entity
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: trust-role
            type: string
            required: true
            maps_to: trust_role
            valid_values:
              - settlor
              - trustee
              - beneficiary
              - protector
          - name: trust-interest-type
            type: string
            required: false
            maps_to: trust_interest_type
            description: For beneficiaries - type of interest
            valid_values:
              - fixed
              - discretionary
              - contingent
          - name: effective-from
            type: date
            required: false
            maps_to: effective_from
          - name: notes
            type: string
            required: false
            maps_to: notes
        returns:
          type: uuid
          name: relationship_id
          capture: true

      end-trust-role:
        description: End a trust role relationship (soft delete - sets effective_to date)
        behavior: crud
        crud:
          operation: update
          table: entity_relationships
          schema: ob-poc
          key: relationship_id
        args:
          - name: relationship-id
            type: uuid
            required: true
            maps_to: relationship_id
            lookup:
              table: entity_relationships
              entity_type: relationship
              schema: ob-poc
              search_key: relationship_id
              primary_key: relationship_id
          - name: effective-to
            type: date
            required: true
            maps_to: effective_to
        returns:
          type: affected

      delete-trust-role:
        description: Hard delete a trust role relationship (removes row from entity_relationships)
        behavior: crud
        crud:
          operation: delete
          table: entity_relationships
          schema: ob-poc
          key: relationship_id
        args:
          - name: relationship-id
            type: uuid
            required: true
            maps_to: relationship_id
            lookup:
              table: entity_relationships
              entity_type: relationship
              schema: ob-poc
              search_key: relationship_id
              primary_key: relationship_id
        returns:
          type: affected

      delete-relationship:
        description: Hard delete any entity relationship by ID (generic fallback)
        behavior: crud
        crud:
          operation: delete
          table: entity_relationships
          schema: ob-poc
          key: relationship_id
        args:
          - name: relationship-id
            type: uuid
            required: true
            maps_to: relationship_id
            lookup:
              table: entity_relationships
              entity_type: relationship
              schema: ob-poc
              search_key: relationship_id
              primary_key: relationship_id
        returns:
          type: affected
      list-owners:
        description: List owners of an entity as of a specific date
        behavior: plugin
        args:
          - name: entity-id
            type: uuid
            required: true
            description: Entity to find owners for
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: as-of-date
            type: date
            required: false
            description: Point-in-time date for temporal query (defaults to today)
        returns:
          type: record_set
      list-owned:
        description: List entities owned by an entity (what does this entity own)
        behavior: crud
        crud:
          operation: list_by_fk
          table: entity_relationships_current
          schema: ob-poc
          fk_col: from_entity_id
          filter:
            relationship_type: OWNERSHIP
        args:
          - name: entity-id
            type: uuid
            required: true
            maps_to: from_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
        returns:
          type: record_set
      # DEPRECATED: Use ubo.allege instead. UBO registration is now handled through
      # the convergence model: allege relationship → link proof → verify.
      # The v_ubo_candidates view automatically identifies UBOs based on ownership ≥25%.
      register-ubo:
        description: "[DEPRECATED] Register a UBO determination - use ubo.allege instead"
        behavior: crud
        crud:
          operation: upsert
          table: ubo_registry
          schema: ob-poc
          conflict_keys:
            - subject_entity_id
            - ubo_proper_person_id
            - relationship_type
          returning: ubo_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: subject-entity-id
            type: uuid
            required: true
            maps_to: subject_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: ubo-person-id
            type: uuid
            required: true
            maps_to: ubo_proper_person_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: relationship-type
            type: string
            required: true
            maps_to: relationship_type
          - name: qualifying-reason
            type: string
            required: true
            maps_to: qualifying_reason
            valid_values:
              - OWNERSHIP_25PCT
              - CONTROL
              - SENIOR_MANAGEMENT
              - OTHER
          - name: ownership-percentage
            type: decimal
            required: false
            maps_to: ownership_percentage
          - name: control-type
            type: string
            required: false
            maps_to: control_type
          - name: workflow-type
            type: string
            required: true
            maps_to: workflow_type
          - name: regulatory-framework
            type: string
            required: false
            maps_to: regulatory_framework
        returns:
          type: uuid
          name: ubo_id
          capture: true
      # DEPRECATED: Use ubo.verify instead (plugin behavior).
      # The new verify operates on cbu_relationship_verification records.
      verify-ubo:
        description: "[DEPRECATED] Mark a UBO as verified - use ubo.verify instead"
        behavior: crud
        crud:
          operation: update
          table: ubo_registry
          schema: ob-poc
          key: ubo_id
        args:
          - name: ubo-id
            type: uuid
            required: true
            maps_to: ubo_id
            lookup:
              table: ubo_registry
              entity_type: ubo
              schema: ob-poc
              search_key: ubo_id
              primary_key: ubo_id
          - name: verification-status
            type: string
            required: true
            maps_to: verification_status
            valid_values:
              - SUSPECTED
              - PENDING
              - PROVEN
              - VERIFIED
              - FAILED
              - DISPUTED
              - REMOVED
          - name: risk-rating
            type: string
            required: false
            maps_to: risk_rating
            valid_values:
              - LOW
              - MEDIUM
              - HIGH
              - PROHIBITED
        returns:
          type: affected
      list-ubos:
        description: List UBO candidates for a CBU (natural persons with ≥25% ownership)
        behavior: crud
        crud:
          operation: list_by_fk
          table: v_ubo_candidates
          schema: ob-poc
          fk_col: cbu_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
        returns:
          type: record_set
      list-by-subject:
        description: List ownership relationships where entity is the owned party
        behavior: crud
        crud:
          operation: list_by_fk
          table: entity_relationships_current
          schema: ob-poc
          fk_col: to_entity_id
          filter:
            relationship_type: OWNERSHIP
        args:
          - name: subject-entity-id
            type: uuid
            required: true
            maps_to: to_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
        returns:
          type: record_set
      calculate:
        description: Calculate ultimate beneficial ownership chain
        behavior: plugin
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: entity-id
            type: uuid
            required: true
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: threshold
            type: decimal
            required: false
            default: 25.0
        returns:
          type: record_set

      trace-chains:
        description: Trace all ownership and control chains to natural persons for a CBU
        behavior: plugin
        args:
          - name: cbu-id
            type: uuid
            required: true
            description: CBU to trace ownership chains for
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: target-entity-id
            type: uuid
            required: false
            description: Optional specific entity to trace from (defaults to CBU's main entity)
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: threshold
            type: decimal
            required: false
            default: 25.0
            description: Minimum ownership percentage to include (default 25%)
          - name: as-of-date
            type: date
            required: false
            description: Point-in-time date for temporal query (defaults to today)
        returns:
          type: record

      # DEPRECATED: With the new convergence model, ownership changes are handled by
      # ending the old relationship (ubo.end-ownership) and creating a new one (ubo.add-ownership).
      # Verification status is tracked per-CBU in cbu_relationship_verification.
      supersede-ubo:
        description: "[DEPRECATED] Supersede a UBO determination - use end-ownership + add-ownership instead"
        behavior: crud
        crud:
          operation: update
          table: ubo_registry
          schema: ob-poc
          key: ubo_id
          set_values:
            superseded_at: now()
        args:
          - name: ubo-id
            type: uuid
            required: true
            maps_to: ubo_id
            lookup:
              table: ubo_registry
              entity_type: ubo
              schema: ob-poc
              search_key: ubo_id
              primary_key: ubo_id
          - name: superseded-by
            type: uuid
            required: true
            maps_to: superseded_by
            description: ID of the new UBO determination that replaces this one
            lookup:
              table: ubo_registry
              entity_type: ubo
              schema: ob-poc
              search_key: ubo_id
              primary_key: ubo_id
          - name: reason
            type: string
            required: true
            maps_to: closed_reason
        returns:
          type: affected
      # DEPRECATED: With the new convergence model, UBO status is determined by
      # the v_ubo_candidates view (natural persons with ≥25% ownership).
      # To remove someone as UBO, end their ownership relationship.
      close-ubo:
        description: "[DEPRECATED] Close a UBO record - use end-ownership instead"
        behavior: crud
        crud:
          operation: update
          table: ubo_registry
          schema: ob-poc
          key: ubo_id
          set_values:
            verification_status: REMOVED
            closed_at: now()
        args:
          - name: ubo-id
            type: uuid
            required: true
            maps_to: ubo_id
            lookup:
              table: ubo_registry
              entity_type: ubo
              schema: ob-poc
              search_key: ubo_id
              primary_key: ubo_id
          - name: removal-reason
            type: string
            required: true
            maps_to: removal_reason
          - name: replacement-ubo-id
            type: uuid
            required: false
            maps_to: replacement_ubo_id
            description: If this UBO is being replaced by another
            lookup:
              table: ubo_registry
              entity_type: ubo
              schema: ob-poc
              search_key: ubo_id
              primary_key: ubo_id
        returns:
          type: affected

      # =========================================================================
      # Phase 7: UBO Removal Operations (Convergence Model)
      # These plugin handlers manage lifecycle events that affect UBO status
      # =========================================================================

      mark-deceased:
        description: Mark a person as deceased and cascade effects to ownership/control relationships
        behavior: plugin
        args:
          - name: entity-id
            type: uuid
            required: true
            description: The natural person entity to mark as deceased
            lookup:
              table: entities
              entity_type: proper_person
              schema: ob-poc
              search_key: "(search_name (nationality :selectivity 0.7) (date_of_birth :selectivity 0.95 :match-mode year-or-exact))"
              primary_key: entity_id
          - name: date-of-death
            type: date
            required: true
            description: Date of death
          - name: reason
            type: string
            required: false
            description: Documentation reference (e.g., "Death certificate received")
        returns:
          type: record

      convergence-supersede:
        description: Atomically supersede an ownership relationship with a new one in the convergence model
        behavior: plugin
        args:
          - name: cbu-id
            type: uuid
            required: true
            description: CBU context for the supersession
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: old-relationship-id
            type: uuid
            required: true
            description: The relationship being superseded
            lookup:
              table: entity_relationships
              schema: ob-poc
              search_key: relationship_id
              primary_key: relationship_id
          - name: new-owner-entity-id
            type: uuid
            required: true
            description: The new owner entity
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: percentage
            type: decimal
            required: true
            description: New ownership percentage
          - name: reason
            type: string
            required: true
            description: Reason for supersession (e.g., "Share transfer", "Inheritance")
          - name: effective-date
            type: date
            required: false
            description: Effective date (defaults to today)
        returns:
          type: record

      transfer-control:
        description: Transfer control relationship from one entity to another
        behavior: plugin
        args:
          - name: cbu-id
            type: uuid
            required: true
            description: CBU context for the transfer
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: from-entity-id
            type: uuid
            required: true
            description: Entity giving up control
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: to-entity-id
            type: uuid
            required: true
            description: Entity receiving control
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: controlled-entity-id
            type: uuid
            required: true
            description: The entity being controlled
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: control-type
            type: string
            required: true
            description: Type of control relationship
            valid_values:
              - board_member
              - executive
              - voting_rights
              - veto_rights
              - appointee
          - name: reason
            type: string
            required: true
            description: Reason for transfer (e.g., "Board resignation", "Appointment")
          - name: effective-date
            type: date
            required: false
            description: Effective date (defaults to today)
        returns:
          type: record

      waive-verification:
        description: Waive verification requirement for a relationship with documented justification
        behavior: plugin
        args:
          - name: cbu-id
            type: uuid
            required: true
            description: CBU context
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: relationship-id
            type: uuid
            required: true
            description: The relationship whose verification is being waived
            lookup:
              table: entity_relationships
              schema: ob-poc
              search_key: relationship_id
              primary_key: relationship_id
          - name: reason
            type: string
            required: true
            description: Justification for waiver
          - name: approved-by
            type: string
            required: true
            description: Email/ID of approving authority
          - name: waiver-type
            type: string
            required: false
            description: Type of waiver
            valid_values:
              - REGULATORY_EXEMPTION
              - LISTED_COMPANY
              - GOVERNMENT_ENTITY
              - LOW_RISK
              - SENIOR_APPROVAL
        returns:
          type: record

      # =========================================================================
      # UBO Chain Terminus - Mark where ownership chain terminates
      # =========================================================================

      mark-terminus:
        description: Mark an entity as a UBO chain terminus (ownership tracing stops here)
        behavior: crud
        crud:
          operation: upsert
          table: entity_relationships
          schema: ob-poc
          returning: relationship_id
          conflict_keys:
            - from_entity_id
            - to_entity_id
            - relationship_type
        args:
          - name: entity-id
            type: uuid
            required: true
            description: The entity that is the terminus (e.g., public company, government)
            maps_to: from_entity_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: terminus-type
            type: string
            required: true
            description: Why the chain terminates here
            maps_to: control_type
            valid_values:
              - LISTED_COMPANY
              - GOVERNMENT_ENTITY
              - REGULATED_FUND
              - WIDELY_HELD
              - EXCHANGE_TRADED
          - name: exchange
            type: string
            required: false
            description: Stock exchange code if listed (e.g., NYSE, XETRA, LSE)
            maps_to: notes
          - name: lei
            type: string
            required: false
            description: LEI of the public company
          - name: effective-from
            type: date
            required: false
            maps_to: effective_from
        defaults:
          relationship_type: UBO_TERMINUS
          to_entity_id: "00000000-0000-0000-0000-000000000000"
          source: DSL
        returns:
          type: uuid
          name: relationship_id
          capture: true
