# Session Verbs - Astro Navigation Model
#
# Metaphor hierarchy:
#   Universe  = All regions client operates in (global footprint)
#   Galaxy    = Regional (LU, DE, IE) - may have multiple ManCos
#   Cluster   = ManCo's controlled CBUs (gravitational grouping)
#   System    = Single CBU (solar system container)
#   Sun       = SPV/Fund entity at center
#   Planets   = Products, ISDA, KYC, etc.
#
# Session state = HashSet<Uuid> of loaded CBUs
# Focus/camera/viewport = CLIENT SIDE, not DSL verbs
# History: undo/redo stack of session states

domains:
  session:
    description: |
      Manages which CBUs are loaded into the session.
      CBU is the atomic unit. Clusters/galaxies derived from group edges.
      Viewport focus is client-side, not managed here.

    verbs:
      # ============================================
      # Load CBUs into session (mutates state, pushes history)
      # Organized by astro scale: Universe → Galaxy → Cluster → System
      # ============================================

      load-universe:
        description: Load all CBUs (optionally filtered by client)
        behavior: plugin
        handler: SessionLoadUniverseOp
        invocation_phrases:
          - "load universe"
          - "load all"
          - "show everything"
          - "load all CBUs"
        metadata:
          tier: intent
          source_of_truth: session
          noun: session_cbus
          tags: [load, universe, bulk]
        args:
          - name: client-id
            type: uuid
            required: false
            description: Optional client filter (defaults to all)
            lookup:
              table: entities
              schema: ob-poc
              entity_type: entity
              search_key: name
              primary_key: entity_id
        returns:
          type: record
          fields: [count_added, total_loaded]

      load-galaxy:
        description: Load all CBUs in a region/jurisdiction (Galaxy = regional)
        behavior: plugin
        handler: SessionLoadGalaxyOp
        invocation_phrases:
          - "load galaxy"
          - "load jurisdiction"
          - "show all in"
          - "load all CBUs in"
          - "load region"
        metadata:
          tier: intent
          source_of_truth: session
          noun: session_cbus
          tags: [load, galaxy, jurisdiction, bulk]
        args:
          - name: jurisdiction
            type: string
            required: true
            description: ISO country code (LU, IE, DE, US, etc.)
        returns:
          type: record
          fields: [jurisdiction, count_added, total_loaded]

      load-cluster:
        description: Load all CBUs for a client (e.g., "show allianz lux cbu")
        behavior: plugin
        handler: SessionLoadClusterOp
        invocation_phrases:
          - "load cluster"
          - "load book"
          - "show book"
          - "load all funds under"
          - "show all CBUs for"
          - "show all cbus"
          - "load manco"
          - "load group"
          - "show cbu book"
          - "cbu book"
          - "show funds for"
          - "all cbus for"
          - "show cbu universe"
          - "cbu universe"
        metadata:
          tier: intent
          source_of_truth: session
          noun: session_cbus
          tags: [load, cluster, book, client, bulk]
        args:
          - name: client
            type: string
            required: true
            description: Client shorthand (e.g., "allianz", "blackrock") - matches client_label on entities
          - name: jurisdiction
            type: string
            required: false
            description: Filter to specific jurisdiction (LU, DE, IE, etc.)
        returns:
          type: record
          fields: [client, jurisdiction, count_added, total_loaded]

      load-system:
        description: Load a single CBU (Solar System = CBU container)
        behavior: plugin
        handler: SessionLoadSystemOp
        invocation_phrases:
          - "load system"
          - "load cbu"
          - "open cbu"
          - "load fund"
          - "switch to"
          - "show cbu"
        metadata:
          tier: intent
          source_of_truth: session
          noun: session_cbus
          tags: [load, system, cbu]
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
            description: The CBU to load
            lookup:
              table: cbus
              schema: ob-poc
              entity_type: cbu
              search_key: name
              primary_key: cbu_id
        returns:
          type: record
          fields: [cbu_id, name, jurisdiction, total_loaded]

      # ============================================
      # Filter/Narrow scope (removes CBUs not matching filter)
      # ============================================

      filter-jurisdiction:
        description: Narrow session to only CBUs in a specific jurisdiction
        behavior: plugin
        handler: SessionFilterJurisdictionOp
        invocation_phrases:
          - "filter to"
          - "narrow to"
          - "just the"
          - "only"
          - "switch to"
          - "now use"
        metadata:
          tier: intent
          source_of_truth: session
          noun: session_cbus
          tags: [filter, narrow, jurisdiction]
        args:
          - name: jurisdiction
            type: string
            required: true
            description: ISO country code to keep (LU, IE, DE, US, etc.)
        returns:
          type: record
          fields: [jurisdiction, count_kept, count_removed, total_loaded]

      # ============================================
      # Unload CBUs from session
      # ============================================

      unload-system:
        description: Remove a single CBU from the session
        behavior: plugin
        handler: SessionUnloadSystemOp
        invocation_phrases:
          - "unload system"
          - "unload cbu"
          - "remove cbu"
          - "close cbu"
        metadata:
          tier: intent
          source_of_truth: session
          noun: session_cbus
          tags: [unload, system, cbu]
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
            description: The CBU to unload
            lookup:
              table: cbus
              schema: ob-poc
              entity_type: cbu
              search_key: name
              primary_key: cbu_id
        returns:
          type: record
          fields: [cbu_id, name, total_loaded, was_present]

      clear:
        description: Remove all CBUs from session
        behavior: plugin
        handler: SessionClearOp
        metadata:
          tier: intent
          source_of_truth: session
          noun: session_cbus
          tags: [clear, reset]
        args: []
        returns:
          type: record
          fields: [count_removed]

      # ============================================
      # History navigation
      # ============================================

      undo:
        description: Rollback to previous session state
        behavior: plugin
        handler: SessionUndoOp
        metadata:
          tier: intent
          source_of_truth: session
          noun: session_history
          tags: [history, undo]
        args: []
        returns:
          type: record
          fields: [success, total_loaded, history_depth]

      redo:
        description: Re-apply undone state change
        behavior: plugin
        handler: SessionRedoOp
        metadata:
          tier: intent
          source_of_truth: session
          noun: session_history
          tags: [history, redo]
        args: []
        returns:
          type: record
          fields: [success, total_loaded, future_depth]

      # ============================================
      # Query (read-only)
      # ============================================

      info:
        description: Get session summary
        behavior: plugin
        handler: SessionInfoOp
        metadata:
          tier: diagnostics
          source_of_truth: session
          noun: session_info
          tags: [read, info]
        args: []
        returns:
          type: record
          fields:
            [total_cbus, jurisdictions, galaxies, history_depth, future_depth]

      list:
        description: List loaded CBUs
        behavior: plugin
        handler: SessionListOp
        metadata:
          tier: diagnostics
          source_of_truth: session
          noun: session_cbus
          tags: [read, list]
        args:
          - name: limit
            type: integer
            required: false
            default: 100
            description: Max results
          - name: jurisdiction
            type: string
            required: false
            description: Filter by jurisdiction
        returns:
          type: record_set
          fields: [cbu_id, name, jurisdiction, apex_entity]
