# Session Verbs - Astro Navigation Model
#
# Metaphor hierarchy:
#   Universe  = All regions client operates in (global footprint)
#   Galaxy    = Regional (LU, DE, IE) - may have multiple ManCos
#   Cluster   = ManCo's controlled CBUs (gravitational grouping)
#   System    = Single CBU (solar system container)
#   Sun       = SPV/Fund entity at center
#   Planets   = Products, ISDA, KYC, etc.
#
# Session state = HashSet<Uuid> of loaded CBUs
# Focus/camera/viewport = CLIENT SIDE, not DSL verbs
# History: undo/redo stack of session states

domains:
  session:
    description: |
      Manages which CBUs are loaded into the session.
      CBU is the atomic unit. Clusters/galaxies derived from group edges.
      Viewport focus is client-side, not managed here.

    verbs:
      # ============================================
      # Load CBUs into session (mutates state, pushes history)
      # Organized by astro scale: Universe → Galaxy → Cluster → System
      # ============================================

      load-universe:
        description: Load all CBUs (optionally filtered by client)
        behavior: plugin
        handler: SessionLoadUniverseOp
        invocation_phrases:
          - "load universe"
          - "load all"
          - "show everything"
          - "load all CBUs"
        metadata:
          tier: intent
          source_of_truth: session
          noun: session_cbus
          tags: [load, universe, bulk]
        args:
          - name: client-id
            type: uuid
            required: false
            description: Optional client filter (defaults to all)
            lookup:
              table: entities
              schema: ob-poc
              entity_type: entity
              search_key: name
              primary_key: entity_id
        returns:
          type: record
          fields: [count_added, total_loaded]

      load-galaxy:
        description: Load all CBUs in a region/jurisdiction (Galaxy = regional)
        behavior: plugin
        handler: SessionLoadGalaxyOp
        invocation_phrases:
          - "load galaxy"
          - "load jurisdiction"
          - "show all in"
          - "load all CBUs in"
          - "load region"
        metadata:
          tier: intent
          source_of_truth: session
          noun: session_cbus
          tags: [load, galaxy, jurisdiction, bulk]
        args:
          - name: jurisdiction
            type: string
            required: true
            description: ISO country code (LU, IE, DE, US, etc.)
        returns:
          type: record
          fields: [jurisdiction, count_added, total_loaded]

      load-cluster:
        description: Load all CBUs under a GROUP entity (apex of ownership hierarchy)
        behavior: plugin
        handler: SessionLoadClusterOp
        invocation_phrases:
          # Scope-setting trigger phrases (signal intent to set working scope)
          - "work on"
          - "focus on"
          - "set scope to"
          - "switch to"
          - "load book for"
          - "load all funds under"
          - "show all CBUs for"
          - "load group"
          - "load cluster"
          - "load book"
          - "show book"
          # Group-level triggers
          - "show all cbus"
          - "show cbu book"
          - "cbu book"
          - "show funds for"
          - "all cbus for"
          - "show cbu universe"
          - "cbu universe"
          - "load manco"
          # Bare client names - direct scope selection (triggers entity resolution)
          # When user says just "allianz", treat as scope selection intent
          - "allianz"
          - "blackrock"
          - "aviva"
          - "axa"
          - "generali"
          # Client name with context
          - "work on allianz"
          - "work on blackrock"
          - "work on aviva"
          - "focus on allianz"
          - "focus on blackrock"
          - "allianz book"
          - "blackrock book"
          - "allianz group"
          - "blackrock group"
          - "aviva group"
          # Load patterns with client names
          - "load allianz"
          - "load blackrock"
          - "load aviva"
          - "load the allianz book"
          - "load the blackrock book"
          - "load the aviva book"
        metadata:
          tier: intent
          source_of_truth: session
          noun: session_cbus
          tags: [load, cluster, book, client, bulk, scope]
        args:
          # Primary: client nickname (e.g., "Allianz", "BlackRock")
          # Two-stage resolution: nickname → client_group_id → anchor_entity_id
          - name: client
            type: string
            required: false
            description: Client group nickname (e.g., "Allianz", "AGI", "BlackRock")
            # Slot type enables "Allianz rule" - resolves to scope setting
            slot_type: client_group_ref
            # Preferred roles for anchor resolution (in priority order)
            preferred_roles: [governance_controller, ultimate_parent]
            lookup:
              table: client_group
              entity_type: client_group
              schema: ob-poc
              search_key: alias
              primary_key: id
          # Alternative: direct apex entity UUID (for programmatic use)
          - name: apex-entity-id
            type: uuid
            required: false
            description: UUID of the GROUP apex entity (alternative to client)
            lookup:
              table: entities
              entity_type: group
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: jurisdiction
            type: string
            required: false
            description: Filter to specific jurisdiction (LU, DE, IE, etc.)
        validation:
          one_of_required: [client, apex-entity-id]
        returns:
          type: record
          fields: [apex_name, jurisdiction, count_added, total_loaded]

      load-system:
        description: Load a single CBU (Solar System = CBU container)
        behavior: plugin
        handler: SessionLoadSystemOp
        invocation_phrases:
          - "load system"
          - "load cbu"
          - "open cbu"
          - "load fund"
          - "switch to"
          - "show cbu"
        metadata:
          tier: intent
          source_of_truth: session
          noun: session_cbus
          tags: [load, system, cbu]
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
            description: The CBU to load
            lookup:
              table: cbus
              schema: ob-poc
              entity_type: cbu
              search_key: name
              primary_key: cbu_id
        returns:
          type: record
          fields: [cbu_id, name, jurisdiction, total_loaded]

      # ============================================
      # Filter/Narrow scope (removes CBUs not matching filter)
      # ============================================

      filter-jurisdiction:
        description: Narrow session to only CBUs in a specific jurisdiction
        behavior: plugin
        handler: SessionFilterJurisdictionOp
        invocation_phrases:
          - "filter to"
          - "narrow to"
          - "just the"
          - "only"
          - "switch to"
          - "now use"
        metadata:
          tier: intent
          source_of_truth: session
          noun: session_cbus
          tags: [filter, narrow, jurisdiction]
        args:
          - name: jurisdiction
            type: string
            required: true
            description: ISO country code to keep (LU, IE, DE, US, etc.)
        returns:
          type: record
          fields: [jurisdiction, count_kept, count_removed, total_loaded]

      # ============================================
      # Unload CBUs from session
      # ============================================

      unload-system:
        description: Remove a single CBU from the session
        behavior: plugin
        handler: SessionUnloadSystemOp
        invocation_phrases:
          - "unload system"
          - "unload cbu"
          - "remove cbu"
          - "close cbu"
        metadata:
          tier: intent
          source_of_truth: session
          noun: session_cbus
          tags: [unload, system, cbu]
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
            description: The CBU to unload
            lookup:
              table: cbus
              schema: ob-poc
              entity_type: cbu
              search_key: name
              primary_key: cbu_id
        returns:
          type: record
          fields: [cbu_id, name, total_loaded, was_present]

      clear:
        description: Remove all CBUs from session
        behavior: plugin
        handler: SessionClearOp
        metadata:
          tier: intent
          source_of_truth: session
          noun: session_cbus
          tags: [clear, reset]
        args: []
        returns:
          type: record
          fields: [count_removed]

      # ============================================
      # History navigation
      # ============================================

      undo:
        description: Rollback to previous session state
        behavior: plugin
        handler: SessionUndoOp
        metadata:
          tier: intent
          source_of_truth: session
          noun: session_history
          tags: [history, undo]
        args: []
        returns:
          type: record
          fields: [success, total_loaded, history_depth]

      redo:
        description: Re-apply undone state change
        behavior: plugin
        handler: SessionRedoOp
        metadata:
          tier: intent
          source_of_truth: session
          noun: session_history
          tags: [history, redo]
        args: []
        returns:
          type: record
          fields: [success, total_loaded, future_depth]

      # ============================================
      # Query (read-only)
      # ============================================

      info:
        description: Get session summary
        behavior: plugin
        handler: SessionInfoOp
        metadata:
          tier: diagnostics
          source_of_truth: session
          noun: session_info
          tags: [read, info]
        args: []
        returns:
          type: record
          fields:
            [total_cbus, jurisdictions, galaxies, history_depth, future_depth]

      list:
        description: List loaded CBUs
        behavior: plugin
        handler: SessionListOp
        metadata:
          tier: diagnostics
          source_of_truth: session
          noun: session_cbus
          tags: [read, list]
        args:
          - name: limit
            type: integer
            required: false
            default: 100
            description: Max results
          - name: jurisdiction
            type: string
            required: false
            description: Filter by jurisdiction
        returns:
          type: record_set
          fields: [cbu_id, name, jurisdiction, apex_entity]

      # ============================================
      # Client Context (entity resolution scope)
      # ============================================

      set-client:
        description: "Set client group context for entity resolution"
        behavior: plugin
        handler: SessionSetClientOp
        invocation_phrases:
          - "work on"
          - "switch to"
          - "I'm working with"
          - "client is"
          - "set client to"
          - "working on"
        metadata:
          tier: intent
          source_of_truth: session
          noun: session_context
          tags: [context, client]
        args:
          - name: client
            type: string
            required: true
            description: "Client nickname (resolved via client_group_alias)"
            # Slot type enables "Allianz rule" - resolves to scope setting
            slot_type: client_group_ref
            # Preferred roles for anchor resolution (in priority order)
            preferred_roles: [governance_controller, ultimate_parent]
            lookup:
              table: client_group
              entity_type: client_group
              schema: ob-poc
              search_key: alias
              primary_key: id
        returns:
          type: record
          fields: [group_id, group_name, entity_count, candidates]
        effects:
          - "If exact match: sets client_group_id immediately"
          - "If ambiguous (score gap < 0.10): returns top 3 candidates for user selection"
          - "If no match above threshold: returns empty with suggestions"

      set-persona:
        description: "Set persona context for tag filtering"
        behavior: plugin
        handler: SessionSetPersonaOp
        invocation_phrases:
          - "I'm doing kyc"
          - "trading view"
          - "for kyc"
          - "for trading"
          - "kyc mode"
          - "trading mode"
          - "ops mode"
        metadata:
          tier: intent
          source_of_truth: session
          noun: session_context
          tags: [context, persona]
        args:
          - name: persona
            type: string
            required: true
            valid_values: ["kyc", "trading", "ops", "onboarding"]
            description: "Persona for tag filtering"
        returns:
          type: affected
          description: "1 if persona was set"
