domains:
  kyc-case:
    description: KYC case lifecycle management
    verbs:
      create:
        description: Create a new KYC case for a CBU
        behavior: crud
        crud:
          operation: insert
          table: cases
          schema: kyc
          returning: case_id
        emits_event: case.created
        args:
        - name: cbu-id
          type: uuid
          required: true
          maps_to: cbu_id
            lookup:
              table: cbus
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
        - name: case-type
          type: string
          required: false
          maps_to: case_type
          default: NEW_CLIENT
          valid_values:
          - NEW_CLIENT
          - PERIODIC_REVIEW
          - EVENT_DRIVEN
          - REMEDIATION
        - name: sla-deadline
          type: timestamp
          required: false
          maps_to: sla_deadline
        - name: assigned-analyst-id
          type: uuid
          required: false
          maps_to: assigned_analyst_id
            lookup:
              table: entities
              schema: ob-poc
              search_key: name
              primary_key: entity_id
        - name: notes
          type: string
          required: false
          maps_to: notes
        returns:
          type: uuid
          name: case_id
          capture: true
      update-status:
        description: Update case status
        behavior: crud
        crud:
          operation: update
          table: cases
          schema: kyc
          key: case_id
        emits_event: case.status-changed
        args:
        - name: case-id
          type: uuid
          required: true
          maps_to: case_id
            lookup:
              table: cases
              schema: kyc
              search_key: case_id
              primary_key: case_id
        - name: status
          type: string
          required: true
          maps_to: status
          valid_values:
          - INTAKE
          - DISCOVERY
          - ASSESSMENT
          - REVIEW
          - APPROVED
          - REJECTED
          - BLOCKED
          - WITHDRAWN
          - EXPIRED
        returns:
          type: affected
      escalate:
        description: Escalate case to higher authority
        behavior: crud
        crud:
          operation: update
          table: cases
          schema: kyc
          key: case_id
        emits_event: case.escalated
        args:
        - name: case-id
          type: uuid
          required: true
          maps_to: case_id
            lookup:
              table: cases
              schema: kyc
              search_key: case_id
              primary_key: case_id
        - name: escalation-level
          type: string
          required: true
          maps_to: escalation_level
          valid_values:
          - STANDARD
          - SENIOR_COMPLIANCE
          - EXECUTIVE
          - BOARD
        returns:
          type: affected
      assign:
        description: Assign case to analyst and/or reviewer
        behavior: crud
        crud:
          operation: update
          table: cases
          schema: kyc
          key: case_id
        emits_event: case.assigned
        args:
        - name: case-id
          type: uuid
          required: true
          maps_to: case_id
            lookup:
              table: cases
              schema: kyc
              search_key: case_id
              primary_key: case_id
        - name: analyst-id
          type: uuid
          required: false
          maps_to: assigned_analyst_id
            lookup:
              table: entities
              schema: ob-poc
              search_key: name
              primary_key: entity_id
        - name: reviewer-id
          type: uuid
          required: false
          maps_to: assigned_reviewer_id
            lookup:
              table: entities
              schema: ob-poc
              search_key: name
              primary_key: entity_id
        returns:
          type: affected
      set-risk-rating:
        description: Set case risk rating
        behavior: crud
        crud:
          operation: update
          table: cases
          schema: kyc
          key: case_id
        emits_event: case.risk-rated
        args:
        - name: case-id
          type: uuid
          required: true
          maps_to: case_id
            lookup:
              table: cases
              schema: kyc
              search_key: case_id
              primary_key: case_id
        - name: risk-rating
          type: string
          required: true
          maps_to: risk_rating
          valid_values:
          - LOW
          - MEDIUM
          - HIGH
          - VERY_HIGH
          - PROHIBITED
        returns:
          type: affected
      close:
        description: Close the case
        behavior: crud
        crud:
          operation: update
          table: cases
          schema: kyc
          key: case_id
          set_values:
            closed_at: now()
        emits_event: case.closed
        args:
        - name: case-id
          type: uuid
          required: true
          maps_to: case_id
            lookup:
              table: cases
              schema: kyc
              search_key: case_id
              primary_key: case_id
        - name: status
          type: string
          required: true
          maps_to: status
          valid_values:
          - APPROVED
          - REJECTED
          - WITHDRAWN
          - EXPIRED
        - name: notes
          type: string
          required: false
          maps_to: notes
        returns:
          type: affected
      read:
        description: Read case details
        behavior: crud
        crud:
          operation: select
          table: cases
          schema: kyc
        args:
        - name: case-id
          type: uuid
          required: true
          maps_to: case_id
            lookup:
              table: cases
              schema: kyc
              search_key: case_id
              primary_key: case_id
        returns:
          type: record
      list-by-cbu:
        description: List cases for a CBU
        behavior: crud
        crud:
          operation: list_by_fk
          table: cases
          schema: kyc
          fk_col: cbu_id
        args:
        - name: cbu-id
          type: uuid
          required: true
          lookup:
            table: cbus
            schema: ob-poc
            search_key: name
            primary_key: cbu_id
        - name: status
          type: string
          required: false
          maps_to: status
        returns:
          type: record_set
