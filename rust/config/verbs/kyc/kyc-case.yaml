domains:
  kyc-case:
    description: KYC case lifecycle management
    verbs:
      create:
        description: Create a new KYC case for a CBU
        invocation_phrases:
          - "create kyc case"
          - "open case"
          - "start onboarding"
          - "create case for"
        metadata:
          tier: intent
          source_of_truth: workflow
          scope: cbu
          noun: kyc_case
        behavior: crud
        produces:
          type: case
          resolved: false
        consumes:
          - arg: cbu-id
            type: cbu
            required: true
        crud:
          operation: insert
          table: cases
          schema: kyc
          returning: case_id
        emits_event: case.created
        args:
          - name: cbu-id
            type: uuid
            required: true
            maps_to: cbu_id
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: case-type
            type: string
            required: false
            maps_to: case_type
            default: NEW_CLIENT
            valid_values:
              - NEW_CLIENT
              - PERIODIC_REVIEW
              - EVENT_DRIVEN
              - REMEDIATION
          - name: sla-deadline
            type: timestamp
            required: false
            maps_to: sla_deadline
          - name: assigned-analyst-id
            type: uuid
            required: false
            maps_to: assigned_analyst_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: notes
            type: string
            required: false
            maps_to: notes
        returns:
          type: uuid
          name: case_id
          capture: true
      update-status:
        description: Update case status
        metadata:
          tier: intent
          source_of_truth: workflow
          scope: cbu
          noun: kyc_case
        behavior: crud
        crud:
          operation: update
          table: cases
          schema: kyc
          key: case_id
        emits_event: case.status-changed
        args:
          - name: case-id
            type: uuid
            required: true
            maps_to: case_id
            lookup:
              table: cases
              entity_type: kyc_case
              schema: kyc
              search_key: case_id
              primary_key: case_id
          - name: status
            type: string
            required: true
            maps_to: status
            valid_values:
              - INTAKE
              - DISCOVERY
              - ASSESSMENT
              - REVIEW
              - APPROVED
              - REJECTED
              - BLOCKED
              - WITHDRAWN
              - EXPIRED
              - REFER_TO_REGULATOR
              - DO_NOT_ONBOARD
        returns:
          type: affected
      escalate:
        description: Escalate case to higher authority
        invocation_phrases:
          - "escalate case"
          - "escalate kyc case"
          - "raise to senior"
        metadata:
          tier: intent
          source_of_truth: workflow
          scope: cbu
          noun: kyc_case
        behavior: crud
        crud:
          operation: update
          table: cases
          schema: kyc
          key: case_id
        emits_event: case.escalated
        args:
          - name: case-id
            type: uuid
            required: true
            maps_to: case_id
            lookup:
              table: cases
              entity_type: kyc_case
              schema: kyc
              search_key: case_id
              primary_key: case_id
          - name: escalation-level
            type: string
            required: true
            maps_to: escalation_level
            valid_values:
              - STANDARD
              - SENIOR_COMPLIANCE
              - EXECUTIVE
              - BOARD
        returns:
          type: affected
      assign:
        description: Assign case to analyst and/or reviewer
        invocation_phrases:
          - "assign case"
          - "assign to analyst"
          - "assign case to"
        metadata:
          tier: intent
          source_of_truth: workflow
          scope: cbu
          noun: kyc_case
        behavior: crud
        crud:
          operation: update
          table: cases
          schema: kyc
          key: case_id
        emits_event: case.assigned
        args:
          - name: case-id
            type: uuid
            required: true
            maps_to: case_id
            lookup:
              table: cases
              entity_type: kyc_case
              schema: kyc
              search_key: case_id
              primary_key: case_id
          - name: analyst-id
            type: uuid
            required: false
            maps_to: assigned_analyst_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
          - name: reviewer-id
            type: uuid
            required: false
            maps_to: assigned_reviewer_id
            lookup:
              table: entities
              entity_type: entity
              schema: ob-poc
              search_key: name
              primary_key: entity_id
        returns:
          type: affected
      set-risk-rating:
        description: Set case risk rating
        metadata:
          tier: intent
          source_of_truth: workflow
          scope: cbu
          noun: kyc_case
        behavior: crud
        crud:
          operation: update
          table: cases
          schema: kyc
          key: case_id
        emits_event: case.risk-rated
        args:
          - name: case-id
            type: uuid
            required: true
            maps_to: case_id
            lookup:
              table: cases
              entity_type: kyc_case
              schema: kyc
              search_key: case_id
              primary_key: case_id
          - name: risk-rating
            type: string
            required: true
            maps_to: risk_rating
            valid_values:
              - LOW
              - MEDIUM
              - HIGH
              - VERY_HIGH
              - PROHIBITED
        returns:
          type: affected
      close:
        description: Close the case
        metadata:
          tier: intent
          source_of_truth: workflow
          scope: cbu
          noun: kyc_case
        behavior: crud
        crud:
          operation: update
          table: cases
          schema: kyc
          key: case_id
          set_values:
            closed_at: now()
        emits_event: case.closed
        args:
          - name: case-id
            type: uuid
            required: true
            maps_to: case_id
            lookup:
              table: cases
              entity_type: kyc_case
              schema: kyc
              search_key: case_id
              primary_key: case_id
          - name: status
            type: string
            required: true
            maps_to: status
            valid_values:
              - APPROVED
              - REJECTED
              - WITHDRAWN
              - EXPIRED
              - REFER_TO_REGULATOR
              - DO_NOT_ONBOARD
          - name: notes
            type: string
            required: false
            maps_to: notes
        returns:
          type: affected
      read:
        description: Read case details
        metadata:
          tier: reference
          source_of_truth: workflow
          scope: cbu
          noun: kyc_case
        behavior: crud
        crud:
          operation: select
          table: cases
          schema: kyc
        args:
          - name: case-id
            type: uuid
            required: true
            maps_to: case_id
            lookup:
              table: cases
              entity_type: kyc_case
              schema: kyc
              search_key: case_id
              primary_key: case_id
        returns:
          type: record
      list-by-cbu:
        description: List cases for a CBU
        metadata:
          tier: reference
          source_of_truth: workflow
          scope: cbu
          noun: kyc_case
        behavior: crud
        crud:
          operation: list_by_fk
          table: cases
          schema: kyc
          fk_col: cbu_id
        args:
          - name: cbu-id
            type: uuid
            required: true
            lookup:
              table: cbus
              entity_type: cbu
              schema: ob-poc
              search_key: name
              primary_key: cbu_id
          - name: status
            type: string
            required: false
            maps_to: status
        returns:
          type: record_set
      reopen:
        description: Reopen a closed case for remediation or review
        metadata:
          tier: intent
          source_of_truth: workflow
          scope: cbu
          noun: kyc_case
        behavior: crud
        crud:
          operation: update
          table: cases
          schema: kyc
          key: case_id
          set_values:
            closed_at: null
        emits_event: case.reopened
        args:
          - name: case-id
            type: uuid
            required: true
            maps_to: case_id
            lookup:
              table: cases
              entity_type: kyc_case
              schema: kyc
              search_key: case_id
              primary_key: case_id
          - name: reopen-reason
            type: string
            required: true
            maps_to: notes
          - name: new-case-type
            type: string
            required: false
            maps_to: case_type
            default: REMEDIATION
            valid_values:
              - REMEDIATION
              - EVENT_DRIVEN
              - PERIODIC_REVIEW
          - name: new-status
            type: string
            required: false
            maps_to: status
            default: INTAKE
            valid_values:
              - INTAKE
              - DISCOVERY
        returns:
          type: affected
      state:
        description: Get full case state with workstreams and embedded awaiting requests
        metadata:
          tier: intent
          source_of_truth: workflow
          scope: cbu
          noun: kyc_case
        behavior: plugin
        handler: KycCaseStateOp
        args:
          - name: case-id
            type: uuid
            required: true
            lookup:
              table: cases
              entity_type: kyc_case
              schema: kyc
              search_key: case_id
              primary_key: case_id
        returns:
          type: record
          description: |
            Returns domain-coherent case state with workstreams containing
            embedded `awaiting` arrays. Requests appear as child nodes of
            workstreams, not as a separate list. Includes summary counts
            and attention items for overdue requests.
