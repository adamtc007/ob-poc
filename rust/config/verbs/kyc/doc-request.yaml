domains:
  doc-request:
    description: Document collection and verification for KYC workstreams
    verbs:
      create:
        description: Create a document request
        behavior: crud
        crud:
          operation: insert
          table: doc_requests
          schema: kyc
          returning: request_id
        emits_event: doc-request.created
        args:
        - name: workstream-id
          type: uuid
          required: true
          maps_to: workstream_id
            lookup:
              table: entity_workstreams
              schema: kyc
              search_key: workstream_id
              primary_key: workstream_id
        - name: doc-type
          type: string
          required: true
          maps_to: doc_type
          valid_values:
          - PASSPORT
          - NATIONAL_ID
          - DRIVERS_LICENSE
          - PROOF_OF_ADDRESS
          - CERT_OF_INCORPORATION
          - CERT_OF_GOOD_STANDING
          - MEMORANDUM_ARTICLES
          - REGISTER_OF_DIRECTORS
          - REGISTER_OF_SHAREHOLDERS
          - ANNUAL_RETURN
          - TRUST_DEED
          - LETTER_OF_WISHES
          - DEED_OF_APPOINTMENT
          - BANK_STATEMENT
          - SOURCE_OF_WEALTH
          - SOURCE_OF_FUNDS
          - FINANCIAL_STATEMENTS
          - TAX_RETURN
          - REGULATORY_LICENSE
          - POWER_OF_ATTORNEY
          - BOARD_RESOLUTION
          - SIGNATORY_LIST
        - name: due-date
          type: date
          required: false
          maps_to: due_date
        - name: is-mandatory
          type: boolean
          required: false
          maps_to: is_mandatory
          default: true
        - name: priority
          type: string
          required: false
          maps_to: priority
          default: NORMAL
          valid_values:
          - LOW
          - NORMAL
          - HIGH
          - URGENT
        returns:
          type: uuid
          name: request_id
          capture: true
      mark-requested:
        description: Mark document as formally requested
        behavior: crud
        crud:
          operation: update
          table: doc_requests
          schema: kyc
          key: request_id
          set_values:
            status: REQUESTED
            requested_at: now()
        emits_event: doc-request.requested
        args:
        - name: request-id
          type: uuid
          required: true
          maps_to: request_id
            lookup:
              table: doc_requests
              schema: kyc
              search_key: request_id
              primary_key: request_id
        returns:
          type: affected
      receive:
        description: Record document received
        behavior: crud
        crud:
          operation: update
          table: doc_requests
          schema: kyc
          key: request_id
          set_values:
            status: RECEIVED
            received_at: now()
        emits_event: doc-request.received
        args:
        - name: request-id
          type: uuid
          required: true
          maps_to: request_id
            lookup:
              table: doc_requests
              schema: kyc
              search_key: request_id
              primary_key: request_id
        - name: document-id
          type: uuid
          required: true
          maps_to: document_id
            lookup:
              table: document_catalog
              schema: ob-poc
              search_key: document_name
              primary_key: doc_id
        returns:
          type: affected
      verify:
        description: Verify document as valid
        behavior: crud
        crud:
          operation: update
          table: doc_requests
          schema: kyc
          key: request_id
          set_values:
            status: VERIFIED
            verified_at: now()
        emits_event: doc-request.verified
        args:
        - name: request-id
          type: uuid
          required: true
          maps_to: request_id
            lookup:
              table: doc_requests
              schema: kyc
              search_key: request_id
              primary_key: request_id
        - name: notes
          type: string
          required: false
          maps_to: verification_notes
        returns:
          type: affected
      reject:
        description: Reject document
        behavior: crud
        crud:
          operation: update
          table: doc_requests
          schema: kyc
          key: request_id
          set_values:
            status: REJECTED
        emits_event: doc-request.rejected
        args:
        - name: request-id
          type: uuid
          required: true
          maps_to: request_id
            lookup:
              table: doc_requests
              schema: kyc
              search_key: request_id
              primary_key: request_id
        - name: reason
          type: string
          required: true
          maps_to: rejection_reason
        returns:
          type: affected
      waive:
        description: Waive document requirement
        behavior: crud
        crud:
          operation: update
          table: doc_requests
          schema: kyc
          key: request_id
          set_values:
            status: WAIVED
        emits_event: doc-request.waived
        args:
        - name: request-id
          type: uuid
          required: true
          maps_to: request_id
            lookup:
              table: doc_requests
              schema: kyc
              search_key: request_id
              primary_key: request_id
        - name: notes
          type: string
          required: true
          maps_to: verification_notes
        returns:
          type: affected
      list-by-workstream:
        description: List document requests for a workstream
        behavior: crud
        crud:
          operation: list_by_fk
          table: doc_requests
          schema: kyc
          fk_col: workstream_id
        args:
        - name: workstream-id
          type: uuid
          required: true
          lookup:
            table: entity_workstreams
            schema: kyc
            search_key: workstream_id
            primary_key: workstream_id
        - name: status
          type: string
          required: false
          maps_to: status
        returns:
          type: record_set
