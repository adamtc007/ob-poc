<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>OB-POC Agent Session</title>
        <style>
            * {
                box-sizing: border-box;
            }
            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    sans-serif;
                max-width: 1600px;
                margin: 0 auto;
                padding: 20px;
                background: #f5f5f5;
            }
            h1 {
                color: #333;
                margin-bottom: 10px;
            }
            .header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
                padding-bottom: 15px;
                border-bottom: 1px solid #ddd;
            }
            .session-info {
                color: #666;
                font-size: 14px;
            }
            .session-info.active {
                color: #4caf50;
            }
            .session-state {
                display: inline-block;
                padding: 4px 10px;
                border-radius: 4px;
                font-size: 12px;
                font-weight: 600;
                margin-left: 10px;
                text-transform: uppercase;
            }
            .session-state.new {
                background: #e3f2fd;
                color: #1976d2;
            }
            .session-state.pending_validation {
                background: #fff3e0;
                color: #f57c00;
            }
            .session-state.ready_to_execute {
                background: #e8f5e9;
                color: #388e3c;
            }
            .session-state.executing {
                background: #fce4ec;
                color: #c2185b;
            }
            .session-state.executed {
                background: #f3e5f5;
                color: #7b1fa2;
            }
            .new-session-btn {
                background: #2196f3;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
            }
            .new-session-btn:hover {
                background: #1976d2;
            }
            .container {
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                gap: 20px;
            }
            .panel {
                background: white;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                overflow: hidden;
            }
            .panel-header {
                background: #fafafa;
                padding: 12px 16px;
                border-bottom: 1px solid #eee;
                font-weight: 600;
                color: #333;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .chat {
                height: 500px;
                overflow-y: auto;
                padding: 16px;
            }
            .intents-panel {
                height: 500px;
                overflow-y: auto;
                padding: 16px;
                background: #fafafa;
            }
            .dsl-preview {
                background: #1e1e1e;
                color: #d4d4d4;
                height: 500px;
                overflow-y: auto;
                padding: 16px;
                font-family: "SF Mono", Monaco, "Courier New", monospace;
                font-size: 13px;
            }
            .input-area {
                display: flex;
                gap: 10px;
                padding: 16px;
                background: #fafafa;
                border-top: 1px solid #eee;
            }
            .input-area input {
                flex: 1;
                padding: 12px 16px;
                border: 1px solid #ddd;
                border-radius: 6px;
                font-size: 14px;
            }
            .input-area input:focus {
                outline: none;
                border-color: #2196f3;
            }
            .input-area button {
                padding: 12px 24px;
                background: #2196f3;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
            }
            .input-area button:hover {
                background: #1976d2;
            }
            .input-area button:disabled {
                background: #ccc;
                cursor: not-allowed;
            }
            .message {
                margin: 12px 0;
                padding: 12px 16px;
                border-radius: 8px;
                line-height: 1.5;
            }
            .user {
                background: #e3f2fd;
                margin-left: 20px;
            }
            .agent {
                background: #f5f5f5;
                margin-right: 20px;
            }
            .message-role {
                font-size: 11px;
                font-weight: 600;
                text-transform: uppercase;
                color: #666;
                margin-bottom: 6px;
            }
            .intent-card {
                background: white;
                border: 1px solid #e0e0e0;
                border-radius: 6px;
                padding: 12px;
                margin-bottom: 12px;
            }
            .intent-card.valid {
                border-left: 3px solid #4caf50;
            }
            .intent-card.invalid {
                border-left: 3px solid #f44336;
            }
            .intent-verb {
                font-weight: 600;
                color: #1976d2;
                font-family: monospace;
                font-size: 14px;
            }
            .intent-params {
                margin-top: 8px;
                font-size: 13px;
            }
            .intent-param {
                display: flex;
                margin: 4px 0;
            }
            .intent-param-key {
                color: #666;
                min-width: 100px;
            }
            .intent-param-value {
                color: #333;
                font-family: monospace;
            }
            .intent-refs {
                margin-top: 8px;
                padding-top: 8px;
                border-top: 1px dashed #e0e0e0;
                font-size: 12px;
                color: #f57c00;
            }
            .validation-errors {
                margin-top: 8px;
                padding: 8px;
                background: #ffebee;
                border-radius: 4px;
                font-size: 12px;
                color: #c62828;
            }
            .dsl-block {
                background: #2d2d2d;
                padding: 12px;
                margin: 10px 0;
                border-radius: 4px;
                font-family: "SF Mono", Monaco, "Courier New", monospace;
                font-size: 12px;
                white-space: pre-wrap;
                word-break: break-all;
            }
            .dsl-block.valid {
                border-left: 3px solid #4caf50;
            }
            .dsl-block.invalid {
                border-left: 3px solid #f44336;
            }
            .dsl-item {
                background: #2d2d2d;
                padding: 10px 12px;
                margin: 8px 0;
                border-radius: 4px;
                border-left: 3px solid #4caf50;
            }
            .execute-area {
                padding: 16px;
                background: #fafafa;
                border-top: 1px solid #eee;
                display: flex;
                gap: 10px;
            }
            .execute-btn {
                flex: 1;
                padding: 14px;
                background: #4caf50;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
            }
            .execute-btn:hover {
                background: #43a047;
            }
            .execute-btn:disabled {
                background: #ccc;
                cursor: not-allowed;
            }
            .clear-btn {
                padding: 14px 20px;
                background: #ff5722;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
            }
            .clear-btn:hover {
                background: #e64a19;
            }
            .clear-btn:disabled {
                background: #ccc;
                cursor: not-allowed;
            }
            .empty-state {
                color: #999;
                text-align: center;
                padding: 40px;
            }
            .loading {
                color: #999;
                font-style: italic;
            }
            .error-message {
                color: #c62828;
                background: #ffebee;
                padding: 12px;
                border-radius: 6px;
                margin: 10px 0;
            }
            .success-message {
                color: #2e7d32;
                background: #e8f5e9;
                padding: 12px;
                border-radius: 6px;
                margin: 10px 0;
            }
            .badge {
                display: inline-block;
                padding: 2px 8px;
                border-radius: 4px;
                font-size: 11px;
                font-weight: 600;
            }
            .badge.valid {
                background: #e8f5e9;
                color: #2e7d32;
            }
            .badge.invalid {
                background: #ffebee;
                color: #c62828;
            }
            .badge.count {
                background: #e3f2fd;
                color: #1976d2;
            }
        </style>
    </head>
    <body>
        <div class="header">
            <div>
                <h1>OB-POC Agent Session</h1>
                <div>
                    <span id="session-info" class="session-info"
                        >No active session</span
                    >
                    <span
                        id="session-state"
                        class="session-state"
                        style="display: none"
                    ></span>
                </div>
            </div>
            <button class="new-session-btn" onclick="createSession()">
                New Session
            </button>
        </div>

        <div class="container">
            <div class="panel">
                <div class="panel-header">Chat</div>
                <div class="chat" id="chat">
                    <div class="empty-state">
                        Create a session to start chatting
                    </div>
                </div>
                <div class="input-area">
                    <input
                        type="text"
                        id="message"
                        placeholder="Describe what you want to create..."
                        onkeypress="if(event.key==='Enter')sendMessage()"
                        disabled
                    />
                    <button onclick="sendMessage()" id="send-btn" disabled>
                        Send
                    </button>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    Extracted Intents
                    <span
                        class="badge count"
                        id="intent-count"
                        style="display: none"
                        >0</span
                    >
                </div>
                <div class="intents-panel" id="intents-panel">
                    <div class="empty-state">Intents will appear here</div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    Assembled DSL
                    <span
                        class="badge count"
                        id="dsl-count"
                        style="display: none"
                        >0</span
                    >
                </div>
                <div class="dsl-preview" id="dsl-preview">
                    <div class="empty-state" style="color: #666">
                        DSL will appear here
                    </div>
                </div>
                <div class="execute-area">
                    <button
                        class="execute-btn"
                        id="execute-btn"
                        disabled
                        onclick="executeDsl()"
                    >
                        Execute All DSL
                    </button>
                    <button
                        class="clear-btn"
                        id="clear-btn"
                        disabled
                        onclick="clearDsl()"
                    >
                        Clear
                    </button>
                </div>
            </div>
        </div>

        <script>
            let sessionId = null;
            const API = window.location.origin;

            async function createSession() {
                try {
                    const res = await fetch(`${API}/api/session`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({}),
                    });

                    if (!res.ok) throw new Error(`HTTP ${res.status}`);

                    const data = await res.json();
                    sessionId = data.session_id;

                    document.getElementById("session-info").textContent =
                        `Session: ${sessionId.substring(0, 8)}...`;
                    document.getElementById("session-info").className =
                        "session-info active";
                    updateSessionState(data.state);

                    document.getElementById("chat").innerHTML =
                        '<div class="empty-state">Session started. Describe what you want to create!</div>';
                    document.getElementById("intents-panel").innerHTML =
                        '<div class="empty-state">Intents will appear here</div>';
                    document.getElementById("dsl-preview").innerHTML =
                        '<div class="empty-state" style="color: #666;">DSL will appear here</div>';

                    document.getElementById("intent-count").style.display =
                        "none";
                    document.getElementById("dsl-count").style.display = "none";
                    document.getElementById("message").disabled = false;
                    document.getElementById("send-btn").disabled = false;
                    document.getElementById("execute-btn").disabled = true;
                    document.getElementById("clear-btn").disabled = true;
                    document.getElementById("message").focus();
                } catch (err) {
                    alert("Failed to create session: " + err.message);
                }
            }

            async function sendMessage() {
                if (!sessionId) {
                    alert("Create a session first");
                    return;
                }

                const input = document.getElementById("message");
                const message = input.value.trim();
                if (!message) return;

                addMessage("user", message);
                input.value = "";

                const loadingDiv = document.createElement("div");
                loadingDiv.className = "message agent loading";
                loadingDiv.innerHTML =
                    '<div class="message-role">Agent</div>Extracting intents...';
                document.getElementById("chat").appendChild(loadingDiv);
                scrollChat();

                try {
                    const res = await fetch(
                        `${API}/api/session/${sessionId}/chat`,
                        {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ message }),
                        },
                    );

                    if (!res.ok) throw new Error(`HTTP ${res.status}`);

                    const data = await res.json();
                    loadingDiv.remove();

                    // Show agent response
                    let content = escapeHtml(data.message);

                    // Show validation summary
                    if (data.intents && data.intents.length > 0) {
                        const validCount = data.validation_results.filter(
                            (v) => v.valid,
                        ).length;
                        const totalCount = data.intents.length;
                        if (validCount === totalCount) {
                            content += ` <span class="badge valid">${validCount}/${totalCount} valid</span>`;
                        } else {
                            content += ` <span class="badge invalid">${validCount}/${totalCount} valid</span>`;
                        }
                    }

                    addMessage("agent", content);

                    // Update intents panel
                    updateIntentsPanel(data.intents, data.validation_results);

                    // Update DSL preview
                    if (data.assembled_dsl) {
                        updateDslPreview(data.assembled_dsl.statements);
                    }

                    // Update session state
                    updateSessionState(data.session_state);

                    // Update buttons
                    document.getElementById("execute-btn").disabled =
                        !data.can_execute;
                    document.getElementById("clear-btn").disabled =
                        !data.assembled_dsl ||
                        data.assembled_dsl.statements.length === 0;
                } catch (err) {
                    loadingDiv.remove();
                    addMessage(
                        "agent",
                        `<div class="error-message">Error: ${escapeHtml(err.message)}</div>`,
                    );
                }
            }

            async function executeDsl() {
                if (!sessionId) return;

                const btn = document.getElementById("execute-btn");
                btn.disabled = true;
                btn.textContent = "Executing...";

                try {
                    const res = await fetch(
                        `${API}/api/session/${sessionId}/execute`,
                        {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ dry_run: false }),
                        },
                    );

                    if (!res.ok) throw new Error(`HTTP ${res.status}`);

                    const data = await res.json();

                    if (data.success) {
                        addMessage(
                            "agent",
                            `<div class="success-message">Successfully executed ${data.results.length} DSL statement(s)</div>`,
                        );
                        updateDslPreview([]);
                        document.getElementById("intents-panel").innerHTML =
                            '<div class="empty-state">Intents will appear here</div>';
                        document.getElementById("intent-count").style.display =
                            "none";
                    } else {
                        let errorContent =
                            '<div class="error-message">Execution failed:<br>';
                        data.errors.forEach((err) => {
                            errorContent += `${escapeHtml(err)}<br>`;
                        });
                        errorContent += "</div>";
                        addMessage("agent", errorContent);
                    }

                    updateSessionState(data.new_state);
                } catch (err) {
                    addMessage(
                        "agent",
                        `<div class="error-message">Execution error: ${escapeHtml(err.message)}</div>`,
                    );
                }

                btn.textContent = "Execute All DSL";
                await refreshSessionState();
            }

            async function clearDsl() {
                if (!sessionId) return;

                try {
                    const res = await fetch(
                        `${API}/api/session/${sessionId}/clear`,
                        {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                        },
                    );

                    if (!res.ok) throw new Error(`HTTP ${res.status}`);

                    const data = await res.json();
                    updateDslPreview([]);
                    updateSessionState(data.state);
                    document.getElementById("intents-panel").innerHTML =
                        '<div class="empty-state">Intents will appear here</div>';
                    document.getElementById("intent-count").style.display =
                        "none";
                    addMessage("agent", "DSL cleared.");
                } catch (err) {
                    addMessage(
                        "agent",
                        `<div class="error-message">Error: ${escapeHtml(err.message)}</div>`,
                    );
                }
            }

            async function refreshSessionState() {
                if (!sessionId) return;

                try {
                    const res = await fetch(`${API}/api/session/${sessionId}`);
                    if (res.ok) {
                        const data = await res.json();
                        updateDslPreview(data.accumulated_dsl);
                        updateSessionState(data.state);
                        document.getElementById("execute-btn").disabled =
                            !data.can_execute;
                        document.getElementById("clear-btn").disabled =
                            data.accumulated_dsl.length === 0;
                    }
                } catch (err) {
                    console.error("Failed to refresh session state:", err);
                }
            }

            function updateSessionState(state) {
                const el = document.getElementById("session-state");
                if (state) {
                    el.textContent = state.replace("_", " ");
                    el.className = `session-state ${state}`;
                    el.style.display = "inline-block";
                } else {
                    el.style.display = "none";
                }
            }

            function updateIntentsPanel(intents, validations) {
                const panel = document.getElementById("intents-panel");
                const countEl = document.getElementById("intent-count");

                if (!intents || intents.length === 0) {
                    panel.innerHTML =
                        '<div class="empty-state">No intents extracted</div>';
                    countEl.style.display = "none";
                    return;
                }

                countEl.textContent = intents.length;
                countEl.style.display = "inline-block";

                let html = "";
                intents.forEach((intent, i) => {
                    const validation = validations && validations[i];
                    const isValid = validation ? validation.valid : true;

                    html += `<div class="intent-card ${isValid ? "valid" : "invalid"}">`;
                    html += `<div class="intent-verb">${escapeHtml(intent.verb)}</div>`;

                    // Parameters
                    if (
                        intent.params &&
                        Object.keys(intent.params).length > 0
                    ) {
                        html += '<div class="intent-params">';
                        for (const [key, value] of Object.entries(
                            intent.params,
                        )) {
                            const displayValue =
                                typeof value === "object"
                                    ? JSON.stringify(value)
                                    : value;
                            html += `<div class="intent-param">
                            <span class="intent-param-key">:${escapeHtml(key)}</span>
                            <span class="intent-param-value">${escapeHtml(String(displayValue))}</span>
                        </div>`;
                        }
                        html += "</div>";
                    }

                    // References
                    if (intent.refs && Object.keys(intent.refs).length > 0) {
                        html += '<div class="intent-refs">';
                        for (const [key, ref] of Object.entries(intent.refs)) {
                            html += `<span>:${escapeHtml(key)} = ${escapeHtml(ref)}</span> `;
                        }
                        html += "</div>";
                    }

                    // Validation errors
                    if (validation && !validation.valid && validation.errors) {
                        html += '<div class="validation-errors">';
                        validation.errors.forEach((err) => {
                            html += `${escapeHtml(err.message)}<br>`;
                        });
                        html += "</div>";
                    }

                    html += "</div>";
                });

                panel.innerHTML = html;
            }

            function updateDslPreview(dslList) {
                const preview = document.getElementById("dsl-preview");
                const countEl = document.getElementById("dsl-count");

                if (!dslList || dslList.length === 0) {
                    preview.innerHTML =
                        '<div class="empty-state" style="color: #666;">DSL will appear here</div>';
                    countEl.style.display = "none";
                    document.getElementById("execute-btn").disabled = true;
                    document.getElementById("clear-btn").disabled = true;
                } else {
                    countEl.textContent = dslList.length;
                    countEl.style.display = "inline-block";
                    preview.innerHTML = dslList
                        .map(
                            (d, i) =>
                                `<div class="dsl-item"><span style="color: #888; font-size: 11px;"># Statement ${i + 1}</span><br>${escapeHtml(d)}</div>`,
                        )
                        .join("");
                    document.getElementById("execute-btn").disabled = false;
                    document.getElementById("clear-btn").disabled = false;
                }
            }

            function addMessage(role, content) {
                const chat = document.getElementById("chat");
                const emptyState = chat.querySelector(".empty-state");
                if (emptyState) emptyState.remove();

                const div = document.createElement("div");
                div.className = `message ${role}`;
                div.innerHTML = `<div class="message-role">${role === "user" ? "You" : "Agent"}</div>${content}`;
                chat.appendChild(div);
                scrollChat();
            }

            function scrollChat() {
                const chat = document.getElementById("chat");
                chat.scrollTop = chat.scrollHeight;
            }

            function escapeHtml(text) {
                if (!text) return "";
                const div = document.createElement("div");
                div.textContent = text;
                return div.innerHTML;
            }

            document.addEventListener("DOMContentLoaded", () => {
                document.getElementById("message").focus();
            });
        </script>
    </body>
</html>
