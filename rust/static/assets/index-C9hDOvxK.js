var b=Object.defineProperty;var I=(n,e,t)=>e in n?b(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var l=(n,e,t)=>I(n,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&r(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();const T=window.location.origin;class $ extends Error{constructor(e,t){super(t),this.status=e,this.name="ApiError"}}async function d(n,e,t){const r={method:n,headers:{"Content-Type":"application/json"}};t!==void 0&&(r.body=JSON.stringify(t));const s=await fetch(`${T}${e}`,r);if(!s.ok)throw new $(s.status,`HTTP ${s.status}`);const i=await s.text();if(i)return JSON.parse(i)}const f={createSession(n={}){return d("POST","/api/session",n)},getSession(n){return d("GET",`/api/session/${n}`)},deleteSession(n){return d("DELETE",`/api/session/${n}`)},chat(n,e){return d("POST",`/api/session/${n}/chat`,e)},execute(n,e={}){return d("POST",`/api/session/${n}/execute`,e)},clear(n){return d("POST",`/api/session/${n}/clear`)},searchEntities(n){var t;const e=new URLSearchParams;return e.set("q",n.q),(t=n.types)!=null&&t.length&&e.set("types",n.types.join(",")),n.limit&&e.set("limit",String(n.limit)),d("GET",`/api/entities/search?${e}`)},listTemplates(){return d("GET","/api/templates")},getTemplate(n){return d("GET",`/api/templates/${encodeURIComponent(n)}`)},renderTemplate(n,e){return d("POST",`/api/templates/${encodeURIComponent(n)}/render`,{values:e})}};class k{constructor(e){l(this,"config");l(this,"input");l(this,"dropdown");l(this,"selectedEntity",null);l(this,"debounceTimer",null);l(this,"isOpen",!1);this.config=e,this.input=this.createInput(),this.dropdown=this.createDropdown(),this.render(),this.bindEvents()}createInput(){const e=document.createElement("input");return e.type="text",e.className="entity-picker-input",e.placeholder=this.config.placeholder||"Search...",e}createDropdown(){const e=document.createElement("div");return e.className="entity-picker-dropdown",e.style.display="none",e}render(){const e=document.createElement("div");e.className="entity-picker",e.appendChild(this.input),e.appendChild(this.dropdown),this.config.container.appendChild(e)}bindEvents(){this.input.addEventListener("input",()=>this.handleInput()),this.input.addEventListener("focus",()=>this.handleFocus()),this.input.addEventListener("blur",()=>{setTimeout(()=>this.close(),300)}),this.input.addEventListener("keydown",e=>this.handleKeydown(e))}handleInput(){const e=this.input.value.trim();if(console.log("[EntityPicker] handleInput triggered, query:",e),this.debounceTimer&&clearTimeout(this.debounceTimer),e.length<2){this.close();return}this.debounceTimer=window.setTimeout(()=>{this.search(e)},200)}handleFocus(){this.input.value.trim().length>=2&&this.search(this.input.value.trim())}handleKeydown(e){e.key==="Escape"?this.close():e.key==="ArrowDown"&&this.isOpen?(e.preventDefault(),this.focusNextItem()):e.key==="ArrowUp"&&this.isOpen?(e.preventDefault(),this.focusPrevItem()):e.key==="Enter"&&this.isOpen&&(e.preventDefault(),this.selectFocusedItem())}async search(e){try{console.log("[EntityPicker] Searching:",{query:e,types:this.config.allowedTypes});const t=await f.searchEntities({q:e,types:this.config.allowedTypes,limit:10});console.log("[EntityPicker] Results:",t),this.renderResults(t)}catch(t){console.error("[EntityPicker] Search failed:",t),this.renderError("Search failed")}}renderResults(e){if(this.dropdown.innerHTML="",e.results.length===0){const t=document.createElement("div");t.className="entity-picker-empty",t.textContent="No results found",this.dropdown.appendChild(t)}else if(e.results.forEach((t,r)=>{const s=this.createResultItem(t,r);this.dropdown.appendChild(s)}),e.truncated){const t=document.createElement("div");t.className="entity-picker-more",t.textContent=`${e.total-e.results.length} more results...`,this.dropdown.appendChild(t)}if(this.config.allowCreate){const t=document.createElement("div");t.className="entity-picker-divider",this.dropdown.appendChild(t),this.config.allowedTypes.forEach(r=>{if(r!=="CBU"){const s=document.createElement("div");s.className="entity-picker-item entity-picker-create",s.innerHTML=`<span class="create-icon">+</span> Create New ${r.toLowerCase()}`,s.addEventListener("click",()=>{this.config.onCreate&&this.config.onCreate(r),this.close()}),this.dropdown.appendChild(s)}})}this.open()}createResultItem(e,t){const r=document.createElement("div");r.className="entity-picker-item",r.dataset.index=String(t),r.dataset.id=e.id;const s=document.createElement("span");s.className=`entity-type entity-type-${e.entity_type.toLowerCase()}`,s.textContent=e.entity_type;const i=document.createElement("span");i.className="entity-name",i.textContent=e.display_name;const o=document.createElement("span");return o.className="entity-subtitle",o.textContent=[e.subtitle,e.detail].filter(Boolean).join(" - "),r.appendChild(s),r.appendChild(i),r.appendChild(o),r.addEventListener("click",()=>this.selectEntity(e)),r}renderError(e){this.dropdown.innerHTML="";const t=document.createElement("div");t.className="entity-picker-error",t.textContent=e,this.dropdown.appendChild(t),this.open()}selectEntity(e){this.selectedEntity=e,this.input.value=e.display_name,this.config.onSelect(e),this.close()}open(){this.dropdown.style.display="block",this.isOpen=!0}close(){this.dropdown.style.display="none",this.isOpen=!1}focusNextItem(){const e=this.dropdown.querySelectorAll(".entity-picker-item"),t=this.dropdown.querySelector(".entity-picker-item.focused"),r=t?parseInt(t.getAttribute("data-index")||"-1"):-1,s=Math.min(r+1,e.length-1);e.forEach((i,o)=>{i.classList.toggle("focused",o===s)})}focusPrevItem(){const e=this.dropdown.querySelectorAll(".entity-picker-item"),t=this.dropdown.querySelector(".entity-picker-item.focused"),r=t?parseInt(t.getAttribute("data-index")||"0"):0,s=Math.max(r-1,0);e.forEach((i,o)=>{i.classList.toggle("focused",o===s)})}selectFocusedItem(){const e=this.dropdown.querySelector(".entity-picker-item.focused");e&&e.click()}getValue(){return this.selectedEntity}setValue(e){this.selectedEntity=e,this.input.value=(e==null?void 0:e.display_name)||""}clear(){this.selectedEntity=null,this.input.value="",this.config.onSelect(null)}}class N{constructor(e){l(this,"config");l(this,"pickers",new Map);l(this,"currentValues");this.config=e,this.currentValues={...e.values},this.render()}setValue(e,t){this.currentValues[e]=t,this.config.onChange(e,t)}render(){this.config.container.innerHTML="",this.pickers.clear();for(const e of this.config.template.slots){const t=this.createField(e);this.config.container.appendChild(t)}}createField(e){const t=document.createElement("div");t.className="form-field",t.dataset.slot=e.name;const r=document.createElement("label");r.htmlFor=`field-${e.name}`,r.innerHTML=e.label,e.required&&(r.innerHTML+='<span class="required-star">*</span>'),t.appendChild(r);const s=this.createInput(e);if(t.appendChild(s),e.help_text){const i=document.createElement("div");i.className="help-text",i.textContent=e.help_text,t.appendChild(i)}return t}createInput(e){const t=this.config.values[e.name],r=e.slot_type;switch(r.type){case"text":return this.createTextInput(e,r,t);case"enum":return this.createEnumSelect(e,r,t);case"entity_ref":return this.createEntityPicker(e,r,t);case"country":return this.createCountrySelect(e,t);case"date":return this.createDateInput(e,t);case"percentage":case"integer":case"decimal":return this.createNumberInput(e,r,t);case"boolean":return this.createCheckbox(e,t);default:return this.createTextInput(e,{type:"text"},t)}}createTextInput(e,t,r){if(t.multiline){const i=document.createElement("textarea");return i.id=`field-${e.name}`,i.value=String(r??""),i.placeholder=e.placeholder??"",t.max_length&&(i.maxLength=t.max_length),i.addEventListener("input",()=>{this.setValue(e.name,i.value)}),i}const s=document.createElement("input");return s.type="text",s.id=`field-${e.name}`,s.value=String(r??""),s.placeholder=e.placeholder??"",t.max_length&&(s.maxLength=t.max_length),s.addEventListener("input",()=>{this.setValue(e.name,s.value)}),s}createEnumSelect(e,t,r){const s=document.createElement("select");if(s.id=`field-${e.name}`,!e.required){const i=document.createElement("option");i.value="",i.textContent="-- Select --",s.appendChild(i)}for(const i of t.options){const o=document.createElement("option");o.value=i.value,o.textContent=i.label,i.value===r&&(o.selected=!0),s.appendChild(o)}return s.addEventListener("change",()=>{this.setValue(e.name,s.value)}),s}createEntityPicker(e,t,r){const s=document.createElement("div");s.id=`field-${e.name}`,console.log("[FormRenderer] Creating EntityPicker for slot:",e.name,"with types:",t.allowed_types);const i=new k({container:s,allowedTypes:t.allowed_types,allowCreate:t.allow_create,placeholder:e.placeholder??`Search ${t.allowed_types.join(", ")}...`,onSelect:o=>{this.setValue(e.name,(o==null?void 0:o.id)??null)},onCreate:o=>{console.log("Create new:",o)}});return this.pickers.set(e.name,i),s}createCountrySelect(e,t){const r=[{code:"GB",name:"United Kingdom"},{code:"US",name:"United States"},{code:"DE",name:"Germany"},{code:"FR",name:"France"},{code:"CH",name:"Switzerland"},{code:"LU",name:"Luxembourg"},{code:"IE",name:"Ireland"},{code:"NL",name:"Netherlands"},{code:"SG",name:"Singapore"},{code:"HK",name:"Hong Kong"},{code:"JE",name:"Jersey"},{code:"GG",name:"Guernsey"},{code:"KY",name:"Cayman Islands"},{code:"VG",name:"British Virgin Islands"}],s=document.createElement("select");s.id=`field-${e.name}`;const i=document.createElement("option");i.value="",i.textContent="-- Select Country --",s.appendChild(i);for(const o of r){const m=document.createElement("option");m.value=o.code,m.textContent=`${o.name} (${o.code})`,o.code===t&&(m.selected=!0),s.appendChild(m)}return s.addEventListener("change",()=>{this.setValue(e.name,s.value)}),s}createDateInput(e,t){const r=document.createElement("input");return r.type="date",r.id=`field-${e.name}`,r.value=String(t??""),r.addEventListener("change",()=>{this.setValue(e.name,r.value)}),r}createNumberInput(e,t,r){const s=document.createElement("input");return s.type="number",s.id=`field-${e.name}`,s.value=String(r??""),s.placeholder=e.placeholder??"",t.type==="percentage"?(s.min="0",s.max="100",s.step="0.01"):t.type==="integer"?(s.step="1",t.min!==void 0&&(s.min=String(t.min)),t.max!==void 0&&(s.max=String(t.max))):s.step="0.01",s.addEventListener("input",()=>{const i=t.type==="integer"?parseInt(s.value,10):parseFloat(s.value);this.setValue(e.name,isNaN(i)?null:i)}),s}createCheckbox(e,t){const r=document.createElement("div");r.className="checkbox-wrapper";const s=document.createElement("input");s.type="checkbox",s.id=`field-${e.name}`,s.checked=!!t,s.addEventListener("change",()=>{this.setValue(e.name,s.checked)});const i=document.createElement("label");return i.htmlFor=`field-${e.name}`,i.textContent=e.label,r.appendChild(s),r.appendChild(i),r}getValues(){return{...this.currentValues}}isValid(){for(const e of this.config.template.slots)if(e.required){const t=this.currentValues[e.name];if(t==null||t==="")return!1}return!0}destroy(){this.pickers.clear(),this.config.container.innerHTML=""}}const D={sessionId:null,sessionState:null,messages:[],intents:[],validations:[],assembledDsl:[],canExecute:!1,loading:!1,error:null,templates:[],selectedTemplateId:null,selectedTemplate:null,formValues:{},renderedDsl:null,executionLog:[]};let g={...D};const w=new Set;function E(){return g}function p(n){g={...g,...n},w.forEach(e=>e(g))}function V(n){return w.add(n),()=>w.delete(n)}function h(n){p({loading:n,error:null})}function y(n){p({error:n,loading:!1})}function _(n,e){p({sessionId:n,sessionState:e,messages:[],intents:[],validations:[],assembledDsl:[],canExecute:!1,error:null})}function P(n){p({templates:n})}function x(n){p({selectedTemplateId:(n==null?void 0:n.id)??null,selectedTemplate:n,formValues:n?O(n):{},renderedDsl:null})}function F(n,e){p({formValues:{...g.formValues,[n]:e}})}function L(n){p({renderedDsl:n})}function a(n){p({executionLog:[...g.executionLog,`[${new Date().toLocaleTimeString()}] ${n}`]})}function O(n){const e={};for(const t of n.slots)t.default_value!==void 0&&(e[t.name]=t.default_value);return e}let u=null,S=null;function c(n){const e=document.getElementById(n);if(!e)throw new Error(`Element not found: ${n}`);return e}function R(n){const e=c("template-select");e.innerHTML='<option value="">Select Template...</option>';const t=new Map;for(const r of n)t.has(r.domain)||t.set(r.domain,[]),t.get(r.domain).push(r);for(const[r,s]of t){const i=document.createElement("optgroup");i.label=r.toUpperCase();for(const o of s){const m=document.createElement("option");m.value=o.id,m.textContent=o.name,i.appendChild(m)}e.appendChild(i)}}function M(){const n=E(),e=c("session-info"),t=c("session-state");n.sessionId?(e.textContent=`Session: ${n.sessionId.substring(0,8)}...`,e.className="session-info active"):(e.textContent="No session",e.className="session-info"),n.sessionState?(t.textContent=n.sessionState.replace(/_/g," "),t.className=`session-state ${n.sessionState}`,t.style.display="inline-block"):t.style.display="none"}function H(){const n=E(),e=c("form-container"),t=c("render-btn");if(n.selectedTemplateId===S&&u){v();return}if(S=n.selectedTemplateId,u&&(u.destroy(),u=null),!n.selectedTemplate){e.innerHTML='<p class="placeholder-text">Select a template to begin</p>',t.disabled=!0;return}u=new N({container:e,template:n.selectedTemplate,values:n.formValues,onChange:(r,s)=>{F(r,s),v()}}),v()}function v(){const n=c("render-btn");n.disabled=!u||!u.isValid()}function q(){const n=E(),e=c("dsl-preview"),t=c("execute-btn");n.renderedDsl?(e.textContent=n.renderedDsl,e.classList.remove("placeholder-text"),t.disabled=!n.sessionId):(e.innerHTML='<span class="placeholder-text">DSL will appear here</span>',t.disabled=!0)}function U(){const n=E(),e=c("execution-log");e.innerHTML=n.executionLog.map(t=>{const r=t.includes("Error")||t.includes("Failed"),s=t.includes("Success")||t.includes("Created");return`<div class="log-entry ${r?"error":s?"success":""}">${t}</div>`}).join(""),e.scrollTop=e.scrollHeight}function C(){M(),H(),q(),U()}async function A(){try{h(!0);const n=await f.createSession({});_(n.session_id,n.state),a(`Session created: ${n.session_id.substring(0,8)}...`)}catch(n){const e=n instanceof Error?n.message:"Unknown error";y(e),a(`Error creating session: ${e}`)}finally{h(!1)}}async function B(n){if(!n){x(null);return}try{h(!0);const e=await f.getTemplate(n);x(e),a(`Template loaded: ${e.name}`)}catch(e){const t=e instanceof Error?e.message:"Unknown error";y(t),a(`Error loading template: ${t}`)}finally{h(!1)}}async function G(){const n=E();if(!(!n.selectedTemplateId||!u))try{h(!0);const e=u.getValues(),t=await f.renderTemplate(n.selectedTemplateId,e);L(t.dsl),a(`DSL rendered: ${t.verb}`)}catch(e){const t=e instanceof Error?e.message:"Unknown error";y(t),a(`Error rendering DSL: ${t}`)}finally{h(!1)}}async function K(){const n=E();if(!(!n.sessionId||!n.renderedDsl))try{h(!0),a("Executing DSL...");const e=await f.chat(n.sessionId,{message:`Execute: ${n.renderedDsl}`});if(e.can_execute){const t=await f.execute(n.sessionId,{dry_run:!1});if(t.success){for(const r of t.results)r.success?a(`Success: ${r.message}`):a(`Failed: ${r.message}`);a(`Execution complete: ${t.results.length} statement(s)`),L(null),p({sessionState:t.new_state})}else for(const r of t.errors)a(`Error: ${r}`)}else if(a("Cannot execute: validation failed"),e.validation_results){for(const t of e.validation_results)if(!t.valid)for(const r of t.errors)a(`Validation error: ${r.message}`)}}catch(e){const t=e instanceof Error?e.message:"Unknown error";y(t),a(`Execution error: ${t}`)}finally{h(!1)}}function j(){c("new-session-btn").addEventListener("click",A),c("template-select").addEventListener("change",n=>{const e=n.target;B(e.value)}),c("render-btn").addEventListener("click",G),c("execute-btn").addEventListener("click",K)}async function J(){V(C),j();try{const n=await f.listTemplates();P(n.templates),R(n.templates)}catch(n){console.error("Failed to load templates:",n),a("Error: Failed to load templates")}C()}document.addEventListener("DOMContentLoaded",J);
