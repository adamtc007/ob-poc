#!/usr/bin/env python3
"""
Generate DSL to create CBUs for Allianz GI funds and link them to mancos/IM.

Inputs:
- data/external/allianzgi/*_funds.json (downloaded via fetch_allianzgi_funds.py)

Output:
- data/derived/dsl/allianzgi.dsl

For each region+fund name:
1. Ensure a CBU with name=<fund name>, jurisdiction=<region>.
2. Link region manco with role MANCO.
3. Link global investment manager with role INVESTMENT_MANAGER.
"""

import hashlib
import json
import re
from pathlib import Path

INPUT_DIR = Path("data/external/allianzgi")
OUTPUT_PATH = Path("data/derived/dsl/allianzgi.dsl")

# Minimal, editable mappings for mancos and investment manager
REGION_MANCO = {
    "LU": "Allianz Global Investors GmbH",
    "DE": "Allianz Global Investors GmbH",
    "GB": "Allianz Global Investors UK Limited",
    "IE": "Allianz Global Investors GmbH",
    "CH": "Allianz Global Investors (Schweiz) AG",
}
GLOBAL_IM = "Allianz Global Investors GmbH"


def slugify(text: str) -> str:
    text = text.lower()
    text = re.sub(r"[^a-z0-9]+", "_", text)
    text = text.strip("_")
    return text or "item"


def binding_slug(name: str, region: str) -> str:
    base = slugify(name)[:40]
    digest = hashlib.sha1(f"{region}:{name}".encode()).hexdigest()[:6]
    return f"{base}_{digest}"


def load_funds():
    funds = []
    for path in sorted(INPUT_DIR.glob("*_funds.json")):
        region = path.stem.split("_")[0].upper()
        data = json.loads(path.read_text())
        fund_list = data.get("FundList") or []
        for item in fund_list:
            name = item.get("FundName") or item.get("FundNameColumn")
            if not name:
                continue
            funds.append(
                {
                    "region": region,
                    "name": name.strip(),
                }
            )
    return funds


def dedupe_funds(funds):
    seen = set()
    deduped = []
    for fund in sorted(funds, key=lambda f: (f["region"], f["name"].lower())):
        key = (fund["region"], fund["name"].lower())
        if key in seen:
            continue
        seen.add(key)
        deduped.append(fund)
    return deduped


def ensure_dirs():
    OUTPUT_PATH.parent.mkdir(parents=True, exist_ok=True)


def render_header():
    return [
        ";; Auto-generated Allianz GI fund seeds",
        ";; Generated by scripts/generate_allianzgi_dsl.py",
        "",
    ]


def render_entities():
    lines = []
    # Region mancos
    for region, name in sorted(REGION_MANCO.items()):
        sym = f"manco_{region.lower()}"
        lines.append(
            f'(entity.ensure-limited-company :name "{name}" :jurisdiction "{region}" :as @{sym})'
        )
    # Global IM
    lines.append(
        f'(entity.ensure-limited-company :name "{GLOBAL_IM}" :jurisdiction "DE" :as @im_allianz_gi)'
    )
    lines.append("")  # spacer
    return lines


def render_funds(funds):
    lines = []
    for fund in funds:
        region = fund["region"]
        name = fund["name"]
        cbu_sym = f"cbu_{binding_slug(name, region)}_{region.lower()}"
        manco_sym = f"@manco_{region.lower()}"
        im_sym = "@im_allianz_gi"

        lines.append(
            f'(cbu.ensure :name "{name}" :jurisdiction "{region}" :as @{cbu_sym})'
        )
        lines.append(
            f'(cbu.assign-role :cbu-id @{cbu_sym} :entity-id {manco_sym} :role "MANCO")'
        )
        lines.append(
            f'(cbu.assign-role :cbu-id @{cbu_sym} :entity-id {im_sym} :role "INVESTMENT_MANAGER")'
        )
        lines.append("")  # spacer
    return lines


def main():
    ensure_dirs()
    funds = dedupe_funds(load_funds())
    lines = []
    lines.extend(render_header())
    lines.extend(render_entities())
    lines.extend(render_funds(funds))
    OUTPUT_PATH.write_text("\n".join(lines))
    print(f"[ok] wrote {OUTPUT_PATH} with {len(funds)} funds")


if __name__ == "__main__":
    main()
